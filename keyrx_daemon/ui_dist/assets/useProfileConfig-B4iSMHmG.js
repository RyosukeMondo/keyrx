import{R as e,r as t,j as r,W as a,_ as o,$ as n,a0 as l,k as c,h as s,i}from"./vendor-DchKSmaM.js";import{T as d}from"./Tooltip-Eiv0HiOq.js";import{a as y,q as u}from"./index-DNY7ggn3.js";import{a as p,v as b,P as m}from"./schemas-DRbUxdzV.js";const C=e.memo(({keyCode:e,label:a,mapping:o,onClick:n,isPressed:l=!1,className:c=""})=>{const s=!!o,i=t.useMemo(()=>{if(!o)return`${e} (Default)`;switch(o.type){case"simple":return`${e} → ${o.tapAction}`;case"tap_hold":return`${e} → Tap: ${o.tapAction}, Hold: ${o.holdAction} (${o.threshold}ms)`;case"macro":return`${e} → Macro (${o.macroSteps?.length||0} steps)`;case"layer_switch":return`${e} → Layer: ${o.targetLayer}`;default:return`${e} (Default)`}},[e,o]),u=t.useMemo(()=>{if(!o)return"";switch(o.type){case"simple":return o.tapAction||"";case"tap_hold":return`T:${o.tapAction} H:${o.holdAction}`;case"macro":return"MACRO";case"layer_switch":return o.targetLayer||"";default:return""}},[o]),p=(()=>{if(!o)return{border:"border-slate-600",bg:"bg-slate-700"};switch(o.type){case"simple":return{border:"border-green-500",bg:"bg-slate-700"};case"tap_hold":return{border:"border-red-500",bg:"bg-red-900/15"};case"macro":return{border:"border-purple-500",bg:"bg-purple-900/15"};case"layer_switch":return{border:"border-yellow-500",bg:"bg-yellow-900/15"};default:return{border:"border-slate-600",bg:"bg-slate-700"}}})();return r.jsx(d,{content:i,children:r.jsxs("button",{onClick:n,"aria-label":`Key ${e}. Current mapping: ${i}. Click to configure.`,className:y("relative flex flex-col items-center justify-center","rounded border transition-all duration-150","hover:brightness-110 hover:-translate-y-0.5","focus:outline focus:outline-2 focus:outline-primary-500","min-h-[50px]",p.border,p.bg,l&&"bg-green-500 border-green-400",c),style:{aspectRatio:"1"},children:[r.jsx("span",{className:"text-[10px] text-slate-400 font-mono",children:a}),s&&r.jsx("span",{className:"text-[12px] text-yellow-300 font-bold font-mono mt-0.5",children:u})]})})});C.displayName="KeyButton";const w={name:"ANSI 104",keys:[{code:"KC_ESC",label:"Esc",x:0,y:0,w:1},{code:"KC_F1",label:"F1",x:2,y:0,w:1},{code:"KC_F2",label:"F2",x:3,y:0,w:1},{code:"KC_F3",label:"F3",x:4,y:0,w:1},{code:"KC_F4",label:"F4",x:5,y:0,w:1},{code:"KC_F5",label:"F5",x:6.5,y:0,w:1},{code:"KC_F6",label:"F6",x:7.5,y:0,w:1},{code:"KC_F7",label:"F7",x:8.5,y:0,w:1},{code:"KC_F8",label:"F8",x:9.5,y:0,w:1},{code:"KC_F9",label:"F9",x:11,y:0,w:1},{code:"KC_F10",label:"F10",x:12,y:0,w:1},{code:"KC_F11",label:"F11",x:13,y:0,w:1},{code:"KC_F12",label:"F12",x:14,y:0,w:1},{code:"KC_PSCR",label:"PrtSc",x:15.25,y:0,w:1},{code:"KC_SLCK",label:"ScrLk",x:16.25,y:0,w:1},{code:"KC_PAUS",label:"Pause",x:17.25,y:0,w:1},{code:"KC_GRV",label:"`",x:0,y:1.5,w:1},{code:"KC_1",label:"1",x:1,y:1.5,w:1},{code:"KC_2",label:"2",x:2,y:1.5,w:1},{code:"KC_3",label:"3",x:3,y:1.5,w:1},{code:"KC_4",label:"4",x:4,y:1.5,w:1},{code:"KC_5",label:"5",x:5,y:1.5,w:1},{code:"KC_6",label:"6",x:6,y:1.5,w:1},{code:"KC_7",label:"7",x:7,y:1.5,w:1},{code:"KC_8",label:"8",x:8,y:1.5,w:1},{code:"KC_9",label:"9",x:9,y:1.5,w:1},{code:"KC_0",label:"0",x:10,y:1.5,w:1},{code:"KC_MINS",label:"-",x:11,y:1.5,w:1},{code:"KC_EQL",label:"=",x:12,y:1.5,w:1},{code:"KC_BSPC",label:"Backspace",x:13,y:1.5,w:2},{code:"KC_INS",label:"Ins",x:15.25,y:1.5,w:1},{code:"KC_HOME",label:"Home",x:16.25,y:1.5,w:1},{code:"KC_PGUP",label:"PgUp",x:17.25,y:1.5,w:1},{code:"KC_TAB",label:"Tab",x:0,y:2.5,w:1.5},{code:"KC_Q",label:"Q",x:1.5,y:2.5,w:1},{code:"KC_W",label:"W",x:2.5,y:2.5,w:1},{code:"KC_E",label:"E",x:3.5,y:2.5,w:1},{code:"KC_R",label:"R",x:4.5,y:2.5,w:1},{code:"KC_T",label:"T",x:5.5,y:2.5,w:1},{code:"KC_Y",label:"Y",x:6.5,y:2.5,w:1},{code:"KC_U",label:"U",x:7.5,y:2.5,w:1},{code:"KC_I",label:"I",x:8.5,y:2.5,w:1},{code:"KC_O",label:"O",x:9.5,y:2.5,w:1},{code:"KC_P",label:"P",x:10.5,y:2.5,w:1},{code:"KC_LBRC",label:"[",x:11.5,y:2.5,w:1},{code:"KC_RBRC",label:"]",x:12.5,y:2.5,w:1},{code:"KC_BSLS",label:"\\",x:13.5,y:2.5,w:1.5},{code:"KC_DEL",label:"Del",x:15.25,y:2.5,w:1},{code:"KC_END",label:"End",x:16.25,y:2.5,w:1},{code:"KC_PGDN",label:"PgDn",x:17.25,y:2.5,w:1},{code:"KC_CAPS",label:"Caps",x:0,y:3.5,w:1.75},{code:"KC_A",label:"A",x:1.75,y:3.5,w:1},{code:"KC_S",label:"S",x:2.75,y:3.5,w:1},{code:"KC_D",label:"D",x:3.75,y:3.5,w:1},{code:"KC_F",label:"F",x:4.75,y:3.5,w:1},{code:"KC_G",label:"G",x:5.75,y:3.5,w:1},{code:"KC_H",label:"H",x:6.75,y:3.5,w:1},{code:"KC_J",label:"J",x:7.75,y:3.5,w:1},{code:"KC_K",label:"K",x:8.75,y:3.5,w:1},{code:"KC_L",label:"L",x:9.75,y:3.5,w:1},{code:"KC_SCLN",label:";",x:10.75,y:3.5,w:1},{code:"KC_QUOT",label:"'",x:11.75,y:3.5,w:1},{code:"KC_ENT",label:"Enter",x:12.75,y:3.5,w:2.25},{code:"KC_LSFT",label:"Shift",x:0,y:4.5,w:2.25},{code:"KC_Z",label:"Z",x:2.25,y:4.5,w:1},{code:"KC_X",label:"X",x:3.25,y:4.5,w:1},{code:"KC_C",label:"C",x:4.25,y:4.5,w:1},{code:"KC_V",label:"V",x:5.25,y:4.5,w:1},{code:"KC_B",label:"B",x:6.25,y:4.5,w:1},{code:"KC_N",label:"N",x:7.25,y:4.5,w:1},{code:"KC_M",label:"M",x:8.25,y:4.5,w:1},{code:"KC_COMM",label:",",x:9.25,y:4.5,w:1},{code:"KC_DOT",label:".",x:10.25,y:4.5,w:1},{code:"KC_SLSH",label:"/",x:11.25,y:4.5,w:1},{code:"KC_RSFT",label:"Shift",x:12.25,y:4.5,w:2.75},{code:"KC_UP",label:"↑",x:16.25,y:4.5,w:1},{code:"KC_LCTL",label:"Ctrl",x:0,y:5.5,w:1.25},{code:"KC_LGUI",label:"Win",x:1.25,y:5.5,w:1.25},{code:"KC_LALT",label:"Alt",x:2.5,y:5.5,w:1.25},{code:"KC_SPC",label:"Space",x:3.75,y:5.5,w:6.25},{code:"KC_RALT",label:"Alt",x:10,y:5.5,w:1.25},{code:"KC_RGUI",label:"Win",x:11.25,y:5.5,w:1.25},{code:"KC_APP",label:"Menu",x:12.5,y:5.5,w:1.25},{code:"KC_RCTL",label:"Ctrl",x:13.75,y:5.5,w:1.25},{code:"KC_LEFT",label:"←",x:15.25,y:5.5,w:1},{code:"KC_DOWN",label:"↓",x:16.25,y:5.5,w:1},{code:"KC_RGHT",label:"→",x:17.25,y:5.5,w:1}]},f={ANSI_104:w,ISO_105:w,JIS_109:w,HHKB:w,NUMPAD:w},_=({keyCode:e,label:t,mapping:o,isPressed:n,onClick:l,onDrop:c,disabled:s=!1})=>{const{setNodeRef:i,isOver:d}=a({id:`drop-${e}`,data:{keyCode:e},disabled:s}),u=o?`Currently mapped to ${o.tapAction||"custom action"}`:"No mapping assigned",p=s?`${t} key. ${u}. Not configurable.`:`${t} key. ${u}. Drop zone for key assignment. ${d?"Drop here to assign":""}`;return r.jsx("div",{ref:i,className:y("relative",d&&!s&&"ring-2 ring-primary-500 ring-offset-2 ring-offset-slate-800"),"aria-label":p,"aria-dropeffect":s?"none":d?"move":"none",children:r.jsx(C,{keyCode:e,label:t,mapping:o,onClick:()=>{s||l()},isPressed:n,className:y(s&&"opacity-50 cursor-not-allowed")})})};_.displayName="DroppableKeyWrapper";const g=({layout:e,keyMappings:a,onKeyClick:o,onKeyDrop:n,simulatorMode:l=!1,pressedKeys:c=new Set,className:s=""})=>{const i=t.useRef(null),d=t.useMemo(()=>f[e].keys.map(e=>({keyCode:e.code,label:e.label,gridRow:Math.floor(e.y)+1,gridColumn:Math.floor(e.x)+1,gridColumnSpan:Math.ceil(e.w||1),width:e.w||1})),[e]),u=t.useMemo(()=>Math.max(...d.map(e=>e.gridRow)),[d]),p=t.useMemo(()=>Math.max(...d.map(e=>e.gridColumn+e.gridColumnSpan-1)),[d]);return function(e,r={}){const{orientation:a="vertical",loop:o=!0,onEnter:n}=r;t.useEffect(()=>{const t=e.current;if(!t)return;const r=e=>{const r=function(e){const t=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(", ");return Array.from(e.querySelectorAll(t))}(t),l=r.findIndex(e=>e===document.activeElement);if(-1===l)return;const c="vertical"===a,s=c?"ArrowDown":"ArrowRight",i=c?"ArrowUp":"ArrowLeft";let d=l;if(e.key===s)e.preventDefault(),d=l+1,d>=r.length&&(d=o?0:r.length-1);else if(e.key===i)e.preventDefault(),d=l-1,d<0&&(d=o?r.length-1:0);else if("Home"===e.key)e.preventDefault(),d=0;else if("End"===e.key)e.preventDefault(),d=r.length-1;else if("Enter"===e.key&&n)return e.preventDefault(),void n(l);d!==l&&r[d]?.focus()};return t.addEventListener("keydown",r),()=>t.removeEventListener("keydown",r)},[e,a,o,n])}(i,{orientation:"horizontal",loop:!0}),r.jsx("div",{ref:i,className:y("keyboard-grid",s),role:"group","aria-label":`${e} keyboard layout${l?" (simulator mode)":""}. Use arrow keys to navigate between keys, Enter to select.`,style:{display:"grid",gridTemplateRows:`repeat(${u}, 52px)`,gridTemplateColumns:`repeat(${p}, 52px)`,gap:"2px",padding:"16px",backgroundColor:"var(--color-bg-secondary)",borderRadius:"12px"},children:d.map(e=>{return r.jsx("div",{style:{gridRow:e.gridRow,gridColumn:`${e.gridColumn} / span ${e.gridColumnSpan}`},children:r.jsx(_,{keyCode:e.keyCode,label:e.label,mapping:a.get(e.keyCode),onClick:()=>o(e.keyCode),onDrop:(t=e.keyCode,e=>{n&&n(t,e)}),isPressed:c.has(e.keyCode),disabled:l})},e.keyCode);var t})})},x={wsUrl:`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/ws-rpc`};function K(e){const r=x.wsUrl,[a,c]=t.useState(!1),[s,i]=t.useState(null),d=t.useRef(new Map),y=t.useRef(new Map),{sendMessage:u,lastMessage:b,readyState:m}=o(r,{shouldReconnect:()=>!0,reconnectInterval:3e3,reconnectAttempts:10,onError:e=>{i(new Error("WebSocket connection error")),c(!1)},onClose:()=>{c(!1),d.current.forEach((e,t)=>{clearTimeout(e.timeoutId),e.reject(new Error("WebSocket connection closed"))}),d.current.clear()}});t.useEffect(()=>{if(b?.data)try{const t=JSON.parse(b.data);let r;try{r=p(t,"server")}catch(e){return void i(e instanceof Error?e:new Error("Message validation failed"))}if("connected"===r.type)return c(!0),void i(null);if("response"===r.type){const e=d.current.get(r.id);return void(e&&(clearTimeout(e.timeoutId),d.current.delete(r.id),r.error?e.reject(new Error(r.error.message)):e.resolve(r.result)))}if(function(e){return"event"===e.type}(r)){const e=y.current.get(r.channel);return void(e&&e.forEach(e=>{try{e(r.data)}catch(t){}}))}const a=r;if(a.type&&a.payload&&"response"!==a.type&&"connected"!==a.type){const e=a.type,t=a.payload,r={latency:"latency",state:"daemon-state",event:"events",heartbeat:"heartbeat"}[e];if(r&&"heartbeat"!==r){const e=y.current.get(r);e&&e.forEach(e=>{try{e(t)}catch(r){}})}return}}catch(t){i(t instanceof Error?t:new Error("Failed to parse message"))}},[b]);const C=t.useCallback(e=>new Promise((t,r)=>{if(m!==n.ReadyState.OPEN)return void r(new Error("WebSocket is not connected"));const a=e.id,o=setTimeout(()=>{d.current.delete(a),r(new Error("Request timeout after 30000ms"))},3e4);d.current.set(a,{resolve:t,reject:r,timeoutId:o});try{p(e,"client")}catch(l){return clearTimeout(o),d.current.delete(a),void r(l instanceof Error?l:new Error("Message validation failed"))}try{u(JSON.stringify(e))}catch(c){clearTimeout(o),d.current.delete(a),r(c)}}),[m,u]),w=t.useCallback((e,t)=>{const r=l();return C({type:"query",id:r,method:e,params:t})},[C]),f=t.useCallback((e,t)=>{const r=l();return C({type:"command",id:r,method:e,params:t})},[C]),_=t.useCallback((e,t)=>{let r=y.current.get(e);r||(r=new Set,y.current.set(e,r));const a=0===r.size;if(r.add(t),a&&m===n.ReadyState.OPEN){const t={type:"subscribe",id:l(),channel:e};u(JSON.stringify(t))}return()=>{const r=y.current.get(e);if(r&&(r.delete(t),0===r.size&&(y.current.delete(e),m===n.ReadyState.OPEN))){const t={type:"unsubscribe",id:l(),channel:e};u(JSON.stringify(t))}}},[m,u]),g=t.useCallback(e=>{if(y.current.get(e)&&(y.current.delete(e),m===n.ReadyState.OPEN)){const t={type:"unsubscribe",id:l(),channel:e};u(JSON.stringify(t))}},[m,u]);return t.useEffect(()=>()=>{d.current.forEach(e=>{clearTimeout(e.timeoutId),e.reject(new Error("Component unmounted"))}),d.current.clear(),y.current.forEach((e,t)=>{if(m===n.ReadyState.OPEN){const e={type:"unsubscribe",id:l(),channel:t};try{u(JSON.stringify(e))}catch(r){}}}),y.current.clear()},[m,u]),{query:w,command:f,subscribe:_,unsubscribe:g,readyState:m,isConnected:a,lastError:s}}class h{constructor(e){this.api=e}async getProfiles(){return this.api.query("get_profiles")}async createProfile(e,t){return this.api.command("create_profile",{name:e,template:t})}async activateProfile(e){return this.api.command("activate_profile",{name:e})}async deleteProfile(e){return this.api.command("delete_profile",{name:e})}async duplicateProfile(e,t){return this.api.command("duplicate_profile",{source_name:e,new_name:t})}async renameProfile(e,t){return this.api.command("rename_profile",{old_name:e,new_name:t})}async getProfileConfig(e){const t=await this.api.query("get_profile_config",{name:e}),r=b(m,t,"get_profile_config");return{name:r.name,source:r.config}}async setProfileConfig(e,t){await this.api.command("set_profile_config",{name:e,source:t})}async getActiveProfile(){return this.api.query("get_active_profile")}async getDevices(){return this.api.query("get_devices")}async renameDevice(e,t){return this.api.command("rename_device",{serial:e,new_name:t})}async setScopeDevice(e,t){return this.api.command("set_scope_device",{serial:e,scope:t})}async forgetDevice(e){return this.api.command("forget_device",{serial:e})}async setDeviceLayout(e,t){return this.api.command("set_device_layout",{serial:e,layout:t})}async getConfig(){return this.api.query("get_config")}async updateConfig(e){return this.api.command("update_config",{code:e})}async setKeyMapping(e,t,r){return this.api.command("set_key_mapping",{layer:e,key_code:t,mapping:r})}async deleteKeyMapping(e,t){return this.api.command("delete_key_mapping",{layer:e,key_code:t})}async getLayers(){return this.api.query("get_layers")}async getLatency(){return this.api.query("get_latency")}async getEvents(e,t){return this.api.query("get_events",{limit:e,offset:t})}async clearEvents(){return this.api.command("clear_events")}async simulate(e){return this.api.command("simulate",{input:e})}async resetSimulator(){return this.api.command("reset_simulator")}onDaemonState(e){return this.api.subscribe("daemon-state",e)}onKeyEvent(e){return this.api.subscribe("events",e)}onLatencyUpdate(e){return this.api.subscribe("latency",e)}get isConnected(){return this.api.isConnected}get readyState(){return this.api.readyState}get lastError(){return this.api.lastError}}function v(e){const t=K(),r=new h(t);return c({queryKey:u.config(e),queryFn:()=>r.getProfileConfig(e),enabled:!!e&&t.isConnected,staleTime:3e4,gcTime:3e5,retry:1,retryDelay:1e3})}function S(){const e=s(),t=K(),r=new h(t);return i({mutationFn:({name:e,source:t})=>r.setProfileConfig(e,t),onMutate:async({name:t,source:r})=>{await e.cancelQueries({queryKey:u.config(t)});const a=e.getQueryData(u.config(t));return e.setQueryData(u.config(t),{name:t,source:r}),{previousConfig:a}},onError:(t,{name:r},a)=>{a?.previousConfig&&e.setQueryData(u.config(r),a.previousConfig)},onSuccess:(t,{name:r})=>{e.invalidateQueries({queryKey:u.config(r)}),e.invalidateQueries({queryKey:u.profiles})}})}export{g as K,v as a,S as b,K as u};
//# sourceMappingURL=useProfileConfig-B4iSMHmG.js.map
