import{j as e,s as t,R as a,r,v as s,u as l,w as i}from"./vendor-DchKSmaM.js";import{C as o}from"./client-DsuQMGGi.js";import{M as n}from"./Modal-KUDrpHjH.js";import{u as c,a as d,b as m,K as u}from"./useProfileConfig-B4iSMHmG.js";import{u as p,a as g}from"./useProfiles-MkTJ18U7.js";import{u as y}from"./useDevices-DYblVG9O.js";import"./index-DNY7ggn3.js";import"./Tooltip-Eiv0HiOq.js";import"./schemas-DRbUxdzV.js";function h({value:a,onChange:r,readOnly:s=!1,height:l="600px",language:i="javascript"}){return e.jsx(t,{height:l,language:i,theme:"vs-dark",value:a,onChange:e=>{r&&void 0!==e&&r(e)},options:{readOnly:s,minimap:{enabled:!1},fontSize:14,lineNumbers:"on",scrollBeyondLastLine:!1,automaticLayout:!0,wordWrap:"on",tabSize:2,insertSpaces:!0}})}const b=[{id:"A",label:"A",category:"virtual_key"},{id:"B",label:"B",category:"virtual_key"},{id:"C",label:"C",category:"virtual_key"},{id:"D",label:"D",category:"virtual_key"},{id:"E",label:"E",category:"virtual_key"},{id:"F",label:"F",category:"virtual_key"},{id:"G",label:"G",category:"virtual_key"},{id:"H",label:"H",category:"virtual_key"},{id:"I",label:"I",category:"virtual_key"},{id:"J",label:"J",category:"virtual_key"},{id:"K",label:"K",category:"virtual_key"},{id:"L",label:"L",category:"virtual_key"},{id:"M",label:"M",category:"virtual_key"},{id:"N",label:"N",category:"virtual_key"},{id:"O",label:"O",category:"virtual_key"},{id:"P",label:"P",category:"virtual_key"},{id:"Q",label:"Q",category:"virtual_key"},{id:"R",label:"R",category:"virtual_key"},{id:"S",label:"S",category:"virtual_key"},{id:"T",label:"T",category:"virtual_key"},{id:"U",label:"U",category:"virtual_key"},{id:"V",label:"V",category:"virtual_key"},{id:"W",label:"W",category:"virtual_key"},{id:"X",label:"X",category:"virtual_key"},{id:"Y",label:"Y",category:"virtual_key"},{id:"Z",label:"Z",category:"virtual_key"},{id:"0",label:"0",category:"virtual_key"},{id:"1",label:"1",category:"virtual_key"},{id:"2",label:"2",category:"virtual_key"},{id:"3",label:"3",category:"virtual_key"},{id:"4",label:"4",category:"virtual_key"},{id:"5",label:"5",category:"virtual_key"},{id:"6",label:"6",category:"virtual_key"},{id:"7",label:"7",category:"virtual_key"},{id:"8",label:"8",category:"virtual_key"},{id:"9",label:"9",category:"virtual_key"},{id:"F1",label:"F1",category:"virtual_key"},{id:"F2",label:"F2",category:"virtual_key"},{id:"F3",label:"F3",category:"virtual_key"},{id:"F4",label:"F4",category:"virtual_key"},{id:"F5",label:"F5",category:"virtual_key"},{id:"F6",label:"F6",category:"virtual_key"},{id:"F7",label:"F7",category:"virtual_key"},{id:"F8",label:"F8",category:"virtual_key"},{id:"F9",label:"F9",category:"virtual_key"},{id:"F10",label:"F10",category:"virtual_key"},{id:"F11",label:"F11",category:"virtual_key"},{id:"F12",label:"F12",category:"virtual_key"},{id:"Escape",label:"Esc",category:"virtual_key"},{id:"Enter",label:"Enter",category:"virtual_key"},{id:"Space",label:"Space",category:"virtual_key"},{id:"Backspace",label:"BS",category:"virtual_key"},{id:"Tab",label:"Tab",category:"virtual_key"},{id:"Delete",label:"Del",category:"virtual_key"},{id:"Insert",label:"Ins",category:"virtual_key"},{id:"Home",label:"Home",category:"virtual_key"},{id:"End",label:"End",category:"virtual_key"},{id:"PageUp",label:"PgUp",category:"virtual_key"},{id:"PageDown",label:"PgDn",category:"virtual_key"},{id:"Up",label:"â†‘",category:"virtual_key"},{id:"Down",label:"â†“",category:"virtual_key"},{id:"Left",label:"â†",category:"virtual_key"},{id:"Right",label:"â†’",category:"virtual_key"},{id:"Minus",label:"-",category:"virtual_key"},{id:"Equal",label:"=",category:"virtual_key"},{id:"LeftBracket",label:"[",category:"virtual_key"},{id:"RightBracket",label:"]",category:"virtual_key"},{id:"Backslash",label:"\\",category:"virtual_key"},{id:"Semicolon",label:";",category:"virtual_key"},{id:"Quote",label:"'",category:"virtual_key"},{id:"Comma",label:",",category:"virtual_key"},{id:"Period",label:".",category:"virtual_key"},{id:"Slash",label:"/",category:"virtual_key"}],x=[{id:"MD_00",label:"MD_00",category:"modifier",description:"Modifier/Layer 0"},{id:"MD_01",label:"MD_01",category:"modifier",description:"Modifier/Layer 1"},{id:"MD_02",label:"MD_02",category:"modifier",description:"Modifier/Layer 2"},{id:"MD_03",label:"MD_03",category:"modifier",description:"Modifier/Layer 3"},{id:"MD_04",label:"MD_04",category:"modifier",description:"Modifier/Layer 4"},{id:"MD_05",label:"MD_05",category:"modifier",description:"Modifier/Layer 5"},{id:"MD_06",label:"MD_06",category:"modifier",description:"Modifier/Layer 6"},{id:"MD_07",label:"MD_07",category:"modifier",description:"Modifier/Layer 7"},{id:"MD_08",label:"MD_08",category:"modifier",description:"Modifier/Layer 8"},{id:"MD_09",label:"MD_09",category:"modifier",description:"Modifier/Layer 9"},{id:"LCtrl",label:"LCtrl",category:"modifier",description:"Left Control"},{id:"RCtrl",label:"RCtrl",category:"modifier",description:"Right Control"},{id:"LShift",label:"LShift",category:"modifier",description:"Left Shift"},{id:"RShift",label:"RShift",category:"modifier",description:"Right Shift"},{id:"LAlt",label:"LAlt",category:"modifier",description:"Left Alt"},{id:"RAlt",label:"RAlt",category:"modifier",description:"Right Alt"},{id:"LMeta",label:"LWin",category:"modifier",description:"Left Windows/Super"},{id:"RMeta",label:"RWin",category:"modifier",description:"Right Windows/Super"}],f=[{id:"LK_00",label:"LK_00",category:"lock",description:"Lock 0 (CapsLock)"},{id:"LK_01",label:"LK_01",category:"lock",description:"Lock 1 (NumLock)"},{id:"LK_02",label:"LK_02",category:"lock",description:"Lock 2 (ScrollLock)"},{id:"LK_03",label:"LK_03",category:"lock",description:"Lock 3"},{id:"LK_04",label:"LK_04",category:"lock",description:"Lock 4"},{id:"LK_05",label:"LK_05",category:"lock",description:"Lock 5"},{id:"LK_06",label:"LK_06",category:"lock",description:"Lock 6"},{id:"LK_07",label:"LK_07",category:"lock",description:"Lock 7"},{id:"LK_08",label:"LK_08",category:"lock",description:"Lock 8"},{id:"LK_09",label:"LK_09",category:"lock",description:"Lock 9"}],v=[{id:"MD_00",label:"Base (MD_00)",category:"layer",description:"Base layer"},{id:"MD_01",label:"Layer MD_01",category:"layer",description:"Layer 1"},{id:"MD_02",label:"Layer MD_02",category:"layer",description:"Layer 2"},{id:"MD_03",label:"Layer MD_03",category:"layer",description:"Layer 3"},{id:"MD_04",label:"Layer MD_04",category:"layer",description:"Layer 4"},{id:"MD_05",label:"Layer MD_05",category:"layer",description:"Layer 5"},{id:"MD_06",label:"Layer MD_06",category:"layer",description:"Layer 6"},{id:"MD_07",label:"Layer MD_07",category:"layer",description:"Layer 7"},{id:"MD_08",label:"Layer MD_08",category:"layer",description:"Layer 8"},{id:"MD_09",label:"Layer MD_09",category:"layer",description:"Layer 9"}];function k({onKeySelect:t,selectedKey:r}){const[s,l]=a.useState("virtual_key"),i=[{id:"virtual_key",label:"Keys",keys:b},{id:"modifier",label:"Modifiers",keys:x},{id:"lock",label:"Locks",keys:f},{id:"layer",label:"Layers",keys:v}],n=i.find(e=>e.id===s)?.keys||[];return e.jsxs(o,{className:"h-full",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-100 mb-4",children:"Key Palette"}),e.jsx("div",{className:"flex gap-1 mb-4 border-b border-slate-700",children:i.map(t=>e.jsx("button",{onClick:()=>l(t.id),className:"px-3 py-2 text-sm font-medium transition-colors "+(s===t.id?"text-primary-400 border-b-2 border-primary-400":"text-slate-400 hover:text-slate-300"),children:t.label},t.id))}),e.jsx("div",{className:"grid grid-cols-8 gap-2 overflow-y-auto max-h-[400px] p-4 bg-slate-800/50 rounded-lg",children:n.map(a=>e.jsxs("button",{onClick:()=>t(a),className:`\n              relative flex flex-col items-center justify-center\n              min-h-[50px] px-2 py-2\n              rounded border transition-all\n              hover:brightness-110 hover:-translate-y-0.5 hover:shadow-lg\n              ${r?.id===a.id?"border-primary-500 bg-primary-500/20 shadow-lg shadow-primary-500/50":"border-slate-600 bg-slate-700 hover:border-slate-500"}\n              ${"modifier"===a.category?"border-cyan-500/50":""}\n              ${"lock"===a.category?"border-purple-500/50":""}\n              ${"layer"===a.category?"border-yellow-500/50":""}\n            `,title:a.description||a.id,children:[e.jsx("div",{className:"text-sm font-bold text-white font-mono",children:a.label}),e.jsx("div",{className:"text-[9px] text-slate-400 mt-0.5 font-mono",children:a.id})]},a.id))}),e.jsx("p",{className:"text-xs text-slate-500 mt-4",children:"Click a key from palette, then click a keyboard key to assign"})]})}function _({devices:t,showGlobalOption:a=!0,multiSelect:r=!0,selectedDevices:s,globalSelected:l,onSelectionChange:i,onEditDevice:n}){const c=l||s.length>0;return e.jsxs(o,{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-100 mb-3",children:"Device Selection"}),!c&&e.jsx("div",{className:"mb-3 px-3 py-2 bg-yellow-900/20 border border-yellow-700/50 rounded-md text-yellow-200 text-xs",role:"alert","aria-live":"polite",children:"âš  Select at least one device or global to configure"}),a&&e.jsxs("label",{className:"flex items-center gap-3 px-3 py-2.5 mb-2 rounded-md bg-slate-700/50 hover:bg-slate-700 cursor-pointer transition-colors",htmlFor:"device-global",children:[e.jsx("input",{type:"checkbox",id:"device-global",checked:l,onChange:()=>{i(s,!l)},className:"w-4 h-4 rounded border-slate-500 bg-slate-600 text-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-offset-0 cursor-pointer","aria-label":"Apply configuration globally to all devices"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-slate-100",children:"Global (All Devices)"}),e.jsx("div",{className:"text-xs text-slate-400",children:"Configuration applies to all devices"})]})]}),t.length>0?e.jsx("div",{className:"space-y-2",children:t.map(t=>e.jsxs("label",{className:"flex items-center gap-3 px-3 py-2.5 rounded-md bg-slate-700/50 hover:bg-slate-700 cursor-pointer transition-colors",htmlFor:`device-${t.id}`,children:[e.jsx("input",{type:"checkbox",id:`device-${t.id}`,checked:s.includes(t.id),onChange:()=>(e=>{if(r){const t=s.includes(e)?s.filter(t=>t!==e):[...s,e];i(t,l)}else i([e],l)})(t.id),className:"w-4 h-4 rounded border-slate-500 bg-slate-600 text-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-offset-0 cursor-pointer","aria-label":`Select device ${t.name}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-slate-100 truncate",children:t.name}),void 0!==t.connected&&e.jsx("span",{className:"px-2 py-0.5 text-xs font-medium rounded-full "+(t.connected?"bg-green-900/30 text-green-300 border border-green-700/50":"bg-gray-700/30 text-gray-400 border border-gray-600/50"),"aria-label":t.connected?"Device connected":"Device disconnected",children:t.connected?"Connected":"Disconnected"})]}),t.serial&&e.jsxs("div",{className:"text-xs text-slate-500 truncate",children:["Serial: ",t.serial]}),t.layout&&e.jsxs("div",{className:"text-xs text-slate-500",children:["Layout: ",t.layout]})]}),n&&e.jsx("button",{onClick:e=>{e.preventDefault(),n(t.id)},className:"px-2 py-1 text-xs text-primary-400 hover:text-primary-300 hover:bg-slate-600 rounded transition-colors","aria-label":`Edit device ${t.name}`,type:"button",children:"Edit"})]},t.id))}):e.jsx("div",{className:"text-sm text-slate-500 text-center py-4",children:"No devices detected. Connect a keyboard to get started."}),e.jsx("p",{className:"text-xs text-slate-500 mt-3",children:r?"Select one or more devices to configure. Device-specific mappings will be generated in Rhai script.":"Select a device to configure."})]})}function j({isOpen:t,onClose:a,physicalKey:s,currentMapping:l,onSave:i,availableKeys:o}){const[c,d]=r.useState(l?.type||"simple"),[m,u]=r.useState(l?.tapAction||""),[p,g]=r.useState(l?.holdAction||""),[y,h]=r.useState(l?.threshold||200),[b,x]=r.useState(l?.targetLayer||"");return e.jsx(n,{open:t,onClose:a,title:`Configure: ${s}`,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Mapping Type"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:["simple","tap_hold","macro","layer_switch"].map(t=>e.jsx("button",{onClick:()=>d(t),className:"px-4 py-2 rounded-md text-sm font-medium transition-colors "+(c===t?"bg-primary-500 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"),children:"tap_hold"===t?"Tap/Hold":t.charAt(0).toUpperCase()+t.slice(1).replace("_"," ")},t))})]}),"simple"===c&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Target Key"}),e.jsxs("select",{value:m,onChange:e=>u(e.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"Select a key..."}),o.map(t=>e.jsxs("option",{value:t.id,children:[t.label," (",t.id,")"]},t.id))]})]}),"tap_hold"===c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Tap Action (quick press)"}),e.jsxs("select",{value:m,onChange:e=>u(e.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"Select a key..."}),o.map(t=>e.jsxs("option",{value:t.id,children:[t.label," (",t.id,")"]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Hold Action (when held)"}),e.jsxs("select",{value:p,onChange:e=>g(e.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"Select a key..."}),o.filter(e=>"modifier"===e.category||"layer"===e.category).map(t=>e.jsxs("option",{value:t.id,children:[t.label," (",t.id,")"]},t.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:["Hold Threshold (ms): ",y]}),e.jsx("input",{type:"range",min:"50",max:"500",step:"10",value:y,onChange:e=>h(parseInt(e.target.value)),className:"w-full"}),e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 mt-1",children:[e.jsx("span",{children:"50ms (fast)"}),e.jsx("span",{children:"500ms (slow)"})]})]})]}),"layer_switch"===c&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Target Layer"}),e.jsxs("select",{value:b,onChange:e=>x(e.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"Select a layer..."}),Array.from({length:10},(t,a)=>e.jsxs("option",{value:`MD_${a.toString().padStart(2,"0")}`,children:["Layer MD_",a.toString().padStart(2,"0")]},a))]})]}),"macro"===c&&e.jsx("div",{className:"p-4 bg-slate-700/50 rounded-lg border border-slate-600",children:e.jsx("p",{className:"text-sm text-slate-400",children:"Macro configuration coming soon. Use Code Editor tab for now."})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-slate-700",children:[e.jsx("button",{onClick:a,className:"px-4 py-2 text-slate-300 hover:text-slate-100 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:()=>{i({type:c,tapAction:"layer_switch"!==c?m:void 0,holdAction:"tap_hold"===c?p:void 0,threshold:"tap_hold"===c?y:void 0,targetLayer:"layer_switch"===c?b:void 0}),a()},disabled:"simple"===c&&!m||"tap_hold"===c&&(!m||!p)||"layer_switch"===c&&!b,className:"px-6 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium",children:"Save Mapping"})]})]})})}function N({activeLayer:t,availableLayers:a,onLayerChange:s}){const[l,i]=r.useState(""),o=["base",...Array.from({length:10},(e,t)=>`md-${t.toString().padStart(2,"0")}`)];return e.jsx("div",{className:"p-4 bg-gradient-to-r from-red-900/20 to-red-800/20 rounded-lg border border-red-500/30",children:e.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[e.jsx("span",{className:"text-red-400 font-bold text-sm",children:"LAYERS:"}),o.map(a=>e.jsx("button",{onClick:()=>s(a),className:"px-4 py-2 rounded-md text-sm font-medium transition-all transform hover:scale-105 "+(t===a?"bg-red-500 text-white shadow-lg shadow-red-500/50":"bg-slate-800 text-slate-300 border border-red-500/50 hover:bg-slate-700 hover:border-red-400"),children:"base"===a?"Base Layer":a.toUpperCase()},a)),e.jsxs("form",{onSubmit:e=>{e.preventDefault();const t=parseInt(l,16);if(!isNaN(t)&&t>=0&&t<=255){const e=`md-${t.toString(16).padStart(2,"0")}`;s(e),i("")}},className:"flex items-center gap-2 ml-4",children:[e.jsx("label",{htmlFor:"custom-layer",className:"text-red-400 text-sm",children:"MD_"}),e.jsx("input",{id:"custom-layer",type:"text",value:l,onChange:e=>i(e.target.value.toUpperCase()),placeholder:"00-FF",maxLength:2,className:"w-16 px-2 py-1 bg-slate-800 border border-red-500/50 rounded text-white text-sm font-mono text-center focus:outline-none focus:ring-2 focus:ring-red-500"}),e.jsx("button",{type:"submit",className:"px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-500 transition-colors",children:"Go"})]}),"base"!==t&&!o.includes(t)&&e.jsxs("div",{className:"ml-2 px-3 py-1 bg-red-500/20 border border-red-500 rounded text-red-300 text-sm",children:["Current: ",t.toUpperCase()]})]})})}function w(e){try{const t=e.split("\n"),a={imports:[],globalMappings:[],deviceBlocks:[],comments:[]};let r=null,s=null,l=0;for(const e of t){l++;const t=e.trim();if(!t)continue;const i=t.match(/^\/\/(.*)$/);if(i){a.comments.push({text:i[1].trim(),line:l,type:"line"});continue}const o=t.match(/^\/\*(.*)\*\/$/);if(o){a.comments.push({text:o[1].trim(),line:l,type:"block"});continue}const n=t.match(/^import\s+"([^"]+)"(?:\s+as\s+(\w+))?/);if(n){a.imports.push({path:n[1],alias:n[2],line:l});continue}const c=t.match(/^device_start\s*\(\s*"([^"]+)"\s*\)/);if(c){if(r)return{success:!1,error:{message:"Nested device blocks are not allowed",line:l,column:0,suggestion:"Close previous device block with device_end() before starting a new one"}};r={pattern:c[1],mappings:[],layers:[],startLine:l,endLine:-1};continue}if(t.match(/^device_end\s*\(\s*\)/)){if(!r)return{success:!1,error:{message:"device_end() without matching device_start()",line:l,column:0,suggestion:'Add device_start("pattern") before device_end()'}};r.endLine=l,a.deviceBlocks.push(r),r=null;continue}const d=t.match(/^when_start\s*\(\s*(?:"([^"]+)"|\[([^\]]+)\])\s*\)/);if(d){if(s)return{success:!1,error:{message:"Nested when blocks are not allowed",line:l,column:0,suggestion:"Close previous when block with when_end() before starting a new one"}};let e;e=d[1]?d[1]:d[2].split(",").map(e=>e.trim().replace(/["']/g,"")),s={modifiers:e,mappings:[],startLine:l,endLine:-1};continue}if(t.match(/^when_end\s*\(\s*\)/)){if(!s)return{success:!1,error:{message:"when_end() without matching when_start()",line:l,column:0,suggestion:'Add when_start("modifier") before when_end()'}};s.endLine=l,r&&r.layers.push(s),s=null;continue}const m=t.match(/^map\s*\(\s*"([^"]+)"\s*,\s*"?([^")]+)"?\s*\)/);if(m){const e={type:"simple",sourceKey:m[1],targetKey:m[2].replace(/"/g,""),line:l};s?s.mappings.push(e):r?r.mappings.push(e):a.globalMappings.push(e);continue}const u=t.match(/^tap_hold\s*\(\s*"([^"]+)"\s*,\s*"([^"]+)"\s*,\s*"([^"]+)"\s*,\s*(\d+)\s*\)/);if(u){const e={type:"tap_hold",sourceKey:u[1],line:l,tapHold:{tapAction:u[2],holdAction:u[3],thresholdMs:parseInt(u[4],10)}};s?s.mappings.push(e):r?r.mappings.push(e):a.globalMappings.push(e);continue}const p=t.match(/^map\s*\(\s*"([^"]+)"\s*,\s*(with_\w+\([^)]+\))\s*\)/);if(p){const e={type:"simple",sourceKey:p[1],targetKey:p[2],line:l};s?s.mappings.push(e):r?r.mappings.push(e):a.globalMappings.push(e);continue}}return r?{success:!1,error:{message:"Unclosed device block",line:r.startLine,column:0,suggestion:"Add device_end() to close the device block"}}:s?{success:!1,error:{message:"Unclosed when block",line:s.startLine,column:0,suggestion:"Add when_end() to close the when block"}}:{success:!0,ast:a}}catch(t){return{success:!1,error:{message:t instanceof Error?t.message:"Unknown parse error",line:0,column:0,suggestion:"Check script syntax and try again"}}}}const L={indentSize:4,maxLineLength:100,blankLinesBetweenDevices:1,blankLinesBetweenSections:2};function S(e){return e.alias?`import "${e.path}" as ${e.alias};`:`import "${e.path}";`}function C(e){return"block"===e.type?`/* ${e.text} */`:`// ${e.text}`}function M(e,t=[],a){const r={...L,...a},s=[],l=" ".repeat(r.indentSize),i=A(t,e.startLine-5,e.startLine);for(const o of i)s.push(C(o));s.push(`device_start("${e.pattern}");`);for(const o of e.mappings)s.push(l+K(o,1));for(const o of e.layers)s.push(...D(o,1,r));return s.push("device_end();"),s}function D(e,t,a){const r=[],s=" ".repeat(t*a.indentSize),l=" ".repeat((t+1)*a.indentSize);let i;i=Array.isArray(e.modifiers)?`[${e.modifiers.map(e=>`"${e}"`).join(", ")}]`:`"${e.modifiers}"`,r.push(`${s}when_start(${i});`);for(const o of e.mappings)r.push(l+K(o,t+1));return r.push(`${s}when_end();`),r}function K(e,t=0,a){switch(e.type){case"simple":return function(e){if(!e.targetKey)throw new Error(`Simple mapping missing targetKey at line ${e.line}`);return e.targetKey.startsWith("with_")?`map("${e.sourceKey}", ${e.targetKey});`:`map("${e.sourceKey}", "${e.targetKey}");`}(e);case"tap_hold":return function(e){if(!e.tapHold)throw new Error(`Tap-hold mapping missing tapHold config at line ${e.line}`);const{tapAction:t,holdAction:a,thresholdMs:r}=e.tapHold;return`tap_hold("${e.sourceKey}", "${t}", "${a}", ${r});`}(e);case"macro":return function(e){if(!e.macro)throw new Error(`Macro mapping missing macro config at line ${e.line}`);const{keys:t,delayMs:a}=e.macro,r=t.map(e=>`"${e}"`).join(", ");return void 0!==a?`macro("${e.sourceKey}", [${r}], ${a});`:`macro("${e.sourceKey}", [${r}]);`}(e);case"layer_switch":return function(e){if(!e.layerSwitch)throw new Error(`Layer switch mapping missing layerSwitch config at line ${e.line}`);const{layerId:t,mode:a}=e.layerSwitch;return a?`layer_switch("${e.sourceKey}", "${t}", "${a}");`:`layer_switch("${e.sourceKey}", "${t}");`}(e);default:return`// Unknown mapping type: ${e.type}`}}function A(e,t,a){return e.filter(e=>e.line>=t&&e.line<a)}const $=({profileName:t})=>{const[a]=s(),n=l(),{name:b}=i(),x=a.get("profile"),f=t||b||x||"Default",[v,D]=r.useState(f),$=c(),[E,F]=r.useState("visual"),B=function(e){const{storageKey:t,debounceMs:a=500,enablePersistence:s=!0,onStateChange:l,onError:i}=e,[o,n]=r.useState("idle"),[c,d]=r.useState("none"),[m,u]=r.useState(null),[p,g]=r.useState(null),y=r.useRef(""),h=r.useRef(null),b=r.useRef(null),x=r.useRef(!0),f=r.useRef(!1),v=r.useCallback(e=>{n(e),l?.(e)},[l]);r.useEffect(()=>{if(s)try{const e=localStorage.getItem(`rhai-sync-${t}`);if(e){const{code:a,timestamp:r}=JSON.parse(e);if(Date.now()-r<864e5){y.current=a;const e=w(a);e.success&&e.ast&&(h.current=e.ast,g(e.ast))}else localStorage.removeItem(`rhai-sync-${t}`)}}catch(e){}},[t,s]);const k=r.useCallback(e=>{if(s)try{localStorage.setItem(`rhai-sync-${t}`,JSON.stringify({code:e,timestamp:Date.now()}))}catch(a){}},[t,s]);r.useEffect(()=>()=>{x.current=!1,b.current&&clearTimeout(b.current)},[]);const _=r.useCallback(e=>{x.current&&!f.current&&(f.current=!0,v("parsing"),d("code-to-visual"),setTimeout(()=>{if(!x.current)return;const t=w(e);t.success&&t.ast?(h.current=t.ast,g(t.ast),u(null),v("idle"),d("none")):t.error&&(u(t.error),v("error"),i?.(t.error,"code-to-visual")),f.current=!1},10))},[v,i]),j=r.useCallback(e=>{x.current&&!f.current&&(f.current=!0,v("generating"),d("visual-to-code"),setTimeout(()=>{if(x.current){try{const t=function(e,t){const a={...L,...t},r=[];if(e.imports.length>0){for(const t of e.imports)r.push(S(t));for(let e=0;e<a.blankLinesBetweenSections;e++)r.push("")}if(e.globalMappings.length>0){const t=A(e.comments,0,function(e){return 0===e.deviceBlocks.length?Number.MAX_SAFE_INTEGER:e.deviceBlocks[0].startLine}(e));for(const e of t)r.push(C(e));for(const a of e.globalMappings)r.push(K(a,0));if(e.deviceBlocks.length>0)for(let e=0;e<a.blankLinesBetweenSections;e++)r.push("")}for(let s=0;s<e.deviceBlocks.length;s++){const t=e.deviceBlocks[s];if(r.push(...M(t,e.comments,a)),s<e.deviceBlocks.length-1)for(let e=0;e<a.blankLinesBetweenDevices;e++)r.push("")}return r.join("\n")}(e);y.current=t,h.current=e,g(e),k(t),u(null),v("idle"),d("none")}catch(t){const e={line:0,column:0,message:t instanceof Error?t.message:"Code generation failed",suggestion:"Check visual editor state for invalid mappings"};u(e),v("error"),i?.(e,"visual-to-code")}f.current=!1}},10))},[v,i,k]);return{state:o,direction:c,error:m,lastValidAST:p,onCodeChange:r.useCallback(e=>{x.current&&(y.current=e,k(e),b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{_(e)},a))},[a,_,k]),onVisualChange:r.useCallback(e=>{x.current&&j(e)},[j]),getCode:r.useCallback(()=>y.current,[]),getAST:r.useCallback(()=>h.current,[]),clearError:r.useCallback(()=>{u(null),v("idle"),d("none")},[v]),forceSync:r.useCallback(e=>{"code-to-visual"===e?_(y.current):"visual-to-code"===e&&h.current&&j(h.current)},[_,j])}}({storageKey:`profile-${v}`,debounceMs:500,onStateChange:e=>{},onError:(e,t)=>{}}),{data:R,isLoading:T}=p(),{mutateAsync:H}=g(),[P,I]=r.useState(null),[U,G]=r.useState(null),[O,W]=r.useState(new Map),[z,V]=r.useState([]),[J,Q]=r.useState(!0),[X,Y]=r.useState("base"),[q,Z]=r.useState(!1),{data:ee,isLoading:te,error:ae}=d(v),{mutateAsync:re}=m(),{data:se}=y(),[le,ie]=r.useState([]);r.useEffect(()=>{R&&R.length>0&&!R.some(e=>e.name===v)&&D(R[0].name)},[R,v]);const oe=R?.some(e=>e.name===v),ne=!te&&!ae&&ee?.source,ce=!te&&!ae&&oe&&!ee?.source;r.useEffect(()=>{if(ee?.source)B.onCodeChange(ee.source);else if(ce){const e=`// Configuration for profile: ${v}\n// This is a new configuration file\n\n// Example: Simple key remapping\n// map("A", "B");  // Press A â†’ outputs B\n\n// Example: Tap/Hold behavior\n// tap_hold("CapsLock", "Escape", "LCtrl", 200);\n\n// Add your key mappings here...\n`;B.onCodeChange(e)}},[ee,ce,v]),r.useEffect(()=>{const e=B.getAST();if(!e)return void ie(se?.map(e=>({id:e.id,name:e.name,serial:e.serial||void 0,connected:!0}))||[]);const t=function(e){return e.deviceBlocks.map(e=>e.pattern)}(e),a=new Map;se?.forEach(e=>{e.serial&&a.set(e.serial,e),a.set(e.name,e),a.set(e.id,e)});const r=[],s=new Set;if(t.forEach(e=>{if(s.has(e))return;s.add(e);const t=a.get(e);t?r.push({id:t.id,name:t.name,serial:t.serial||void 0,connected:!0}):r.push({id:`disconnected-${e}`,name:e,serial:e,connected:!1})}),se?.forEach(e=>{t.includes(e.serial||"")||t.includes(e.name)||t.includes(e.id)||r.push({id:e.id,name:e.name,serial:e.serial||void 0,connected:!0})}),ie(r),function(e){return e.globalMappings.length>0}(e)&&Q(!0),t.length>0){const e=r.filter(e=>{const a=e.serial||e.name;return t.includes(a)}).map(e=>e.id);e.length>0&&V(e)}},[B.state,se]),r.useEffect(()=>{if("visual"!==E||"idle"!==B.state)return;const e=B.getAST();if(!e)return;const t=e=>{const t={type:e.type};return"simple"===e.type&&e.targetKey?t.tapAction=e.targetKey:"tap_hold"===e.type&&e.tapHold?(t.tapAction=e.tapHold.tapAction,t.holdAction=e.tapHold.holdAction,t.threshold=e.tapHold.thresholdMs):"macro"===e.type&&e.macro?t.macroSteps=e.macro.keys.map(e=>({type:"press",key:e})):"layer_switch"===e.type&&e.layerSwitch&&(t.targetLayer=e.layerSwitch.layerId),t},a=new Map;J&&e.globalMappings.forEach(e=>{a.set(e.sourceKey,t(e))}),z.length>0&&se&&e.deviceBlocks.forEach(e=>{se.some(t=>{const a=z.includes(t.id),r=e.pattern===t.serial||e.pattern===t.name||e.pattern===t.id;return a&&r})&&e.mappings.forEach(e=>{a.set(e.sourceKey,t(e))})}),W(a)},[E,B.state,J,z,se]);const de=e=>{G(e),Z(!0)},me=le;return e.jsxs("div",{className:"flex flex-col gap-4 md:gap-6 p-4 md:p-6 lg:p-8",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-100 mb-3",children:"Configuration Editor"}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("label",{htmlFor:"profile-selector",className:"text-sm font-medium text-slate-300",children:"Profile:"}),e.jsx("select",{id:"profile-selector",value:v,onChange:e=>{return t=e.target.value,D(t),void n(`/config?profile=${t}`);var t},disabled:T||!$.isConnected,className:"px-4 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 font-medium focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50",children:R?.map(t=>e.jsx("option",{value:t.name,children:t.name},t.name))}),!$.isConnected&&e.jsx("span",{className:"text-xs px-2 py-1 bg-yellow-900/30 border border-yellow-500 text-yellow-400 rounded",children:"âš ï¸ Disconnected"}),te&&$.isConnected&&e.jsx("span",{className:"text-xs px-2 py-1 bg-blue-900/30 border border-blue-500 text-blue-400 rounded",children:"â³ Loading configuration..."}),ne&&e.jsx("span",{className:"text-xs px-2 py-1 bg-green-900/30 border border-green-500 text-green-400 rounded",children:"âœ… Loaded"}),ce&&e.jsx("span",{className:"text-xs px-2 py-1 bg-orange-900/30 border border-orange-500 text-orange-400 rounded",children:"ðŸ“ New configuration"}),ae&&e.jsx("span",{className:"text-xs px-2 py-1 bg-red-900/30 border border-red-500 text-red-400 rounded",children:"âŒ Error"}),!oe&&!te&&$.isConnected&&e.jsx("span",{className:"text-xs px-2 py-1 bg-orange-900/30 border border-orange-500 text-orange-400 rounded",children:"âš ï¸ Profile not found"})]}),!oe&&!te&&$.isConnected&&e.jsxs("div",{className:"mt-3 p-3 bg-orange-900/20 border border-orange-500 rounded-md",children:[e.jsxs("p",{className:"text-sm text-orange-300 mb-2",children:['Profile "',v,'" does not exist.']}),e.jsxs("button",{onClick:async()=>{try{await H({name:v,template:"blank"})}catch(e){}},className:"px-4 py-1.5 bg-orange-600 hover:bg-orange-500 text-white text-sm font-medium rounded transition-colors",children:['Create Profile "',v,'"']})]}),ce&&e.jsx("div",{className:"mt-3 p-3 bg-blue-900/20 border border-blue-500 rounded-md",children:e.jsxs("p",{className:"text-sm text-blue-300",children:['ðŸ“ No configuration file found for "',v,'". A template has been loaded - click ',e.jsx("strong",{children:"Save Configuration"})," to create it."]})}),ae&&e.jsx("div",{className:"mt-3 p-3 bg-red-900/20 border border-red-500 rounded-md",children:e.jsx("p",{className:"text-sm text-red-300",children:ae instanceof Error?ae.message:"Failed to load configuration"})})]}),e.jsx("button",{onClick:async()=>{try{await re({name:v,source:B.getCode()})}catch(e){}},disabled:!$.isConnected||!oe,className:"px-6 py-3 bg-primary-500 text-white font-medium rounded-md hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:ce?"Create Configuration":"Save Configuration"})]}),e.jsxs("div",{className:"flex gap-2 border-b border-slate-700",children:[e.jsx("button",{onClick:()=>F("visual"),className:"px-4 py-2 font-medium transition-colors "+("visual"===E?"text-primary-400 border-b-2 border-primary-400":"text-slate-400 hover:text-slate-300"),children:"Visual Editor"}),e.jsx("button",{onClick:()=>F("code"),className:"px-4 py-2 font-medium transition-colors "+("code"===E?"text-primary-400 border-b-2 border-primary-400":"text-slate-400 hover:text-slate-300"),children:"Code Editor"})]}),"visual"===E?e.jsxs(e.Fragment,{children:[e.jsx(_,{devices:me,selectedDevices:z,globalSelected:J,onSelectionChange:(e,t)=>{V(e),Q(t)}}),J&&e.jsxs(o,{className:"bg-gradient-to-br from-slate-800 to-slate-900",children:[e.jsx("h3",{className:"text-xl font-bold text-primary-400 mb-4",children:"Global Keyboard (All Devices)"}),e.jsx("div",{className:"flex justify-center p-4",children:e.jsx(u,{layout:"ANSI_104",keyMappings:O,onKeyClick:de,simulatorMode:!1})}),e.jsx("p",{className:"text-center text-sm text-slate-400 mt-4",children:"Click any key to configure global mappings"})]}),z.length>0&&me.filter(e=>z.includes(e.id)).map(t=>e.jsxs(o,{className:"bg-gradient-to-br from-slate-800 to-slate-900",children:[e.jsxs("h3",{className:"text-xl font-bold text-primary-400 mb-4",children:[t.name,t.serial&&e.jsxs("span",{className:"ml-2 text-sm text-slate-400 font-normal",children:["(",t.serial,")"]})]}),e.jsx("div",{className:"flex justify-center p-4",children:e.jsx(u,{layout:"ANSI_104",keyMappings:O,onKeyClick:de,simulatorMode:!1})}),e.jsxs("p",{className:"text-center text-sm text-slate-400 mt-4",children:["Click any key to configure device-specific mappings for ",t.name]})]},t.id)),!J&&0===z.length&&e.jsx(o,{className:"bg-yellow-900/20 border border-yellow-700/50",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-yellow-200 text-lg mb-2",children:"âš ï¸ No devices selected"}),e.jsx("p",{className:"text-yellow-300 text-sm",children:'Select at least one device or "Global" to configure key mappings'})]})}),e.jsx(N,{activeLayer:X,availableLayers:["base","md-00","md-01","md-02","md-03","md-04","md-05"],onLayerChange:Y}),e.jsxs("div",{className:"flex gap-4 flex-wrap text-xs text-slate-400 px-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 rounded bg-green-500"}),e.jsx("span",{children:"Simple"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 rounded bg-primary-500"}),e.jsx("span",{children:"Modifier"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 rounded bg-purple-500"}),e.jsx("span",{children:"Lock"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 rounded bg-red-500"}),e.jsx("span",{children:"Tap/Hold"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 rounded bg-yellow-500"}),e.jsx("span",{children:"Layer Active"})]})]}),e.jsx(o,{children:e.jsx(k,{onKeySelect:I,selectedKey:P})}),q&&U&&e.jsx(j,{isOpen:q,onClose:()=>Z(!1),physicalKey:U,currentMapping:O.get(U),onSave:e=>{if(U){const t=new Map(O);t.set(U,e),W(t);const a=e=>Array.from(e.entries()).map(([e,t])=>{const a={type:t.type,sourceKey:e,line:0};return"simple"===t.type&&t.tapAction?a.targetKey=t.tapAction:"tap_hold"===t.type&&t.tapAction&&t.holdAction?a.tapHold={tapAction:t.tapAction,holdAction:t.holdAction,thresholdMs:t.threshold||200}:"macro"===t.type&&t.macroSteps?a.macro={keys:t.macroSteps.filter(e=>e.key).map(e=>e.key),delayMs:t.macroSteps.find(e=>e.delayMs)?.delayMs}:"layer_switch"===t.type&&t.targetLayer&&(a.layerSwitch={layerId:t.targetLayer}),a}),r=z.map((e,r)=>{const s=me.find(t=>t.id===e);return s?{pattern:s.serial||s.name,mappings:a(t),layers:[],startLine:0,endLine:0}:null}).filter(e=>null!==e);B.onVisualChange({imports:[],globalMappings:J?a(t):[],deviceBlocks:r,comments:[]})}},availableKeys:[]})]}):e.jsxs("div",{className:"flex flex-col gap-4",children:["idle"!==B.state&&e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-slate-700 border border-slate-600 rounded-md",children:["parsing"===B.state&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-400"}),e.jsx("span",{className:"text-sm text-slate-300",children:"Parsing Rhai script..."})]}),"generating"===B.state&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-400"}),e.jsx("span",{className:"text-sm text-slate-300",children:"Generating code..."})]}),"syncing"===B.state&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-400"}),e.jsx("span",{className:"text-sm text-slate-300",children:"Syncing..."})]})]}),B.error&&e.jsx("div",{className:"p-4 bg-red-900/20 border border-red-500 rounded-md",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"text-red-400 text-xl",children:"âš ï¸"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-red-400 font-semibold mb-1",children:"Parse Error"}),e.jsxs("p",{className:"text-sm text-red-300 mb-2",children:["Line ",B.error.line,", Column ",B.error.column,": ",B.error.message]}),B.error.suggestion&&e.jsxs("p",{className:"text-sm text-slate-300 italic",children:["ðŸ’¡ ",B.error.suggestion]})]}),e.jsx("button",{onClick:()=>B.clearError(),className:"text-slate-400 hover:text-slate-300 transition-colors","aria-label":"Clear error",children:"âœ•"})]})}),e.jsx(o,{variant:"default",padding:"lg",children:e.jsx(h,{value:B.getCode(),onChange:e=>B.onCodeChange(e),height:"600px",language:"javascript"})})]})]})};export{$ as default};
//# sourceMappingURL=ConfigPage-HwjJatQj.js.map
