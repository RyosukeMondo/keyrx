{"version":3,"file":"DevicesPage-7N92zeJp.js","sources":["../../src/components/Dropdown.tsx","../../src/pages/DevicesPage.tsx","../../src/hooks/useUpdateDevice.ts","../../src/hooks/useAutoSave.ts"],"sourcesContent":["import React, { useState, useMemo, useRef, useEffect, useCallback } from 'react';\nimport { Listbox, Transition } from '@headlessui/react';\n\ninterface DropdownOption {\n  value: string;\n  label: string;\n}\n\ninterface DropdownProps {\n  options: DropdownOption[];\n  value: string;\n  onChange: (value: string) => void;\n  searchable?: boolean;\n  'aria-label': string;\n  disabled?: boolean;\n  placeholder?: string;\n  className?: string;\n}\n\nexport const Dropdown = React.memo<DropdownProps>(({\n  options,\n  value,\n  onChange,\n  searchable = false,\n  'aria-label': ariaLabel,\n  disabled = false,\n  placeholder = 'Select an option',\n  className = '',\n}) => {\n  const [searchTerm, setSearchTerm] = useState('');\n  const searchInputRef = useRef<HTMLInputElement>(null);\n  const openRef = useRef(false);\n\n  // Filter options based on search term\n  const filteredOptions = useMemo(() => {\n    if (!searchable || !searchTerm) {\n      return options;\n    }\n\n    const lowerSearchTerm = searchTerm.toLowerCase();\n    return options.filter((option) =>\n      option.label.toLowerCase().includes(lowerSearchTerm)\n    );\n  }, [options, searchTerm, searchable]);\n\n  // Find selected option label\n  const selectedOption = useMemo(\n    () => options.find((opt) => opt.value === value),\n    [options, value]\n  );\n\n  const handleOpenChange = useCallback((isOpen: boolean) => {\n    openRef.current = isOpen;\n\n    if (isOpen && searchable && searchInputRef.current) {\n      // Focus search input when dropdown opens\n      setTimeout(() => {\n        searchInputRef.current?.focus();\n      }, 0);\n    } else if (!isOpen) {\n      // Clear search when dropdown closes\n      setSearchTerm('');\n    }\n  }, [searchable]);\n\n  return (\n    <Listbox\n      value={value}\n      onChange={onChange}\n      disabled={disabled}\n      as=\"div\"\n      className={`relative ${className}`}\n    >\n      {({ open }) => {\n        // Track open state changes\n        if (open !== openRef.current) {\n          handleOpenChange(open);\n        }\n\n        return (\n          <>\n            <Listbox.Button\n              aria-label={ariaLabel}\n              className={`\n                relative w-full rounded-md border border-slate-600\n                bg-slate-700 py-3 px-4 text-left text-base\n                text-slate-100 transition-all duration-150\n                hover:border-slate-500 hover:bg-slate-600\n                focus:outline focus:outline-2 focus:outline-primary-500\n                focus:outline-offset-2\n                disabled:cursor-not-allowed disabled:opacity-50\n              `}\n            >\n              <span className=\"block truncate\">\n                {selectedOption?.label || placeholder}\n              </span>\n              <span className=\"pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3\">\n                <svg\n                  className={`h-5 w-5 text-slate-400 transition-transform duration-200 ${\n                    open ? 'rotate-180' : ''\n                  }`}\n                  fill=\"none\"\n                  viewBox=\"0 0 24 24\"\n                  stroke=\"currentColor\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M19 9l-7 7-7-7\"\n                  />\n                </svg>\n              </span>\n            </Listbox.Button>\n\n            <Transition\n              show={open}\n              enter=\"transition duration-150 ease-out\"\n              enterFrom=\"opacity-0 translate-y-[-10px]\"\n              enterTo=\"opacity-100 translate-y-0\"\n              leave=\"transition duration-100 ease-in\"\n              leaveFrom=\"opacity-100 translate-y-0\"\n              leaveTo=\"opacity-0 translate-y-[-10px]\"\n            >\n              <Listbox.Options\n                className={`\n                  absolute z-dropdown mt-2 max-h-60 w-full overflow-auto\n                  rounded-md border border-slate-600 bg-slate-800\n                  py-1 shadow-lg focus:outline-none\n                `}\n              >\n                {searchable && (\n                  <div className=\"sticky top-0 z-10 border-b border-slate-600 bg-slate-800 p-2\">\n                    <input\n                      ref={searchInputRef}\n                      type=\"text\"\n                      value={searchTerm}\n                      onChange={(e) => setSearchTerm(e.target.value)}\n                      placeholder=\"Search...\"\n                      className={`\n                        w-full rounded border border-slate-600 bg-slate-700\n                        px-3 py-2 text-sm text-slate-100\n                        placeholder-slate-400\n                        focus:border-primary-500 focus:outline-none\n                      `}\n                      onClick={(e) => e.stopPropagation()}\n                    />\n                  </div>\n                )}\n\n                {filteredOptions.length === 0 ? (\n                  <div className=\"py-2 px-3 text-sm text-slate-400\">\n                    No options found\n                  </div>\n                ) : (\n                  filteredOptions.map((option) => (\n                    <Listbox.Option\n                      key={option.value}\n                      value={option.value}\n                      className={({ active, selected }) =>\n                        `\n                          relative cursor-pointer select-none py-2 px-3\n                          text-base transition-colors duration-100\n                          ${active ? 'bg-primary-500 text-white' : 'text-slate-100'}\n                          ${selected ? 'font-semibold' : 'font-normal'}\n                        `\n                      }\n                    >\n                      {({ selected }) => (\n                        <>\n                          <span className=\"block truncate\">{option.label}</span>\n                          {selected && (\n                            <span className=\"absolute inset-y-0 right-0 flex items-center pr-3 text-primary-500\">\n                              <svg\n                                className=\"h-5 w-5\"\n                                fill=\"currentColor\"\n                                viewBox=\"0 0 20 20\"\n                              >\n                                <path\n                                  fillRule=\"evenodd\"\n                                  d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\"\n                                  clipRule=\"evenodd\"\n                                />\n                              </svg>\n                            </span>\n                          )}\n                        </>\n                      )}\n                    </Listbox.Option>\n                  ))\n                )}\n              </Listbox.Options>\n            </Transition>\n          </>\n        );\n      }}\n    </Listbox>\n  );\n});\n\nDropdown.displayName = 'Dropdown';\n","import React, { useState } from 'react';\nimport { Card } from '../components/Card';\nimport { Button } from '../components/Button';\nimport { Input } from '../components/Input';\nimport { Dropdown } from '../components/Dropdown';\nimport { Modal } from '../components/Modal';\nimport { LoadingSkeleton } from '../components/LoadingSkeleton';\nimport { useAutoSave } from '../hooks/useAutoSave';\nimport { useUpdateDevice } from '../hooks/useUpdateDevice';\nimport { getErrorMessage } from '../utils/errorUtils';\n\ninterface Device {\n  id: string;\n  name: string;\n  identifier: string;\n  layout: string;\n  active: boolean;\n  vendorId?: string;\n  productId?: string;\n  serial?: string;\n  lastSeen?: string;\n}\n\ninterface ApiDevice {\n  id: string;\n  name: string;\n  path: string;\n  layout?: string;\n  active: boolean;\n  serial?: string;\n}\n\ninterface DevicesPageProps {\n  className?: string;\n}\n\nconst LAYOUT_OPTIONS = [\n  { value: 'ANSI_104', label: 'ANSI 104' },\n  { value: 'ISO_105', label: 'ISO 105' },\n  { value: 'JIS_109', label: 'JIS 109' },\n  { value: 'HHKB', label: 'HHKB' },\n  { value: 'NUMPAD', label: 'Numpad' },\n];\n\n/**\n * DeviceCard Component\n *\n * Individual device card with auto-save for layout changes.\n */\ninterface DeviceCardProps {\n  device: Device;\n  isEditing: boolean;\n  editingName: string;\n  nameError: string;\n  onRenameClick: (device: Device) => void;\n  onRenameCancel: () => void;\n  onRenameSave: (deviceId: string) => void;\n  onEditingNameChange: (value: string) => void;\n  onForgetClick: (deviceId: string) => void;\n}\n\nconst DeviceCard: React.FC<DeviceCardProps> = ({\n  device,\n  isEditing,\n  editingName,\n  nameError,\n  onRenameClick,\n  onRenameCancel,\n  onRenameSave,\n  onEditingNameChange,\n  onForgetClick,\n}) => {\n  // Local state for layout - tracks user's current selection\n  const [localLayout, setLocalLayout] = useState(device.layout);\n\n  // Track the server value to detect user changes vs external updates\n  const serverLayoutRef = React.useRef(device.layout);\n\n  // Track whether user has made a change that needs saving\n  const [hasUserChanges, setHasUserChanges] = useState(false);\n\n  // Device update mutation hook\n  const { mutate: updateDevice, isPending: isUpdating, error: updateError } = useUpdateDevice();\n\n  // Track last saved timestamp for feedback\n  const [lastSavedAt, setLastSavedAt] = useState<Date | null>(null);\n\n  // Save function - only called when user makes changes\n  const saveLayout = React.useCallback(async (layout: string) => {\n    await new Promise<void>((resolve, reject) => {\n      updateDevice(\n        { id: device.id, layout },\n        {\n          onSuccess: () => {\n            serverLayoutRef.current = layout; // Update server value after successful save\n            setLastSavedAt(new Date());\n            setHasUserChanges(false);\n            resolve();\n          },\n          onError: (error) => reject(error),\n        }\n      );\n    });\n  }, [device.id, updateDevice]);\n\n  // Auto-save hook - only enabled when user has made changes\n  const { isSaving: isSavingLayout, error: layoutSaveError } = useAutoSave(\n    localLayout,\n    {\n      saveFn: saveLayout,\n      debounceMs: 500,\n      enabled: hasUserChanges, // Only save when user changed the value\n    }\n  );\n\n  // Combine saving and error states\n  const isSaving = isSavingLayout || isUpdating;\n  const saveError = layoutSaveError || updateError;\n\n  // Update local state when device changes externally (e.g., from server refresh)\n  React.useEffect(() => {\n    // Only update if server value changed (external update, not our save)\n    if (device.layout !== serverLayoutRef.current) {\n      serverLayoutRef.current = device.layout;\n      setLocalLayout(device.layout);\n      setHasUserChanges(false); // External update, no user changes\n    }\n  }, [device.layout]);\n\n  const handleLayoutChange = (newLayout: string) => {\n    setLocalLayout(newLayout);\n    // Mark as user change only if different from server value\n    if (newLayout !== serverLayoutRef.current) {\n      setHasUserChanges(true);\n    }\n  };\n\n  return (\n    <Card key={device.id} variant=\"elevated\" className=\"bg-slate-800\" data-testid=\"device-card\">\n      <div className=\"flex flex-col gap-md\">\n        {/* Device header */}\n        <div className=\"flex items-start justify-between\">\n          <div className=\"flex items-center gap-sm\">\n            <span className=\"text-xl\" role=\"img\" aria-label=\"Keyboard\">\n              ðŸ–®\n            </span>\n            <div className=\"flex flex-col\">\n              <div className=\"flex items-center gap-sm\">\n                <span className=\"text-base font-medium text-slate-100\">\n                  {device.name}\n                </span>\n                {device.active && (\n                  <span\n                    className=\"text-xs text-green-500\"\n                    aria-label=\"Connected\"\n                  >\n                    âœ“ Connected\n                  </span>\n                )}\n              </div>\n              <span className=\"text-xs font-mono text-slate-500\">\n                {device.identifier}\n              </span>\n            </div>\n          </div>\n        </div>\n\n        {/* Rename section */}\n        <div className=\"flex flex-col gap-2\">\n          <label className=\"text-sm font-medium text-slate-300\">Name</label>\n          <div className=\"flex flex-col sm:flex-row items-start gap-2\">\n            {isEditing ? (\n              <>\n                <div className=\"flex-1 w-full\">\n                  <div\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter') {\n                        onRenameSave(device.id);\n                      } else if (e.key === 'Escape') {\n                        onRenameCancel();\n                      }\n                    }}\n                  >\n                    <Input\n                      type=\"text\"\n                      value={editingName}\n                      onChange={(value) => onEditingNameChange(value)}\n                      error={nameError}\n                      maxLength={64}\n                      aria-label=\"Device name\"\n                    />\n                  </div>\n                </div>\n                <div className=\"flex gap-2 w-full sm:w-auto\">\n                  <Button\n                    variant=\"primary\"\n                    size=\"sm\"\n                    onClick={() => onRenameSave(device.id)}\n                    aria-label=\"Save device name\"\n                    className=\"flex-1 sm:flex-none min-h-[44px] sm:min-h-0\"\n                  >\n                    Save\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={onRenameCancel}\n                    aria-label=\"Cancel rename\"\n                    className=\"flex-1 sm:flex-none min-h-[44px] sm:min-h-0\"\n                  >\n                    Cancel\n                  </Button>\n                </div>\n              </>\n            ) : (\n              <>\n                <div className=\"flex-1 w-full rounded-md border border-slate-700 bg-slate-900 px-4 py-3 text-sm text-slate-100\">\n                  {device.name}\n                </div>\n                <Button\n                  variant=\"secondary\"\n                  size=\"sm\"\n                  onClick={() => onRenameClick(device)}\n                  aria-label={`Rename device ${device.name}`}\n                  className=\"w-full sm:w-auto min-h-[44px] sm:min-h-0\"\n                >\n                  Rename\n                </Button>\n              </>\n            )}\n          </div>\n        </div>\n\n        {/* Layout selector with save feedback */}\n        <div className=\"flex flex-col gap-2\">\n          <div className=\"flex items-center justify-between\">\n            <label className=\"text-sm font-medium text-slate-300\">Layout</label>\n            <div className=\"flex items-center gap-2\">\n              {isSaving && (\n                <span className=\"text-xs text-slate-400 flex items-center gap-1\">\n                  <span className=\"animate-spin h-3 w-3 border-2 border-slate-400 border-t-transparent rounded-full\" />\n                  Saving...\n                </span>\n              )}\n              {!isSaving && lastSavedAt && (\n                <span className=\"text-xs text-green-500 flex items-center gap-1\">\n                  âœ“ Saved\n                </span>\n              )}\n              {saveError && (\n                <span className=\"text-xs text-red-500 flex items-center gap-1\" title={saveError instanceof Error ? saveError.message : String(saveError)}>\n                  âœ— Error\n                </span>\n              )}\n            </div>\n          </div>\n          <Dropdown\n            options={LAYOUT_OPTIONS}\n            value={localLayout}\n            onChange={handleLayoutChange}\n            aria-label=\"Select keyboard layout\"\n          />\n        </div>\n\n        {/* Device details */}\n        <div className=\"flex flex-wrap gap-md text-xs text-slate-400\">\n          {device.serial && <span>Serial: {device.serial}</span>}\n          {device.vendorId && <span>â€¢ Vendor: {device.vendorId}</span>}\n          {device.productId && <span>â€¢ Product: {device.productId}</span>}\n          {device.lastSeen && <span>â€¢ Last seen: {device.lastSeen}</span>}\n        </div>\n\n        {/* Forget device button */}\n        <div className=\"flex justify-end border-t border-slate-700 pt-md\">\n          <Button\n            variant=\"danger\"\n            size=\"sm\"\n            onClick={() => onForgetClick(device.id)}\n            aria-label={`Forget device ${device.name}`}\n          >\n            Forget Device\n          </Button>\n        </div>\n      </div>\n    </Card>\n  );\n};\n\n/**\n * DevicesPage Component\n *\n * Device management interface with:\n * - Global settings card with default layout selector\n * - Device list showing all connected keyboards\n * - Inline rename functionality (click Rename â†’ input â†’ Enter saves)\n * - Layout selector dropdown with auto-save\n * - Forget device with confirmation dialog\n *\n * Layout: From design.md Layout 2\n * Requirements: Req 5 (Device Management User Flows), Req 2 (Global Layout Selection)\n *\n * Note: Device scope (global vs device-specific) is now determined by the Rhai configuration,\n * not by a UI setting. See ConfigPage for device-aware editing.\n */\nexport const DevicesPage: React.FC<DevicesPageProps> = ({ className = '' }) => {\n  const [loading, setLoading] = useState(true);\n  const [devices, setDevices] = useState<Device[]>([]);\n  const [error, setError] = useState<string | null>(null);\n\n  // Global layout state\n  const [globalLayout, setGlobalLayout] = useState<string>('ANSI_104');\n  const [isSavingGlobalLayout, setIsSavingGlobalLayout] = useState(false);\n  const [globalLayoutError, setGlobalLayoutError] = useState<string | null>(null);\n  const [globalLayoutSavedAt, setGlobalLayoutSavedAt] = useState<Date | null>(null);\n\n  // Fetch devices and global layout from API on mount\n  React.useEffect(() => {\n    const fetchData = async () => {\n      try {\n        setLoading(true);\n        setError(null);\n\n        // Fetch devices\n        const devicesResponse = await fetch('/api/devices');\n        if (!devicesResponse.ok) {\n          throw new Error(`Failed to fetch devices: ${devicesResponse.statusText}`);\n        }\n        const devicesData = await devicesResponse.json();\n\n        // Transform API response to UI format\n        const transformedDevices: Device[] = (devicesData.devices || []).map((device: ApiDevice) => ({\n          id: device.id,\n          name: device.name,\n          identifier: device.path,\n          layout: device.layout || 'ANSI_104',\n          active: device.active,\n          vendorId: device.path.match(/VID_([0-9A-F]{4})/)?.[1],\n          productId: device.path.match(/PID_([0-9A-F]{4})/)?.[1],\n          serial: device.serial,\n          lastSeen: 'Just now',\n        }));\n\n        setDevices(transformedDevices);\n\n        // Fetch global layout (if endpoint exists)\n        try {\n          const layoutResponse = await fetch('/api/settings/global-layout');\n          if (layoutResponse.ok) {\n            const layoutData = await layoutResponse.json();\n            setGlobalLayout(layoutData.layout || 'ANSI_104');\n          }\n        } catch (layoutErr) {\n          // Endpoint may not exist yet, use default\n          // Silent fail - this is expected if backend hasn't implemented the endpoint yet\n        }\n      } catch (err) {\n        console.error('Failed to fetch data:', err);\n        setError(getErrorMessage(err, 'Failed to fetch data'));\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    fetchData();\n  }, []);\n\n  const [editingDeviceId, setEditingDeviceId] = useState<string | null>(null);\n  const [editingName, setEditingName] = useState('');\n  const [nameError, setNameError] = useState('');\n  const [forgetDeviceId, setForgetDeviceId] = useState<string | null>(null);\n\n  const handleRenameClick = (device: Device) => {\n    setEditingDeviceId(device.id);\n    setEditingName(device.name);\n    setNameError('');\n  };\n\n  const handleRenameCancel = () => {\n    setEditingDeviceId(null);\n    setEditingName('');\n    setNameError('');\n  };\n\n  const handleRenameSave = (deviceId: string) => {\n    // Validate name\n    if (!editingName.trim()) {\n      setNameError('Device name cannot be empty');\n      return;\n    }\n\n    if (editingName.length > 64) {\n      setNameError('Device name cannot exceed 64 characters');\n      return;\n    }\n\n    // Save the new name\n    setDevices((prev) =>\n      prev.map((d) => (d.id === deviceId ? { ...d, name: editingName } : d))\n    );\n\n    // Reset editing state\n    setEditingDeviceId(null);\n    setEditingName('');\n    setNameError('');\n  };\n\n\n  const handleGlobalLayoutChange = async (newLayout: string) => {\n    setGlobalLayout(newLayout);\n    setIsSavingGlobalLayout(true);\n    setGlobalLayoutError(null);\n\n    try {\n      const response = await fetch('/api/settings/global-layout', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ layout: newLayout }),\n      });\n\n      if (!response.ok) {\n        throw new Error(`Failed to save global layout: ${response.statusText}`);\n      }\n\n      setGlobalLayoutSavedAt(new Date());\n\n      // Auto-clear success indicator after 3 seconds\n      setTimeout(() => {\n        setGlobalLayoutSavedAt(null);\n      }, 3000);\n    } catch (err) {\n      console.error('Failed to save global layout:', err);\n      setGlobalLayoutError(getErrorMessage(err, 'Failed to save global layout'));\n    } finally {\n      setIsSavingGlobalLayout(false);\n    }\n  };\n\n  const handleForgetDevice = () => {\n    if (forgetDeviceId) {\n      setDevices((prev) => prev.filter((d) => d.id !== forgetDeviceId));\n      setForgetDeviceId(null);\n    }\n  };\n\n  const forgetDevice = devices.find((d) => d.id === forgetDeviceId);\n\n  if (loading) {\n    return (\n      <div className={`flex flex-col gap-4 md:gap-6 p-4 md:p-6 lg:p-8 ${className}`}>\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n          <LoadingSkeleton variant=\"text\" width=\"150px\" height=\"32px\" />\n          <LoadingSkeleton variant=\"rectangular\" width=\"100px\" height=\"36px\" />\n        </div>\n\n        <Card>\n          <div className=\"flex flex-col gap-md\">\n            <LoadingSkeleton variant=\"text\" width=\"200px\" height=\"24px\" />\n            <div className=\"flex flex-col gap-md\">\n              <LoadingSkeleton variant=\"rectangular\" height=\"120px\" />\n              <LoadingSkeleton variant=\"rectangular\" height=\"120px\" />\n            </div>\n          </div>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className={`flex flex-col gap-4 md:gap-6 p-4 md:p-6 lg:p-8 ${className}`}>\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n        <h1 className=\"text-xl md:text-2xl lg:text-3xl font-semibold text-slate-100\">\n          Devices\n        </h1>\n        <div className=\"flex gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => {\n              window.location.reload();\n            }}\n            aria-label=\"Refresh device list\"\n            disabled={loading}\n          >\n            Refresh\n          </Button>\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"bg-red-900/20 border border-red-700 rounded-lg p-4\">\n          <p className=\"text-sm text-red-400\">{error}</p>\n        </div>\n      )}\n\n      {/* Global Settings Card */}\n      <Card variant=\"elevated\" className=\"bg-slate-800\">\n        <div className=\"flex flex-col gap-md\">\n          <div className=\"flex items-center justify-between\">\n            <h2 className=\"text-lg font-semibold text-slate-100\">Global Settings</h2>\n            {isSavingGlobalLayout && (\n              <span className=\"text-xs text-slate-400 flex items-center gap-1\">\n                <span className=\"animate-spin h-3 w-3 border-2 border-slate-400 border-t-transparent rounded-full\" />\n                Saving...\n              </span>\n            )}\n            {!isSavingGlobalLayout && globalLayoutSavedAt && (\n              <span className=\"text-xs text-green-500 flex items-center gap-1\">\n                âœ“ Saved\n              </span>\n            )}\n            {globalLayoutError && (\n              <span className=\"text-xs text-red-500 flex items-center gap-1\" title={globalLayoutError}>\n                âœ— Error\n              </span>\n            )}\n          </div>\n\n          <div className=\"flex flex-col gap-sm\">\n            <label className=\"text-sm font-medium text-slate-300\">\n              Default Keyboard Layout\n            </label>\n            <p className=\"text-xs text-slate-400\">\n              New devices will inherit this layout by default. You can override it for specific devices below.\n            </p>\n            <Dropdown\n              options={LAYOUT_OPTIONS}\n              value={globalLayout}\n              onChange={handleGlobalLayoutChange}\n              aria-label=\"Select default keyboard layout\"\n            />\n          </div>\n\n          {globalLayoutError && (\n            <div className=\"bg-red-900/20 border border-red-700 rounded-lg p-3\">\n              <p className=\"text-xs text-red-400\">{globalLayoutError}</p>\n            </div>\n          )}\n        </div>\n      </Card>\n\n      <Card>\n        <div className=\"flex flex-col gap-md\">\n          <h2 className=\"text-lg font-semibold text-slate-100\">\n            Device List ({devices.length} connected)\n          </h2>\n\n          {devices.length === 0 ? (\n            <div className=\"py-xl text-center\">\n              <p className=\"text-sm text-slate-400\">\n                No devices connected. Connect a keyboard to get started.\n              </p>\n            </div>\n          ) : (\n            <div className=\"flex flex-col gap-md\">\n              {devices.map((device) => {\n                const isEditing = editingDeviceId === device.id;\n\n                return (\n                  <DeviceCard\n                    key={device.id}\n                    device={device}\n                    isEditing={isEditing}\n                    editingName={editingName}\n                    nameError={nameError}\n                    onRenameClick={handleRenameClick}\n                    onRenameCancel={handleRenameCancel}\n                    onRenameSave={handleRenameSave}\n                    onEditingNameChange={setEditingName}\n                    onForgetClick={setForgetDeviceId}\n                  />\n                );\n              })}\n            </div>\n          )}\n        </div>\n      </Card>\n\n      {/* Forget device confirmation modal */}\n      <Modal\n        open={forgetDeviceId !== null}\n        onClose={() => setForgetDeviceId(null)}\n        title=\"Forget Device\"\n      >\n        <div className=\"flex flex-col gap-lg\">\n          <p className=\"text-sm text-slate-300\">\n            Are you sure you want to forget device{' '}\n            <span className=\"font-semibold text-slate-100\">{forgetDevice?.name}</span>?\n          </p>\n          <p className=\"text-sm text-slate-400\">\n            This will remove all device-specific configuration and mappings. This action cannot be\n            undone.\n          </p>\n          <div className=\"flex justify-end gap-sm\">\n            <Button\n              variant=\"ghost\"\n              size=\"md\"\n              onClick={() => setForgetDeviceId(null)}\n              aria-label=\"Cancel forget device\"\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"danger\"\n              size=\"md\"\n              onClick={handleForgetDevice}\n              aria-label=\"Confirm forget device\"\n            >\n              Forget Device\n            </Button>\n          </div>\n        </div>\n      </Modal>\n    </div>\n  );\n};\n\nexport default DevicesPage;\n","/**\n * useUpdateDevice - React hook for updating device configuration\n *\n * This hook provides a unified mutation for updating device layout and scope settings.\n * It replaces separate PUT endpoints with a single PATCH endpoint for atomic updates.\n *\n * Features:\n * - PATCH /api/devices/:id for unified config updates\n * - Optimistic updates with rollback on error\n * - Automatic cache invalidation on success\n * - Loading and error state management\n *\n * @example\n * ```tsx\n * function DeviceSettings() {\n *   const { mutate: updateDevice, isPending } = useUpdateDevice();\n *\n *   const handleLayoutChange = (layout: string) => {\n *     updateDevice({ id: deviceId, layout });\n *   };\n *\n *   const handleScopeChange = (scope: DeviceScope) => {\n *     updateDevice({ id: deviceId, scope });\n *   };\n * }\n * ```\n */\n\nimport { useMutation, useQueryClient } from '@tanstack/react-query';\nimport { queryKeys } from '../lib/queryClient';\nimport { apiClient } from '../api/client';\nimport type { DeviceEntry, DeviceScope } from '../types';\n\n/**\n * Request body for PATCH /api/devices/:id\n * Both fields are optional - send only what needs updating\n */\ninterface UpdateDeviceRequest {\n  layout?: string | null;\n  scope?: DeviceScope | null;\n}\n\n/**\n * Mutation variables for the hook\n */\ninterface UpdateDeviceVariables {\n  id: string;\n  layout?: string | null;\n  scope?: DeviceScope | null;\n}\n\n/**\n * Backend response (currently not used, but follows existing patterns)\n */\ninterface DeviceResponse {\n  success: boolean;\n}\n\n/**\n * Update device configuration (layout, scope, or both)\n *\n * Uses React Query mutation with optimistic updates for instant UI feedback.\n * Automatically invalidates device cache on success to ensure consistency.\n *\n * @returns Mutation object with:\n *   - mutate/mutateAsync: Update function (accepts { id, layout?, scope? })\n *   - isPending: Loading state\n *   - isError: Error state\n *   - error: Error details if mutation failed\n */\nexport function useUpdateDevice() {\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async ({ id, layout, scope }: UpdateDeviceVariables) => {\n      const request: UpdateDeviceRequest = {};\n\n      // Only include fields that are provided\n      if (layout !== undefined) {\n        request.layout = layout;\n      }\n      if (scope !== undefined) {\n        request.scope = scope;\n      }\n\n      return apiClient.patch<DeviceResponse>(`/api/devices/${id}`, request);\n    },\n\n    // Optimistic update: immediately update cache before API call\n    onMutate: async ({ id, layout, scope }) => {\n      // Cancel outgoing queries to avoid overwriting optimistic update\n      await queryClient.cancelQueries({ queryKey: queryKeys.devices });\n\n      // Snapshot previous value for rollback\n      const previousDevices = queryClient.getQueryData<DeviceEntry[]>(\n        queryKeys.devices\n      );\n\n      // Optimistically update cache\n      queryClient.setQueryData<DeviceEntry[]>(queryKeys.devices, (old) =>\n        old?.map((device) => {\n          if (device.id !== id) return device;\n\n          // Update only the fields that were provided\n          const updated = { ...device };\n          if (layout !== undefined) {\n            updated.layout = layout;\n          }\n          if (scope !== undefined) {\n            updated.scope = scope;\n          }\n          return updated;\n        })\n      );\n\n      // Return context for rollback\n      return { previousDevices };\n    },\n\n    // Rollback on error\n    onError: (_error, _variables, context) => {\n      if (context?.previousDevices) {\n        queryClient.setQueryData(queryKeys.devices, context.previousDevices);\n      }\n    },\n\n    // Refetch on success to ensure data consistency\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: queryKeys.devices });\n    },\n  });\n}\n","import { useEffect, useRef, useState, useCallback } from 'react';\n\nexport interface UseAutoSaveOptions<T> {\n  /** Function to save the data */\n  saveFn: (data: T) => Promise<void>;\n  /** Debounce delay in milliseconds (default: 500) */\n  debounceMs?: number;\n  /** Maximum retry attempts on failure (default: 3) */\n  maxRetries?: number;\n  /** Initial retry delay in milliseconds (default: 1000) */\n  retryDelayMs?: number;\n  /** Whether auto-save is enabled (default: true) */\n  enabled?: boolean;\n}\n\nexport interface UseAutoSaveResult {\n  /** Whether a save operation is in progress */\n  isSaving: boolean;\n  /** Error from the last save attempt, if any */\n  error: Error | null;\n  /** Timestamp of the last successful save */\n  lastSavedAt: Date | null;\n  /** Trigger a save immediately without debouncing */\n  saveNow: () => void;\n  /** Clear the error state */\n  clearError: () => void;\n}\n\n/**\n * Generic auto-save hook with debouncing and retry logic.\n *\n * @example\n * ```tsx\n * const { isSaving, error, lastSavedAt } = useAutoSave(\n *   layoutName,\n *   async (layout) => {\n *     await api.saveLayout(deviceId, layout);\n *   }\n * );\n * ```\n */\nexport function useAutoSave<T>(\n  data: T,\n  options: UseAutoSaveOptions<T>\n): UseAutoSaveResult {\n  const {\n    saveFn,\n    debounceMs = 500,\n    maxRetries = 3,\n    retryDelayMs = 1000,\n    enabled = true,\n  } = options;\n\n  const [isSaving, setIsSaving] = useState(false);\n  const [error, setError] = useState<Error | null>(null);\n  const [lastSavedAt, setLastSavedAt] = useState<Date | null>(null);\n\n  // Use refs to track pending operations and prevent stale closures\n  const debounceTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const retryTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const pendingDataRef = useRef<T>(data);\n  const isMountedRef = useRef(true);\n  const retryCountRef = useRef(0);\n\n  // Update pending data ref when data changes\n  useEffect(() => {\n    pendingDataRef.current = data;\n  }, [data]);\n\n  // Cleanup on unmount\n  useEffect(() => {\n    return () => {\n      isMountedRef.current = false;\n      if (debounceTimerRef.current) {\n        clearTimeout(debounceTimerRef.current);\n      }\n      if (retryTimerRef.current) {\n        clearTimeout(retryTimerRef.current);\n      }\n    };\n  }, []);\n\n  // Save function with retry logic\n  const executeSave = useCallback(async (dataToSave: T, retryCount: number = 0) => {\n    if (!isMountedRef.current) return;\n\n    try {\n      setIsSaving(true);\n      setError(null);\n\n      await saveFn(dataToSave);\n\n      if (!isMountedRef.current) return;\n\n      setLastSavedAt(new Date());\n      setIsSaving(false);\n      retryCountRef.current = 0;\n    } catch (err) {\n      if (!isMountedRef.current) return;\n\n      const error = err instanceof Error ? err : new Error(String(err));\n\n      // Don't retry on validation errors (4xx status codes)\n      const isValidationError =\n        error.message.includes('400') ||\n        error.message.includes('404') ||\n        error.message.includes('validation');\n\n      if (isValidationError || retryCount >= maxRetries) {\n        setError(error);\n        setIsSaving(false);\n        retryCountRef.current = 0;\n        return;\n      }\n\n      // Retry with exponential backoff\n      const delay = retryDelayMs * Math.pow(2, retryCount);\n      retryCountRef.current = retryCount + 1;\n\n      retryTimerRef.current = setTimeout(() => {\n        executeSave(dataToSave, retryCount + 1);\n      }, delay);\n    }\n  }, [saveFn, maxRetries, retryDelayMs]);\n\n  // Trigger save immediately without debouncing\n  const saveNow = useCallback(() => {\n    if (!enabled) return;\n\n    // Clear any pending debounced save\n    if (debounceTimerRef.current) {\n      clearTimeout(debounceTimerRef.current);\n      debounceTimerRef.current = null;\n    }\n\n    executeSave(pendingDataRef.current);\n  }, [enabled, executeSave]);\n\n  // Clear error state\n  const clearError = useCallback(() => {\n    setError(null);\n  }, []);\n\n  // Debounced auto-save effect\n  useEffect(() => {\n    if (!enabled) return;\n\n    // Clear existing debounce timer\n    if (debounceTimerRef.current) {\n      clearTimeout(debounceTimerRef.current);\n    }\n\n    // Set new debounce timer\n    debounceTimerRef.current = setTimeout(() => {\n      executeSave(data);\n    }, debounceMs);\n\n    // Cleanup function\n    return () => {\n      if (debounceTimerRef.current) {\n        clearTimeout(debounceTimerRef.current);\n      }\n    };\n  }, [data, debounceMs, enabled, executeSave]);\n\n  return {\n    isSaving,\n    error,\n    lastSavedAt,\n    saveNow,\n    clearError,\n  };\n}\n"],"names":["Dropdown","React","memo","options","value","onChange","searchable","ariaLabel","disabled","placeholder","className","searchTerm","setSearchTerm","useState","searchInputRef","useRef","openRef","filteredOptions","useMemo","lowerSearchTerm","toLowerCase","filter","option","label","includes","selectedOption","find","opt","handleOpenChange","useCallback","isOpen","current","setTimeout","focus","jsx","Listbox","as","children","open","jsxs","Fragment","Button","fill","viewBox","stroke","strokeLinecap","strokeLinejoin","strokeWidth","d","Transition","show","enter","enterFrom","enterTo","leave","leaveFrom","leaveTo","Options","ref","type","e","target","onClick","stopPropagation","length","map","Option","active","selected","fillRule","clipRule","displayName","LAYOUT_OPTIONS","DeviceCard","device","isEditing","editingName","nameError","onRenameClick","onRenameCancel","onRenameSave","onEditingNameChange","onForgetClick","localLayout","setLocalLayout","layout","serverLayoutRef","hasUserChanges","setHasUserChanges","mutate","updateDevice","isPending","isUpdating","error","updateError","queryClient","useQueryClient","useMutation","mutationFn","async","id","scope","request","apiClient","patch","onMutate","cancelQueries","queryKey","queryKeys","devices","previousDevices","getQueryData","setQueryData","old","updated","onError","_error","_variables","context","onSuccess","invalidateQueries","useUpdateDevice","lastSavedAt","setLastSavedAt","saveLayout","Promise","resolve","reject","Date","isSaving","isSavingLayout","layoutSaveError","data","saveFn","debounceMs","maxRetries","retryDelayMs","enabled","setIsSaving","setError","debounceTimerRef","retryTimerRef","pendingDataRef","isMountedRef","retryCountRef","useEffect","clearTimeout","executeSave","dataToSave","retryCount","err","Error","String","message","delay","Math","pow","saveNow","clearError","useAutoSave","saveError","Card","variant","role","name","identifier","onKeyDown","key","Input","maxLength","size","title","newLayout","serial","vendorId","productId","lastSeen","DevicesPage","loading","setLoading","setDevices","globalLayout","setGlobalLayout","isSavingGlobalLayout","setIsSavingGlobalLayout","globalLayoutError","setGlobalLayoutError","globalLayoutSavedAt","setGlobalLayoutSavedAt","devicesResponse","fetch","ok","statusText","transformedDevices","json","path","match","layoutResponse","layoutData","layoutErr","getErrorMessage","fetchData","editingDeviceId","setEditingDeviceId","setEditingName","setNameError","forgetDeviceId","setForgetDeviceId","handleRenameClick","handleRenameCancel","handleRenameSave","deviceId","trim","prev","forgetDevice","LoadingSkeleton","width","height","window","location","reload","response","method","headers","body","JSON","stringify","Modal","onClose"],"mappings":"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"}