import{R as e,r as a,j as s,g as t,t as l,h as n,i as r}from"./vendor-DchKSmaM.js";import{a as i,C as c}from"./client-DsuQMGGi.js";import{q as o,B as d}from"./index-DNY7ggn3.js";import{I as x}from"./Input-DwmkWAVg.js";import{M as u}from"./Modal-KUDrpHjH.js";import{L as m}from"./LoadingSkeleton-DwR2jlpO.js";import{g as p}from"./errorUtils-C0i9WI_e.js";const h=e.memo(({options:e,value:n,onChange:r,searchable:i=!1,"aria-label":c,disabled:o=!1,placeholder:d="Select an option",className:x=""})=>{const[u,m]=a.useState(""),p=a.useRef(null),h=a.useRef(!1),f=a.useMemo(()=>{if(!i||!u)return e;const a=u.toLowerCase();return e.filter(e=>e.label.toLowerCase().includes(a))},[e,u,i]),v=a.useMemo(()=>e.find(e=>e.value===n),[e,n]),g=a.useCallback(e=>{h.current=e,e&&i&&p.current?setTimeout(()=>{p.current?.focus()},0):e||m("")},[i]);return s.jsx(t,{value:n,onChange:r,disabled:o,as:"div",className:`relative ${x}`,children:({open:e})=>(e!==h.current&&g(e),s.jsxs(s.Fragment,{children:[s.jsxs(t.Button,{"aria-label":c,className:"\n                relative w-full rounded-md border border-slate-600\n                bg-slate-700 py-3 px-4 text-left text-base\n                text-slate-100 transition-all duration-150\n                hover:border-slate-500 hover:bg-slate-600\n                focus:outline focus:outline-2 focus:outline-primary-500\n                focus:outline-offset-2\n                disabled:cursor-not-allowed disabled:opacity-50\n              ",children:[s.jsx("span",{className:"block truncate",children:v?.label||d}),s.jsx("span",{className:"pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3",children:s.jsx("svg",{className:"h-5 w-5 text-slate-400 transition-transform duration-200 "+(e?"rotate-180":""),fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]}),s.jsx(l,{show:e,enter:"transition duration-150 ease-out",enterFrom:"opacity-0 translate-y-[-10px]",enterTo:"opacity-100 translate-y-0",leave:"transition duration-100 ease-in",leaveFrom:"opacity-100 translate-y-0",leaveTo:"opacity-0 translate-y-[-10px]",children:s.jsxs(t.Options,{className:"\n                  absolute z-dropdown mt-2 max-h-60 w-full overflow-auto\n                  rounded-md border border-slate-600 bg-slate-800\n                  py-1 shadow-lg focus:outline-none\n                ",children:[i&&s.jsx("div",{className:"sticky top-0 z-10 border-b border-slate-600 bg-slate-800 p-2",children:s.jsx("input",{ref:p,type:"text",value:u,onChange:e=>m(e.target.value),placeholder:"Search...",className:"\n                        w-full rounded border border-slate-600 bg-slate-700\n                        px-3 py-2 text-sm text-slate-100\n                        placeholder-slate-400\n                        focus:border-primary-500 focus:outline-none\n                      ",onClick:e=>e.stopPropagation()})}),0===f.length?s.jsx("div",{className:"py-2 px-3 text-sm text-slate-400",children:"No options found"}):f.map(e=>s.jsx(t.Option,{value:e.value,className:({active:e,selected:a})=>`\n                          relative cursor-pointer select-none py-2 px-3\n                          text-base transition-colors duration-100\n                          ${e?"bg-primary-500 text-white":"text-slate-100"}\n                          ${a?"font-semibold":"font-normal"}\n                        `,children:({selected:a})=>s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"block truncate",children:e.label}),a&&s.jsx("span",{className:"absolute inset-y-0 right-0 flex items-center pr-3 text-primary-500",children:s.jsx("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:s.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]})},e.value))]})})]}))})});h.displayName="Dropdown";const f=[{value:"ANSI_104",label:"ANSI 104"},{value:"ISO_105",label:"ISO 105"},{value:"JIS_109",label:"JIS 109"},{value:"HHKB",label:"HHKB"},{value:"NUMPAD",label:"Numpad"}],v=({device:t,isEditing:l,editingName:u,nameError:m,onRenameClick:p,onRenameCancel:v,onRenameSave:g,onEditingNameChange:j,onForgetClick:b})=>{const[y,N]=a.useState(t.layout),w=e.useRef(t.layout),[S,C]=a.useState(!1),{mutate:k,isPending:D,error:E}=function(){const e=n();return r({mutationFn:async({id:e,layout:a,scope:s})=>{const t={};return void 0!==a&&(t.layout=a),void 0!==s&&(t.scope=s),i.patch(`/api/devices/${e}`,t)},onMutate:async({id:a,layout:s,scope:t})=>{await e.cancelQueries({queryKey:o.devices});const l=e.getQueryData(o.devices);return e.setQueryData(o.devices,e=>e?.map(e=>{if(e.id!==a)return e;const l={...e};return void 0!==s&&(l.layout=s),void 0!==t&&(l.scope=t),l})),{previousDevices:l}},onError:(a,s,t)=>{t?.previousDevices&&e.setQueryData(o.devices,t.previousDevices)},onSuccess:()=>{e.invalidateQueries({queryKey:o.devices})}})}(),[R,F]=a.useState(null),I=e.useCallback(async e=>{await new Promise((a,s)=>{k({id:t.id,layout:e},{onSuccess:()=>{w.current=e,F(new Date),C(!1),a()},onError:e=>s(e)})})},[t.id,k]),{isSaving:T,error:L}=function(e,s){const{saveFn:t,debounceMs:l=500,maxRetries:n=3,retryDelayMs:r=1e3,enabled:i=!0}=s,[c,o]=a.useState(!1),[d,x]=a.useState(null),[u,m]=a.useState(null),p=a.useRef(null),h=a.useRef(null),f=a.useRef(e),v=a.useRef(!0),g=a.useRef(0);a.useEffect(()=>{f.current=e},[e]),a.useEffect(()=>()=>{v.current=!1,p.current&&clearTimeout(p.current),h.current&&clearTimeout(h.current)},[]);const j=a.useCallback(async(e,a=0)=>{if(v.current)try{if(o(!0),x(null),await t(e),!v.current)return;m(new Date),o(!1),g.current=0}catch(s){if(!v.current)return;const t=s instanceof Error?s:new Error(String(s));if(t.message.includes("400")||t.message.includes("404")||t.message.includes("validation")||a>=n)return x(t),o(!1),void(g.current=0);const l=r*Math.pow(2,a);g.current=a+1,h.current=setTimeout(()=>{j(e,a+1)},l)}},[t,n,r]),b=a.useCallback(()=>{i&&(p.current&&(clearTimeout(p.current),p.current=null),j(f.current))},[i,j]),y=a.useCallback(()=>{x(null)},[]);return a.useEffect(()=>{if(i)return p.current&&clearTimeout(p.current),p.current=setTimeout(()=>{j(e)},l),()=>{p.current&&clearTimeout(p.current)}},[e,l,i,j]),{isSaving:c,error:d,lastSavedAt:u,saveNow:b,clearError:y}}(y,{saveFn:I,debounceMs:500,enabled:S}),M=T||D,z=L||E;return e.useEffect(()=>{t.layout!==w.current&&(w.current=t.layout,N(t.layout),C(!1))},[t.layout]),s.jsx(c,{variant:"elevated",className:"bg-slate-800","data-testid":"device-card",children:s.jsxs("div",{className:"flex flex-col gap-md",children:[s.jsx("div",{className:"flex items-start justify-between",children:s.jsxs("div",{className:"flex items-center gap-sm",children:[s.jsx("span",{className:"text-xl",role:"img","aria-label":"Keyboard",children:"ðŸ–®"}),s.jsxs("div",{className:"flex flex-col",children:[s.jsxs("div",{className:"flex items-center gap-sm",children:[s.jsx("span",{className:"text-base font-medium text-slate-100",children:t.name}),t.active&&s.jsx("span",{className:"text-xs text-green-500","aria-label":"Connected",children:"âœ“ Connected"})]}),s.jsx("span",{className:"text-xs font-mono text-slate-500",children:t.identifier})]})]})}),s.jsxs("div",{className:"flex flex-col gap-2",children:[s.jsx("label",{className:"text-sm font-medium text-slate-300",children:"Name"}),s.jsx("div",{className:"flex flex-col sm:flex-row items-start gap-2",children:l?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"flex-1 w-full",children:s.jsx("div",{onKeyDown:e=>{"Enter"===e.key?g(t.id):"Escape"===e.key&&v()},children:s.jsx(x,{type:"text",value:u,onChange:e=>j(e),error:m,maxLength:64,"aria-label":"Device name"})})}),s.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[s.jsx(d,{variant:"primary",size:"sm",onClick:()=>g(t.id),"aria-label":"Save device name",className:"flex-1 sm:flex-none min-h-[44px] sm:min-h-0",children:"Save"}),s.jsx(d,{variant:"ghost",size:"sm",onClick:v,"aria-label":"Cancel rename",className:"flex-1 sm:flex-none min-h-[44px] sm:min-h-0",children:"Cancel"})]})]}):s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"flex-1 w-full rounded-md border border-slate-700 bg-slate-900 px-4 py-3 text-sm text-slate-100",children:t.name}),s.jsx(d,{variant:"secondary",size:"sm",onClick:()=>p(t),"aria-label":`Rename device ${t.name}`,className:"w-full sm:w-auto min-h-[44px] sm:min-h-0",children:"Rename"})]})})]}),s.jsxs("div",{className:"flex flex-col gap-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("label",{className:"text-sm font-medium text-slate-300",children:"Layout"}),s.jsxs("div",{className:"flex items-center gap-2",children:[M&&s.jsxs("span",{className:"text-xs text-slate-400 flex items-center gap-1",children:[s.jsx("span",{className:"animate-spin h-3 w-3 border-2 border-slate-400 border-t-transparent rounded-full"}),"Saving..."]}),!M&&R&&s.jsx("span",{className:"text-xs text-green-500 flex items-center gap-1",children:"âœ“ Saved"}),z&&s.jsx("span",{className:"text-xs text-red-500 flex items-center gap-1",title:z instanceof Error?z.message:String(z),children:"âœ— Error"})]})]}),s.jsx(h,{options:f,value:y,onChange:e=>{N(e),e!==w.current&&C(!0)},"aria-label":"Select keyboard layout"})]}),s.jsxs("div",{className:"flex flex-wrap gap-md text-xs text-slate-400",children:[t.serial&&s.jsxs("span",{children:["Serial: ",t.serial]}),t.vendorId&&s.jsxs("span",{children:["â€¢ Vendor: ",t.vendorId]}),t.productId&&s.jsxs("span",{children:["â€¢ Product: ",t.productId]}),t.lastSeen&&s.jsxs("span",{children:["â€¢ Last seen: ",t.lastSeen]})]}),s.jsx("div",{className:"flex justify-end border-t border-slate-700 pt-md",children:s.jsx(d,{variant:"danger",size:"sm",onClick:()=>b(t.id),"aria-label":`Forget device ${t.name}`,children:"Forget Device"})})]})},t.id)},g=({className:t=""})=>{const[l,n]=a.useState(!0),[r,i]=a.useState([]),[o,x]=a.useState(null),[g,j]=a.useState("ANSI_104"),[b,y]=a.useState(!1),[N,w]=a.useState(null),[S,C]=a.useState(null);e.useEffect(()=>{(async()=>{try{n(!0),x(null);const a=await fetch("/api/devices");if(!a.ok)throw new Error(`Failed to fetch devices: ${a.statusText}`);const s=((await a.json()).devices||[]).map(e=>({id:e.id,name:e.name,identifier:e.path,layout:e.layout||"ANSI_104",active:e.active,vendorId:e.path.match(/VID_([0-9A-F]{4})/)?.[1],productId:e.path.match(/PID_([0-9A-F]{4})/)?.[1],serial:e.serial,lastSeen:"Just now"}));i(s);try{const e=await fetch("/api/settings/global-layout");if(e.ok){const a=await e.json();j(a.layout||"ANSI_104")}}catch(e){}}catch(a){x(p(a,"Failed to fetch data"))}finally{n(!1)}})()},[]);const[k,D]=a.useState(null),[E,R]=a.useState(""),[F,I]=a.useState(""),[T,L]=a.useState(null),M=e=>{D(e.id),R(e.name),I("")},z=()=>{D(null),R(""),I("")},A=e=>{E.trim()?E.length>64?I("Device name cannot exceed 64 characters"):(i(a=>a.map(a=>a.id===e?{...a,name:E}:a)),D(null),R(""),I("")):I("Device name cannot be empty")},$=r.find(e=>e.id===T);return l?s.jsxs("div",{className:`flex flex-col gap-4 md:gap-6 p-4 md:p-6 lg:p-8 ${t}`,children:[s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[s.jsx(m,{variant:"text",width:"150px",height:"32px"}),s.jsx(m,{variant:"rectangular",width:"100px",height:"36px"})]}),s.jsx(c,{children:s.jsxs("div",{className:"flex flex-col gap-md",children:[s.jsx(m,{variant:"text",width:"200px",height:"24px"}),s.jsxs("div",{className:"flex flex-col gap-md",children:[s.jsx(m,{variant:"rectangular",height:"120px"}),s.jsx(m,{variant:"rectangular",height:"120px"})]})]})})]}):s.jsxs("div",{className:`flex flex-col gap-4 md:gap-6 p-4 md:p-6 lg:p-8 ${t}`,children:[s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[s.jsx("h1",{className:"text-xl md:text-2xl lg:text-3xl font-semibold text-slate-100",children:"Devices"}),s.jsx("div",{className:"flex gap-2",children:s.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{window.location.reload()},"aria-label":"Refresh device list",disabled:l,children:"Refresh"})})]}),o&&s.jsx("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-4",children:s.jsx("p",{className:"text-sm text-red-400",children:o})}),s.jsx(c,{variant:"elevated",className:"bg-slate-800",children:s.jsxs("div",{className:"flex flex-col gap-md",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h2",{className:"text-lg font-semibold text-slate-100",children:"Global Settings"}),b&&s.jsxs("span",{className:"text-xs text-slate-400 flex items-center gap-1",children:[s.jsx("span",{className:"animate-spin h-3 w-3 border-2 border-slate-400 border-t-transparent rounded-full"}),"Saving..."]}),!b&&S&&s.jsx("span",{className:"text-xs text-green-500 flex items-center gap-1",children:"âœ“ Saved"}),N&&s.jsx("span",{className:"text-xs text-red-500 flex items-center gap-1",title:N,children:"âœ— Error"})]}),s.jsxs("div",{className:"flex flex-col gap-sm",children:[s.jsx("label",{className:"text-sm font-medium text-slate-300",children:"Default Keyboard Layout"}),s.jsx("p",{className:"text-xs text-slate-400",children:"New devices will inherit this layout by default. You can override it for specific devices below."}),s.jsx(h,{options:f,value:g,onChange:async e=>{j(e),y(!0),w(null);try{const a=await fetch("/api/settings/global-layout",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({layout:e})});if(!a.ok)throw new Error(`Failed to save global layout: ${a.statusText}`);C(new Date),setTimeout(()=>{C(null)},3e3)}catch(a){w(p(a,"Failed to save global layout"))}finally{y(!1)}},"aria-label":"Select default keyboard layout"})]}),N&&s.jsx("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-3",children:s.jsx("p",{className:"text-xs text-red-400",children:N})})]})}),s.jsx(c,{children:s.jsxs("div",{className:"flex flex-col gap-md",children:[s.jsxs("h2",{className:"text-lg font-semibold text-slate-100",children:["Device List (",r.length," connected)"]}),0===r.length?s.jsx("div",{className:"py-xl text-center",children:s.jsx("p",{className:"text-sm text-slate-400",children:"No devices connected. Connect a keyboard to get started."})}):s.jsx("div",{className:"flex flex-col gap-md",children:r.map(e=>{const a=k===e.id;return s.jsx(v,{device:e,isEditing:a,editingName:E,nameError:F,onRenameClick:M,onRenameCancel:z,onRenameSave:A,onEditingNameChange:R,onForgetClick:L},e.id)})})]})}),s.jsx(u,{open:null!==T,onClose:()=>L(null),title:"Forget Device",children:s.jsxs("div",{className:"flex flex-col gap-lg",children:[s.jsxs("p",{className:"text-sm text-slate-300",children:["Are you sure you want to forget device"," ",s.jsx("span",{className:"font-semibold text-slate-100",children:$?.name}),"?"]}),s.jsx("p",{className:"text-sm text-slate-400",children:"This will remove all device-specific configuration and mappings. This action cannot be undone."}),s.jsxs("div",{className:"flex justify-end gap-sm",children:[s.jsx(d,{variant:"ghost",size:"md",onClick:()=>L(null),"aria-label":"Cancel forget device",children:"Cancel"}),s.jsx(d,{variant:"danger",size:"md",onClick:()=>{T&&(i(e=>e.filter(e=>e.id!==T)),L(null))},"aria-label":"Confirm forget device",children:"Forget Device"})]})]})})]})};export{g as DevicesPage,g as default};
//# sourceMappingURL=DevicesPage-7N92zeJp.js.map
