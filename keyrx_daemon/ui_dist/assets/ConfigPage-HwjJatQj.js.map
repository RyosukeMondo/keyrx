{"version":3,"file":"ConfigPage-HwjJatQj.js","sources":["../../src/components/SimpleCodeEditor.tsx","../../src/components/KeyPalette.tsx","../../src/components/DeviceSelector.tsx","../../src/components/KeyConfigModal.tsx","../../src/components/LayerSwitcher.tsx","../../src/utils/rhaiParser.ts","../../src/utils/rhaiCodeGen.ts","../../src/pages/ConfigPage.tsx","../../src/components/RhaiSyncEngine.tsx"],"sourcesContent":["import { Editor } from '@monaco-editor/react';\n\n/**\n * Simple code editor without WASM validation\n * Lightweight alternative to MonacoEditor for pages that don't need validation\n */\ninterface SimpleCodeEditorProps {\n  value: string;\n  onChange?: (value: string) => void;\n  readOnly?: boolean;\n  height?: string;\n  language?: string;\n}\n\nexport function SimpleCodeEditor({\n  value,\n  onChange,\n  readOnly = false,\n  height = '600px',\n  language = 'javascript',\n}: SimpleCodeEditorProps) {\n  const handleChange = (newValue: string | undefined) => {\n    if (onChange && newValue !== undefined) {\n      onChange(newValue);\n    }\n  };\n\n  return (\n    <Editor\n      height={height}\n      language={language}\n      theme=\"vs-dark\"\n      value={value}\n      onChange={handleChange}\n      options={{\n        readOnly,\n        minimap: { enabled: false },\n        fontSize: 14,\n        lineNumbers: 'on',\n        scrollBeyondLastLine: false,\n        automaticLayout: true,\n        wordWrap: 'on',\n        tabSize: 2,\n        insertSpaces: true,\n      }}\n    />\n  );\n}\n","import React from 'react';\nimport { Card } from './Card';\n\n/**\n * Key Palette - Shows available keys/modifiers/layers for assignment\n * Based on 2025 UI/UX trends: categorized, searchable, drag-friendly\n */\n\nexport interface PaletteKey {\n  id: string;\n  label: string;\n  category: 'virtual_key' | 'modifier' | 'lock' | 'layer';\n  description?: string;\n}\n\ninterface KeyPaletteProps {\n  onKeySelect: (key: PaletteKey) => void;\n  selectedKey?: PaletteKey | null;\n}\n\n// Comprehensive key lists based on keyrx specification\nconst VIRTUAL_KEYS: PaletteKey[] = [\n  // Letters\n  { id: 'A', label: 'A', category: 'virtual_key' },\n  { id: 'B', label: 'B', category: 'virtual_key' },\n  { id: 'C', label: 'C', category: 'virtual_key' },\n  { id: 'D', label: 'D', category: 'virtual_key' },\n  { id: 'E', label: 'E', category: 'virtual_key' },\n  { id: 'F', label: 'F', category: 'virtual_key' },\n  { id: 'G', label: 'G', category: 'virtual_key' },\n  { id: 'H', label: 'H', category: 'virtual_key' },\n  { id: 'I', label: 'I', category: 'virtual_key' },\n  { id: 'J', label: 'J', category: 'virtual_key' },\n  { id: 'K', label: 'K', category: 'virtual_key' },\n  { id: 'L', label: 'L', category: 'virtual_key' },\n  { id: 'M', label: 'M', category: 'virtual_key' },\n  { id: 'N', label: 'N', category: 'virtual_key' },\n  { id: 'O', label: 'O', category: 'virtual_key' },\n  { id: 'P', label: 'P', category: 'virtual_key' },\n  { id: 'Q', label: 'Q', category: 'virtual_key' },\n  { id: 'R', label: 'R', category: 'virtual_key' },\n  { id: 'S', label: 'S', category: 'virtual_key' },\n  { id: 'T', label: 'T', category: 'virtual_key' },\n  { id: 'U', label: 'U', category: 'virtual_key' },\n  { id: 'V', label: 'V', category: 'virtual_key' },\n  { id: 'W', label: 'W', category: 'virtual_key' },\n  { id: 'X', label: 'X', category: 'virtual_key' },\n  { id: 'Y', label: 'Y', category: 'virtual_key' },\n  { id: 'Z', label: 'Z', category: 'virtual_key' },\n  // Numbers\n  { id: '0', label: '0', category: 'virtual_key' },\n  { id: '1', label: '1', category: 'virtual_key' },\n  { id: '2', label: '2', category: 'virtual_key' },\n  { id: '3', label: '3', category: 'virtual_key' },\n  { id: '4', label: '4', category: 'virtual_key' },\n  { id: '5', label: '5', category: 'virtual_key' },\n  { id: '6', label: '6', category: 'virtual_key' },\n  { id: '7', label: '7', category: 'virtual_key' },\n  { id: '8', label: '8', category: 'virtual_key' },\n  { id: '9', label: '9', category: 'virtual_key' },\n  // Function Keys\n  { id: 'F1', label: 'F1', category: 'virtual_key' },\n  { id: 'F2', label: 'F2', category: 'virtual_key' },\n  { id: 'F3', label: 'F3', category: 'virtual_key' },\n  { id: 'F4', label: 'F4', category: 'virtual_key' },\n  { id: 'F5', label: 'F5', category: 'virtual_key' },\n  { id: 'F6', label: 'F6', category: 'virtual_key' },\n  { id: 'F7', label: 'F7', category: 'virtual_key' },\n  { id: 'F8', label: 'F8', category: 'virtual_key' },\n  { id: 'F9', label: 'F9', category: 'virtual_key' },\n  { id: 'F10', label: 'F10', category: 'virtual_key' },\n  { id: 'F11', label: 'F11', category: 'virtual_key' },\n  { id: 'F12', label: 'F12', category: 'virtual_key' },\n  // Special Keys\n  { id: 'Escape', label: 'Esc', category: 'virtual_key' },\n  { id: 'Enter', label: 'Enter', category: 'virtual_key' },\n  { id: 'Space', label: 'Space', category: 'virtual_key' },\n  { id: 'Backspace', label: 'BS', category: 'virtual_key' },\n  { id: 'Tab', label: 'Tab', category: 'virtual_key' },\n  { id: 'Delete', label: 'Del', category: 'virtual_key' },\n  { id: 'Insert', label: 'Ins', category: 'virtual_key' },\n  { id: 'Home', label: 'Home', category: 'virtual_key' },\n  { id: 'End', label: 'End', category: 'virtual_key' },\n  { id: 'PageUp', label: 'PgUp', category: 'virtual_key' },\n  { id: 'PageDown', label: 'PgDn', category: 'virtual_key' },\n  // Arrows\n  { id: 'Up', label: '↑', category: 'virtual_key' },\n  { id: 'Down', label: '↓', category: 'virtual_key' },\n  { id: 'Left', label: '←', category: 'virtual_key' },\n  { id: 'Right', label: '→', category: 'virtual_key' },\n  // Symbols\n  { id: 'Minus', label: '-', category: 'virtual_key' },\n  { id: 'Equal', label: '=', category: 'virtual_key' },\n  { id: 'LeftBracket', label: '[', category: 'virtual_key' },\n  { id: 'RightBracket', label: ']', category: 'virtual_key' },\n  { id: 'Backslash', label: '\\\\', category: 'virtual_key' },\n  { id: 'Semicolon', label: ';', category: 'virtual_key' },\n  { id: 'Quote', label: \"'\", category: 'virtual_key' },\n  { id: 'Comma', label: ',', category: 'virtual_key' },\n  { id: 'Period', label: '.', category: 'virtual_key' },\n  { id: 'Slash', label: '/', category: 'virtual_key' },\n];\n\nconst MODIFIERS: PaletteKey[] = [\n  { id: 'MD_00', label: 'MD_00', category: 'modifier', description: 'Modifier/Layer 0' },\n  { id: 'MD_01', label: 'MD_01', category: 'modifier', description: 'Modifier/Layer 1' },\n  { id: 'MD_02', label: 'MD_02', category: 'modifier', description: 'Modifier/Layer 2' },\n  { id: 'MD_03', label: 'MD_03', category: 'modifier', description: 'Modifier/Layer 3' },\n  { id: 'MD_04', label: 'MD_04', category: 'modifier', description: 'Modifier/Layer 4' },\n  { id: 'MD_05', label: 'MD_05', category: 'modifier', description: 'Modifier/Layer 5' },\n  { id: 'MD_06', label: 'MD_06', category: 'modifier', description: 'Modifier/Layer 6' },\n  { id: 'MD_07', label: 'MD_07', category: 'modifier', description: 'Modifier/Layer 7' },\n  { id: 'MD_08', label: 'MD_08', category: 'modifier', description: 'Modifier/Layer 8' },\n  { id: 'MD_09', label: 'MD_09', category: 'modifier', description: 'Modifier/Layer 9' },\n  { id: 'LCtrl', label: 'LCtrl', category: 'modifier', description: 'Left Control' },\n  { id: 'RCtrl', label: 'RCtrl', category: 'modifier', description: 'Right Control' },\n  { id: 'LShift', label: 'LShift', category: 'modifier', description: 'Left Shift' },\n  { id: 'RShift', label: 'RShift', category: 'modifier', description: 'Right Shift' },\n  { id: 'LAlt', label: 'LAlt', category: 'modifier', description: 'Left Alt' },\n  { id: 'RAlt', label: 'RAlt', category: 'modifier', description: 'Right Alt' },\n  { id: 'LMeta', label: 'LWin', category: 'modifier', description: 'Left Windows/Super' },\n  { id: 'RMeta', label: 'RWin', category: 'modifier', description: 'Right Windows/Super' },\n];\n\nconst LOCKS: PaletteKey[] = [\n  { id: 'LK_00', label: 'LK_00', category: 'lock', description: 'Lock 0 (CapsLock)' },\n  { id: 'LK_01', label: 'LK_01', category: 'lock', description: 'Lock 1 (NumLock)' },\n  { id: 'LK_02', label: 'LK_02', category: 'lock', description: 'Lock 2 (ScrollLock)' },\n  { id: 'LK_03', label: 'LK_03', category: 'lock', description: 'Lock 3' },\n  { id: 'LK_04', label: 'LK_04', category: 'lock', description: 'Lock 4' },\n  { id: 'LK_05', label: 'LK_05', category: 'lock', description: 'Lock 5' },\n  { id: 'LK_06', label: 'LK_06', category: 'lock', description: 'Lock 6' },\n  { id: 'LK_07', label: 'LK_07', category: 'lock', description: 'Lock 7' },\n  { id: 'LK_08', label: 'LK_08', category: 'lock', description: 'Lock 8' },\n  { id: 'LK_09', label: 'LK_09', category: 'lock', description: 'Lock 9' },\n];\n\nconst LAYERS: PaletteKey[] = [\n  { id: 'MD_00', label: 'Base (MD_00)', category: 'layer', description: 'Base layer' },\n  { id: 'MD_01', label: 'Layer MD_01', category: 'layer', description: 'Layer 1' },\n  { id: 'MD_02', label: 'Layer MD_02', category: 'layer', description: 'Layer 2' },\n  { id: 'MD_03', label: 'Layer MD_03', category: 'layer', description: 'Layer 3' },\n  { id: 'MD_04', label: 'Layer MD_04', category: 'layer', description: 'Layer 4' },\n  { id: 'MD_05', label: 'Layer MD_05', category: 'layer', description: 'Layer 5' },\n  { id: 'MD_06', label: 'Layer MD_06', category: 'layer', description: 'Layer 6' },\n  { id: 'MD_07', label: 'Layer MD_07', category: 'layer', description: 'Layer 7' },\n  { id: 'MD_08', label: 'Layer MD_08', category: 'layer', description: 'Layer 8' },\n  { id: 'MD_09', label: 'Layer MD_09', category: 'layer', description: 'Layer 9' },\n];\n\nexport function KeyPalette({ onKeySelect, selectedKey }: KeyPaletteProps) {\n  const [activeCategory, setActiveCategory] = React.useState<PaletteKey['category']>('virtual_key');\n\n  const categories = [\n    { id: 'virtual_key' as const, label: 'Keys', keys: VIRTUAL_KEYS },\n    { id: 'modifier' as const, label: 'Modifiers', keys: MODIFIERS },\n    { id: 'lock' as const, label: 'Locks', keys: LOCKS },\n    { id: 'layer' as const, label: 'Layers', keys: LAYERS },\n  ];\n\n  const activeKeys = categories.find(c => c.id === activeCategory)?.keys || [];\n\n  return (\n    <Card className=\"h-full\">\n      <h3 className=\"text-lg font-semibold text-slate-100 mb-4\">Key Palette</h3>\n\n      {/* Category Tabs */}\n      <div className=\"flex gap-1 mb-4 border-b border-slate-700\">\n        {categories.map(cat => (\n          <button\n            key={cat.id}\n            onClick={() => setActiveCategory(cat.id)}\n            className={`px-3 py-2 text-sm font-medium transition-colors ${\n              activeCategory === cat.id\n                ? 'text-primary-400 border-b-2 border-primary-400'\n                : 'text-slate-400 hover:text-slate-300'\n            }`}\n          >\n            {cat.label}\n          </button>\n        ))}\n      </div>\n\n      {/* Key Grid - Keyboard keycap style */}\n      <div className=\"grid grid-cols-8 gap-2 overflow-y-auto max-h-[400px] p-4 bg-slate-800/50 rounded-lg\">\n        {activeKeys.map(key => (\n          <button\n            key={key.id}\n            onClick={() => onKeySelect(key)}\n            className={`\n              relative flex flex-col items-center justify-center\n              min-h-[50px] px-2 py-2\n              rounded border transition-all\n              hover:brightness-110 hover:-translate-y-0.5 hover:shadow-lg\n              ${\n                selectedKey?.id === key.id\n                  ? 'border-primary-500 bg-primary-500/20 shadow-lg shadow-primary-500/50'\n                  : 'border-slate-600 bg-slate-700 hover:border-slate-500'\n              }\n              ${key.category === 'modifier' ? 'border-cyan-500/50' : ''}\n              ${key.category === 'lock' ? 'border-purple-500/50' : ''}\n              ${key.category === 'layer' ? 'border-yellow-500/50' : ''}\n            `}\n            title={key.description || key.id}\n          >\n            {/* Key label (main) */}\n            <div className=\"text-sm font-bold text-white font-mono\">\n              {key.label}\n            </div>\n            {/* Key ID (small, below) */}\n            <div className=\"text-[9px] text-slate-400 mt-0.5 font-mono\">\n              {key.id}\n            </div>\n          </button>\n        ))}\n      </div>\n\n      {/* Hint */}\n      <p className=\"text-xs text-slate-500 mt-4\">\n        Click a key from palette, then click a keyboard key to assign\n      </p>\n    </Card>\n  );\n}\n","import React from 'react';\nimport { Card } from './Card';\n\n/**\n * Device Selector - Multi-device selection with global option\n * Replaces old scope-based selection with device-aware configuration\n */\n\nexport interface Device {\n  id: string;\n  name: string;\n  serial?: string;\n  connected?: boolean;\n  layout?: string;\n}\n\ninterface DeviceSelectorProps {\n  /** List of available devices */\n  devices: Device[];\n  /** Whether to show global checkbox option */\n  showGlobalOption?: boolean;\n  /** Whether to allow multiple device selection */\n  multiSelect?: boolean;\n  /** Currently selected device IDs */\n  selectedDevices: string[];\n  /** Whether global is selected */\n  globalSelected: boolean;\n  /** Called when selection changes */\n  onSelectionChange: (devices: string[], global: boolean) => void;\n  /** Called when device edit is requested */\n  onEditDevice?: (deviceId: string) => void;\n}\n\nexport function DeviceSelector({\n  devices,\n  showGlobalOption = true,\n  multiSelect = true,\n  selectedDevices,\n  globalSelected,\n  onSelectionChange,\n  onEditDevice,\n}: DeviceSelectorProps) {\n  const handleGlobalToggle = () => {\n    onSelectionChange(selectedDevices, !globalSelected);\n  };\n\n  const handleDeviceToggle = (deviceId: string) => {\n    if (multiSelect) {\n      const newSelected = selectedDevices.includes(deviceId)\n        ? selectedDevices.filter((id) => id !== deviceId)\n        : [...selectedDevices, deviceId];\n      onSelectionChange(newSelected, globalSelected);\n    } else {\n      onSelectionChange([deviceId], globalSelected);\n    }\n  };\n\n  const hasSelection = globalSelected || selectedDevices.length > 0;\n\n  return (\n    <Card>\n      <h3 className=\"text-sm font-semibold text-slate-100 mb-3\">\n        Device Selection\n      </h3>\n\n      {/* Warning if no selection */}\n      {!hasSelection && (\n        <div\n          className=\"mb-3 px-3 py-2 bg-yellow-900/20 border border-yellow-700/50 rounded-md text-yellow-200 text-xs\"\n          role=\"alert\"\n          aria-live=\"polite\"\n        >\n          ⚠ Select at least one device or global to configure\n        </div>\n      )}\n\n      {/* Global checkbox */}\n      {showGlobalOption && (\n        <label\n          className=\"flex items-center gap-3 px-3 py-2.5 mb-2 rounded-md bg-slate-700/50 hover:bg-slate-700 cursor-pointer transition-colors\"\n          htmlFor=\"device-global\"\n        >\n          <input\n            type=\"checkbox\"\n            id=\"device-global\"\n            checked={globalSelected}\n            onChange={handleGlobalToggle}\n            className=\"w-4 h-4 rounded border-slate-500 bg-slate-600 text-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-offset-0 cursor-pointer\"\n            aria-label=\"Apply configuration globally to all devices\"\n          />\n          <div className=\"flex-1\">\n            <div className=\"text-sm font-medium text-slate-100\">\n              Global (All Devices)\n            </div>\n            <div className=\"text-xs text-slate-400\">\n              Configuration applies to all devices\n            </div>\n          </div>\n        </label>\n      )}\n\n      {/* Device list */}\n      {devices.length > 0 ? (\n        <div className=\"space-y-2\">\n          {devices.map((device) => (\n            <label\n              key={device.id}\n              className=\"flex items-center gap-3 px-3 py-2.5 rounded-md bg-slate-700/50 hover:bg-slate-700 cursor-pointer transition-colors\"\n              htmlFor={`device-${device.id}`}\n            >\n              <input\n                type=\"checkbox\"\n                id={`device-${device.id}`}\n                checked={selectedDevices.includes(device.id)}\n                onChange={() => handleDeviceToggle(device.id)}\n                className=\"w-4 h-4 rounded border-slate-500 bg-slate-600 text-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-offset-0 cursor-pointer\"\n                aria-label={`Select device ${device.name}`}\n              />\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-sm font-medium text-slate-100 truncate\">\n                    {device.name}\n                  </span>\n                  {/* Connection status badge */}\n                  {device.connected !== undefined && (\n                    <span\n                      className={`px-2 py-0.5 text-xs font-medium rounded-full ${\n                        device.connected\n                          ? 'bg-green-900/30 text-green-300 border border-green-700/50'\n                          : 'bg-gray-700/30 text-gray-400 border border-gray-600/50'\n                      }`}\n                      aria-label={\n                        device.connected ? 'Device connected' : 'Device disconnected'\n                      }\n                    >\n                      {device.connected ? 'Connected' : 'Disconnected'}\n                    </span>\n                  )}\n                </div>\n                {device.serial && (\n                  <div className=\"text-xs text-slate-500 truncate\">\n                    Serial: {device.serial}\n                  </div>\n                )}\n                {device.layout && (\n                  <div className=\"text-xs text-slate-500\">\n                    Layout: {device.layout}\n                  </div>\n                )}\n              </div>\n              {/* Edit button */}\n              {onEditDevice && (\n                <button\n                  onClick={(e) => {\n                    e.preventDefault();\n                    onEditDevice(device.id);\n                  }}\n                  className=\"px-2 py-1 text-xs text-primary-400 hover:text-primary-300 hover:bg-slate-600 rounded transition-colors\"\n                  aria-label={`Edit device ${device.name}`}\n                  type=\"button\"\n                >\n                  Edit\n                </button>\n              )}\n            </label>\n          ))}\n        </div>\n      ) : (\n        <div className=\"text-sm text-slate-500 text-center py-4\">\n          No devices detected. Connect a keyboard to get started.\n        </div>\n      )}\n\n      {/* Info text */}\n      <p className=\"text-xs text-slate-500 mt-3\">\n        {multiSelect\n          ? 'Select one or more devices to configure. Device-specific mappings will be generated in Rhai script.'\n          : 'Select a device to configure.'}\n      </p>\n    </Card>\n  );\n}\n","import React, { useState } from 'react';\nimport { Modal } from './Modal';\nimport type { KeyMapping } from '@/types';\nimport type { PaletteKey } from './KeyPalette';\n\n/**\n * Advanced Key Configuration Modal\n * Supports: simple, tap_hold, modified, macro, layer_switch\n */\n\ninterface KeyConfigModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  physicalKey: string;\n  currentMapping?: KeyMapping;\n  onSave: (mapping: KeyMapping) => void;\n  availableKeys: PaletteKey[];\n}\n\ntype MappingType = 'simple' | 'tap_hold' | 'macro' | 'layer_switch';\n\nexport function KeyConfigModal({\n  isOpen,\n  onClose,\n  physicalKey,\n  currentMapping,\n  onSave,\n  availableKeys,\n}: KeyConfigModalProps) {\n  const [mappingType, setMappingType] = useState<MappingType>(\n    currentMapping?.type || 'simple'\n  );\n  const [tapAction, setTapAction] = useState(currentMapping?.tapAction || '');\n  const [holdAction, setHoldAction] = useState(currentMapping?.holdAction || '');\n  const [threshold, setThreshold] = useState(currentMapping?.threshold || 200);\n  const [targetLayer, setTargetLayer] = useState(currentMapping?.targetLayer || '');\n\n  const handleSave = () => {\n    const mapping: KeyMapping = {\n      type: mappingType,\n      tapAction: mappingType !== 'layer_switch' ? tapAction : undefined,\n      holdAction: mappingType === 'tap_hold' ? holdAction : undefined,\n      threshold: mappingType === 'tap_hold' ? threshold : undefined,\n      targetLayer: mappingType === 'layer_switch' ? targetLayer : undefined,\n    };\n    onSave(mapping);\n    onClose();\n  };\n\n  return (\n    <Modal open={isOpen} onClose={onClose} title={`Configure: ${physicalKey}`}>\n      <div className=\"space-y-6\">\n        {/* Mapping Type Selector */}\n        <div>\n          <label className=\"block text-sm font-medium text-slate-300 mb-2\">\n            Mapping Type\n          </label>\n          <div className=\"grid grid-cols-2 gap-2\">\n            {(['simple', 'tap_hold', 'macro', 'layer_switch'] as MappingType[]).map((type) => (\n              <button\n                key={type}\n                onClick={() => setMappingType(type)}\n                className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${\n                  mappingType === type\n                    ? 'bg-primary-500 text-white'\n                    : 'bg-slate-700 text-slate-300 hover:bg-slate-600'\n                }`}\n              >\n                {type === 'tap_hold' ? 'Tap/Hold' : type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ')}\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Simple Mapping */}\n        {mappingType === 'simple' && (\n          <div>\n            <label className=\"block text-sm font-medium text-slate-300 mb-2\">\n              Target Key\n            </label>\n            <select\n              value={tapAction}\n              onChange={(e) => setTapAction(e.target.value)}\n              className=\"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary-500\"\n            >\n              <option value=\"\">Select a key...</option>\n              {availableKeys.map((key) => (\n                <option key={key.id} value={key.id}>\n                  {key.label} ({key.id})\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Tap/Hold Mapping */}\n        {mappingType === 'tap_hold' && (\n          <>\n            <div>\n              <label className=\"block text-sm font-medium text-slate-300 mb-2\">\n                Tap Action (quick press)\n              </label>\n              <select\n                value={tapAction}\n                onChange={(e) => setTapAction(e.target.value)}\n                className=\"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary-500\"\n              >\n                <option value=\"\">Select a key...</option>\n                {availableKeys.map((key) => (\n                  <option key={key.id} value={key.id}>\n                    {key.label} ({key.id})\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-slate-300 mb-2\">\n                Hold Action (when held)\n              </label>\n              <select\n                value={holdAction}\n                onChange={(e) => setHoldAction(e.target.value)}\n                className=\"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary-500\"\n              >\n                <option value=\"\">Select a key...</option>\n                {availableKeys.filter(k => k.category === 'modifier' || k.category === 'layer').map((key) => (\n                  <option key={key.id} value={key.id}>\n                    {key.label} ({key.id})\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-slate-300 mb-2\">\n                Hold Threshold (ms): {threshold}\n              </label>\n              <input\n                type=\"range\"\n                min=\"50\"\n                max=\"500\"\n                step=\"10\"\n                value={threshold}\n                onChange={(e) => setThreshold(parseInt(e.target.value))}\n                className=\"w-full\"\n              />\n              <div className=\"flex justify-between text-xs text-slate-500 mt-1\">\n                <span>50ms (fast)</span>\n                <span>500ms (slow)</span>\n              </div>\n            </div>\n          </>\n        )}\n\n        {/* Layer Switch */}\n        {mappingType === 'layer_switch' && (\n          <div>\n            <label className=\"block text-sm font-medium text-slate-300 mb-2\">\n              Target Layer\n            </label>\n            <select\n              value={targetLayer}\n              onChange={(e) => setTargetLayer(e.target.value)}\n              className=\"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-primary-500\"\n            >\n              <option value=\"\">Select a layer...</option>\n              {Array.from({ length: 10 }, (_, i) => (\n                <option key={i} value={`MD_${i.toString().padStart(2, '0')}`}>\n                  Layer MD_{i.toString().padStart(2, '0')}\n                </option>\n              ))}\n            </select>\n          </div>\n        )}\n\n        {/* Macro (placeholder) */}\n        {mappingType === 'macro' && (\n          <div className=\"p-4 bg-slate-700/50 rounded-lg border border-slate-600\">\n            <p className=\"text-sm text-slate-400\">\n              Macro configuration coming soon. Use Code Editor tab for now.\n            </p>\n          </div>\n        )}\n\n        {/* Actions */}\n        <div className=\"flex justify-end gap-3 pt-4 border-t border-slate-700\">\n          <button\n            onClick={onClose}\n            className=\"px-4 py-2 text-slate-300 hover:text-slate-100 transition-colors\"\n          >\n            Cancel\n          </button>\n          <button\n            onClick={handleSave}\n            disabled={\n              (mappingType === 'simple' && !tapAction) ||\n              (mappingType === 'tap_hold' && (!tapAction || !holdAction)) ||\n              (mappingType === 'layer_switch' && !targetLayer)\n            }\n            className=\"px-6 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium\"\n          >\n            Save Mapping\n          </button>\n        </div>\n      </div>\n    </Modal>\n  );\n}\n","import React, { useState } from 'react';\n\n/**\n * Layer Switcher - Beautiful layer selection styled like user_layout.html\n * Supports MD_00 to MD_FF (0-255 layers)\n */\n\ninterface LayerSwitcherProps {\n  activeLayer: string;\n  availableLayers: string[];\n  onLayerChange: (layer: string) => void;\n}\n\nexport function LayerSwitcher({\n  activeLayer,\n  availableLayers,\n  onLayerChange,\n}: LayerSwitcherProps) {\n  const [customLayerInput, setCustomLayerInput] = useState('');\n\n  // Quick access layers (base + first 9 modifiers)\n  const quickLayers = ['base', ...Array.from({ length: 10 }, (_, i) => `md-${i.toString().padStart(2, '0')}`)];\n\n  const handleCustomLayerSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    const layerNum = parseInt(customLayerInput, 16);\n    if (!isNaN(layerNum) && layerNum >= 0 && layerNum <= 255) {\n      const layerName = `md-${layerNum.toString(16).padStart(2, '0')}`;\n      onLayerChange(layerName);\n      setCustomLayerInput('');\n    }\n  };\n\n  return (\n    <div className=\"p-4 bg-gradient-to-r from-red-900/20 to-red-800/20 rounded-lg border border-red-500/30\">\n      <div className=\"flex items-center gap-4 flex-wrap\">\n        <span className=\"text-red-400 font-bold text-sm\">LAYERS:</span>\n\n        {/* Quick access layer buttons */}\n        {quickLayers.map((layer) => (\n          <button\n            key={layer}\n            onClick={() => onLayerChange(layer)}\n            className={`px-4 py-2 rounded-md text-sm font-medium transition-all transform hover:scale-105 ${\n              activeLayer === layer\n                ? 'bg-red-500 text-white shadow-lg shadow-red-500/50'\n                : 'bg-slate-800 text-slate-300 border border-red-500/50 hover:bg-slate-700 hover:border-red-400'\n            }`}\n          >\n            {layer === 'base' ? 'Base Layer' : layer.toUpperCase()}\n          </button>\n        ))}\n\n        {/* Custom layer input (MD_00 to MD_FF) */}\n        <form onSubmit={handleCustomLayerSubmit} className=\"flex items-center gap-2 ml-4\">\n          <label htmlFor=\"custom-layer\" className=\"text-red-400 text-sm\">\n            MD_\n          </label>\n          <input\n            id=\"custom-layer\"\n            type=\"text\"\n            value={customLayerInput}\n            onChange={(e) => setCustomLayerInput(e.target.value.toUpperCase())}\n            placeholder=\"00-FF\"\n            maxLength={2}\n            className=\"w-16 px-2 py-1 bg-slate-800 border border-red-500/50 rounded text-white text-sm font-mono text-center focus:outline-none focus:ring-2 focus:ring-red-500\"\n          />\n          <button\n            type=\"submit\"\n            className=\"px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-500 transition-colors\"\n          >\n            Go\n          </button>\n        </form>\n\n        {/* Current layer display (if custom) */}\n        {activeLayer !== 'base' && !quickLayers.includes(activeLayer) && (\n          <div className=\"ml-2 px-3 py-1 bg-red-500/20 border border-red-500 rounded text-red-300 text-sm\">\n            Current: {activeLayer.toUpperCase()}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","/**\n * Rhai script parser for KeyRx configuration files\n *\n * This module provides utilities to parse Rhai scripts into structured AST\n * representations for use in the visual configuration editor.\n *\n * Key features:\n * - Parse device() blocks with serial number patterns\n * - Extract all mapping types (simple, tap_hold, macro, layer_switch)\n * - Distinguish global vs device-specific scope\n * - Extract import statements\n * - Preserve comments with line numbers\n * - Handle syntax errors gracefully with actionable suggestions\n *\n * @module rhaiParser\n */\n\n/**\n * Parse result containing either successful AST or error details\n */\nexport interface ParseResult {\n  /** Whether parsing succeeded */\n  success: boolean;\n  /** Parsed AST if successful */\n  ast?: RhaiAST;\n  /** Parse error if failed */\n  error?: ParseError;\n}\n\n/**\n * Abstract Syntax Tree representation of a Rhai configuration script\n */\nexport interface RhaiAST {\n  /** Import statements found in the script */\n  imports: ImportStatement[];\n  /** Global mappings (outside any device block) */\n  globalMappings: KeyMapping[];\n  /** Device-specific configuration blocks */\n  deviceBlocks: DeviceBlock[];\n  /** Comments preserved with their line numbers */\n  comments: Comment[];\n}\n\n/**\n * Import statement for including other Rhai files or modules\n */\nexport interface ImportStatement {\n  /** Path or module being imported */\n  path: string;\n  /** Optional alias for the import */\n  alias?: string;\n  /** Line number where import appears */\n  line: number;\n}\n\n/**\n * Device configuration block for device-specific mappings\n */\nexport interface DeviceBlock {\n  /** Device serial number pattern (e.g., \"*\", \"*Keychron*\", \"Vendor_04d9_Product_a09f\") */\n  pattern: string;\n  /** Key mappings specific to this device */\n  mappings: KeyMapping[];\n  /** Modifier layers (when_start blocks) */\n  layers: ModifierLayer[];\n  /** Line number where device block starts */\n  startLine: number;\n  /** Line number where device block ends */\n  endLine: number;\n}\n\n/**\n * Modifier layer activated by holding a modifier key\n */\nexport interface ModifierLayer {\n  /** Modifier ID(s) that activate this layer (e.g., \"MD_00\" or [\"MD_00\", \"MD_01\"]) */\n  modifiers: string | string[];\n  /** Key mappings active when this layer is enabled */\n  mappings: KeyMapping[];\n  /** Line number where layer starts */\n  startLine: number;\n  /** Line number where layer ends */\n  endLine: number;\n}\n\n/**\n * Key mapping configuration - supports multiple mapping types\n */\nexport interface KeyMapping {\n  /** Mapping type */\n  type: 'simple' | 'tap_hold' | 'macro' | 'layer_switch';\n  /** Physical key code (VK_* format) */\n  sourceKey: string;\n  /** Line number where mapping is defined */\n  line: number;\n  /** Simple mapping target (for type='simple') */\n  targetKey?: string;\n  /** Tap-hold configuration (for type='tap_hold') */\n  tapHold?: TapHoldConfig;\n  /** Macro sequence (for type='macro') */\n  macro?: MacroSequence;\n  /** Layer switch (for type='layer_switch') */\n  layerSwitch?: LayerSwitch;\n}\n\n/**\n * Tap-hold dual-function key configuration\n */\nexport interface TapHoldConfig {\n  /** Key to output on quick tap */\n  tapAction: string;\n  /** Modifier to activate on hold */\n  holdAction: string;\n  /** Threshold in milliseconds */\n  thresholdMs: number;\n}\n\n/**\n * Macro sequence configuration\n */\nexport interface MacroSequence {\n  /** Array of key codes to emit in sequence */\n  keys: string[];\n  /** Optional delay between keys in milliseconds */\n  delayMs?: number;\n}\n\n/**\n * Layer switch configuration\n */\nexport interface LayerSwitch {\n  /** Target layer identifier */\n  layerId: string;\n  /** Switch mode (toggle, momentary, etc.) */\n  mode?: 'toggle' | 'momentary';\n}\n\n/**\n * Key action that can include modifiers (Ctrl, Shift, Alt, Super)\n */\nexport interface KeyAction {\n  /** Base key code */\n  key: string;\n  /** Whether Ctrl modifier is active */\n  ctrl?: boolean;\n  /** Whether Shift modifier is active */\n  shift?: boolean;\n  /** Whether Alt modifier is active */\n  alt?: boolean;\n  /** Whether Super/Windows modifier is active */\n  super?: boolean;\n}\n\n/**\n * Comment preserved from the source code\n */\nexport interface Comment {\n  /** Comment text (excluding // or /* *\\/) */\n  text: string;\n  /** Line number where comment appears */\n  line: number;\n  /** Comment type */\n  type: 'line' | 'block';\n}\n\n/**\n * Parse error with detailed location and suggestion\n */\nexport interface ParseError {\n  /** Error message */\n  message: string;\n  /** Line number where error occurred */\n  line: number;\n  /** Column number where error occurred */\n  column: number;\n  /** Helpful suggestion to fix the error */\n  suggestion?: string;\n}\n\n/**\n * Parse a Rhai script into structured AST\n *\n * This function parses Rhai configuration scripts and extracts all relevant\n * information including device blocks, key mappings, import statements, and comments.\n *\n * @param script - Rhai script source code\n * @returns ParseResult containing either AST or error details\n *\n * @example\n * ```typescript\n * const script = `\n *   device_start(\"*\");\n *     map(\"VK_A\", \"VK_B\");\n *   device_end();\n * `;\n *\n * const result = parseRhaiScript(script);\n * if (result.success) {\n *   console.log('Device blocks:', result.ast.deviceBlocks);\n * } else {\n *   console.error('Parse error:', result.error);\n * }\n * ```\n */\nexport function parseRhaiScript(script: string): ParseResult {\n  try {\n    const lines = script.split('\\n');\n    const ast: RhaiAST = {\n      imports: [],\n      globalMappings: [],\n      deviceBlocks: [],\n      comments: [],\n    };\n\n    let currentDeviceBlock: DeviceBlock | null = null;\n    let currentModifierLayer: ModifierLayer | null = null;\n    let lineNumber = 0;\n\n    for (const line of lines) {\n      lineNumber++;\n      const trimmed = line.trim();\n\n      // Skip empty lines\n      if (!trimmed) continue;\n\n      // Extract comments\n      const commentMatch = trimmed.match(/^\\/\\/(.*)$/);\n      if (commentMatch) {\n        ast.comments.push({\n          text: commentMatch[1].trim(),\n          line: lineNumber,\n          type: 'line',\n        });\n        continue;\n      }\n\n      // Extract block comments (simplified - assumes single-line /* */)\n      const blockCommentMatch = trimmed.match(/^\\/\\*(.*)\\*\\/$/);\n      if (blockCommentMatch) {\n        ast.comments.push({\n          text: blockCommentMatch[1].trim(),\n          line: lineNumber,\n          type: 'block',\n        });\n        continue;\n      }\n\n      // Parse import statements\n      const importMatch = trimmed.match(/^import\\s+\"([^\"]+)\"(?:\\s+as\\s+(\\w+))?/);\n      if (importMatch) {\n        ast.imports.push({\n          path: importMatch[1],\n          alias: importMatch[2],\n          line: lineNumber,\n        });\n        continue;\n      }\n\n      // Parse device_start\n      const deviceStartMatch = trimmed.match(/^device_start\\s*\\(\\s*\"([^\"]+)\"\\s*\\)/);\n      if (deviceStartMatch) {\n        if (currentDeviceBlock) {\n          return {\n            success: false,\n            error: {\n              message: 'Nested device blocks are not allowed',\n              line: lineNumber,\n              column: 0,\n              suggestion: 'Close previous device block with device_end() before starting a new one',\n            },\n          };\n        }\n        currentDeviceBlock = {\n          pattern: deviceStartMatch[1],\n          mappings: [],\n          layers: [],\n          startLine: lineNumber,\n          endLine: -1,\n        };\n        continue;\n      }\n\n      // Parse device_end\n      if (trimmed.match(/^device_end\\s*\\(\\s*\\)/)) {\n        if (!currentDeviceBlock) {\n          return {\n            success: false,\n            error: {\n              message: 'device_end() without matching device_start()',\n              line: lineNumber,\n              column: 0,\n              suggestion: 'Add device_start(\"pattern\") before device_end()',\n            },\n          };\n        }\n        currentDeviceBlock.endLine = lineNumber;\n        ast.deviceBlocks.push(currentDeviceBlock);\n        currentDeviceBlock = null;\n        continue;\n      }\n\n      // Parse when_start (modifier layers)\n      const whenStartMatch = trimmed.match(/^when_start\\s*\\(\\s*(?:\"([^\"]+)\"|\\[([^\\]]+)\\])\\s*\\)/);\n      if (whenStartMatch) {\n        if (currentModifierLayer) {\n          return {\n            success: false,\n            error: {\n              message: 'Nested when blocks are not allowed',\n              line: lineNumber,\n              column: 0,\n              suggestion: 'Close previous when block with when_end() before starting a new one',\n            },\n          };\n        }\n\n        // Parse modifiers - either single string or array\n        let modifiers: string | string[];\n        if (whenStartMatch[1]) {\n          // Single modifier\n          modifiers = whenStartMatch[1];\n        } else {\n          // Array of modifiers\n          modifiers = whenStartMatch[2]\n            .split(',')\n            .map(m => m.trim().replace(/[\"']/g, ''));\n        }\n\n        currentModifierLayer = {\n          modifiers,\n          mappings: [],\n          startLine: lineNumber,\n          endLine: -1,\n        };\n        continue;\n      }\n\n      // Parse when_end\n      if (trimmed.match(/^when_end\\s*\\(\\s*\\)/)) {\n        if (!currentModifierLayer) {\n          return {\n            success: false,\n            error: {\n              message: 'when_end() without matching when_start()',\n              line: lineNumber,\n              column: 0,\n              suggestion: 'Add when_start(\"modifier\") before when_end()',\n            },\n          };\n        }\n        currentModifierLayer.endLine = lineNumber;\n\n        // Add layer to current device block or global\n        if (currentDeviceBlock) {\n          currentDeviceBlock.layers.push(currentModifierLayer);\n        }\n        currentModifierLayer = null;\n        continue;\n      }\n\n      // Parse map() - simple mapping\n      const mapMatch = trimmed.match(/^map\\s*\\(\\s*\"([^\"]+)\"\\s*,\\s*\"?([^\")]+)\"?\\s*\\)/);\n      if (mapMatch) {\n        const mapping: KeyMapping = {\n          type: 'simple',\n          sourceKey: mapMatch[1],\n          targetKey: mapMatch[2].replace(/\"/g, ''),\n          line: lineNumber,\n        };\n\n        // Add to current context (layer, device, or global)\n        if (currentModifierLayer) {\n          currentModifierLayer.mappings.push(mapping);\n        } else if (currentDeviceBlock) {\n          currentDeviceBlock.mappings.push(mapping);\n        } else {\n          ast.globalMappings.push(mapping);\n        }\n        continue;\n      }\n\n      // Parse tap_hold()\n      const tapHoldMatch = trimmed.match(\n        /^tap_hold\\s*\\(\\s*\"([^\"]+)\"\\s*,\\s*\"([^\"]+)\"\\s*,\\s*\"([^\"]+)\"\\s*,\\s*(\\d+)\\s*\\)/\n      );\n      if (tapHoldMatch) {\n        const mapping: KeyMapping = {\n          type: 'tap_hold',\n          sourceKey: tapHoldMatch[1],\n          line: lineNumber,\n          tapHold: {\n            tapAction: tapHoldMatch[2],\n            holdAction: tapHoldMatch[3],\n            thresholdMs: parseInt(tapHoldMatch[4], 10),\n          },\n        };\n\n        // Add to current context\n        if (currentModifierLayer) {\n          currentModifierLayer.mappings.push(mapping);\n        } else if (currentDeviceBlock) {\n          currentDeviceBlock.mappings.push(mapping);\n        } else {\n          ast.globalMappings.push(mapping);\n        }\n        continue;\n      }\n\n      // Parse helper functions like with_ctrl(), with_shift(), etc.\n      const withModMatch = trimmed.match(/^map\\s*\\(\\s*\"([^\"]+)\"\\s*,\\s*(with_\\w+\\([^)]+\\))\\s*\\)/);\n      if (withModMatch) {\n        const mapping: KeyMapping = {\n          type: 'simple',\n          sourceKey: withModMatch[1],\n          targetKey: withModMatch[2], // Store the full expression\n          line: lineNumber,\n        };\n\n        // Add to current context\n        if (currentModifierLayer) {\n          currentModifierLayer.mappings.push(mapping);\n        } else if (currentDeviceBlock) {\n          currentDeviceBlock.mappings.push(mapping);\n        } else {\n          ast.globalMappings.push(mapping);\n        }\n        continue;\n      }\n\n      // If we get here and we're not in a comment or empty line, it might be unrecognized syntax\n      // For now, we'll silently ignore unrecognized lines to be permissive\n    }\n\n    // Check for unclosed blocks\n    if (currentDeviceBlock) {\n      return {\n        success: false,\n        error: {\n          message: 'Unclosed device block',\n          line: currentDeviceBlock.startLine,\n          column: 0,\n          suggestion: 'Add device_end() to close the device block',\n        },\n      };\n    }\n\n    if (currentModifierLayer) {\n      return {\n        success: false,\n        error: {\n          message: 'Unclosed when block',\n          line: currentModifierLayer.startLine,\n          column: 0,\n          suggestion: 'Add when_end() to close the when block',\n        },\n      };\n    }\n\n    return {\n      success: true,\n      ast,\n    };\n  } catch (error) {\n    // Handle unexpected errors\n    return {\n      success: false,\n      error: {\n        message: error instanceof Error ? error.message : 'Unknown parse error',\n        line: 0,\n        column: 0,\n        suggestion: 'Check script syntax and try again',\n      },\n    };\n  }\n}\n\n/**\n * Extract device serial patterns from device blocks\n *\n * @param ast - Parsed AST\n * @returns Array of device serial patterns\n */\nexport function extractDevicePatterns(ast: RhaiAST): string[] {\n  return ast.deviceBlocks.map(block => block.pattern);\n}\n\n/**\n * Check if AST has global mappings (mappings outside device blocks)\n *\n * @param ast - Parsed AST\n * @returns True if there are global mappings\n */\nexport function hasGlobalMappings(ast: RhaiAST): boolean {\n  return ast.globalMappings.length > 0;\n}\n\n/**\n * Get all mappings for a specific device pattern\n *\n * @param ast - Parsed AST\n * @param pattern - Device pattern to search for\n * @returns Array of key mappings for the device, or undefined if not found\n */\nexport function getMappingsForDevice(ast: RhaiAST, pattern: string): KeyMapping[] | undefined {\n  const deviceBlock = ast.deviceBlocks.find(block => block.pattern === pattern);\n  if (!deviceBlock) return undefined;\n\n  // Flatten device mappings and layer mappings\n  const allMappings = [...deviceBlock.mappings];\n  for (const layer of deviceBlock.layers) {\n    allMappings.push(...layer.mappings);\n  }\n\n  return allMappings;\n}\n\n/**\n * Validate that parsed AST has expected structure\n *\n * @param ast - Parsed AST to validate\n * @returns Validation result with any errors found\n */\nexport function validateAST(ast: RhaiAST): { valid: boolean; errors: string[] } {\n  const errors: string[] = [];\n\n  // Check for duplicate device patterns\n  const patterns = new Set<string>();\n  for (const block of ast.deviceBlocks) {\n    if (patterns.has(block.pattern)) {\n      errors.push(`Duplicate device pattern: ${block.pattern}`);\n    }\n    patterns.add(block.pattern);\n  }\n\n  // Validate tap_hold thresholds\n  const allMappings = [\n    ...ast.globalMappings,\n    ...ast.deviceBlocks.flatMap(block => [\n      ...block.mappings,\n      ...block.layers.flatMap(layer => layer.mappings),\n    ]),\n  ];\n\n  for (const mapping of allMappings) {\n    if (mapping.type === 'tap_hold' && mapping.tapHold) {\n      const threshold = mapping.tapHold.thresholdMs;\n      if (threshold < 50) {\n        errors.push(`Tap-hold threshold too low (${threshold}ms) at line ${mapping.line}. Minimum: 50ms`);\n      }\n      if (threshold > 1000) {\n        errors.push(`Tap-hold threshold too high (${threshold}ms) at line ${mapping.line}. Maximum: 1000ms`);\n      }\n    }\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n  };\n}\n","/**\n * Rhai code generator for KeyRx configuration files\n *\n * This module provides utilities to generate Rhai scripts from structured AST\n * representations created by the visual configuration editor.\n *\n * Key features:\n * - Generate clean, formatted Rhai code from AST\n * - Support all mapping types (simple, tap_hold, macro, layer_switch)\n * - Generate device() blocks with proper grouping\n * - Preserve comments and formatting\n * - Configurable formatting options\n *\n * @module rhaiCodeGen\n */\n\nimport type {\n  RhaiAST,\n  DeviceBlock,\n  KeyMapping,\n  ModifierLayer,\n  ImportStatement,\n  Comment,\n} from './rhaiParser';\n\n/**\n * Formatting options for code generation\n */\nexport interface FormatOptions {\n  /** Number of spaces for indentation (default: 4) */\n  indentSize?: number;\n  /** Maximum line length (default: 100) */\n  maxLineLength?: number;\n  /** Number of blank lines between device blocks (default: 1) */\n  blankLinesBetweenDevices?: number;\n  /** Number of blank lines between sections (imports, global, devices) (default: 2) */\n  blankLinesBetweenSections?: number;\n}\n\n/**\n * Default formatting options\n */\nconst DEFAULT_FORMAT_OPTIONS: Required<FormatOptions> = {\n  indentSize: 4,\n  maxLineLength: 100,\n  blankLinesBetweenDevices: 1,\n  blankLinesBetweenSections: 2,\n};\n\n/**\n * Generate a complete Rhai script from AST\n *\n * This function generates a properly formatted Rhai configuration script\n * from a parsed AST structure, preserving comments and applying consistent\n * formatting rules.\n *\n * @param ast - Parsed AST structure\n * @param options - Optional formatting configuration\n * @returns Generated Rhai script as string\n *\n * @example\n * ```typescript\n * const ast: RhaiAST = {\n *   imports: [],\n *   globalMappings: [\n *     { type: 'simple', sourceKey: 'VK_A', targetKey: 'VK_B', line: 1 }\n *   ],\n *   deviceBlocks: [],\n *   comments: []\n * };\n *\n * const script = generateRhaiScript(ast);\n * console.log(script);\n * // Output:\n * // map(\"VK_A\", \"VK_B\");\n * ```\n */\nexport function generateRhaiScript(ast: RhaiAST, options?: FormatOptions): string {\n  const opts = { ...DEFAULT_FORMAT_OPTIONS, ...options };\n  const lines: string[] = [];\n\n  // Generate import statements\n  if (ast.imports.length > 0) {\n    for (const importStmt of ast.imports) {\n      lines.push(generateImportStatement(importStmt));\n    }\n    // Add blank lines after imports\n    for (let i = 0; i < opts.blankLinesBetweenSections; i++) {\n      lines.push('');\n    }\n  }\n\n  // Generate global mappings\n  if (ast.globalMappings.length > 0) {\n    // Add comments that appear before global mappings\n    const globalComments = getCommentsForSection(ast.comments, 0, getFirstDeviceLineOrEnd(ast));\n    for (const comment of globalComments) {\n      lines.push(generateComment(comment));\n    }\n\n    for (const mapping of ast.globalMappings) {\n      lines.push(generateKeyMapping(mapping, 0, opts));\n    }\n\n    // Add blank lines after global mappings if there are device blocks\n    if (ast.deviceBlocks.length > 0) {\n      for (let i = 0; i < opts.blankLinesBetweenSections; i++) {\n        lines.push('');\n      }\n    }\n  }\n\n  // Generate device blocks\n  for (let i = 0; i < ast.deviceBlocks.length; i++) {\n    const deviceBlock = ast.deviceBlocks[i];\n    lines.push(...generateDeviceBlock(deviceBlock, ast.comments, opts));\n\n    // Add blank lines between device blocks (except after last one)\n    if (i < ast.deviceBlocks.length - 1) {\n      for (let j = 0; j < opts.blankLinesBetweenDevices; j++) {\n        lines.push('');\n      }\n    }\n  }\n\n  return lines.join('\\n');\n}\n\n/**\n * Generate import statement\n *\n * @param importStmt - Import statement to generate\n * @returns Generated import statement as string\n */\nfunction generateImportStatement(importStmt: ImportStatement): string {\n  if (importStmt.alias) {\n    return `import \"${importStmt.path}\" as ${importStmt.alias};`;\n  }\n  return `import \"${importStmt.path}\";`;\n}\n\n/**\n * Generate comment\n *\n * @param comment - Comment to generate\n * @returns Generated comment as string\n */\nfunction generateComment(comment: Comment): string {\n  if (comment.type === 'block') {\n    return `/* ${comment.text} */`;\n  }\n  return `// ${comment.text}`;\n}\n\n/**\n * Generate device block with all its mappings and layers\n *\n * @param device - Device block to generate\n * @param allComments - All comments from the AST (for context preservation)\n * @param options - Formatting options\n * @returns Array of lines for the device block\n */\nexport function generateDeviceBlock(\n  device: DeviceBlock,\n  allComments: Comment[] = [],\n  options?: FormatOptions\n): string[] {\n  const opts = { ...DEFAULT_FORMAT_OPTIONS, ...options };\n  const lines: string[] = [];\n  const indent = ' '.repeat(opts.indentSize);\n\n  // Add comments that appear before this device block\n  const blockComments = getCommentsForSection(\n    allComments,\n    device.startLine - 5, // Look for comments within 5 lines before\n    device.startLine\n  );\n  for (const comment of blockComments) {\n    lines.push(generateComment(comment));\n  }\n\n  // Device start\n  lines.push(`device_start(\"${device.pattern}\");`);\n\n  // Device mappings\n  for (const mapping of device.mappings) {\n    lines.push(indent + generateKeyMapping(mapping, 1, opts));\n  }\n\n  // Modifier layers\n  for (const layer of device.layers) {\n    lines.push(...generateModifierLayer(layer, 1, opts));\n  }\n\n  // Device end\n  lines.push('device_end();');\n\n  return lines;\n}\n\n/**\n * Generate modifier layer (when block)\n *\n * @param layer - Modifier layer to generate\n * @param baseIndentLevel - Base indentation level (0 = no indent, 1 = one level, etc.)\n * @param options - Formatting options\n * @returns Array of lines for the modifier layer\n */\nfunction generateModifierLayer(\n  layer: ModifierLayer,\n  baseIndentLevel: number,\n  options: Required<FormatOptions>\n): string[] {\n  const lines: string[] = [];\n  const baseIndent = ' '.repeat(baseIndentLevel * options.indentSize);\n  const innerIndent = ' '.repeat((baseIndentLevel + 1) * options.indentSize);\n\n  // Format modifiers - single string or array\n  let modifiersArg: string;\n  if (Array.isArray(layer.modifiers)) {\n    const quotedMods = layer.modifiers.map(m => `\"${m}\"`).join(', ');\n    modifiersArg = `[${quotedMods}]`;\n  } else {\n    modifiersArg = `\"${layer.modifiers}\"`;\n  }\n\n  // When start\n  lines.push(`${baseIndent}when_start(${modifiersArg});`);\n\n  // Layer mappings\n  for (const mapping of layer.mappings) {\n    lines.push(innerIndent + generateKeyMapping(mapping, baseIndentLevel + 1, options));\n  }\n\n  // When end\n  lines.push(`${baseIndent}when_end();`);\n\n  return lines;\n}\n\n/**\n * Generate a single key mapping\n *\n * @param mapping - Key mapping to generate\n * @param indentLevel - Current indentation level\n * @param options - Formatting options\n * @returns Generated mapping statement as string\n */\nexport function generateKeyMapping(\n  mapping: KeyMapping,\n  indentLevel: number = 0,\n  options?: FormatOptions\n): string {\n  const opts = { ...DEFAULT_FORMAT_OPTIONS, ...options };\n\n  switch (mapping.type) {\n    case 'simple':\n      return generateSimpleMapping(mapping);\n\n    case 'tap_hold':\n      return generateTapHoldMapping(mapping);\n\n    case 'macro':\n      return generateMacroMapping(mapping);\n\n    case 'layer_switch':\n      return generateLayerSwitchMapping(mapping);\n\n    default:\n      // TypeScript should prevent this, but handle unknown types gracefully\n      return `// Unknown mapping type: ${(mapping as any).type}`;\n  }\n}\n\n/**\n * Generate simple key mapping\n */\nfunction generateSimpleMapping(mapping: KeyMapping): string {\n  if (!mapping.targetKey) {\n    throw new Error(`Simple mapping missing targetKey at line ${mapping.line}`);\n  }\n\n  // Check if target is a helper function (with_ctrl, with_shift, etc.)\n  if (mapping.targetKey.startsWith('with_')) {\n    return `map(\"${mapping.sourceKey}\", ${mapping.targetKey});`;\n  }\n\n  return `map(\"${mapping.sourceKey}\", \"${mapping.targetKey}\");`;\n}\n\n/**\n * Generate tap-hold mapping\n */\nfunction generateTapHoldMapping(mapping: KeyMapping): string {\n  if (!mapping.tapHold) {\n    throw new Error(`Tap-hold mapping missing tapHold config at line ${mapping.line}`);\n  }\n\n  const { tapAction, holdAction, thresholdMs } = mapping.tapHold;\n  return `tap_hold(\"${mapping.sourceKey}\", \"${tapAction}\", \"${holdAction}\", ${thresholdMs});`;\n}\n\n/**\n * Generate macro mapping\n */\nfunction generateMacroMapping(mapping: KeyMapping): string {\n  if (!mapping.macro) {\n    throw new Error(`Macro mapping missing macro config at line ${mapping.line}`);\n  }\n\n  const { keys, delayMs } = mapping.macro;\n  const keysStr = keys.map(k => `\"${k}\"`).join(', ');\n\n  if (delayMs !== undefined) {\n    return `macro(\"${mapping.sourceKey}\", [${keysStr}], ${delayMs});`;\n  }\n\n  return `macro(\"${mapping.sourceKey}\", [${keysStr}]);`;\n}\n\n/**\n * Generate layer switch mapping\n */\nfunction generateLayerSwitchMapping(mapping: KeyMapping): string {\n  if (!mapping.layerSwitch) {\n    throw new Error(`Layer switch mapping missing layerSwitch config at line ${mapping.line}`);\n  }\n\n  const { layerId, mode } = mapping.layerSwitch;\n\n  if (mode) {\n    return `layer_switch(\"${mapping.sourceKey}\", \"${layerId}\", \"${mode}\");`;\n  }\n\n  return `layer_switch(\"${mapping.sourceKey}\", \"${layerId}\");`;\n}\n\n/**\n * Get comments that appear within a specific line range\n */\nfunction getCommentsForSection(\n  comments: Comment[],\n  startLine: number,\n  endLine: number\n): Comment[] {\n  return comments.filter(c => c.line >= startLine && c.line < endLine);\n}\n\n/**\n * Get the line number of the first device block, or a large number if no device blocks\n */\nfunction getFirstDeviceLineOrEnd(ast: RhaiAST): number {\n  if (ast.deviceBlocks.length === 0) {\n    return Number.MAX_SAFE_INTEGER;\n  }\n  return ast.deviceBlocks[0].startLine;\n}\n\n/**\n * Format a Rhai script with consistent indentation and spacing\n *\n * This is a utility function that can re-format existing Rhai code\n * to match project standards. It works by parsing and regenerating.\n *\n * Note: This function is now implemented in rhaiFormatter.ts to avoid\n * circular dependencies. Use that module for formatting functionality.\n *\n * @deprecated Use formatRhaiScript from rhaiFormatter.ts instead\n * @param script - Rhai script to format\n * @param options - Formatting options\n * @returns Formatted script\n */\nexport function formatRhaiScript(script: string, options?: FormatOptions): string {\n  // This function is deprecated - use rhaiFormatter.formatRhaiScript instead\n  throw new Error(\n    'formatRhaiScript has been moved to rhaiFormatter.ts. Please import from there instead.'\n  );\n}\n","import React, { useState, useEffect } from 'react';\nimport { useSearchParams, useParams, useNavigate } from 'react-router-dom';\nimport { Card } from '@/components/Card';\nimport { SimpleCodeEditor } from '@/components/SimpleCodeEditor';\nimport { KeyPalette, type PaletteKey } from '@/components/KeyPalette';\nimport { DeviceSelector, type Device } from '@/components/DeviceSelector';\nimport { KeyConfigModal } from '@/components/KeyConfigModal';\nimport { LayerSwitcher } from '@/components/LayerSwitcher';\nimport { KeyboardVisualizer } from '@/components/KeyboardVisualizer';\nimport { useGetProfileConfig, useSetProfileConfig } from '@/hooks/useProfileConfig';\nimport { useProfiles, useCreateProfile } from '@/hooks/useProfiles';\nimport { useUnifiedApi } from '@/hooks/useUnifiedApi';\nimport { useDevices } from '@/hooks/useDevices';\nimport { useRhaiSyncEngine } from '@/components/RhaiSyncEngine';\nimport { extractDevicePatterns, hasGlobalMappings } from '@/utils/rhaiParser';\nimport type { KeyMapping } from '@/types';\nimport type { KeyMapping as RhaiKeyMapping } from '@/utils/rhaiParser';\n\ninterface ConfigPageProps {\n  profileName?: string;\n}\n\nconst ConfigPage: React.FC<ConfigPageProps> = ({\n  profileName: propProfileName,\n}) => {\n  const [searchParams] = useSearchParams();\n  const navigate = useNavigate();\n  const { name: profileNameFromRoute } = useParams<{ name: string }>();\n  const profileNameFromQuery = searchParams.get('profile');\n  const defaultProfileName = propProfileName || profileNameFromRoute || profileNameFromQuery || 'Default';\n\n  const [selectedProfileName, setSelectedProfileName] = useState<string>(defaultProfileName);\n\n  const api = useUnifiedApi();\n  const [activeTab, setActiveTab] = useState<'visual' | 'code'>('visual');\n\n  // Initialize RhaiSyncEngine for bidirectional sync\n  const syncEngine = useRhaiSyncEngine({\n    storageKey: `profile-${selectedProfileName}`,\n    debounceMs: 500,\n    onStateChange: (state) => {\n      console.debug('Sync state changed:', state);\n    },\n    onError: (error, direction) => {\n      console.error('Sync error:', { error, direction });\n    },\n  });\n\n  // Fetch available profiles\n  const { data: profiles, isLoading: isLoadingProfiles } = useProfiles();\n  const { mutateAsync: createProfile } = useCreateProfile();\n\n  // Visual editor state\n  const [selectedPaletteKey, setSelectedPaletteKey] = useState<PaletteKey | null>(null);\n  const [selectedPhysicalKey, setSelectedPhysicalKey] = useState<string | null>(null);\n  const [keyMappings, setKeyMappings] = useState<Map<string, KeyMapping>>(new Map());\n  const [selectedDevices, setSelectedDevices] = useState<string[]>([]);\n  const [globalSelected, setGlobalSelected] = useState<boolean>(true);\n  const [activeLayer, setActiveLayer] = useState<string>('base');\n  const [isModalOpen, setIsModalOpen] = useState(false);\n\n  // Available layers\n  const availableLayers = ['base', 'md-00', 'md-01', 'md-02', 'md-03', 'md-04', 'md-05'];\n\n  // Query for profile config - doesn't block rendering\n  const { data: profileConfig, isLoading, error } = useGetProfileConfig(selectedProfileName);\n  const { mutateAsync: setProfileConfig } = useSetProfileConfig();\n\n  // Fetch devices\n  const { data: devicesData } = useDevices();\n\n  // Merged device list: connected devices + devices from Rhai (even if disconnected)\n  const [mergedDevices, setMergedDevices] = useState<Device[]>([]);\n\n  // Auto-select first profile if \"Default\" doesn't exist and profiles are loaded\n  useEffect(() => {\n    if (profiles && profiles.length > 0 && !profiles.some(p => p.name === selectedProfileName)) {\n      setSelectedProfileName(profiles[0].name);\n    }\n  }, [profiles, selectedProfileName]);\n\n  // Check if selected profile exists\n  const profileExists = profiles?.some(p => p.name === selectedProfileName);\n\n  // Check if config file exists\n  const configExists = !isLoading && !error && profileConfig?.source;\n  const configMissing = !isLoading && !error && profileExists && !profileConfig?.source;\n\n  // Update sync engine when profile config loads\n  useEffect(() => {\n    if (profileConfig?.source) {\n      // Initialize sync engine with loaded config\n      syncEngine.onCodeChange(profileConfig.source);\n    } else if (configMissing) {\n      // Default config template when config file doesn't exist\n      const defaultTemplate = `// Configuration for profile: ${selectedProfileName}\n// This is a new configuration file\n\n// Example: Simple key remapping\n// map(\"A\", \"B\");  // Press A → outputs B\n\n// Example: Tap/Hold behavior\n// tap_hold(\"CapsLock\", \"Escape\", \"LCtrl\", 200);\n\n// Add your key mappings here...\n`;\n      syncEngine.onCodeChange(defaultTemplate);\n    }\n  }, [profileConfig, configMissing, selectedProfileName]);\n\n  // Rhai-driven device detection: Extract devices from parsed Rhai and merge with connected devices\n  useEffect(() => {\n    const ast = syncEngine.getAST();\n    if (!ast) {\n      // No AST yet, just use connected devices\n      setMergedDevices(\n        devicesData?.map((d) => ({\n          id: d.id,\n          name: d.name,\n          serial: d.serial || undefined,\n          connected: true,\n        })) || []\n      );\n      return;\n    }\n\n    // Extract device patterns from Rhai script\n    const devicePatternsInRhai = extractDevicePatterns(ast);\n\n    // Create a map of connected devices by serial/name/id\n    const connectedDeviceMap = new Map<string, NonNullable<typeof devicesData>[number]>();\n    devicesData?.forEach((device) => {\n      if (device.serial) connectedDeviceMap.set(device.serial, device);\n      connectedDeviceMap.set(device.name, device);\n      connectedDeviceMap.set(device.id, device);\n    });\n\n    // Build merged device list\n    const merged: Device[] = [];\n    const addedPatterns = new Set<string>();\n\n    // Add devices from Rhai (may be disconnected)\n    devicePatternsInRhai.forEach((pattern) => {\n      if (addedPatterns.has(pattern)) return;\n      addedPatterns.add(pattern);\n\n      // Try to find matching connected device\n      const connectedDevice = connectedDeviceMap.get(pattern);\n      if (connectedDevice) {\n        // Device is both in Rhai and connected\n        merged.push({\n          id: connectedDevice.id,\n          name: connectedDevice.name,\n          serial: connectedDevice.serial || undefined,\n          connected: true,\n        });\n      } else {\n        // Device in Rhai but not connected (disconnected device)\n        merged.push({\n          id: `disconnected-${pattern}`,\n          name: pattern, // Use pattern as name for disconnected devices\n          serial: pattern,\n          connected: false,\n        });\n      }\n    });\n\n    // Add connected devices not in Rhai\n    devicesData?.forEach((device) => {\n      const isInRhai =\n        devicePatternsInRhai.includes(device.serial || '') ||\n        devicePatternsInRhai.includes(device.name) ||\n        devicePatternsInRhai.includes(device.id);\n\n      if (!isInRhai) {\n        merged.push({\n          id: device.id,\n          name: device.name,\n          serial: device.serial || undefined,\n          connected: true,\n        });\n      }\n    });\n\n    setMergedDevices(merged);\n\n    // Auto-populate device selector based on Rhai content\n    // If Rhai has global mappings, select global\n    if (hasGlobalMappings(ast)) {\n      setGlobalSelected(true);\n    }\n\n    // If Rhai has device blocks, auto-select those devices\n    if (devicePatternsInRhai.length > 0) {\n      const devicesToSelect = merged\n        .filter((device) => {\n          const pattern = device.serial || device.name;\n          return devicePatternsInRhai.includes(pattern);\n        })\n        .map((device) => device.id);\n\n      if (devicesToSelect.length > 0) {\n        setSelectedDevices(devicesToSelect);\n      }\n    }\n  }, [syncEngine.state, devicesData]); // Re-run when sync state changes (parsing complete) or devices change\n\n  // Sync visual editor state from parsed AST when transitioning to visual tab or when code changes\n  useEffect(() => {\n    // Only sync when on visual tab and state is idle (parsing complete)\n    if (activeTab !== 'visual' || syncEngine.state !== 'idle') return;\n\n    const ast = syncEngine.getAST();\n    if (!ast) return;\n\n    // Helper to convert RhaiKeyMapping to visual KeyMapping\n    const convertToVisualMapping = (m: RhaiKeyMapping): KeyMapping => {\n      const visualMapping: KeyMapping = {\n        type: m.type,\n      };\n\n      if (m.type === 'simple' && m.targetKey) {\n        visualMapping.tapAction = m.targetKey;\n      } else if (m.type === 'tap_hold' && m.tapHold) {\n        visualMapping.tapAction = m.tapHold.tapAction;\n        visualMapping.holdAction = m.tapHold.holdAction;\n        visualMapping.threshold = m.tapHold.thresholdMs;\n      } else if (m.type === 'macro' && m.macro) {\n        visualMapping.macroSteps = m.macro.keys.map((key) => ({\n          type: 'press' as const,\n          key,\n        }));\n      } else if (m.type === 'layer_switch' && m.layerSwitch) {\n        visualMapping.targetLayer = m.layerSwitch.layerId;\n      }\n\n      return visualMapping;\n    };\n\n    // Convert RhaiAST to visual editor KeyMapping format\n    const newMappings = new Map<string, KeyMapping>();\n\n    // Add global mappings if global is selected\n    if (globalSelected) {\n      ast.globalMappings.forEach((m) => {\n        newMappings.set(m.sourceKey, convertToVisualMapping(m));\n      });\n    }\n\n    // Add device-specific mappings for selected devices\n    if (selectedDevices.length > 0 && devicesData) {\n      ast.deviceBlocks.forEach((block) => {\n        // Check if this device block matches any selected device\n        const matchesSelectedDevice = devicesData.some((device) => {\n          const isSelected = selectedDevices.includes(device.id);\n          const matchesPattern =\n            block.pattern === device.serial ||\n            block.pattern === device.name ||\n            block.pattern === device.id;\n          return isSelected && matchesPattern;\n        });\n\n        if (matchesSelectedDevice) {\n          block.mappings.forEach((m) => {\n            // Device-specific mappings override global mappings\n            newMappings.set(m.sourceKey, convertToVisualMapping(m));\n          });\n        }\n      });\n    }\n\n    setKeyMappings(newMappings);\n  }, [activeTab, syncEngine.state, globalSelected, selectedDevices, devicesData]);\n\n  // Handle profile selection change\n  const handleProfileChange = (newProfileName: string) => {\n    setSelectedProfileName(newProfileName);\n    navigate(`/config?profile=${newProfileName}`);\n  };\n\n  // Handle profile creation\n  const handleCreateProfile = async () => {\n    try {\n      await createProfile({ name: selectedProfileName, template: 'blank' });\n    } catch (err) {\n      console.error('Failed to create profile:', err);\n    }\n  };\n\n  const handleSaveConfig = async () => {\n    try {\n      await setProfileConfig({ name: selectedProfileName, source: syncEngine.getCode() });\n    } catch (err) {\n      console.error('Failed to save config:', err);\n    }\n  };\n\n  // Handle key click: open modal for configuration\n  const handlePhysicalKeyClick = (keyCode: string) => {\n    setSelectedPhysicalKey(keyCode);\n    setIsModalOpen(true);\n  };\n\n  // Handle save from modal\n  const handleSaveMapping = (mapping: KeyMapping) => {\n    if (selectedPhysicalKey) {\n      const newMappings = new Map(keyMappings);\n      newMappings.set(selectedPhysicalKey, mapping);\n      setKeyMappings(newMappings);\n\n      // Convert visual editor state to RhaiAST and trigger sync\n      const convertToRhaiMappings = (mappings: Map<string, KeyMapping>): RhaiKeyMapping[] => {\n        return Array.from(mappings.entries()).map(([key, m]) => {\n          const baseMapping: RhaiKeyMapping = {\n            type: m.type,\n            sourceKey: key,\n            line: 0,\n          };\n\n          if (m.type === 'simple' && m.tapAction) {\n            baseMapping.targetKey = m.tapAction;\n          } else if (m.type === 'tap_hold' && m.tapAction && m.holdAction) {\n            baseMapping.tapHold = {\n              tapAction: m.tapAction,\n              holdAction: m.holdAction,\n              thresholdMs: m.threshold || 200,\n            };\n          } else if (m.type === 'macro' && m.macroSteps) {\n            baseMapping.macro = {\n              keys: m.macroSteps.filter(s => s.key).map(s => s.key!),\n              delayMs: m.macroSteps.find(s => s.delayMs)?.delayMs,\n            };\n          } else if (m.type === 'layer_switch' && m.targetLayer) {\n            baseMapping.layerSwitch = {\n              layerId: m.targetLayer,\n            };\n          }\n\n          return baseMapping;\n        });\n      };\n\n      // Build device blocks based on current selection\n      const deviceBlocks = selectedDevices.map((deviceId, index) => {\n        const device = devices.find((d) => d.id === deviceId);\n        if (!device) return null;\n\n        return {\n          pattern: device.serial || device.name,\n          mappings: convertToRhaiMappings(newMappings),\n          layers: [],\n          startLine: 0,\n          endLine: 0,\n        };\n      }).filter((block): block is NonNullable<typeof block> => block !== null);\n\n      // Update sync engine with new AST\n      syncEngine.onVisualChange({\n        imports: [],\n        globalMappings: globalSelected ? convertToRhaiMappings(newMappings) : [],\n        deviceBlocks,\n        comments: [],\n      });\n    }\n  };\n\n  // Use merged device list (connected + disconnected from Rhai)\n  const devices: Device[] = mergedDevices;\n\n  // Get all available keys for modal (will be passed from KeyPalette component data)\n  // For now, use a simplified list\n  const getAllAvailableKeys = (): PaletteKey[] => {\n    // This should include all VK_, MD_, LK_ keys\n    // For now returning empty array, will be populated from KeyPalette\n    return [];\n  };\n\n  return (\n    <div className=\"flex flex-col gap-4 md:gap-6 p-4 md:p-6 lg:p-8\">\n      {/* Header with Profile Selector */}\n      <div className=\"flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4\">\n        <div className=\"flex-1\">\n          <h1 className=\"text-2xl md:text-3xl font-bold text-slate-100 mb-3\">\n            Configuration Editor\n          </h1>\n\n          {/* Profile Selector */}\n          <div className=\"flex items-center gap-3 flex-wrap\">\n            <label htmlFor=\"profile-selector\" className=\"text-sm font-medium text-slate-300\">\n              Profile:\n            </label>\n            <select\n              id=\"profile-selector\"\n              value={selectedProfileName}\n              onChange={(e) => handleProfileChange(e.target.value)}\n              disabled={isLoadingProfiles || !api.isConnected}\n              className=\"px-4 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 font-medium focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50\"\n            >\n              {profiles?.map((profile) => (\n                <option key={profile.name} value={profile.name}>\n                  {profile.name}\n                </option>\n              ))}\n            </select>\n\n            {/* Status indicators */}\n            {!api.isConnected && (\n              <span className=\"text-xs px-2 py-1 bg-yellow-900/30 border border-yellow-500 text-yellow-400 rounded\">\n                ⚠️ Disconnected\n              </span>\n            )}\n            {isLoading && api.isConnected && (\n              <span className=\"text-xs px-2 py-1 bg-blue-900/30 border border-blue-500 text-blue-400 rounded\">\n                ⏳ Loading configuration...\n              </span>\n            )}\n            {configExists && (\n              <span className=\"text-xs px-2 py-1 bg-green-900/30 border border-green-500 text-green-400 rounded\">\n                ✅ Loaded\n              </span>\n            )}\n            {configMissing && (\n              <span className=\"text-xs px-2 py-1 bg-orange-900/30 border border-orange-500 text-orange-400 rounded\">\n                📝 New configuration\n              </span>\n            )}\n            {error && (\n              <span className=\"text-xs px-2 py-1 bg-red-900/30 border border-red-500 text-red-400 rounded\">\n                ❌ Error\n              </span>\n            )}\n            {!profileExists && !isLoading && api.isConnected && (\n              <span className=\"text-xs px-2 py-1 bg-orange-900/30 border border-orange-500 text-orange-400 rounded\">\n                ⚠️ Profile not found\n              </span>\n            )}\n          </div>\n\n          {/* Error message with action */}\n          {!profileExists && !isLoading && api.isConnected && (\n            <div className=\"mt-3 p-3 bg-orange-900/20 border border-orange-500 rounded-md\">\n              <p className=\"text-sm text-orange-300 mb-2\">\n                Profile \"{selectedProfileName}\" does not exist.\n              </p>\n              <button\n                onClick={handleCreateProfile}\n                className=\"px-4 py-1.5 bg-orange-600 hover:bg-orange-500 text-white text-sm font-medium rounded transition-colors\"\n              >\n                Create Profile \"{selectedProfileName}\"\n              </button>\n            </div>\n          )}\n\n          {configMissing && (\n            <div className=\"mt-3 p-3 bg-blue-900/20 border border-blue-500 rounded-md\">\n              <p className=\"text-sm text-blue-300\">\n                📝 No configuration file found for \"{selectedProfileName}\". A template has been loaded - click <strong>Save Configuration</strong> to create it.\n              </p>\n            </div>\n          )}\n\n          {error && (\n            <div className=\"mt-3 p-3 bg-red-900/20 border border-red-500 rounded-md\">\n              <p className=\"text-sm text-red-300\">\n                {error instanceof Error ? error.message : 'Failed to load configuration'}\n              </p>\n            </div>\n          )}\n        </div>\n\n        <button\n          onClick={handleSaveConfig}\n          disabled={!api.isConnected || !profileExists}\n          className=\"px-6 py-3 bg-primary-500 text-white font-medium rounded-md hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n        >\n          {configMissing ? 'Create Configuration' : 'Save Configuration'}\n        </button>\n      </div>\n\n      {/* Tabs */}\n      <div className=\"flex gap-2 border-b border-slate-700\">\n        <button\n          onClick={() => setActiveTab('visual')}\n          className={`px-4 py-2 font-medium transition-colors ${\n            activeTab === 'visual'\n              ? 'text-primary-400 border-b-2 border-primary-400'\n              : 'text-slate-400 hover:text-slate-300'\n          }`}\n        >\n          Visual Editor\n        </button>\n        <button\n          onClick={() => setActiveTab('code')}\n          className={`px-4 py-2 font-medium transition-colors ${\n            activeTab === 'code'\n              ? 'text-primary-400 border-b-2 border-primary-400'\n              : 'text-slate-400 hover:text-slate-300'\n          }`}\n        >\n          Code Editor\n        </button>\n      </div>\n\n      {/* Content */}\n      {activeTab === 'visual' ? (\n        <>\n          {/* Device Selector (compact at top) */}\n          <DeviceSelector\n            devices={devices}\n            selectedDevices={selectedDevices}\n            globalSelected={globalSelected}\n            onSelectionChange={(deviceIds, global) => {\n              setSelectedDevices(deviceIds);\n              setGlobalSelected(global);\n            }}\n          />\n\n          {/* KEYBOARD DISPLAY - Shows Global and/or Device-Specific Keyboards */}\n          {globalSelected && (\n            <Card className=\"bg-gradient-to-br from-slate-800 to-slate-900\">\n              <h3 className=\"text-xl font-bold text-primary-400 mb-4\">\n                Global Keyboard (All Devices)\n              </h3>\n              <div className=\"flex justify-center p-4\">\n                <KeyboardVisualizer\n                  layout=\"ANSI_104\"\n                  keyMappings={keyMappings}\n                  onKeyClick={handlePhysicalKeyClick}\n                  simulatorMode={false}\n                />\n              </div>\n              <p className=\"text-center text-sm text-slate-400 mt-4\">\n                Click any key to configure global mappings\n              </p>\n            </Card>\n          )}\n\n          {/* Device-Specific Keyboards */}\n          {selectedDevices.length > 0 && devices\n            .filter((d) => selectedDevices.includes(d.id))\n            .map((device) => (\n              <Card key={device.id} className=\"bg-gradient-to-br from-slate-800 to-slate-900\">\n                <h3 className=\"text-xl font-bold text-primary-400 mb-4\">\n                  {device.name}\n                  {device.serial && (\n                    <span className=\"ml-2 text-sm text-slate-400 font-normal\">\n                      ({device.serial})\n                    </span>\n                  )}\n                </h3>\n                <div className=\"flex justify-center p-4\">\n                  <KeyboardVisualizer\n                    layout=\"ANSI_104\"\n                    keyMappings={keyMappings}\n                    onKeyClick={handlePhysicalKeyClick}\n                    simulatorMode={false}\n                  />\n                </div>\n                <p className=\"text-center text-sm text-slate-400 mt-4\">\n                  Click any key to configure device-specific mappings for {device.name}\n                </p>\n              </Card>\n            ))}\n\n          {/* Warning if no selection */}\n          {!globalSelected && selectedDevices.length === 0 && (\n            <Card className=\"bg-yellow-900/20 border border-yellow-700/50\">\n              <div className=\"text-center py-8\">\n                <p className=\"text-yellow-200 text-lg mb-2\">⚠️ No devices selected</p>\n                <p className=\"text-yellow-300 text-sm\">\n                  Select at least one device or \"Global\" to configure key mappings\n                </p>\n              </div>\n            </Card>\n          )}\n\n          {/* Layer Switcher */}\n          <LayerSwitcher\n            activeLayer={activeLayer}\n            availableLayers={availableLayers}\n            onLayerChange={setActiveLayer}\n          />\n\n          {/* Legend - Color coding */}\n          <div className=\"flex gap-4 flex-wrap text-xs text-slate-400 px-2\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 rounded bg-green-500\"></div>\n              <span>Simple</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 rounded bg-primary-500\"></div>\n              <span>Modifier</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 rounded bg-purple-500\"></div>\n              <span>Lock</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 rounded bg-red-500\"></div>\n              <span>Tap/Hold</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 rounded bg-yellow-500\"></div>\n              <span>Layer Active</span>\n            </div>\n          </div>\n\n          {/* Key Palette - Comprehensive list at bottom */}\n          <Card>\n            <KeyPalette\n              onKeySelect={setSelectedPaletteKey}\n              selectedKey={selectedPaletteKey}\n            />\n          </Card>\n\n          {/* Configuration Modal */}\n          {isModalOpen && selectedPhysicalKey && (\n            <KeyConfigModal\n              isOpen={isModalOpen}\n              onClose={() => setIsModalOpen(false)}\n              physicalKey={selectedPhysicalKey}\n              currentMapping={keyMappings.get(selectedPhysicalKey)}\n              onSave={handleSaveMapping}\n              availableKeys={getAllAvailableKeys()}\n            />\n          )}\n        </>\n      ) : (\n        <div className=\"flex flex-col gap-4\">\n          {/* Sync status indicator */}\n          {syncEngine.state !== 'idle' && (\n            <div className=\"flex items-center gap-2 px-4 py-2 bg-slate-700 border border-slate-600 rounded-md\">\n              {syncEngine.state === 'parsing' && (\n                <>\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-400\"></div>\n                  <span className=\"text-sm text-slate-300\">Parsing Rhai script...</span>\n                </>\n              )}\n              {syncEngine.state === 'generating' && (\n                <>\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-400\"></div>\n                  <span className=\"text-sm text-slate-300\">Generating code...</span>\n                </>\n              )}\n              {syncEngine.state === 'syncing' && (\n                <>\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-400\"></div>\n                  <span className=\"text-sm text-slate-300\">Syncing...</span>\n                </>\n              )}\n            </div>\n          )}\n\n          {/* Parse error display */}\n          {syncEngine.error && (\n            <div className=\"p-4 bg-red-900/20 border border-red-500 rounded-md\">\n              <div className=\"flex items-start gap-3\">\n                <span className=\"text-red-400 text-xl\">⚠️</span>\n                <div className=\"flex-1\">\n                  <h4 className=\"text-red-400 font-semibold mb-1\">Parse Error</h4>\n                  <p className=\"text-sm text-red-300 mb-2\">\n                    Line {syncEngine.error.line}, Column {syncEngine.error.column}: {syncEngine.error.message}\n                  </p>\n                  {syncEngine.error.suggestion && (\n                    <p className=\"text-sm text-slate-300 italic\">\n                      💡 {syncEngine.error.suggestion}\n                    </p>\n                  )}\n                </div>\n                <button\n                  onClick={() => syncEngine.clearError()}\n                  className=\"text-slate-400 hover:text-slate-300 transition-colors\"\n                  aria-label=\"Clear error\"\n                >\n                  ✕\n                </button>\n              </div>\n            </div>\n          )}\n\n          <Card variant=\"default\" padding=\"lg\">\n            <SimpleCodeEditor\n              value={syncEngine.getCode()}\n              onChange={(value) => syncEngine.onCodeChange(value)}\n              height=\"600px\"\n              language=\"javascript\"\n            />\n          </Card>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default ConfigPage;\n","/**\n * RhaiSyncEngine - Bidirectional synchronization between visual and code editors\n *\n * This component manages the synchronization between the visual configuration\n * editor (KeyboardVisualizer with key mappings) and the Monaco code editor\n * (Rhai script). It ensures both views stay in sync while preserving user\n * edits and handling errors gracefully.\n *\n * Key features:\n * - Bidirectional sync: visual ↔ code\n * - Debounced parsing of code changes (500ms)\n * - Immediate code generation from visual changes\n * - State machine: idle → parsing/generating → syncing → idle/error\n * - Graceful error handling with last valid state preservation\n * - LocalStorage persistence of unsaved changes\n *\n * @module RhaiSyncEngine\n */\n\nimport { useEffect, useRef, useState, useCallback } from 'react';\nimport { parseRhaiScript, type RhaiAST, type ParseError } from '../utils/rhaiParser';\nimport { generateRhaiScript } from '../utils/rhaiCodeGen';\n\n/**\n * Sync state machine states\n */\nexport type SyncState = 'idle' | 'parsing' | 'generating' | 'syncing' | 'error';\n\n/**\n * Direction of the sync operation\n */\nexport type SyncDirection = 'visual-to-code' | 'code-to-visual' | 'none';\n\n/**\n * Sync engine configuration options\n */\nexport interface RhaiSyncEngineOptions {\n  /** Unique identifier for localStorage persistence (e.g., profileId) */\n  storageKey: string;\n  /** Debounce delay for code editor changes in milliseconds (default: 500) */\n  debounceMs?: number;\n  /** Whether to enable localStorage persistence (default: true) */\n  enablePersistence?: boolean;\n  /** Callback when sync state changes */\n  onStateChange?: (state: SyncState) => void;\n  /** Callback when sync error occurs */\n  onError?: (error: ParseError, direction: SyncDirection) => void;\n}\n\n/**\n * Sync engine result\n */\nexport interface RhaiSyncEngineResult {\n  /** Current sync state */\n  state: SyncState;\n  /** Current sync direction */\n  direction: SyncDirection;\n  /** Parse error if state is 'error' */\n  error: ParseError | null;\n  /** Last valid AST (preserved during errors) */\n  lastValidAST: RhaiAST | null;\n  /** Handle code editor changes */\n  onCodeChange: (code: string) => void;\n  /** Handle visual editor changes */\n  onVisualChange: (ast: RhaiAST) => void;\n  /** Get current code content */\n  getCode: () => string;\n  /** Get current AST */\n  getAST: () => RhaiAST | null;\n  /** Clear error state and restore last valid state */\n  clearError: () => void;\n  /** Force sync in a specific direction */\n  forceSync: (direction: SyncDirection) => void;\n}\n\n/**\n * Custom hook for bidirectional Rhai sync engine\n *\n * @example\n * ```tsx\n * function ConfigEditor({ profileId }) {\n *   const {\n *     state,\n *     error,\n *     onCodeChange,\n *     onVisualChange,\n *     getCode,\n *     getAST\n *   } = useRhaiSyncEngine({\n *     storageKey: `profile-${profileId}`,\n *     onError: (err) => console.error('Sync error:', err)\n *   });\n *\n *   return (\n *     <>\n *       <MonacoEditor value={getCode()} onChange={onCodeChange} />\n *       <KeyboardVisualizer ast={getAST()} onChange={onVisualChange} />\n *       {state === 'error' && <ErrorBanner error={error} />}\n *     </>\n *   );\n * }\n * ```\n */\nexport function useRhaiSyncEngine(options: RhaiSyncEngineOptions): RhaiSyncEngineResult {\n  const {\n    storageKey,\n    debounceMs = 500,\n    enablePersistence = true,\n    onStateChange,\n    onError,\n  } = options;\n\n  // State management\n  const [state, setState] = useState<SyncState>('idle');\n  const [direction, setDirection] = useState<SyncDirection>('none');\n  const [error, setError] = useState<ParseError | null>(null);\n  const [lastValidAST, setLastValidAST] = useState<RhaiAST | null>(null);\n\n  // Refs to track current values and prevent stale closures\n  const codeRef = useRef<string>('');\n  const astRef = useRef<RhaiAST | null>(null);\n  const debounceTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const isMountedRef = useRef(true);\n  const syncLockRef = useRef(false); // Prevent infinite sync loops\n\n  // Update state and notify\n  const updateState = useCallback((newState: SyncState) => {\n    setState(newState);\n    onStateChange?.(newState);\n  }, [onStateChange]);\n\n  // Load from localStorage on mount\n  useEffect(() => {\n    if (!enablePersistence) return;\n\n    try {\n      const saved = localStorage.getItem(`rhai-sync-${storageKey}`);\n      if (saved) {\n        const { code, timestamp } = JSON.parse(saved);\n        // Only restore if saved within last 24 hours\n        const age = Date.now() - timestamp;\n        if (age < 24 * 60 * 60 * 1000) {\n          codeRef.current = code;\n          // Parse the restored code\n          const result = parseRhaiScript(code);\n          if (result.success && result.ast) {\n            astRef.current = result.ast;\n            setLastValidAST(result.ast);\n          }\n        } else {\n          // Clear old data\n          localStorage.removeItem(`rhai-sync-${storageKey}`);\n        }\n      }\n    } catch (err) {\n      console.warn('Failed to restore from localStorage:', err);\n    }\n  }, [storageKey, enablePersistence]);\n\n  // Save to localStorage\n  const persistToStorage = useCallback((code: string) => {\n    if (!enablePersistence) return;\n\n    try {\n      localStorage.setItem(\n        `rhai-sync-${storageKey}`,\n        JSON.stringify({\n          code,\n          timestamp: Date.now(),\n        })\n      );\n    } catch (err) {\n      console.warn('Failed to save to localStorage:', err);\n    }\n  }, [storageKey, enablePersistence]);\n\n  // Cleanup on unmount\n  useEffect(() => {\n    return () => {\n      isMountedRef.current = false;\n      if (debounceTimerRef.current) {\n        clearTimeout(debounceTimerRef.current);\n      }\n    };\n  }, []);\n\n  // Parse code and update AST (code → visual)\n  const parseCode = useCallback((code: string) => {\n    if (!isMountedRef.current || syncLockRef.current) return;\n\n    syncLockRef.current = true;\n    updateState('parsing');\n    setDirection('code-to-visual');\n\n    // Small delay to allow UI to update\n    setTimeout(() => {\n      if (!isMountedRef.current) return;\n\n      const result = parseRhaiScript(code);\n\n      if (result.success && result.ast) {\n        // Success: update AST and last valid state\n        astRef.current = result.ast;\n        setLastValidAST(result.ast);\n        setError(null);\n        updateState('idle');\n        setDirection('none');\n      } else if (result.error) {\n        // Error: preserve last valid AST, show error\n        setError(result.error);\n        updateState('error');\n        onError?.(result.error, 'code-to-visual');\n      }\n\n      syncLockRef.current = false;\n    }, 10);\n  }, [updateState, onError]);\n\n  // Generate code from AST (visual → code)\n  const generateCode = useCallback((ast: RhaiAST) => {\n    if (!isMountedRef.current || syncLockRef.current) return;\n\n    syncLockRef.current = true;\n    updateState('generating');\n    setDirection('visual-to-code');\n\n    // Small delay to allow UI to update\n    setTimeout(() => {\n      if (!isMountedRef.current) return;\n\n      try {\n        const code = generateRhaiScript(ast);\n        codeRef.current = code;\n        astRef.current = ast;\n        setLastValidAST(ast);\n        persistToStorage(code);\n        setError(null);\n        updateState('idle');\n        setDirection('none');\n      } catch (err) {\n        const error: ParseError = {\n          line: 0,\n          column: 0,\n          message: err instanceof Error ? err.message : 'Code generation failed',\n          suggestion: 'Check visual editor state for invalid mappings',\n        };\n        setError(error);\n        updateState('error');\n        onError?.(error, 'visual-to-code');\n      }\n\n      syncLockRef.current = false;\n    }, 10);\n  }, [updateState, onError, persistToStorage]);\n\n  // Handle code editor changes (debounced)\n  const onCodeChange = useCallback((code: string) => {\n    if (!isMountedRef.current) return;\n\n    codeRef.current = code;\n    persistToStorage(code);\n\n    // Clear existing debounce timer\n    if (debounceTimerRef.current) {\n      clearTimeout(debounceTimerRef.current);\n    }\n\n    // Set new debounce timer\n    debounceTimerRef.current = setTimeout(() => {\n      parseCode(code);\n    }, debounceMs);\n  }, [debounceMs, parseCode, persistToStorage]);\n\n  // Handle visual editor changes (immediate)\n  const onVisualChange = useCallback((ast: RhaiAST) => {\n    if (!isMountedRef.current) return;\n    generateCode(ast);\n  }, [generateCode]);\n\n  // Get current code\n  const getCode = useCallback(() => codeRef.current, []);\n\n  // Get current AST\n  const getAST = useCallback(() => astRef.current, []);\n\n  // Clear error and restore last valid state\n  const clearError = useCallback(() => {\n    setError(null);\n    updateState('idle');\n    setDirection('none');\n  }, [updateState]);\n\n  // Force sync in a specific direction\n  const forceSync = useCallback((syncDirection: SyncDirection) => {\n    if (syncDirection === 'code-to-visual') {\n      parseCode(codeRef.current);\n    } else if (syncDirection === 'visual-to-code' && astRef.current) {\n      generateCode(astRef.current);\n    }\n  }, [parseCode, generateCode]);\n\n  return {\n    state,\n    direction,\n    error,\n    lastValidAST,\n    onCodeChange,\n    onVisualChange,\n    getCode,\n    getAST,\n    clearError,\n    forceSync,\n  };\n}\n\n/**\n * RhaiSyncEngine component (wrapper for use in JSX)\n *\n * @example\n * ```tsx\n * <RhaiSyncEngine\n *   storageKey=\"profile-123\"\n *   onStateChange={(state) => console.log('State:', state)}\n * >\n *   {({ onCodeChange, onVisualChange, getCode, getAST, error }) => (\n *     <>\n *       <MonacoEditor value={getCode()} onChange={onCodeChange} />\n *       <KeyboardVisualizer ast={getAST()} onChange={onVisualChange} />\n *       {error && <ErrorBanner error={error} />}\n *     </>\n *   )}\n * </RhaiSyncEngine>\n * ```\n */\nexport function RhaiSyncEngine({\n  children,\n  ...options\n}: RhaiSyncEngineOptions & {\n  children: (result: RhaiSyncEngineResult) => React.ReactNode;\n}) {\n  const result = useRhaiSyncEngine(options);\n  return <>{children(result)}</>;\n}\n"],"names":["SimpleCodeEditor","value","onChange","readOnly","height","language","jsx","Editor","theme","newValue","options","minimap","enabled","fontSize","lineNumbers","scrollBeyondLastLine","automaticLayout","wordWrap","tabSize","insertSpaces","VIRTUAL_KEYS","id","label","category","MODIFIERS","description","LOCKS","LAYERS","KeyPalette","onKeySelect","selectedKey","activeCategory","setActiveCategory","React","useState","categories","keys","activeKeys","find","c","jsxs","Card","className","children","map","cat","onClick","key","title","DeviceSelector","devices","showGlobalOption","multiSelect","selectedDevices","globalSelected","onSelectionChange","onEditDevice","hasSelection","length","role","htmlFor","type","checked","device","includes","deviceId","newSelected","filter","handleDeviceToggle","name","connected","serial","layout","e","preventDefault","KeyConfigModal","isOpen","onClose","physicalKey","currentMapping","onSave","availableKeys","mappingType","setMappingType","tapAction","setTapAction","holdAction","setHoldAction","threshold","setThreshold","targetLayer","setTargetLayer","Modal","open","charAt","toUpperCase","slice","replace","target","Fragment","k","min","max","step","parseInt","Array","from","_","i","toString","padStart","disabled","LayerSwitcher","activeLayer","availableLayers","onLayerChange","customLayerInput","setCustomLayerInput","quickLayers","layer","onSubmit","layerNum","isNaN","layerName","placeholder","maxLength","parseRhaiScript","script","lines","split","ast","imports","globalMappings","deviceBlocks","comments","currentDeviceBlock","currentModifierLayer","lineNumber","line","trimmed","trim","commentMatch","match","push","text","blockCommentMatch","importMatch","path","alias","deviceStartMatch","success","error","message","column","suggestion","pattern","mappings","layers","startLine","endLine","whenStartMatch","modifiers","m","mapMatch","mapping","sourceKey","targetKey","tapHoldMatch","tapHold","thresholdMs","withModMatch","Error","DEFAULT_FORMAT_OPTIONS","indentSize","maxLineLength","blankLinesBetweenDevices","blankLinesBetweenSections","generateImportStatement","importStmt","generateComment","comment","generateDeviceBlock","allComments","opts","indent","repeat","blockComments","getCommentsForSection","generateKeyMapping","generateModifierLayer","baseIndentLevel","baseIndent","innerIndent","modifiersArg","isArray","join","indentLevel","startsWith","generateSimpleMapping","generateTapHoldMapping","macro","delayMs","keysStr","generateMacroMapping","layerSwitch","layerId","mode","generateLayerSwitchMapping","ConfigPage","profileName","propProfileName","searchParams","useSearchParams","navigate","useNavigate","profileNameFromRoute","useParams","profileNameFromQuery","get","defaultProfileName","selectedProfileName","setSelectedProfileName","api","useUnifiedApi","activeTab","setActiveTab","syncEngine","storageKey","debounceMs","enablePersistence","onStateChange","onError","state","setState","direction","setDirection","setError","lastValidAST","setLastValidAST","codeRef","useRef","astRef","debounceTimerRef","isMountedRef","syncLockRef","updateState","useCallback","newState","useEffect","saved","localStorage","getItem","code","timestamp","JSON","parse","Date","now","current","result","removeItem","err","persistToStorage","setItem","stringify","clearTimeout","parseCode","setTimeout","generateCode","globalComments","Number","MAX_SAFE_INTEGER","getFirstDeviceLineOrEnd","deviceBlock","j","generateRhaiScript","onCodeChange","onVisualChange","getCode","getAST","clearError","forceSync","syncDirection","useRhaiSyncEngine","data","profiles","isLoading","isLoadingProfiles","useProfiles","mutateAsync","createProfile","useCreateProfile","selectedPaletteKey","setSelectedPaletteKey","selectedPhysicalKey","setSelectedPhysicalKey","keyMappings","setKeyMappings","Map","setSelectedDevices","setGlobalSelected","setActiveLayer","isModalOpen","setIsModalOpen","profileConfig","useGetProfileConfig","setProfileConfig","useSetProfileConfig","devicesData","useDevices","mergedDevices","setMergedDevices","some","p","profileExists","configExists","source","configMissing","defaultTemplate","d","devicePatternsInRhai","block","extractDevicePatterns","connectedDeviceMap","forEach","set","merged","addedPatterns","Set","has","add","connectedDevice","hasGlobalMappings","devicesToSelect","convertToVisualMapping","visualMapping","macroSteps","newMappings","isSelected","matchesPattern","handlePhysicalKeyClick","keyCode","handleProfileChange","newProfileName","isConnected","profile","async","template","deviceIds","global","KeyboardVisualizer","onKeyClick","simulatorMode","convertToRhaiMappings","entries","baseMapping","s","index","variant","padding"],"mappings":"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"}