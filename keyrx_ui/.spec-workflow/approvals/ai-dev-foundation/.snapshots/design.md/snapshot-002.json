{
  "id": "snapshot_1766293390975_1iqnorq7f",
  "approvalId": "approval_1766293348950_hcm7h9pj4",
  "approvalTitle": "Design for AI development foundation",
  "version": 2,
  "timestamp": "2025-12-21T05:03:10.975Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe **AI-Dev-Foundation** establishes the critical infrastructure enabling fully autonomous AI-driven development of the keyrx project. This foundation consists of:\n\n1. **4-Crate Workspace Structure**: Properly initialized Rust workspace with keyrx_core, keyrx_compiler, keyrx_daemon, keyrx_ui\n2. **AI-Friendly Build Scripts**: Consistent, parseable scripts (build.sh, verify.sh, test.sh, launch.sh) with machine-readable output\n3. **CLAUDE.md Documentation**: Single source of truth for AI agent guidance\n4. **Quality Automation**: Pre-commit hooks and CI/CD for deterministic verification\n5. **Simplified Orchestration**: Makefile for top-level commands\n\nThis foundation is the **prerequisite for all feature development**, as it creates an environment where AI agents can autonomously implement, test, and verify work without human intervention.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**4-Crate Workspace Architecture**:\n- `keyrx_core`: no_std library with rkyv, boomphf, fixedbitset, arrayvec\n- `keyrx_compiler`: Binary with Rhai, serde, clap for CLI\n- `keyrx_daemon`: Binary with platform-specific features (linux/windows/web)\n- `keyrx_ui`: React 18+ with TypeScript 5+, Vite, WASM integration\n\n**AI-Coding-Agent-Friendly Scripts**:\n- Consistent markers: `=== accomplished ===`, `=== failed ===`, `=== warning ===`\n- Epoch-timestamped logs: `scripts/logs/build_$(date +%s).log`\n- Machine-parseable JSON output with `--json` flag\n- Error-focused debugging with `--error` flag\n\n**Quality Standards**:\n- Pre-commit hooks enforce clippy (warnings as errors), rustfmt, tests\n- CI/CD verifies 80% minimum test coverage (cargo-tarpaulin)\n- Max 500 lines/file, max 50 lines/function (enforced via clippy)\n\n### Project Structure (structure.md)\n\n**Directory Organization**:\n```\nkeyrx2/\n├── keyrx_core/           # Core library (no_std)\n├── keyrx_compiler/       # Compiler binary\n├── keyrx_daemon/         # Daemon binary with web server\n├── keyrx_ui/             # React frontend\n├── scripts/              # Build/test/launch automation\n│   ├── build.sh\n│   ├── verify.sh\n│   ├── test.sh\n│   ├── launch.sh\n│   ├── setup_hooks.sh\n│   ├── logs/             # Timestamped execution logs\n│   └── CLAUDE.md         # Script documentation\n├── .claude/\n│   └── CLAUDE.md         # AI agent guidance (root)\n├── .github/workflows/\n│   ├── ci.yml            # Continuous integration\n│   └── release.yml       # Release automation\n├── Makefile              # Top-level orchestration\n└── Cargo.toml            # Workspace configuration\n```\n\n**Naming Conventions**:\n- Rust: snake_case for modules, files, functions\n- Scripts: lowercase with .sh extension\n- Logs: `[script]_[epoch].log` format\n\n## Code Reuse Analysis\n\nThis is a **greenfield initialization** - no existing code to reuse. However, the design establishes **patterns for future reuse**:\n\n### Patterns Being Established\n\n**Script Library Pattern**:\n- Common functions (log_info, log_error, check_exit_code) will be extracted to `scripts/lib/common.sh`\n- All scripts source this library for consistency\n- AI agents can discover patterns by reading one file\n\n**CLAUDE.md as SSOT**:\n- All rules, patterns, conventions documented in two locations:\n  - `scripts/CLAUDE.md`: Script usage, flags, output formats\n  - `.claude/CLAUDE.md`: Code quality rules, architecture patterns\n- AI agents read these before making changes\n\n**CI/CD Reusability**:\n- GitHub Actions workflows use composite actions for repeated logic\n- Cache configuration (Cargo, npm) reused across jobs\n- Platform matrix (Linux, Windows) enables parallel verification\n\n## Architecture\n\n### Design Principles\n\n1. **Single Responsibility**: Each script does ONE thing (build, verify, test, launch)\n2. **Composability**: Scripts can call each other (e.g., verify.sh calls build.sh)\n3. **Consistency**: All scripts accept same flags (--error, --json, --quiet, --log-file)\n4. **Idempotency**: Scripts can run multiple times safely (no side effects)\n5. **Fail-Fast**: Scripts exit immediately on error with non-zero code\n\n### Script Architecture\n\n```mermaid\ngraph TD\n    A[User/AI Agent] --> B{Command}\n    B -->|make build| C[build.sh]\n    B -->|make verify| D[verify.sh]\n    B -->|make test| E[test.sh]\n    B -->|make launch| F[launch.sh]\n\n    D --> C\n    D --> G[clippy]\n    D --> H[rustfmt]\n    D --> E\n    D --> I[tarpaulin]\n\n    C --> J[cargo build]\n    E --> K[cargo test]\n    F --> L[keyrx_daemon]\n\n    C --> M[Log File]\n    D --> M\n    E --> M\n    F --> M\n\n    M --> N[=== accomplished ===]\n    M --> O[=== failed ===]\n```\n\n### Output Format Architecture\n\n**Three Output Modes**:\n\n1. **Standard Mode** (default):\n   - Human-readable logs: `[2025-12-21 04:55:17] [INFO] Building workspace...`\n   - Status markers: `=== accomplished ===` or `=== failed ===`\n   - Exit codes: 0 (success), 1 (error), 2 (warning)\n\n2. **JSON Mode** (`--json` flag):\n   - Structured logs: `{\"timestamp\":\"2025-12-21T04:55:17Z\",\"level\":\"INFO\",\"message\":\"Building workspace\"}`\n   - Final summary: `{\"status\":\"success\",\"duration_ms\":1234,\"tests_passed\":42}`\n   - AI agents parse this directly\n\n3. **Quiet Mode** (`--quiet` flag):\n   - Suppress all output except final status marker\n   - Useful for CI/CD and automated workflows\n\n## Components and Interfaces\n\n### Component 1: Workspace Initializer\n\n**Purpose**: Create 4-crate workspace with proper structure, dependencies, placeholders\n\n**Implementation**: Bash script `scripts/init_workspace.sh` (one-time use, not in Makefile)\n\n**Operations**:\n1. Create root `Cargo.toml` with workspace members\n2. Run `cargo new --lib keyrx_core` (then modify for no_std)\n3. Run `cargo new --bin keyrx_compiler`\n4. Run `cargo new --bin keyrx_daemon`\n5. Create `keyrx_ui` with `npm create vite@latest`\n6. Add dependencies to each crate's `Cargo.toml`\n7. Create placeholder modules (config.rs, lookup.rs, etc.)\n8. Create README.md for each crate\n9. Create root `.gitignore`\n\n**Exit Criteria**:\n- `cargo build --workspace` succeeds\n- `npm install` in keyrx_ui succeeds\n- All placeholder modules compile\n\n### Component 2: Build Script (build.sh)\n\n**Purpose**: Build all crates in workspace\n\n**Interface**:\n```bash\nscripts/build.sh [OPTIONS]\n\nOPTIONS:\n  --release        Build in release mode (optimized)\n  --watch          Continuous build on file changes (requires cargo-watch)\n  --error          Show only error-level messages\n  --json           Output machine-readable JSON\n  --quiet          Suppress all output except status markers\n  --log-file PATH  Write logs to custom path (default: scripts/logs/build_$(date +%s).log)\n```\n\n**Implementation**:\n```bash\n#!/bin/bash\nsource scripts/lib/common.sh\n\n# Parse arguments\nRELEASE_FLAG=\"\"\nWATCH=false\nwhile [[ $# -gt 0 ]]; do\n  case $1 in\n    --release) RELEASE_FLAG=\"--release\"; shift ;;\n    --watch) WATCH=true; shift ;;\n    # ... other flags\n  esac\ndone\n\n# Setup logging\nLOG_FILE=\"${LOG_FILE:-scripts/logs/build_$(date +%s).log}\"\nmkdir -p \"$(dirname \"$LOG_FILE\")\"\n\n# Execute build\nlog_info \"Building workspace...\"\nif [ \"$WATCH\" = true ]; then\n  cargo watch -x \"build $RELEASE_FLAG\" 2>&1 | tee -a \"$LOG_FILE\"\nelse\n  cargo build --workspace $RELEASE_FLAG 2>&1 | tee -a \"$LOG_FILE\"\nfi\n\ncheck_exit_code $? \"Build\"\n```\n\n**Dependencies**:\n- `cargo` (Rust toolchain)\n- `cargo-watch` (optional, for --watch flag)\n- `scripts/lib/common.sh` (shared functions)\n\n### Component 3: Verify Script (verify.sh)\n\n**Purpose**: Run all quality checks (clippy, fmt, tests, coverage)\n\n**Interface**:\n```bash\nscripts/verify.sh [OPTIONS]\n\nOPTIONS:\n  Same as build.sh, plus:\n  --skip-coverage  Skip test coverage check (faster CI)\n```\n\n**Implementation Flow**:\n1. Run `scripts/build.sh --quiet` (ensure clean build)\n2. Run `cargo clippy --workspace -- -D warnings`\n3. Run `cargo fmt --check`\n4. Run `cargo test --workspace`\n5. Run `cargo tarpaulin --workspace --out Xml --target-dir target/tarpaulin` (check 80% minimum)\n6. Output summary table:\n   ```\n   === Verification Summary ===\n   [✓] Build:        PASSED\n   [✓] Clippy:       PASSED\n   [✓] Format:       PASSED\n   [✓] Tests:        PASSED (42 tests)\n   [✓] Coverage:     PASSED (85%)\n   === accomplished ===\n   ```\n\n**Error Handling**:\n- If ANY check fails, abort immediately with `=== failed ===`\n- Output which check failed with actionable message\n- Exit code 1 on failure\n\n### Component 4: Test Script (test.sh)\n\n**Purpose**: Run tests with filtering options\n\n**Interface**:\n```bash\nscripts/test.sh [OPTIONS]\n\nOPTIONS:\n  --unit           Run only unit tests (lib tests)\n  --integration    Run only integration tests (tests/ directory)\n  --fuzz DURATION  Run fuzzing for DURATION seconds (default: 60)\n  --bench          Run benchmarks (requires nightly)\n  # ... standard flags (--error, --json, --quiet, --log-file)\n```\n\n**Implementation**:\n```bash\nif [ \"$UNIT\" = true ]; then\n  cargo test --lib --workspace\nelif [ \"$INTEGRATION\" = true ]; then\n  cargo test --test '*' --workspace\nelif [ \"$FUZZ\" != \"\" ]; then\n  cd keyrx_core/fuzz\n  cargo fuzz run fuzz_target_1 -- -max_total_time=\"$FUZZ\"\nelif [ \"$BENCH\" = true ]; then\n  cargo +nightly bench --workspace\nelse\n  # Run all tests\n  cargo test --workspace\nfi\n```\n\n### Component 5: Launch Script (launch.sh)\n\n**Purpose**: Start daemon with configuration\n\n**Interface**:\n```bash\nscripts/launch.sh [OPTIONS]\n\nOPTIONS:\n  --headless       Start daemon without web UI (no browser)\n  --debug          Enable debug-level logging\n  --config PATH    Use custom config file (default: ~/.config/keyrx/main.rhai)\n  # ... standard flags\n```\n\n**Implementation**:\n```bash\nCARGO_FLAGS=\"\"\nDAEMON_FLAGS=\"\"\n\n[ \"$DEBUG\" = true ] && DAEMON_FLAGS=\"$DAEMON_FLAGS --log-level debug\"\n[ \"$HEADLESS\" = true ] && DAEMON_FLAGS=\"$DAEMON_FLAGS --headless\"\n[ -n \"$CONFIG\" ] && DAEMON_FLAGS=\"$DAEMON_FLAGS --config $CONFIG\"\n\n# Build first (ensure up-to-date)\ncargo build --bin keyrx_daemon $CARGO_FLAGS\n\n# Launch daemon\n./target/debug/keyrx_daemon $DAEMON_FLAGS 2>&1 | tee -a \"$LOG_FILE\"\n```\n\n**Output on Success**:\n```\n[2025-12-21 05:00:00] [INFO] keyrx daemon starting...\n[2025-12-21 05:00:00] [INFO] PID: 12345\n[2025-12-21 05:00:00] [INFO] Web server: http://localhost:8080\n[2025-12-21 05:00:00] [INFO] WebSocket: ws://localhost:8080/ws\n=== accomplished ===\n```\n\n### Component 6: Setup Hooks Script (setup_hooks.sh)\n\n**Purpose**: Install pre-commit hooks for automated quality enforcement\n\n**Interface**:\n```bash\nscripts/setup_hooks.sh\n```\n\n**Implementation**:\n```bash\n#!/bin/bash\nHOOK_PATH=\".git/hooks/pre-commit\"\n\ncat > \"$HOOK_PATH\" << 'EOF'\n#!/bin/bash\n# Auto-generated pre-commit hook\necho \"Running pre-commit verification...\"\nscripts/verify.sh --quiet\n\nif [ $? -ne 0 ]; then\n  echo \"❌ Pre-commit checks failed. Commit aborted.\"\n  echo \"Fix errors and try again, or use 'git commit --no-verify' to skip (not recommended)\"\n  exit 1\nfi\nEOF\n\nchmod +x \"$HOOK_PATH\"\necho \"✓ Pre-commit hook installed at $HOOK_PATH\"\n```\n\n**Idempotency**: Safe to run multiple times (overwrites existing hook)\n\n### Component 7: CI/CD Workflows\n\n**Purpose**: Automated verification on every push/PR, release builds on tags\n\n#### Workflow 1: CI (.github/workflows/ci.yml)\n\n```yaml\nname: CI\n\non:\n  push:\n    branches: ['**']\n  pull_request:\n    branches: ['**']\n\njobs:\n  verify:\n    name: Verify Code Quality\n    runs-on: ${{ matrix.os }}\n    strategy:\n      matrix:\n        os: [ubuntu-latest, windows-latest]\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Setup Rust\n        uses: actions-rs/toolchain@v1\n        with:\n          toolchain: stable\n          components: rustfmt, clippy\n\n      - name: Cache Cargo\n        uses: actions/cache@v3\n        with:\n          path: |\n            ~/.cargo/registry\n            ~/.cargo/git\n            target\n          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}\n\n      - name: Install Tools\n        run: |\n          cargo install cargo-tarpaulin\n          cargo install cargo-watch\n\n      - name: Run Verification\n        run: scripts/verify.sh --json\n\n      - name: Upload Coverage\n        if: matrix.os == 'ubuntu-latest'\n        uses: actions/upload-artifact@v3\n        with:\n          name: coverage-report\n          path: cobertura.xml\n```\n\n#### Workflow 2: Release (.github/workflows/release.yml)\n\n```yaml\nname: Release\n\non:\n  push:\n    tags:\n      - 'v*.*.*'\n\njobs:\n  build-release:\n    name: Build Release Binaries\n    runs-on: ${{ matrix.os }}\n    strategy:\n      matrix:\n        include:\n          - os: ubuntu-latest\n            target: x86_64-unknown-linux-gnu\n          - os: windows-latest\n            target: x86_64-pc-windows-msvc\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Setup Rust\n        uses: actions-rs/toolchain@v1\n        with:\n          toolchain: stable\n          target: ${{ matrix.target }}\n\n      - name: Build Release\n        run: cargo build --release --target ${{ matrix.target }}\n\n      - name: Create Release\n        uses: softprops/action-gh-release@v1\n        with:\n          files: |\n            target/${{ matrix.target }}/release/keyrx_compiler*\n            target/${{ matrix.target }}/release/keyrx_daemon*\n```\n\n### Component 8: CLAUDE.md Documentation\n\n**Purpose**: Single source of truth for AI agent guidance\n\n#### File 1: scripts/CLAUDE.md\n\n**Sections**:\n1. **Script Reference Table**\n   - Script name, purpose, common flags, exit codes\n2. **Output Format Specification**\n   - Status markers (=== accomplished ===)\n   - Log format: `[YYYY-MM-DD HH:MM:SS] [LEVEL] message`\n   - JSON schema for `--json` mode\n3. **Example Commands**\n   - At least 3 examples per script\n4. **Failure Scenarios**\n   - Common errors and how to interpret them\n\n**Example Content**:\n```markdown\n# Script Reference\n\n## build.sh - Build Workspace\n\n**Purpose**: Compile all crates in the workspace\n\n**Common Flags**:\n- `--release`: Optimized build (slower compile, faster runtime)\n- `--watch`: Continuous build on file changes (requires cargo-watch)\n- `--error`: Show only errors (suppress INFO/DEBUG)\n- `--json`: Machine-readable JSON output\n- `--quiet`: Suppress all output except status marker\n\n**Exit Codes**:\n- 0: Build succeeded\n- 1: Build failed (compilation errors)\n\n**Examples**:\n```bash\n# Standard debug build\nscripts/build.sh\n\n# Release build with JSON output\nscripts/build.sh --release --json\n\n# Continuous development mode\nscripts/build.sh --watch\n```\n\n**Failure Scenarios**:\n- `error[E0425]: cannot find value`: Undefined variable/function\n  - **Fix**: Check imports, add missing dependency\n- `error: could not compile`: Syntax error in Rust code\n  - **Fix**: Read error message, fix syntax\n```\n\n#### File 2: .claude/CLAUDE.md\n\n**Sections**:\n1. **AI-Agent Quick Start**\n   - Steps to verify environment\n   - Run first build\n   - Run tests\n2. **Project Structure**\n   - 4-crate workspace overview\n   - Directory layout\n3. **Code Quality Rules**\n   - Max 500 lines/file (enforced by clippy)\n   - Max 50 lines/function\n   - 80% test coverage minimum\n4. **Architecture Patterns**\n   - SOLID principles\n   - Dependency injection\n   - SSOT (Single Source of Truth)\n   - KISS (Keep It Simple, Stupid)\n5. **Naming Conventions**\n   - Rust: snake_case for modules/functions, PascalCase for types\n   - TypeScript: camelCase for variables/functions, PascalCase for types/components\n6. **Common Tasks**\n   - How to add a new module\n   - How to add a test\n   - How to run specific tests\n\n### Component 9: Makefile\n\n**Purpose**: Top-level orchestration with simple commands\n\n**Interface**:\n```makefile\n.PHONY: help build verify test launch clean setup\n\n# Default target\n.DEFAULT_GOAL := help\n\nhelp:\n\t@echo \"Available targets:\"\n\t@echo \"  make build   - Build all crates\"\n\t@echo \"  make verify  - Run all quality checks (clippy, fmt, tests, coverage)\"\n\t@echo \"  make test    - Run tests\"\n\t@echo \"  make launch  - Start daemon\"\n\t@echo \"  make clean   - Remove build artifacts\"\n\t@echo \"  make setup   - Install dev tools and pre-commit hooks\"\n\nbuild:\n\t@scripts/build.sh\n\nverify:\n\t@scripts/verify.sh\n\ntest:\n\t@scripts/test.sh\n\nlaunch:\n\t@scripts/launch.sh\n\nclean:\n\t@cargo clean\n\t@rm -rf keyrx_ui/node_modules keyrx_ui/dist\n\t@rm -rf scripts/logs/*.log\n\nsetup:\n\t@echo \"Installing development tools...\"\n\t@cargo install cargo-watch cargo-tarpaulin cargo-fuzz wasm-pack\n\t@scripts/setup_hooks.sh\n\t@echo \"✓ Development environment ready\"\n```\n\n## Data Models\n\n### Script Output Format (Standard Mode)\n\n```\nStructure:\n[TIMESTAMP] [LEVEL] message\n\nExamples:\n[2025-12-21 05:00:17] [INFO] Building workspace...\n[2025-12-21 05:00:18] [ERROR] Compilation failed: undefined variable 'foo'\n[2025-12-21 05:00:19] [WARN] Test coverage below 80%: 75%\n\nStatus Markers:\n=== accomplished ===  (on success)\n=== failed ===        (on error)\n=== warning ===       (on non-critical issues)\n```\n\n### Script Output Format (JSON Mode)\n\n```json\n{\n  \"timestamp\": \"2025-12-21T05:00:17Z\",\n  \"level\": \"INFO|ERROR|WARN|DEBUG\",\n  \"message\": \"Human-readable message\",\n  \"context\": {\n    \"script\": \"build.sh\",\n    \"operation\": \"cargo_build\",\n    \"duration_ms\": 1234\n  }\n}\n```\n\n**Final Summary** (JSON mode):\n```json\n{\n  \"status\": \"success|failed|warning\",\n  \"duration_ms\": 5678,\n  \"operations\": [\n    {\"name\": \"cargo_build\", \"status\": \"success\", \"duration_ms\": 3000},\n    {\"name\": \"cargo_test\", \"status\": \"success\", \"duration_ms\": 2678, \"tests_passed\": 42}\n  ],\n  \"exit_code\": 0\n}\n```\n\n### Log File Format\n\n**Filename**: `scripts/logs/[script]_[epoch].log`\n\nExample: `scripts/logs/build_1766292917.log`\n\n**Content**: Same as stdout (either standard or JSON depending on flags)\n\n**Retention**: Logs persist indefinitely (AI agents can analyze historical runs)\n\n### Pre-Commit Hook Exit Codes\n\n```\n0: All checks passed (commit proceeds)\n1: Checks failed (commit aborted)\n```\n\n## Error Handling\n\n### Error Scenario 1: Build Failure\n\n**Description**: Rust compilation errors (syntax, type errors, missing dependencies)\n\n**Handling**:\n```bash\n# In build.sh\ncargo build --workspace 2>&1 | tee -a \"$LOG_FILE\"\nEXIT_CODE=${PIPESTATUS[0]}\n\nif [ $EXIT_CODE -ne 0 ]; then\n  log_error \"Build failed (exit code: $EXIT_CODE)\"\n  echo \"=== failed ===\" | tee -a \"$LOG_FILE\"\n  exit 1\nfi\n```\n\n**User/AI Impact**:\n- Script exits immediately with code 1\n- `=== failed ===` marker in output and log file\n- Error details in log (compiler error messages)\n- AI agent parses log, identifies error type, suggests fix\n\n### Error Scenario 2: Test Failures\n\n**Description**: Unit/integration tests fail\n\n**Handling**:\n```bash\n# In test.sh\ncargo test --workspace 2>&1 | tee -a \"$LOG_FILE\"\nEXIT_CODE=${PIPESTATUS[0]}\n\nif [ $EXIT_CODE -ne 0 ]; then\n  log_error \"Tests failed\"\n  # Parse output for failed test names\n  FAILED_TESTS=$(grep \"test result: FAILED\" \"$LOG_FILE\" || echo \"Unknown\")\n  log_error \"Failed tests: $FAILED_TESTS\"\n  echo \"=== failed ===\" | tee -a \"$LOG_FILE\"\n  exit 1\nfi\n```\n\n**User/AI Impact**:\n- Script lists failed test names\n- AI agent can identify which test failed, read test code, fix implementation\n\n### Error Scenario 3: Coverage Below Threshold\n\n**Description**: Test coverage <80%\n\n**Handling**:\n```bash\n# In verify.sh\nCOVERAGE=$(cargo tarpaulin --workspace --out Xml | grep -oP 'line-rate=\"\\K[0-9.]+' | head -1)\nCOVERAGE_PCT=$(echo \"$COVERAGE * 100\" | bc)\n\nif (( $(echo \"$COVERAGE_PCT < 80\" | bc -l) )); then\n  log_error \"Coverage below 80%: ${COVERAGE_PCT}%\"\n  echo \"=== failed ===\" | tee -a \"$LOG_FILE\"\n  exit 1\nfi\n```\n\n**User/AI Impact**:\n- Script shows current coverage percentage\n- AI agent adds more tests to uncovered code paths\n\n### Error Scenario 4: Pre-Commit Hook Blocked\n\n**Description**: Developer tries to commit code that fails quality checks\n\n**Handling**:\n```bash\n# In .git/hooks/pre-commit\nscripts/verify.sh --quiet\n\nif [ $? -ne 0 ]; then\n  echo \"❌ Pre-commit checks failed. Commit aborted.\"\n  echo \"Run 'scripts/verify.sh' to see details\"\n  echo \"Fix errors and try again, or use 'git commit --no-verify' to skip (not recommended)\"\n  exit 1\nfi\n```\n\n**User/AI Impact**:\n- Commit is blocked\n- Developer/AI sees clear message about what failed\n- Can run `scripts/verify.sh` without `--quiet` to see full details\n- Option to bypass with `--no-verify` (discouraged)\n\n### Error Scenario 5: Missing Tools\n\n**Description**: Required tools (cargo-watch, cargo-tarpaulin) not installed\n\n**Handling**:\n```bash\n# In scripts/lib/common.sh\ncheck_tool() {\n  if ! command -v \"$1\" &> /dev/null; then\n    log_error \"Required tool '$1' not found\"\n    log_error \"Install with: $2\"\n    exit 1\n  fi\n}\n\n# In build.sh (if --watch used)\nif [ \"$WATCH\" = true ]; then\n  check_tool \"cargo-watch\" \"cargo install cargo-watch\"\nfi\n```\n\n**User/AI Impact**:\n- Script exits with actionable error message\n- Shows exact install command\n- AI agent can run install command automatically\n\n## Testing Strategy\n\n### Unit Testing (Scripts)\n\n**Approach**: Use Bash Automated Testing System (BATS) for script testing\n\n**Test File**: `scripts/tests/test_build.bats`\n\n```bash\n#!/usr/bin/env bats\n\n@test \"build.sh succeeds on valid workspace\" {\n  run scripts/build.sh --quiet\n  [ \"$status\" -eq 0 ]\n  [[ \"$output\" == *\"=== accomplished ===\"* ]]\n}\n\n@test \"build.sh fails on missing dependencies\" {\n  # Temporarily rename Cargo.toml\n  mv Cargo.toml Cargo.toml.bak\n  run scripts/build.sh --quiet\n  [ \"$status\" -eq 1 ]\n  [[ \"$output\" == *\"=== failed ===\"* ]]\n  mv Cargo.toml.bak Cargo.toml\n}\n\n@test \"build.sh --json outputs valid JSON\" {\n  run scripts/build.sh --json --quiet\n  [ \"$status\" -eq 0 ]\n  # Validate JSON format\n  echo \"$output\" | jq .status\n}\n```\n\n**Coverage**:\n- Test each script with valid inputs (expect success)\n- Test with invalid inputs (expect failure with correct exit code)\n- Test flag combinations (--json, --error, --quiet)\n- Verify output format (status markers, JSON schema)\n\n### Integration Testing (Workspace)\n\n**Approach**: Verify entire workflow end-to-end\n\n**Test Scenarios**:\n1. **Fresh Workspace Setup**:\n   - Run `scripts/init_workspace.sh`\n   - Verify all crates exist\n   - Run `make build` (should succeed)\n   - Run `make verify` (should succeed)\n\n2. **Pre-Commit Hook**:\n   - Run `make setup` (install hooks)\n   - Introduce clippy error\n   - Try to commit (should be blocked)\n   - Fix error, commit again (should succeed)\n\n3. **CI Simulation**:\n   - Run `.github/workflows/ci.yml` locally with `act` tool\n   - Verify all jobs pass\n   - Verify coverage report uploaded\n\n### End-to-End Testing (AI Agent Workflow)\n\n**Approach**: Simulate AI agent autonomous development cycle\n\n**Test Scenario**:\n1. AI agent reads `.claude/CLAUDE.md`\n2. AI agent runs `make build` to verify environment\n3. AI agent adds new module to `keyrx_core/src/new_module.rs`\n4. AI agent runs `make verify` (should fail - no tests)\n5. AI agent adds test to `keyrx_core/tests/test_new_module.rs`\n6. AI agent runs `make verify` (should succeed)\n7. AI agent commits (pre-commit hook runs, succeeds)\n8. AI agent pushes (CI runs, passes)\n\n**Success Criteria**:\n- All steps complete without human intervention\n- AI agent interprets script output correctly\n- AI agent fixes errors based on log messages\n- Pre-commit hook blocks bad commits\n- CI workflow catches issues missed locally\n",
  "fileStats": {
    "size": 23218,
    "lines": 855,
    "lastModified": "2025-12-21T05:02:21.601Z"
  },
  "comments": []
}