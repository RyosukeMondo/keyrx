{
  "id": "snapshot_1765037991484_urp9rrh40",
  "approvalId": "approval_1765037991395_tuv102dkf",
  "approvalTitle": "Requirements for mapping-screen-refresh",
  "version": 1,
  "timestamp": "2025-12-06T16:19:51.484Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\nMapping Screen Refresh introduces a clearer end-to-end flow for configuring devices and profiles in the Flutter desktop app. The feature renames the Editor screen to Profiles, adds a new Mapping screen for stepwise key assignment, and brings automatic, OS-appropriate saving of user profiles to the home directory. The goal is to make device naming, profile layout definition, and per-key mapping obvious, responsive, and reliable without explicit save actions.\n\n## Alignment with Product Vision\n- Supports the \"Visual > Abstract\" principle by making layout and key assignment legible and navigable.\n- Aligns with \"Progressive Complexity\" by guiding users through device > profile > mapping in steps while keeping advanced flexibility.\n- Upholds \"CLI First, GUI Later\" by persisting user data in a predictable filesystem location (`~/.keyrx` or `%USERPROFILE%/.keyrx`) shared with the engine/CLI.\n\n## Requirements\n\n### Requirement 1: Profiles screen rename and autosave\n**User Story:** As a user, I want the Editor screen renamed to Profiles and to have my profile changes saved automatically, so that I never lose work and understand where to edit layouts.\n\n#### Acceptance Criteria\n1. WHEN the app renders the navigation, THEN the existing Editor entry SHALL be labeled “Profiles” (routing preserved).\n2. WHEN a profile is created or edited, THEN the app SHALL auto-save without a visible save button.\n3. WHEN saving on Windows, THEN data SHALL be written to `%USERPROFILE%/.keyrx`; WHEN on Linux, THEN data SHALL be written to `~/.keyrx`.\n4. IF the target directory does not exist, THEN it SHALL be created before writing.\n5. WHEN autosave succeeds or fails, THEN the user SHALL receive unobtrusive feedback (success/last saved time or error toast/banner).\n6. WHEN autosave is in progress, THEN the UI SHALL indicate the state without blocking interaction.\n\n### Requirement 2: Devices screen clarity\n**User Story:** As a user, I want to discover devices and assign a friendly name on the Devices screen, so that I can recognize keyboards when mapping.\n\n#### Acceptance Criteria\n1. WHEN devices are listed, THEN each entry SHALL show vendor/product ids and the user-defined friendly name (or placeholder when unset).\n2. WHEN the user edits a device name inline or in a dialog, THEN the name SHALL persist immediately and display updated state.\n3. IF device discovery returns no devices, THEN the screen SHALL show an empty state with guidance to connect or refresh.\n4. WHEN discovery is running, THEN a progress/refresh affordance SHALL be visible and non-blocking.\n\n### Requirement 3: Profiles layout setup UX\n**User Story:** As a user, I want to define the keyboard grid layout (rows/columns per row) in the Profiles screen before assigning keys, so that the mapping step matches my hardware.\n\n#### Acceptance Criteria\n1. WHEN creating or editing a profile, THEN the layout step SHALL allow setting row count and columns per row with immediate visual preview.\n2. WHEN the layout changes, THEN the preview SHALL resize responsively to avoid narrow vertical stacking; minimum sensible height/width SHALL be enforced.\n3. IF layout input is invalid (e.g., zero rows), THEN the UI SHALL prevent progression and show inline validation.\n\n### Requirement 4: Mapping screen (new) for key assignment\n**User Story:** As a user, I want a dedicated Mapping screen to assign actions/keys to each grid position after layout is defined, so that mapping is clear and scannable.\n\n#### Acceptance Criteria\n1. WHEN a profile is selected, THEN the Mapping screen SHALL display the defined grid with consistent cell sizing and readable labels.\n2. WHEN assigning or editing a key/action, THEN an editor panel or dialog SHALL present common actions (emit, block, modifier/layer toggle, macro) with search.\n3. WHEN many rows/columns exist, THEN the grid SHALL support zoom or density controls (e.g., compact/comfortable) to avoid vertical squish.\n4. WHEN a mapping changes, THEN autosave SHALL trigger using the same home-directory location and feedback model as Requirement 1.\n5. WHEN searching/filtering mappings, THEN matched cells SHALL be highlighted and non-matching cells de-emphasized.\n\n### Requirement 5: UX consistency and accessibility\n**User Story:** As a user, I want the mapping and profile flows to be easy to scan and operate, so that I can complete setup without confusion.\n\n#### Acceptance Criteria\n1. UI SHALL adopt consistent spacing, typography scale, and panel widths so the mapping area is not overly narrow.\n2. Focus and keyboard navigation SHALL work for primary controls (device rename, layout inputs, mapping grid traversal).\n3. Color usage SHALL meet accessible contrast for text and interactive elements.\n4. Loading/error states SHALL be visually distinct without blocking the main layout.\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Keep screen/page widgets focused (Devices, Profiles, Mapping) with shared sub-widgets for lists, grids, and editors.\n- **Modular Design**: Extract autosave service and shared storage path resolver for reuse across profiles and mappings.\n- **Dependency Management**: Use existing state management and repositories; avoid duplicating storage logic.\n- **Clear Interfaces**: Define clear contracts for profile persistence and device naming.\n\n### Performance\n- Autosave SHALL complete within 300ms for typical profiles (under 200 mappings) and not block UI thread.\n- Grid rendering SHALL keep 60fps on desktop targets for typical layouts (up to 20x10).\n\n### Security\n- Writes SHALL stay within the user home `.keyrx` directory; no elevated permissions.\n- Input validation SHALL prevent invalid file names and reject path traversal.\n\n### Reliability\n- Autosave retries up to 3 times on transient errors with backoff.\n- Errors are surfaced to the user with actionable guidance without losing in-memory edits.\n\n### Usability\n- Provide inline guidance/tooltips for layout and mapping steps.\n- Maintain visible breadcrumbs or tabs for Devices → Profiles → Mapping.\n- Avoid modal blocking except for focused mapping edits; provide escape/close affordances.\n",
  "fileStats": {
    "size": 6202,
    "lines": 84,
    "lastModified": "2025-12-06T16:17:59.947Z"
  },
  "comments": []
}