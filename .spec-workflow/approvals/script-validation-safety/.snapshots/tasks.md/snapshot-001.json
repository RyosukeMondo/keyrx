{
  "id": "snapshot_1764753926623_kzrrzo3ko",
  "approvalId": "approval_1764753926608_xv6ioi8rj",
  "approvalTitle": "Tasks: Script Validation & Safety",
  "version": 1,
  "timestamp": "2025-12-03T09:25:26.623Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document: Script Validation & Safety\n\n## Phase 1: Core Validation Infrastructure\n\n- [ ] 1. Create validation module structure\n  - Files: `core/src/validation/mod.rs` (new)\n  - Create module with public exports for types, engine, semantic, conflicts, safety, coverage\n  - Add `pub mod validation;` to `core/src/lib.rs`\n  - _Leverage: existing module patterns in `core/src/`_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust systems engineer | Task: Create core/src/validation/mod.rs with module declarations and public exports for: types, engine, semantic, conflicts, safety, coverage, suggestions. Add mod validation to core/src/lib.rs | Restrictions: ≤30 lines; follow existing module patterns; no implementation yet | Success: `cargo check` passes with empty submodules. Mark [-] before starting, use log-implementation after completion, mark [x] when done._\n\n- [ ] 2. Define validation types and result structures\n  - Files: `core/src/validation/types.rs` (new)\n  - Implement ValidationResult, ValidationError, ValidationWarning, CoverageReport, ValidationOptions, SourceLocation, WarningCategory\n  - Add serde derives for JSON output\n  - _Leverage: existing error types in `core/src/error.rs`_\n  - _Requirements: REQ-1, REQ-2, REQ-3, REQ-5_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust developer specializing in data modeling | Task: Create core/src/validation/types.rs with ValidationResult, ValidationError, ValidationWarning, CoverageReport, ValidationOptions structs as specified in design.md. Add serde Serialize/Deserialize derives | Restrictions: ≤150 lines; use existing patterns from error.rs; include doc comments | Success: All types compile, serde works for JSON. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 3. Implement key name suggestion engine\n  - Files: `core/src/validation/suggestions.rs` (new)\n  - Implement Levenshtein distance-based similar key suggestions\n  - Use `KeyCode::all_names()` as dictionary\n  - _Leverage: `core/src/drivers/keycodes/mod.rs` for KeyCode_\n  - _Requirements: REQ-1.2_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Algorithm developer | Task: Create core/src/validation/suggestions.rs with suggest_similar_keys(invalid: &str, max: usize) -> Vec<String> using Levenshtein distance. Add strsim crate to Cargo.toml. Return top N similar key names from KeyCode::all_names() | Restrictions: ≤100 lines; max 5 suggestions; threshold distance of 3 | Success: \"Escpe\" suggests \"Escape\", \"LeftCrtl\" suggests \"LeftCtrl\". Mark [-] before, log-implementation after, mark [x] complete._\n\n## Phase 2: Semantic Validation\n\n- [ ] 4. Implement semantic validator core\n  - Files: `core/src/validation/semantic.rs` (new)\n  - Validate key names in all PendingOp variants\n  - Validate layer references exist when used\n  - Validate modifier references exist when used\n  - _Leverage: `core/src/scripting/pending_ops.rs`, `suggestions.rs`_\n  - _Requirements: REQ-1.1, REQ-1.3, REQ-1.4_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust developer specializing in static analysis | Task: Create core/src/validation/semantic.rs with SemanticValidator struct and validate_operations(ops: &[PendingOp], layers: &HashSet<String>, modifiers: &HashSet<String>) -> Vec<ValidationError>. Check all key names are valid, all layer refs exist, all modifier refs exist | Restrictions: ≤200 lines; reuse KeyCode::from_name(); include suggestions on error | Success: Invalid keys and undefined layers/modifiers produce errors with suggestions. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 5. Implement timing validation\n  - Files: `core/src/validation/semantic.rs` (extend)\n  - Validate timing parameters are in reasonable ranges\n  - Warn on suspiciously high/low timeout values\n  - _Leverage: existing `validate_timeout()` in `scripting/builtins.rs`_\n  - _Requirements: REQ-1.1_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Validation engineer | Task: Extend core/src/validation/semantic.rs to validate timing operations (TapTimeout, ComboTimeout, HoldDelay). Warn if tap_timeout < 50ms or > 500ms, combo_timeout < 10ms or > 100ms | Restrictions: ≤80 lines added; produce warnings not errors for timing issues | Success: Extreme timing values produce warnings. Mark [-] before, log-implementation after, mark [x] complete._\n\n## Phase 3: Conflict Detection\n\n- [ ] 6. Implement remap conflict detection\n  - Files: `core/src/validation/conflicts.rs` (new)\n  - Detect when same key is remapped multiple times\n  - Detect when key is both remapped and blocked\n  - Detect tap-hold conflicts with simple remaps\n  - _Leverage: `PendingOp` enum from `scripting/pending_ops.rs`_\n  - _Requirements: REQ-2.1, REQ-2.2, REQ-2.3_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Conflict analysis engineer | Task: Create core/src/validation/conflicts.rs with ConflictDetector and detect_remap_conflicts(ops: &[PendingOp]) -> Vec<ValidationWarning>. Track key→operation mappings, detect duplicates. Show both conflicting lines | Restrictions: ≤200 lines; track operation indices for line numbers; categorize as WarningCategory::Conflict | Success: Duplicate remaps and remap+block conflicts detected. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 7. Implement combo shadowing detection\n  - Files: `core/src/validation/conflicts.rs` (extend)\n  - Detect when combo keys overlap (e.g., [A,S] shadows [A,S,D])\n  - _Leverage: existing combo parsing_\n  - _Requirements: REQ-2.4_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Combo analysis engineer | Task: Extend core/src/validation/conflicts.rs with detect_combo_shadowing(ops: &[PendingOp]) -> Vec<ValidationWarning>. Detect when one combo's keys are a subset of another (potential shadowing) | Restrictions: ≤80 lines added; only warn if subset relationship exists | Success: Overlapping combos produce warnings. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 8. Implement circular remap detection\n  - Files: `core/src/validation/conflicts.rs` (extend)\n  - Detect A→B, B→A circular dependencies\n  - Detect longer chains (A→B→C→A)\n  - _Requirements: REQ-3.4_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Graph algorithm developer | Task: Extend core/src/validation/conflicts.rs with detect_circular_remaps(ops: &[PendingOp]) -> Vec<ValidationWarning>. Build directed graph of remaps, detect cycles using DFS | Restrictions: ≤100 lines added; handle chains up to 10 keys | Success: A→B→A and longer cycles detected. Mark [-] before, log-implementation after, mark [x] complete._\n\n## Phase 4: Safety Analysis\n\n- [ ] 9. Implement safety analyzer\n  - Files: `core/src/validation/safety.rs` (new)\n  - Warn on Escape key remapping/blocking\n  - Warn on emergency exit combo interference\n  - Warn on blocking all modifiers\n  - _Leverage: `EMERGENCY_EXIT_KEYS` from `drivers/emergency_exit.rs`_\n  - _Requirements: REQ-3.1, REQ-3.2, REQ-3.3, REQ-3.5_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Security-focused developer | Task: Create core/src/validation/safety.rs with SafetyAnalyzer and analyze_safety(ops: &[PendingOp]) -> Vec<ValidationWarning>. Check for Escape remap/block, emergency combo keys (Ctrl+Alt+Shift+Escape), blocking both Left/Right of same modifier type, >10 blocked keys | Restrictions: ≤200 lines; categorize as WarningCategory::Safety; include remediation hints | Success: Dangerous patterns produce clear warnings. Mark [-] before, log-implementation after, mark [x] complete._\n\n## Phase 5: Coverage Analysis\n\n- [ ] 10. Implement coverage analyzer\n  - Files: `core/src/validation/coverage.rs` (new)\n  - Categorize keys by behavior type (remapped, blocked, tap-hold, combo, unaffected)\n  - Track per-layer coverage\n  - _Requirements: REQ-5.1, REQ-5.2, REQ-5.3_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Coverage analysis developer | Task: Create core/src/validation/coverage.rs with CoverageAnalyzer and analyze_coverage(ops: &[PendingOp]) -> CoverageReport. Categorize all affected keys by type, track layer-specific mappings | Restrictions: ≤150 lines; use HashSet for deduplication | Success: Coverage report shows all affected keys by category. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 11. Implement ASCII keyboard visualization\n  - Files: `core/src/validation/coverage.rs` (extend)\n  - Render ANSI keyboard layout with affected keys highlighted\n  - Use symbols: [R]emap, [B]lock, [T]ap-hold, [C]ombo, [ ] unaffected\n  - _Leverage: existing ANSI layout from `drivers/keycodes/layouts/`_\n  - _Requirements: REQ-5.4_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: TUI developer | Task: Extend core/src/validation/coverage.rs with render_ascii_keyboard(coverage: &CoverageReport) -> String. Render ANSI 104-key layout with key indicators | Restrictions: ≤150 lines added; use simple ASCII art; include legend | Success: ASCII keyboard shows affected keys visually. Mark [-] before, log-implementation after, mark [x] complete._\n\n## Phase 6: Validation Engine\n\n- [ ] 12. Implement validation engine orchestrator\n  - Files: `core/src/validation/engine.rs` (new)\n  - Orchestrate all validation passes\n  - Collect and aggregate results\n  - Support ValidationOptions\n  - _Leverage: all validator modules_\n  - _Requirements: REQ-1.5, REQ-1.6, REQ-2.6, REQ-3.6_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Integration architect | Task: Create core/src/validation/engine.rs with ValidationEngine and validate(script: &str, options: ValidationOptions) -> ValidationResult. Parse script with Rhai, collect PendingOps, run all validators, aggregate results | Restrictions: ≤200 lines; handle parse errors gracefully; respect options (strict, no_warnings, max_errors) | Success: Full validation pipeline works end-to-end. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 13. Add operation collection for validation\n  - Files: `core/src/validation/engine.rs` (extend)\n  - Extract layer and modifier definitions during parsing\n  - Track operation source locations\n  - _Leverage: `LayerView`, `ModifierView` from `scripting/builtins.rs`_\n  - _Requirements: REQ-1.3, REQ-1.4_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Parser integration developer | Task: Extend core/src/validation/engine.rs to collect defined layers/modifiers during validation parse. Use existing LayerView/ModifierView patterns. Track source positions if Rhai provides them | Restrictions: ≤100 lines added; don't duplicate runtime logic | Success: Validator knows which layers/modifiers are defined. Mark [-] before, log-implementation after, mark [x] complete._\n\n## Phase 7: CLI Integration\n\n- [ ] 14. Enhance keyrx check command\n  - Files: `core/src/cli/commands/check.rs` (rewrite)\n  - Replace syntax-only check with full semantic validation\n  - Add --strict, --no-warnings, --coverage, --visual flags\n  - Support JSON output\n  - _Leverage: `ValidationEngine`, `OutputWriter`_\n  - _Requirements: REQ-1, REQ-2, REQ-3, REQ-5_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: CLI developer | Task: Rewrite core/src/cli/commands/check.rs to use ValidationEngine. Add clap flags: --strict (warnings as errors), --no-warnings, --coverage (include coverage report), --visual (ASCII keyboard). Output errors/warnings with colors, support --json | Restrictions: ≤250 lines; maintain backward compatibility for basic check; exit code 0=valid, 1=errors, 2=warnings in strict mode | Success: `keyrx check --coverage --visual script.rhai` shows full validation. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 15. Enhance keyrx simulate for dry-run\n  - Files: `core/src/cli/commands/simulate.rs` (extend)\n  - Add --script flag to load script before simulation\n  - Show both tap and hold behaviors for tap-hold keys\n  - _Leverage: existing simulate infrastructure_\n  - _Requirements: REQ-4.1, REQ-4.2, REQ-4.3_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: CLI developer | Task: Extend core/src/cli/commands/simulate.rs with --script flag. When provided, load script first, then simulate with that config. For tap-hold keys, show \"Tap: X, Hold: Y (threshold: Zms)\" | Restrictions: ≤100 lines added; reuse existing simulation engine | Success: `keyrx simulate --script config.rhai --input CapsLock` shows tap-hold behavior. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 16. Add interactive simulation mode\n  - Files: `core/src/cli/commands/simulate.rs` (extend)\n  - Add --interactive flag for REPL-style simulation\n  - User types key names, system shows output\n  - _Leverage: existing REPL patterns from `cli/commands/repl.rs`_\n  - _Requirements: REQ-4.5_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: CLI developer | Task: Extend core/src/cli/commands/simulate.rs with --interactive flag. Start a REPL loop where user types key names and system shows what output would be produced. Support 'quit' to exit | Restrictions: ≤100 lines added; reuse rustyline from REPL; simple prompt \"simulate> \" | Success: Interactive mode allows testing keys one by one. Mark [-] before, log-implementation after, mark [x] complete._\n\n## Phase 8: FFI & Flutter Integration\n\n- [ ] 17. Add validation FFI exports\n  - Files: `core/src/ffi/exports_validation.rs` (new)\n  - Export validate_script() returning JSON result\n  - Export get_key_suggestions() for autocomplete\n  - _Leverage: existing FFI patterns in `ffi/exports_*.rs`_\n  - _Requirements: REQ-6.1_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: FFI engineer | Task: Create core/src/ffi/exports_validation.rs with extern \"C\" functions: keyrx_validate_script(script: *const c_char) -> *mut c_char (JSON result), keyrx_suggest_keys(partial: *const c_char) -> *mut c_char (JSON array). Add to ffi/mod.rs | Restrictions: ≤150 lines; follow existing FFI patterns; free strings properly | Success: FFI exports work from Dart. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 18. Update Flutter bridge for validation\n  - Files: `ui/lib/ffi/bridge.dart` (extend)\n  - Add validateScript() method returning ValidationResult\n  - Add suggestKeys() for autocomplete\n  - _Leverage: existing bridge patterns_\n  - _Requirements: REQ-6.1, REQ-6.4_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter FFI developer | Task: Extend ui/lib/ffi/bridge.dart with validateScript(String script) -> Future<ValidationResult> and suggestKeys(String partial) -> Future<List<String>>. Parse JSON from FFI, create Dart model classes for ValidationResult, ValidationError, ValidationWarning | Restrictions: ≤150 lines added; create models in lib/models/validation.dart | Success: Flutter can call validation and get structured results. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 19. Add validation display to editor page\n  - Files: `ui/lib/pages/editor_page.dart` (extend)\n  - Display validation errors/warnings inline\n  - Highlight problematic lines\n  - Show suggestions on hover\n  - _Leverage: existing editor infrastructure_\n  - _Requirements: REQ-6.2, REQ-6.3, REQ-6.4, REQ-6.5_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter UI developer | Task: Extend ui/lib/pages/editor_page.dart to call validateScript on text change (debounced 500ms). Display errors/warnings below editor. Highlight error lines in red. Show tooltip with suggestions on error tap | Restrictions: ≤200 lines added; debounce to avoid excessive validation; allow save even with errors (show warning dialog) | Success: Editor shows real-time validation feedback. Mark [-] before, log-implementation after, mark [x] complete._\n\n## Phase 9: Testing & Documentation\n\n- [ ] 20. Add unit tests for validators\n  - Files: `core/src/validation/semantic.rs`, `conflicts.rs`, `safety.rs` (extend with #[cfg(test)])\n  - Test each validation rule\n  - Test edge cases and false positive prevention\n  - _Leverage: existing test patterns_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Test engineer | Task: Add #[cfg(test)] modules to each validator file. Test: invalid key detection, layer/modifier undefined, duplicate remaps, combo shadowing, circular remaps, all safety patterns. Ensure valid scripts produce no errors | Restrictions: ≤200 lines per file; test both positive and negative cases | Success: `cargo test validation` passes with good coverage. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 21. Add integration tests\n  - Files: `core/tests/validation_integration.rs` (new)\n  - Test full validation pipeline with real scripts\n  - Test CLI output format\n  - Test FFI roundtrip\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Integration test engineer | Task: Create core/tests/validation_integration.rs. Test ValidationEngine with scripts from scripts/ directory. Verify no false positives on valid example scripts. Test JSON output parsing. Test CLI exit codes | Restrictions: ≤200 lines; use existing test fixtures | Success: Integration tests pass. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 22. Update documentation\n  - Files: `README.md` (extend)\n  - Document validation features in README\n  - Add examples of check command usage\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical writer | Task: Add \"## Script Validation\" section to README.md. Document keyrx check flags (--strict, --coverage, --visual, --json). Show example output. Explain error/warning categories | Restrictions: ≤60 lines added; include code examples | Success: Users understand validation features from README. Mark [-] before, log-implementation after, mark [x] complete._\n\n- [ ] 23. Verify all requirements met\n  - Files: N/A (manual verification)\n  - Run full test suite\n  - Verify each requirement has corresponding tests\n  - Test on sample user scripts\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec script-validation-safety, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA engineer | Task: Verify all REQ-1 through REQ-6 requirements are implemented and tested. Run `cargo test`, `flutter test`, manual CLI testing. Create checklist mapping requirements to tests | Restrictions: Document any gaps found; create follow-up issues if needed | Success: All requirements verified as implemented. Mark [-] before, log-implementation after, mark [x] complete._\n",
  "fileStats": {
    "size": 20733,
    "lines": 206,
    "lastModified": "2025-12-03T09:25:15.802Z"
  },
  "comments": []
}