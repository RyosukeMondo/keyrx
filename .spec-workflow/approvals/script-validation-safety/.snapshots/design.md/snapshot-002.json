{
  "id": "snapshot_1764754123764_mgbtmzhoe",
  "approvalId": "approval_1764753926546_11so8kl29",
  "approvalTitle": "Design: Script Validation & Safety",
  "version": 2,
  "timestamp": "2025-12-03T09:28:43.764Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: Script Validation & Safety\n\n## Overview\n\nThis feature adds a comprehensive validation layer to KeyRx's script processing pipeline. The validation system performs static analysis of Rhai scripts before runtime, detecting semantic errors, conflicts, and dangerous patterns. It integrates with the existing `keyrx check` CLI command, adds new simulation capabilities, and exposes validation through FFI for Flutter UI integration.\n\nThe design follows the existing module patterns in `core/src/` and reuses the scripting infrastructure (Rhai engine, key parsing, layer/modifier state) in a non-destructive read-only mode.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **Dependency Injection**: Validation uses the same trait-based DI pattern as other modules. `ValidationEngine` accepts injected dependencies for testability.\n- **CLI First**: All validation features are CLI-exercisable before any Flutter UI integration.\n- **Error Handling**: Follows the structured `KeyRxError` hierarchy with actionable remediation hints.\n- **Rhai Contract**: Reuses `KeyCode::from_name()` and existing Rhai bindings for consistent key validation.\n\n### Project Structure (structure.md)\n\n- **Module Location**: `core/src/validation/` following the existing pattern (`core/src/engine/`, `core/src/scripting/`, etc.)\n- **Naming Conventions**: `snake_case.rs` files, `PascalCase` structs, `snake_case` functions\n- **Test Location**: `core/src/validation/*.rs` with `#[cfg(test)]` modules and `core/tests/validation_integration.rs`\n- **CLI Command**: `core/src/cli/commands/check.rs` extended, new `simulate.rs` features\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`KeyCode::from_name()`** (`drivers/keycodes/mod.rs`): Key name validation with alias support\n- **`parse_key_or_error()`** (`scripting/helpers.rs`): Key parsing with error formatting\n- **`PendingOps`** (`scripting/pending_ops.rs`): Collects script operations - can be analyzed for conflicts\n- **`LayerView` / `ModifierView`** (`scripting/builtins.rs`): Track layer/modifier definitions during script execution\n- **`RhaiRuntime`** (`scripting/runtime.rs`): Rhai engine setup with KeyRx bindings\n- **`KeyRxError`** (`error.rs`): Error type hierarchy with remediation hints\n- **`OutputWriter`** (`cli/output.rs`): JSON/human-readable output formatting\n\n### Integration Points\n\n- **`keyrx check` command** (`cli/commands/check.rs`): Extend from syntax-only to semantic validation\n- **`keyrx simulate` command** (`cli/commands/simulate.rs`): Already exists, extend with script-aware simulation\n- **FFI layer** (`ffi/exports_script.rs`): Add validation result exports for Flutter UI\n- **Flutter UI** (`ui/lib/pages/editor_page.dart`): Display validation results inline\n\n## Architecture\n\nThe validation system uses a pipeline architecture where the script is processed through multiple validation passes:\n\n```mermaid\ngraph LR\n    Script[Rhai Script] --> Parse[Parse & Collect Ops]\n    Parse --> Semantic[Semantic Validation]\n    Parse --> Conflict[Conflict Detection]\n    Parse --> Safety[Safety Analysis]\n    Semantic --> Results[ValidationResult]\n    Conflict --> Results\n    Safety --> Results\n    Results --> CLI[CLI Output]\n    Results --> FFI[FFI Export]\n    Results --> UI[Flutter UI]\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each validation type in its own file (`semantic.rs`, `conflicts.rs`, `safety.rs`)\n- **Component Isolation**: Validators are independent and can run in parallel\n- **Service Layer Separation**: Validation logic separated from CLI presentation and FFI export\n- **Utility Modularity**: Key similarity matching in dedicated `suggestions.rs` module\n\n## Components and Interfaces\n\n### ValidationEngine (`validation/engine.rs`)\n\n- **Purpose**: Orchestrates all validation passes and aggregates results\n- **Interfaces**:\n  ```rust\n  pub fn validate(script: &str) -> ValidationResult\n  pub fn validate_with_options(script: &str, options: ValidationOptions) -> ValidationResult\n  ```\n- **Dependencies**: `SemanticValidator`, `ConflictDetector`, `SafetyAnalyzer`\n- **Reuses**: `RhaiRuntime` for script parsing, `PendingOps` for operation collection\n\n### SemanticValidator (`validation/semantic.rs`)\n\n- **Purpose**: Validates key names, layer references, modifier references, timing values\n- **Interfaces**:\n  ```rust\n  pub fn validate_operations(ops: &[PendingOp]) -> Vec<ValidationError>\n  pub fn suggest_similar_keys(invalid: &str) -> Vec<String>\n  ```\n- **Dependencies**: `KeyCode`, `strsim` crate for Levenshtein distance\n- **Reuses**: `KeyCode::from_name()`, `KeyCode::all_names()`\n\n### ConflictDetector (`validation/conflicts.rs`)\n\n- **Purpose**: Detects overlapping remaps, remap+block conflicts, combo shadowing\n- **Interfaces**:\n  ```rust\n  pub fn detect_conflicts(ops: &[PendingOp]) -> Vec<ValidationWarning>\n  pub fn detect_circular_remaps(ops: &[PendingOp]) -> Vec<ValidationWarning>\n  ```\n- **Dependencies**: None (pure logic on `PendingOp` list)\n- **Reuses**: `PendingOp` enum variants\n\n### SafetyAnalyzer (`validation/safety.rs`)\n\n- **Purpose**: Warns about dangerous patterns (lockout risks, emergency combo interference)\n- **Interfaces**:\n  ```rust\n  pub fn analyze_safety(ops: &[PendingOp]) -> Vec<ValidationWarning>\n  ```\n- **Dependencies**: Emergency exit key codes from `drivers/emergency_exit.rs`\n- **Reuses**: `EMERGENCY_EXIT_KEYS` constant\n\n### CoverageAnalyzer (`validation/coverage.rs`)\n\n- **Purpose**: Generates coverage report showing affected keys\n- **Interfaces**:\n  ```rust\n  pub fn analyze_coverage(ops: &[PendingOp]) -> CoverageReport\n  pub fn render_ascii_keyboard(coverage: &CoverageReport) -> String\n  ```\n- **Dependencies**: None\n- **Reuses**: `KeyCode` enum for keyboard layout\n\n### ValidationResult (`validation/types.rs`)\n\n- **Purpose**: Structured result type aggregating all validation output\n- **Interfaces**: Data structure (see Data Models below)\n- **Dependencies**: None\n- **Reuses**: None\n\n## Data Models\n\n### ValidationResult\n\n```rust\npub struct ValidationResult {\n    /// Script is valid (no errors, warnings allowed)\n    pub is_valid: bool,\n    /// Semantic and structural errors\n    pub errors: Vec<ValidationError>,\n    /// Conflict and safety warnings\n    pub warnings: Vec<ValidationWarning>,\n    /// Coverage analysis (if requested)\n    pub coverage: Option<CoverageReport>,\n}\n```\n\n### ValidationError\n\n```rust\npub struct ValidationError {\n    /// Error code for categorization (e.g., \"E001\")\n    pub code: String,\n    /// Human-readable error message\n    pub message: String,\n    /// Source location if available\n    pub location: Option<SourceLocation>,\n    /// Suggested fixes\n    pub suggestions: Vec<String>,\n}\n\npub struct SourceLocation {\n    pub line: usize,\n    pub column: Option<usize>,\n    pub context: Option<String>,  // The problematic line\n}\n```\n\n### ValidationWarning\n\n```rust\npub struct ValidationWarning {\n    /// Warning code for categorization (e.g., \"W001\")\n    pub code: String,\n    /// Warning category\n    pub category: WarningCategory,\n    /// Human-readable message\n    pub message: String,\n    /// Source location if available\n    pub location: Option<SourceLocation>,\n}\n\npub enum WarningCategory {\n    Conflict,\n    Safety,\n    Performance,\n}\n```\n\n### CoverageReport\n\n```rust\npub struct CoverageReport {\n    /// Keys that are remapped\n    pub remapped: Vec<KeyCode>,\n    /// Keys that are blocked\n    pub blocked: Vec<KeyCode>,\n    /// Keys with tap-hold behavior\n    pub tap_hold: Vec<KeyCode>,\n    /// Keys involved in combos\n    pub combo_triggers: Vec<KeyCode>,\n    /// Keys unaffected by script\n    pub unaffected: Vec<KeyCode>,\n    /// Per-layer coverage\n    pub layers: HashMap<String, LayerCoverage>,\n}\n```\n\n### ValidationOptions\n\n```rust\npub struct ValidationOptions {\n    /// Treat warnings as errors\n    pub strict: bool,\n    /// Suppress warnings\n    pub no_warnings: bool,\n    /// Maximum errors to report (default: 20)\n    pub max_errors: usize,\n    /// Include coverage analysis\n    pub include_coverage: bool,\n    /// Include ASCII keyboard visualization\n    pub include_visual: bool,\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Key Name**\n   - **Handling**: Collect error with line/column, compute similar key suggestions using Levenshtein distance\n   - **User Impact**: See error with location and \"Did you mean: X, Y, Z?\" suggestions\n\n2. **Undefined Layer Reference**\n   - **Handling**: Collect error, list defined layers as suggestions\n   - **User Impact**: See error with \"Layer 'foo' not defined. Defined layers: base, nav, symbols\"\n\n3. **Conflicting Remaps**\n   - **Handling**: Collect warning showing both mappings and which one wins\n   - **User Impact**: See warning \"Key 'A' remapped twice: A→B (line 5) overridden by A→C (line 10)\"\n\n4. **Dangerous Pattern**\n   - **Handling**: Collect warning with specific risk description\n   - **User Impact**: See warning \"Blocking Escape key may make it difficult to exit applications\"\n\n5. **Script Parse Error**\n   - **Handling**: Fall back to existing Rhai compile error with line/column\n   - **User Impact**: Existing behavior preserved\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Semantic validation**: Test each key name validation, layer/modifier reference validation\n- **Conflict detection**: Test duplicate remap, remap+block, combo shadowing scenarios\n- **Safety analysis**: Test each dangerous pattern detection\n- **Suggestions**: Test Levenshtein similarity with known typos\n- **Coverage**: Test coverage categorization\n\n### Integration Testing\n\n- Test full validation pipeline with real scripts\n- Test CLI output format (human and JSON)\n- Test FFI export roundtrip\n- Test interaction with existing `keyrx check` behavior\n\n### End-to-End Testing\n\n- Validate sample scripts from `scripts/` directory\n- Ensure no false positives on valid scripts\n- Test Flutter UI displays validation results correctly\n",
  "fileStats": {
    "size": 9927,
    "lines": 273,
    "lastModified": "2025-12-03T09:23:48.160Z"
  },
  "comments": []
}