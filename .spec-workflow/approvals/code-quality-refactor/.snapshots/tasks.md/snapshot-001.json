{
  "id": "snapshot_1764473353136_7irq7cjxt",
  "approvalId": "approval_1764473353131_p0amx0csa",
  "approvalTitle": "Tasks: Code Quality Refactor",
  "version": 1,
  "timestamp": "2025-11-30T03:29:13.136Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document: code-quality-refactor\n\n## Phase 1: Foundation (Keycodes & Traits)\n\n- [ ] 1. Create keycode macro system\n  - File: `core/src/drivers/keycodes.rs` (new)\n  - Define `define_keycodes!` macro that generates:\n    - KeyCode enum with all variants\n    - Display impl\n    - FromStr impl with aliases\n    - `evdev_to_keycode()` / `keycode_to_evdev()` (cfg linux)\n    - `vk_to_keycode()` / `keycode_to_vk()` (cfg windows)\n    - `all_keycodes()` for uinput registration\n  - Invoke macro with all 127 keycodes\n  - Purpose: Single source of truth for all keycode definitions\n  - _Leverage: existing keycode mappings from linux.rs, windows.rs, types.rs_\n  - _Requirements: REQ-1, REQ-7_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Macro Developer specializing in declarative macros | Task: Create define_keycodes! macro in core/src/drivers/keycodes.rs that generates KeyCode enum and all conversion functions from a single definition, extracting existing mappings from linux.rs lines 1148-1387, windows.rs lines 941-1204, and types.rs | Restrictions: Must compile to match statements (no HashMap), must preserve all existing keycodes and aliases, no runtime overhead | Success: cargo build succeeds, all existing keycode tests pass, evdev/vk roundtrips verified | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 2. Create KeyInjector trait\n  - File: `core/src/drivers/injector.rs` (new)\n  - Define `KeyInjector` trait with `inject()` and `sync()` methods\n  - Create `MockKeyInjector` implementation for testing\n  - Add unit tests for mock\n  - Purpose: Enable dependency injection for key output\n  - _Leverage: InputSource trait pattern from traits/mod.rs_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in trait design and DI | Task: Create KeyInjector trait in core/src/drivers/injector.rs following InputSource pattern, with MockKeyInjector for testing | Restrictions: Trait must be Send, must not require async, keep interface minimal | Success: MockKeyInjector captures all injections, tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 3. Extract shared utilities\n  - File: `core/src/drivers/common.rs` (extend)\n  - Add `extract_panic_message()` function\n  - File: `core/src/scripting/helpers.rs` (new)\n  - Add `parse_key_or_error()` function\n  - Add unit tests for both\n  - Purpose: DRY - eliminate duplicated patterns\n  - _Leverage: existing panic handling in linux.rs:841-854, windows.rs:847-854_\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Extract extract_panic_message() to common.rs and parse_key_or_error() to scripting/helpers.rs, with unit tests | Restrictions: Must be exact behavioral match to existing code | Success: Functions extracted, tests pass, ready for driver refactoring | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n## Phase 2: Linux Driver Refactor\n\n- [ ] 4. Split Linux driver into submodules\n  - Create directory: `core/src/drivers/linux/`\n  - File: `linux/mod.rs` - LinuxInput struct, InputSource impl\n  - File: `linux/reader.rs` - EvdevReader\n  - File: `linux/writer.rs` - UinputWriter\n  - File: `linux/keymap.rs` - re-export from keycodes.rs\n  - Move code preserving all functionality\n  - Purpose: File size compliance (<500 lines each)\n  - _Leverage: existing linux.rs structure_\n  - _Requirements: REQ-2, REQ-6_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in module organization | Task: Split core/src/drivers/linux.rs (1600 lines) into linux/mod.rs, linux/reader.rs, linux/writer.rs, linux/keymap.rs with each file <500 lines | Restrictions: Preserve all public API, no behavioral changes, maintain backward compatibility of imports | Success: cargo build succeeds, all linux driver tests pass, each file <500 lines | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 5. Refactor EvdevReader::spawn() for SLAP compliance\n  - File: `core/src/drivers/linux/reader.rs`\n  - Extract `run_loop()` method (~30 lines)\n  - Extract `process_events()` method (~20 lines)\n  - Extract `handle_thread_exit()` method (~20 lines)\n  - Use `extract_panic_message()` from common.rs\n  - Purpose: Function size compliance (<50 lines), SLAP\n  - _Leverage: extracted panic utility from task 3_\n  - _Requirements: REQ-3, REQ-5_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Refactor EvdevReader::spawn() (currently 140 lines) into spawn() + run_loop() + process_events() + handle_thread_exit(), each <50 lines, using extract_panic_message() | Restrictions: Identical behavior, no new features | Success: spawn() is <50 lines, all tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 6. Implement KeyInjector for UinputWriter\n  - File: `core/src/drivers/linux/writer.rs`\n  - Implement `KeyInjector` trait for `UinputWriter`\n  - Update `LinuxInput` to use generic `KeyInjector`\n  - Add `new_with_injector()` constructor\n  - Add tests with `MockKeyInjector`\n  - Purpose: Testability improvement\n  - _Leverage: KeyInjector trait from task 2_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Implement KeyInjector trait for UinputWriter, add LinuxInput::new_with_injector() constructor, write tests using MockKeyInjector | Restrictions: Preserve existing new() behavior as default | Success: Tests pass with mock injector, no hardware needed for unit tests | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 7. Update Linux keymap to use keycodes.rs\n  - File: `core/src/drivers/linux/keymap.rs`\n  - Remove manual `evdev_to_keycode()` / `keycode_to_evdev()` implementations\n  - Re-export from `keycodes.rs`\n  - Remove `build_key_set()`, use `all_keycodes()`\n  - Update imports in writer.rs\n  - Purpose: SSOT compliance\n  - _Leverage: keycodes.rs from task 1_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Replace linux/keymap.rs manual implementations with re-exports from keycodes.rs, update writer.rs to use all_keycodes() | Restrictions: All existing keycode conversions must work identically | Success: Keymap tests pass, build_key_set removed, SSOT achieved | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n## Phase 3: Windows Driver Refactor\n\n- [ ] 8. Split Windows driver into submodules\n  - Create directory: `core/src/drivers/windows/`\n  - File: `windows/mod.rs` - WindowsInput struct, InputSource impl\n  - File: `windows/hook.rs` - HookManager, low_level_keyboard_proc\n  - File: `windows/injector.rs` - SendInputInjector\n  - File: `windows/keymap.rs` - re-export from keycodes.rs\n  - Move code preserving all functionality\n  - Purpose: File size compliance (<500 lines each)\n  - _Leverage: existing windows.rs structure_\n  - _Requirements: REQ-2, REQ-6_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in Windows API | Task: Split core/src/drivers/windows.rs (1743 lines) into windows/mod.rs, windows/hook.rs, windows/injector.rs, windows/keymap.rs with each file <500 lines | Restrictions: Preserve thread-local storage patterns, maintain all public API | Success: cargo build succeeds on Windows target, each file <500 lines | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 9. Implement KeyInjector for SendInputInjector\n  - File: `core/src/drivers/windows/injector.rs`\n  - Implement `KeyInjector` trait for `SendInputInjector`\n  - Update `WindowsInput` to use generic `KeyInjector`\n  - Add `new_with_injector()` constructor\n  - Add tests with `MockKeyInjector`\n  - Purpose: Testability improvement\n  - _Leverage: KeyInjector trait from task 2_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Implement KeyInjector trait for SendInputInjector, add WindowsInput::new_with_injector() constructor, write tests using MockKeyInjector | Restrictions: Preserve existing new() behavior | Success: Tests pass with mock injector | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 10. Update Windows keymap to use keycodes.rs\n  - File: `core/src/drivers/windows/keymap.rs`\n  - Remove manual `vk_to_keycode()` / `keycode_to_vk()` implementations\n  - Re-export from `keycodes.rs`\n  - Update imports in injector.rs and hook.rs\n  - Purpose: SSOT compliance\n  - _Leverage: keycodes.rs from task 1_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Replace windows/keymap.rs manual implementations with re-exports from keycodes.rs | Restrictions: All existing VK conversions must work identically | Success: Keymap tests pass, SSOT achieved | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n## Phase 4: Scripting & Types Cleanup\n\n- [ ] 11. Update RhaiRuntime to use parse_key_or_error()\n  - File: `core/src/scripting/runtime.rs`\n  - Replace inline key parsing in `remap()`, `block()`, `pass()` closures\n  - Use `parse_key_or_error()` from helpers.rs\n  - Reduce code duplication\n  - Purpose: DRY compliance\n  - _Leverage: helpers.rs from task 3_\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Refactor runtime.rs lines 56-153 to use parse_key_or_error() helper, eliminating duplicate key parsing code | Restrictions: Identical error messages and behavior | Success: All Rhai script tests pass, code is DRY | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 12. Update types.rs to use keycodes.rs\n  - File: `core/src/engine/types.rs`\n  - Remove `KeyCode` enum definition (now in keycodes.rs)\n  - Remove `Display` impl (generated by macro)\n  - Remove `FromStr` impl (generated by macro)\n  - Re-export `KeyCode` from keycodes.rs\n  - Keep `InputEvent`, `OutputAction`, `RemapAction` in place\n  - Purpose: SSOT compliance, file size reduction\n  - _Leverage: keycodes.rs from task 1_\n  - _Requirements: REQ-1, REQ-2_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Remove KeyCode enum, Display, FromStr from types.rs, re-export from keycodes.rs, reduce file from 627 to <400 lines | Restrictions: All existing imports must continue to work | Success: types.rs <500 lines, all tests pass, public API unchanged | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n## Phase 5: Verification & Cleanup\n\n- [ ] 13. Run full test suite and benchmarks\n  - Run `cargo test --all-features`\n  - Run `cargo bench`\n  - Compare benchmark results to baseline\n  - Fix any regressions\n  - Purpose: Verify zero performance regression\n  - _Requirements: REQ-7_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Run full test suite and benchmarks, compare to pre-refactor baseline, document any differences | Restrictions: No regressions allowed >100 microseconds | Success: All tests pass, benchmarks within threshold | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 14. Update module exports and documentation\n  - File: `core/src/drivers/mod.rs`\n  - Update re-exports for new module structure\n  - File: `core/src/lib.rs`\n  - Verify public API unchanged\n  - Update any broken doc comments\n  - Purpose: Maintain backward compatibility\n  - _Requirements: REQ-2, REQ-6_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Update drivers/mod.rs and lib.rs exports for new module structure, verify rustdoc builds without warnings | Restrictions: Public API must be identical | Success: cargo doc succeeds, existing examples compile | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 15. Verify code metrics compliance\n  - Run line count on all modified files\n  - Verify each file <500 lines (excluding comments/blanks)\n  - Verify each function <50 lines\n  - Document final metrics\n  - Purpose: Confirm KPI compliance\n  - _Requirements: REQ-2, REQ-3_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Code Quality Engineer | Task: Run tokei or cloc on all driver files, verify <500 lines/file and <50 lines/function, document in implementation log | Restrictions: Must meet all metrics | Success: All files and functions within limits, metrics documented | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 16. Delete old monolithic driver files\n  - Delete `core/src/drivers/linux.rs` (replaced by linux/)\n  - Delete `core/src/drivers/windows.rs` (replaced by windows/)\n  - Final `cargo build` and `cargo test`\n  - Purpose: Clean up legacy code\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec code-quality-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Developer | Task: Delete old linux.rs and windows.rs files, run final build and test to confirm nothing is broken | Restrictions: Only delete after all tests pass | Success: Old files removed, cargo build and cargo test pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n",
  "fileStats": {
    "size": 15753,
    "lines": 184,
    "lastModified": "2025-11-30T03:29:05.550Z"
  },
  "comments": []
}