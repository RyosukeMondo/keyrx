{
  "id": "snapshot_1764473023080_yy6yhgezc",
  "approvalId": "approval_1764473023070_jmtt80css",
  "approvalTitle": "Requirements: Code Quality Refactor",
  "version": 1,
  "timestamp": "2025-11-30T03:23:43.080Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: code-quality-refactor\n\n## Introduction\n\nThis spec addresses code quality issues identified during architectural review, including:\n- File/function size violations (>500 lines, >50 lines)\n- SSOT violations (keycode definitions repeated 6+ times)\n- DRY violations (duplicated patterns across drivers)\n- Missing abstractions affecting testability\n- SLAP violations (mixed abstraction levels)\n\nThe goal is to improve maintainability, testability, and reduce bug risk while **preserving zero-latency performance** critical for keyboard remapping.\n\n## Alignment with Product Vision\n\nFrom `product.md`:\n> \"Performance > Features: Latency is the enemy. The tool must feel invisible.\"\n\nFrom `tech.md`:\n> \"Input latency: < 1ms processing overhead (hard requirement)\"\n\nThis refactoring maintains compile-time code generation to ensure **zero runtime overhead** while achieving single-source-of-truth for keycode definitions.\n\n## Requirements\n\n### REQ-1: Single Source of Truth for Keycodes\n\n**User Story:** As a developer, I want keycode definitions in a single location, so that adding new keys requires changes in only one place.\n\n#### Acceptance Criteria\n\n1. WHEN a new keycode is added THEN the system SHALL require modification of exactly ONE source file\n2. WHEN keycodes are defined THEN the system SHALL generate all conversions (evdev, VK, Display, FromStr) at compile time\n3. WHEN the build runs THEN the system SHALL produce zero runtime overhead from keycode conversions (compiled match statements)\n4. IF a keycode mapping is inconsistent THEN the build SHALL fail with a clear error message\n\n### REQ-2: File Size Compliance\n\n**User Story:** As a maintainer, I want files under 500 lines, so that the codebase remains navigable and reviewable.\n\n#### Acceptance Criteria\n\n1. WHEN refactoring is complete THEN each file SHALL contain fewer than 500 lines (excluding comments/blank lines)\n2. WHEN splitting files THEN the system SHALL maintain backward-compatible public API exports\n3. WHEN organizing modules THEN related functionality SHALL be grouped in subdirectories\n\n### REQ-3: Function Size Compliance\n\n**User Story:** As a developer, I want functions under 50 lines, so that each function has a single, testable responsibility.\n\n#### Acceptance Criteria\n\n1. WHEN refactoring is complete THEN each function SHALL contain fewer than 50 lines\n2. WHEN splitting functions THEN the system SHALL preserve identical behavior (no semantic changes)\n3. WHEN extracting helpers THEN they SHALL be reusable across similar patterns\n\n### REQ-4: KeyInjector Trait Abstraction\n\n**User Story:** As a test author, I want to inject mock key emitters, so that I can unit test driver logic without real hardware.\n\n#### Acceptance Criteria\n\n1. WHEN implementing key injection THEN the system SHALL use a `KeyInjector` trait\n2. WHEN testing LinuxInput THEN a MockKeyInjector SHALL be injectable without real uinput\n3. WHEN testing WindowsInput THEN a MockKeyInjector SHALL be injectable without real SendInput\n4. IF the injector fails THEN appropriate errors SHALL propagate to the caller\n\n### REQ-5: Shared Utility Extraction\n\n**User Story:** As a developer, I want common patterns extracted to utilities, so that bug fixes apply everywhere.\n\n#### Acceptance Criteria\n\n1. WHEN handling panics in threads THEN a shared `extract_panic_message()` utility SHALL be used\n2. WHEN parsing keys in Rhai functions THEN a shared `parse_key_or_error()` helper SHALL be used\n3. WHEN the shared utility is fixed THEN all callers SHALL benefit without modification\n\n### REQ-6: Driver Module Organization\n\n**User Story:** As a contributor, I want driver code organized into submodules, so that I can find and modify specific functionality easily.\n\n#### Acceptance Criteria\n\n1. WHEN organizing Linux driver THEN it SHALL split into: `mod.rs`, `reader.rs`, `writer.rs`, `keymap.rs`\n2. WHEN organizing Windows driver THEN it SHALL split into: `mod.rs`, `hook.rs`, `injector.rs`, `keymap.rs`\n3. WHEN importing driver functionality THEN existing `use` statements SHALL continue to work\n\n### REQ-7: Zero Performance Regression\n\n**User Story:** As a user, I want refactoring to have zero impact on latency, so that my keyboard remapping remains imperceptible.\n\n#### Acceptance Criteria\n\n1. WHEN benchmarking after refactor THEN latency SHALL NOT increase by more than 100 microseconds\n2. WHEN generating keycode conversions THEN they SHALL compile to jump tables (not runtime lookups)\n3. WHEN running `cargo bench` THEN all existing benchmarks SHALL pass with equivalent or better results\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Each file has one well-defined purpose\n- **Modular Design**: Keycodes, drivers, and utilities are isolated and reusable\n- **Dependency Management**: No circular dependencies between new modules\n- **Clear Interfaces**: `KeyInjector` trait defines clean contract for injection\n\n### Performance\n- Zero runtime overhead from refactoring\n- Compile-time code generation for keycode mappings\n- Match statements preserved for branch prediction optimization\n- No HashMap/BTreeMap lookups in hot path\n\n### Testability\n- All driver components injectable via traits\n- Mock implementations provided for each new trait\n- Unit tests achievable without hardware access\n\n### Maintainability\n- Adding a new keycode requires exactly 1 file change\n- File sizes comply with project KPIs\n- Function sizes comply with project KPIs\n\n### Backward Compatibility\n- Public API unchanged\n- Existing tests pass without modification\n- External crate users unaffected\n",
  "fileStats": {
    "size": 5620,
    "lines": 126,
    "lastModified": "2025-11-30T03:23:37.140Z"
  },
  "comments": []
}