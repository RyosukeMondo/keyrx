{
  "id": "snapshot_1764443509104_qp93z7b5l",
  "approvalId": "approval_1764443509099_t1wposuw2",
  "approvalTitle": "MVP Requirements Document",
  "version": 1,
  "timestamp": "2025-11-29T19:11:49.104Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: MVP\n\n## Introduction\n\nThis specification defines the Minimum Viable Product (MVP) for KeyRx - an advanced input remapping engine. The MVP establishes the foundational infrastructure enabling the core engine to be installed, run, load basic configurations, perform simple key remapping, and support CLI-first autonomous development and testing. Target platforms are Linux and Windows.\n\n## Alignment with Product Vision\n\nThis MVP directly supports Phase 1 (\"The Iron Core\") from the product roadmap:\n- **CLI First, GUI Later**: All features are CLI-exercisable for rapid trial, self-check, and AI agent autonomy\n- **Performance > Features**: Establishes latency benchmarking from day one\n- **Logic > Configuration**: Implements Rhai scripting foundation for programmable behavior\n- **Dependency Injection**: All components testable via mock substitution\n\n## Requirements\n\n### REQ-1: Installation\n\n**User Story:** As a developer, I want to install KeyRx from source, so that I can build and run the engine on my development machine.\n\n#### Acceptance Criteria\n\n1. WHEN a user clones the repository and runs `cargo build --release` THEN the system SHALL produce a `keyrx` binary\n2. WHEN building on Linux (kernel 5.0+, x86_64) THEN the build SHALL complete without errors\n3. WHEN building on Windows 10+ (x86_64) THEN the build SHALL complete without errors\n4. IF required system dependencies are missing THEN the build system SHALL display clear error messages indicating what is needed\n\n### REQ-2: CLI Execution\n\n**User Story:** As a developer, I want to run KeyRx from the command line, so that I can start the engine and verify it works.\n\n#### Acceptance Criteria\n\n1. WHEN a user runs `keyrx --help` THEN the system SHALL display available commands and options\n2. WHEN a user runs `keyrx --version` THEN the system SHALL display the current version number\n3. WHEN a user runs `keyrx run` without arguments THEN the system SHALL start with default/empty configuration\n4. WHEN a user runs `keyrx run --debug` THEN the system SHALL output debug information to stderr\n5. WHEN the engine starts successfully THEN the system SHALL exit with code 0 on graceful shutdown (Ctrl+C)\n6. IF the engine encounters a fatal error THEN the system SHALL exit with code 1 and display error details\n\n### REQ-3: Configuration Loading\n\n**User Story:** As a user, I want to load a Rhai configuration script, so that I can define my key remapping behavior.\n\n#### Acceptance Criteria\n\n1. WHEN a user runs `keyrx run --script path/to/config.rhai` THEN the system SHALL load and execute the specified script\n2. WHEN a user runs `keyrx check path/to/config.rhai` THEN the system SHALL validate the script syntax without executing\n3. IF the script file does not exist THEN the system SHALL display an error message and exit with code 1\n4. IF the script contains syntax errors THEN `keyrx check` SHALL display line/column error location and exit with code 2\n5. WHEN `keyrx check` succeeds THEN the system SHALL display \"OK\" and exit with code 0\n6. WHEN loading a valid script THEN the system SHALL execute `on_init()` hook if defined\n\n### REQ-4: Basic Key Remapping\n\n**User Story:** As a user, I want to remap one key to another, so that I can customize my keyboard behavior.\n\n#### Acceptance Criteria\n\n1. WHEN a Rhai script defines `remap(\"A\", \"B\")` THEN pressing A SHALL output B\n2. WHEN a Rhai script defines `block(\"CapsLock\")` THEN pressing CapsLock SHALL produce no output\n3. WHEN a Rhai script defines `pass()` as default THEN undefined keys SHALL pass through unchanged\n4. WHEN processing a key event THEN the latency overhead SHALL be measurable via `keyrx bench`\n5. IF no remapping is defined for a key THEN the key event SHALL pass through to the OS unchanged\n6. WHEN the engine processes key events THEN both key-down and key-up events SHALL be handled correctly\n\n### REQ-5: Event Simulation (Headless Testing)\n\n**User Story:** As a developer, I want to simulate key events without real keyboard input, so that I can test remapping logic autonomously.\n\n#### Acceptance Criteria\n\n1. WHEN a user runs `keyrx simulate --input \"A\" --script config.rhai` THEN the system SHALL process the simulated key event\n2. WHEN simulation completes THEN the system SHALL output the resulting action (remapped key, blocked, passed)\n3. WHEN a user runs `keyrx simulate --input \"A,B,C\"` THEN the system SHALL process multiple keys in sequence\n4. WHEN a user specifies `--json` flag THEN output SHALL be in JSON format for programmatic parsing\n5. WHEN simulation mode is active THEN NO real keyboard hooks SHALL be installed\n6. IF the script modifies engine state THEN subsequent simulated keys SHALL reflect that state\n\n### REQ-6: Self-Diagnostics\n\n**User Story:** As a user, I want to run diagnostics, so that I can verify my system is correctly configured for KeyRx.\n\n#### Acceptance Criteria\n\n1. WHEN a user runs `keyrx doctor` THEN the system SHALL check platform-specific requirements\n2. WHEN on Linux THEN `keyrx doctor` SHALL verify uinput/evdev access permissions\n3. WHEN on Windows THEN `keyrx doctor` SHALL verify keyboard hook registration capability\n4. WHEN all checks pass THEN the system SHALL display \"All checks passed\" and exit with code 0\n5. IF any check fails THEN the system SHALL display the failing check with remediation guidance\n6. WHEN a user specifies `--verbose` THEN detailed diagnostic information SHALL be displayed\n\n### REQ-7: Latency Benchmarking\n\n**User Story:** As a developer, I want to benchmark input latency, so that I can ensure performance meets requirements.\n\n#### Acceptance Criteria\n\n1. WHEN a user runs `keyrx bench` THEN the system SHALL run latency benchmarks\n2. WHEN benchmarking completes THEN the system SHALL display min/max/mean/p99 latency statistics\n3. WHEN a user specifies `--iterations N` THEN the benchmark SHALL run N iterations\n4. WHEN a user specifies `--json` THEN output SHALL be in JSON format\n5. WHEN latency exceeds 1ms mean THEN the output SHALL include a warning\n6. WHEN benchmarking THEN the system SHALL measure script execution time separately from event processing\n\n### REQ-8: Cross-Platform Build\n\n**User Story:** As a developer, I want to build KeyRx for both Linux and Windows from the same codebase, so that I can support multiple platforms.\n\n#### Acceptance Criteria\n\n1. WHEN running `cargo build --release` on Linux THEN a Linux binary SHALL be produced\n2. WHEN running `cargo build --release` on Windows THEN a Windows binary SHALL be produced\n3. WHEN cross-compiling with `cargo build --target x86_64-pc-windows-gnu` on Linux THEN a Windows binary SHALL be produced\n4. WHEN building THEN platform-specific drivers SHALL be conditionally compiled via Cargo features\n5. WHEN the binary is built THEN it SHALL have no external runtime dependencies\n6. IF a platform is unsupported THEN the build SHALL fail with a clear error message\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Each module handles one concern (engine, scripting, drivers, CLI)\n- **Modular Design**: OS drivers implement `InputSource` trait for interchangeability\n- **Dependency Injection**: All external dependencies injected for testability\n- **Clear Interfaces**: Traits define contracts between engine, scripting, and OS layers\n\n### Performance\n- Input-to-output latency overhead < 1ms (measured via `keyrx bench`)\n- Memory usage < 50MB idle\n- Startup time < 500ms to operational state\n\n### Security\n- Rhai scripts are sandboxed (no filesystem, network, or system call access)\n- Scripts cannot crash the engine (panics are caught and logged)\n- No elevated privileges required for core functionality\n\n### Reliability\n- Engine survives malformed Rhai scripts without crashing\n- Graceful shutdown on SIGINT/SIGTERM (Linux) or Ctrl+C (Windows)\n- All key events are processed or explicitly dropped (no silent failures)\n\n### Testability\n- 80% code coverage minimum for core modules\n- All CLI commands testable via simulated input\n- Mock implementations available for InputSource, ScriptRuntime, StateStore traits\n\n### Usability\n- All CLI commands support `--help` with usage examples\n- Error messages include actionable remediation steps\n- JSON output mode (`--json`) for AI agent consumption\n",
  "fileStats": {
    "size": 8283,
    "lines": 151,
    "lastModified": "2025-11-29T19:11:41.936Z"
  },
  "comments": []
}