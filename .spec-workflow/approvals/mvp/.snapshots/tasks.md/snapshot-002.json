{
  "id": "snapshot_1764443824773_2809dn1z6",
  "approvalId": "approval_1764443795563_ftz77digi",
  "approvalTitle": "MVP Tasks Document",
  "version": 2,
  "timestamp": "2025-11-29T19:17:04.773Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: MVP\n\n## Task 1: Complete KeyCode Enum and Event Types\n\n- [ ] 1. Expand KeyCode enum with full keyboard coverage\n  - File: `core/src/engine/types.rs`\n  - Add all standard keyboard keys (A-Z, 0-9, F1-F12, modifiers, special keys)\n  - Add `RemapAction` enum (Remap, Block, Pass)\n  - Ensure `KeyCode` implements `Hash`, `Eq`, `Copy`, `Clone`, `Debug`\n  - Purpose: Establish complete type system for key handling\n  - _Leverage: Existing `InputEvent`, `OutputAction` in types.rs_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in type systems | Task: Expand KeyCode enum in core/src/engine/types.rs to cover full keyboard (A-Z, 0-9, F1-F12, modifiers, special keys). Add RemapAction enum with variants Remap(KeyCode), Block, Pass. Ensure all types derive Hash, Eq, Copy, Clone, Debug, Serialize, Deserialize | Restrictions: Keep file under 200 lines, use standard US keyboard layout as reference, do not add mouse or gamepad codes yet | _Leverage: Existing InputEvent, OutputAction structs | _Requirements: REQ-4 (Basic Key Remapping) | Success: All common keyboard keys represented, types compile without errors, can be used as HashMap keys. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 2: Create RemapRegistry\n\n- [ ] 2. Implement RemapRegistry for tracking key mappings\n  - File: `core/src/scripting/registry.rs`\n  - Create `RemapRegistry` struct with `HashMap<KeyCode, RemapAction>`\n  - Implement `remap()`, `block()`, `pass()`, `lookup()`, `clear()` methods\n  - Add `Default` impl that returns Pass for unmapped keys\n  - Purpose: Central storage for script-defined key behaviors\n  - _Leverage: KeyCode, RemapAction from engine/types.rs_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with expertise in data structures | Task: Create RemapRegistry in core/src/scripting/registry.rs. Struct holds HashMap<KeyCode, RemapAction>. Implement: remap(from, to), block(key), pass(key), lookup(key) -> RemapAction, clear(). Default returns Pass for unmapped keys | Restrictions: Keep struct simple, no async, no external deps, max 100 lines | _Leverage: KeyCode, RemapAction from engine/types.rs | _Requirements: REQ-4 | Success: All methods work correctly, lookup returns Pass by default, unit tests pass. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n- [ ] 2.1 Add RemapRegistry to scripting module\n  - File: `core/src/scripting/mod.rs`\n  - Add `mod registry;` and `pub use registry::RemapRegistry;`\n  - Purpose: Export registry from scripting module\n  - _Leverage: Existing mod.rs structure_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Update core/src/scripting/mod.rs to add mod registry and pub use registry::RemapRegistry | Restrictions: Only add 2 lines, preserve existing exports | _Requirements: REQ-4 | Success: RemapRegistry is importable from keyrx_core::scripting. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 3: Register Rhai Remap Functions\n\n- [ ] 3. Register remap/block/pass functions in RhaiRuntime\n  - File: `core/src/scripting/runtime.rs`\n  - Add `RemapRegistry` field to `RhaiRuntime`\n  - Register `remap(from: &str, to: &str)` that calls `registry.remap()`\n  - Register `block(key: &str)` that calls `registry.block()`\n  - Register `pass(key: &str)` that calls `registry.pass()`\n  - Add `registry()` accessor method\n  - Purpose: Enable Rhai scripts to define key behaviors\n  - _Leverage: Existing Rhai engine setup, RemapRegistry_\n  - _Requirements: REQ-3, REQ-4_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with Rhai experience | Task: Modify core/src/scripting/runtime.rs to add RemapRegistry field. Register functions: remap(from: &str, to: &str), block(key: &str), pass(key: &str). Parse string keys to KeyCode. Add registry() -> &RemapRegistry accessor | Restrictions: Handle invalid key names gracefully (log warning, ignore), keep sandbox limits | _Leverage: Existing RhaiRuntime, RemapRegistry | _Requirements: REQ-3, REQ-4 | Success: Rhai scripts can call remap(\"A\", \"B\"), block(\"CapsLock\"), pass(\"Enter\"). Registry reflects calls. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 4: Implement Event Processing Loop\n\n- [ ] 4. Add process_event and run_loop to Engine\n  - File: `core/src/engine/event_loop.rs`\n  - Implement `process_event(&mut self, event: InputEvent) -> Result<OutputAction>`\n  - Query ScriptRuntime's registry for remapping decision\n  - Implement `run_loop(&mut self) -> Result<()>` that polls InputSource\n  - Handle graceful shutdown on stop signal\n  - Purpose: Core event processing pipeline\n  - _Leverage: Existing Engine struct, InputSource trait, ScriptRuntime trait_\n  - _Requirements: REQ-2, REQ-4_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with async experience | Task: Add to Engine in core/src/engine/event_loop.rs: process_event(event: InputEvent) -> Result<OutputAction> that looks up event.key in script runtime's registry and returns appropriate OutputAction. Add run_loop() that polls input source in a loop, processes events, and respects self.running flag | Restrictions: Keep loop simple, no complex buffering, handle both key-down and key-up | _Leverage: Existing Engine, InputSource, ScriptRuntime | _Requirements: REQ-2, REQ-4 | Success: Events flow through pipeline, remappings applied correctly, loop exits cleanly. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n- [ ] 4.1 Add registry accessor to ScriptRuntime trait\n  - File: `core/src/traits/script_runtime.rs`\n  - Add `fn registry(&self) -> &RemapRegistry;` to trait\n  - Update MockRuntime to implement new method\n  - Purpose: Allow Engine to query remappings from any ScriptRuntime\n  - _Leverage: Existing ScriptRuntime trait_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Add registry() -> &RemapRegistry method to ScriptRuntime trait in core/src/traits/script_runtime.rs. Update MockRuntime in mocks/mock_runtime.rs to implement this method (return empty registry) | Restrictions: Keep trait changes minimal | _Leverage: Existing trait definition | _Requirements: REQ-4 | Success: Trait compiles, MockRuntime compiles, Engine can call script.registry(). Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 5: Implement Simulate Command\n\n- [ ] 5. Create simulate command for headless testing\n  - File: `core/src/cli/commands/simulate.rs`\n  - Parse `--input \"A,B,C\"` into sequence of InputEvents\n  - Load script with RhaiRuntime\n  - Process each event through Engine with MockInput\n  - Output results (original key -> output action)\n  - Support `--json` flag via OutputWriter\n  - Purpose: Enable autonomous testing without real keyboard\n  - _Leverage: Engine, MockInput, RhaiRuntime, OutputWriter_\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with CLI experience | Task: Create SimulateCommand in core/src/cli/commands/simulate.rs. Parse --input \"A,B,C\" into InputEvents. Create Engine with MockInput, load script with RhaiRuntime. Process each event, collect OutputActions. Print results using OutputWriter (human: \"A -> B\", json: structured output) | Restrictions: No real keyboard hooks, use mocks only, handle parse errors gracefully | _Leverage: Engine, MockInput, RhaiRuntime, OutputWriter | _Requirements: REQ-5 | Success: keyrx simulate --input \"A\" --script test.rhai outputs remapped result. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n- [ ] 5.1 Wire simulate command into CLI\n  - File: `core/src/bin/keyrx.rs`, `core/src/cli/commands/mod.rs`\n  - Add `Simulate` variant to Commands enum\n  - Import and call `SimulateCommand`\n  - Export SimulateCommand from mod.rs\n  - Purpose: Make simulate command accessible via CLI\n  - _Leverage: Existing CLI structure_\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Update core/src/bin/keyrx.rs to add Simulate command with --input and --script args. Update core/src/cli/commands/mod.rs to export SimulateCommand. Wire up command execution | Restrictions: Follow existing command patterns | _Requirements: REQ-5 | Success: keyrx simulate --help works, command executes. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 6: Implement Bench Command\n\n- [ ] 6. Create bench command for latency measurement\n  - File: `core/src/cli/commands/bench.rs`\n  - Create `BenchCommand` struct with iterations count\n  - Create `BenchResult` struct (min, max, mean, p99 in nanoseconds)\n  - Run N iterations of event processing with MockInput\n  - Calculate statistics using `std::time::Instant`\n  - Warn if mean > 1ms\n  - Purpose: Verify performance requirements\n  - _Leverage: Engine, MockInput, OutputWriter_\n  - _Requirements: REQ-7_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with performance testing experience | Task: Create BenchCommand in core/src/cli/commands/bench.rs. Accept --iterations (default 10000). Time event processing using Instant::now(). Calculate min/max/mean/p99 latency. Create BenchResult struct. Output via OutputWriter. Add warning if mean > 1_000_000 ns (1ms) | Restrictions: Use mocks not real input, keep measurement overhead minimal | _Leverage: Engine, MockInput, OutputWriter | _Requirements: REQ-7 | Success: keyrx bench outputs latency stats, --json works. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n- [ ] 6.1 Wire bench command into CLI\n  - File: `core/src/bin/keyrx.rs`, `core/src/cli/commands/mod.rs`\n  - Replace placeholder bench implementation\n  - Export BenchCommand from mod.rs\n  - Purpose: Make bench command functional\n  - _Leverage: Existing CLI structure_\n  - _Requirements: REQ-7_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Update core/src/bin/keyrx.rs to call BenchCommand instead of placeholder. Update mod.rs to export BenchCommand | Restrictions: Follow existing patterns | _Requirements: REQ-7 | Success: keyrx bench runs and outputs stats. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 7: Complete Doctor Command\n\n- [ ] 7. Implement platform-specific diagnostics\n  - File: `core/src/cli/commands/doctor.rs`\n  - Create `DiagnosticCheck` struct (name, status, message, remediation)\n  - Linux: Check `/dev/uinput` exists and is accessible\n  - Linux: Check user is in `input` group\n  - Windows: Check keyboard hook API accessible\n  - Collect all checks, report pass/fail with remediation\n  - Purpose: Help users diagnose system setup issues\n  - _Leverage: OutputWriter, platform-specific conditionals_\n  - _Requirements: REQ-6_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with cross-platform experience | Task: Enhance DoctorCommand in core/src/cli/commands/doctor.rs. Create DiagnosticCheck struct. Add checks: Linux - /dev/uinput exists, user in input group. Windows - keyboard hook registerable. Use #[cfg(target_os)] for platform code. Output all checks with pass/fail and remediation hints | Restrictions: Checks must not require elevated privileges to run, only to pass | _Leverage: OutputWriter | _Requirements: REQ-6 | Success: keyrx doctor shows all checks with clear status and remediation. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 8: Implement Linux Driver Stub\n\n- [ ] 8. Create Linux InputSource implementation\n  - File: `core/src/drivers/linux.rs`\n  - Implement `LinuxInput` struct implementing `InputSource`\n  - Start: Open `/dev/uinput` or return error with remediation\n  - Poll: Read events from evdev (stub: return empty vec)\n  - Stop: Close file descriptors\n  - Purpose: Linux platform driver foundation\n  - _Leverage: evdev crate, InputSource trait_\n  - _Requirements: REQ-1, REQ-8_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with Linux systems experience | Task: Implement LinuxInput in core/src/drivers/linux.rs. Struct holds evdev device handle (Option for stub). Implement InputSource trait: start() opens device or returns descriptive error, poll_events() returns Vec<InputEvent> (empty for stub), stop() closes handle. Use async-trait | Restrictions: Keep as working stub, full evdev integration is post-MVP, handle permission errors gracefully | _Leverage: evdev crate, InputSource trait | _Requirements: REQ-1, REQ-8 | Success: Compiles on Linux, start() gives clear error if uinput unavailable. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 9: Implement Windows Driver Stub\n\n- [ ] 9. Create Windows InputSource implementation\n  - File: `core/src/drivers/windows.rs`\n  - Implement `WindowsInput` struct implementing `InputSource`\n  - Start: Attempt keyboard hook registration (stub: log and succeed)\n  - Poll: Return empty events (stub)\n  - Stop: Unhook keyboard\n  - Purpose: Windows platform driver foundation\n  - _Leverage: windows-rs crate, InputSource trait_\n  - _Requirements: REQ-1, REQ-8_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with Windows API experience | Task: Implement WindowsInput in core/src/drivers/windows.rs. Use windows-rs crate. Implement InputSource trait: start() logs hook registration attempt (stub: always succeed), poll_events() returns empty Vec, stop() logs unhook. Use #[cfg(windows)] guard | Restrictions: Keep as working stub, full hook integration is post-MVP, no blocking calls | _Leverage: windows-rs crate, InputSource trait | _Requirements: REQ-1, REQ-8 | Success: Compiles on Windows, can be instantiated and started. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 10: Complete Run Command with Real Engine\n\n- [ ] 10. Wire up run command with full engine pipeline\n  - File: `core/src/cli/commands/run.rs`\n  - Load script via RhaiRuntime if provided\n  - Call on_init() hook if defined\n  - Create Engine with platform driver (or MockInput if --mock flag)\n  - Run event loop until Ctrl+C\n  - Output debug info if --debug flag\n  - Purpose: Make engine actually process real/simulated input\n  - _Leverage: Engine, RhaiRuntime, LinuxInput/WindowsInput, OutputWriter_\n  - _Requirements: REQ-2, REQ-3_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Enhance RunCommand in core/src/cli/commands/run.rs. If --script provided, load with RhaiRuntime and call on_init() if present. Create Engine with appropriate InputSource (platform driver or MockInput if --mock). Run event loop. On Ctrl+C, stop engine gracefully. Debug flag enables verbose logging | Restrictions: Use tracing for debug output, handle all errors gracefully | _Leverage: Engine, RhaiRuntime, drivers | _Requirements: REQ-2, REQ-3 | Success: keyrx run --script config.rhai starts engine, processes events, stops cleanly. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 11: Create Example Rhai Script\n\n- [ ] 11. Create example remap script\n  - File: `scripts/std/example.rhai`\n  - Demonstrate remap(), block(), pass() functions\n  - Include on_init() hook with debug message\n  - Add comments explaining each function\n  - Purpose: Provide working example for users and testing\n  - _Leverage: Rhai functions registered in RhaiRuntime_\n  - _Requirements: REQ-3, REQ-4_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rhai Script Developer | Task: Create example.rhai in scripts/std/. Define on_init() that prints debug message. Call remap(\"CapsLock\", \"Escape\"), block(\"Insert\"), pass(\"Enter\"). Add comments explaining each function. Keep script simple and educational | Restrictions: Only use registered functions, no undefined calls | _Leverage: Registered remap/block/pass functions | _Requirements: REQ-3, REQ-4 | Success: keyrx check scripts/std/example.rhai passes, keyrx run --script scripts/std/example.rhai starts without error. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 12: Add Unit Tests for Core Components\n\n- [ ] 12. Create engine unit tests\n  - File: `core/tests/engine_test.rs`\n  - Test Engine creation with mocks\n  - Test process_event with various RemapActions\n  - Test key-down and key-up handling\n  - Purpose: Verify core engine behavior\n  - _Leverage: MockInput, MockRuntime, MockState_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Test Engineer | Task: Create core/tests/engine_test.rs. Test Engine::new with mocks. Test process_event: remap A->B, block CapsLock, pass Enter. Test both key-down (pressed=true) and key-up (pressed=false) events produce correct OutputActions | Restrictions: Use only mocks, no real input, aim for 80% coverage of event_loop.rs | _Leverage: MockInput, MockRuntime, MockState | _Requirements: REQ-4 | Success: All tests pass, cover main code paths. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n- [ ] 12.1 Create simulate command tests\n  - File: `core/tests/simulate_test.rs`\n  - Test input parsing (\"A,B,C\" -> events)\n  - Test simulate with simple remap script\n  - Test JSON output format\n  - Purpose: Verify simulate command works correctly\n  - _Leverage: SimulateCommand_\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Test Engineer | Task: Create core/tests/simulate_test.rs. Test input string parsing. Test simulate with remap script produces correct output. Test --json flag produces valid JSON | Restrictions: Use temp files for test scripts | _Leverage: SimulateCommand, tempfile crate | _Requirements: REQ-5 | Success: All tests pass, simulate command verified. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n- [ ] 12.2 Create RemapRegistry unit tests\n  - File: `core/src/scripting/registry.rs` (inline tests)\n  - Test remap, block, pass, lookup, clear methods\n  - Test default behavior (unmapped keys return Pass)\n  - Purpose: Verify registry correctness\n  - _Leverage: RemapRegistry_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Test Engineer | Task: Add #[cfg(test)] mod tests to core/src/scripting/registry.rs. Test: remap A->B then lookup A returns Remap(B). Test block CapsLock then lookup returns Block. Test unmapped key returns Pass. Test clear resets all | Restrictions: Keep tests inline in same file | _Requirements: REQ-4 | Success: cargo test registry passes. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 13: Build Verification\n\n- [ ] 13. Verify Linux build\n  - Run `cargo build --release` on Linux\n  - Run `cargo test` to verify all tests pass\n  - Run `keyrx --help` to verify CLI works\n  - Run `keyrx check scripts/std/example.rhai`\n  - Purpose: Confirm Linux build works end-to-end\n  - _Requirements: REQ-1, REQ-8_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Build Engineer | Task: On Linux, run: cargo build --release, cargo test, ./target/release/keyrx --help, ./target/release/keyrx check scripts/std/example.rhai. Fix any build or test failures | Restrictions: All commands must exit 0 | _Requirements: REQ-1, REQ-8 | Success: All commands succeed, binary runs. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n- [ ] 13.1 Verify Windows build (or cross-compile)\n  - Run `cargo build --release` on Windows OR\n  - Run `cargo build --target x86_64-pc-windows-gnu` for cross-compile\n  - Verify binary is produced\n  - Purpose: Confirm Windows build works\n  - _Requirements: REQ-1, REQ-8_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Build Engineer | Task: Build for Windows target. Either on Windows run cargo build --release, or on Linux run cargo build --target x86_64-pc-windows-gnu (requires mingw-w64 installed). Verify .exe is produced | Restrictions: Binary must be produced without errors | _Requirements: REQ-1, REQ-8 | Success: Windows binary exists and is valid PE executable. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n\n## Task 14: Documentation\n\n- [ ] 14. Update CLI help text and README\n  - File: `core/src/bin/keyrx.rs`, `README.md`\n  - Ensure all commands have descriptive help text\n  - Add basic usage examples to README\n  - Purpose: Users can understand how to use KeyRx\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer | Task: Review all command definitions in keyrx.rs, ensure #[command(about)] and #[arg(help)] are clear. Update README.md with: Installation (cargo build), Basic Usage (keyrx run, check, simulate, doctor, bench), Example Script | Restrictions: Keep README concise, link to detailed docs if needed | _Requirements: REQ-2 | Success: keyrx --help is clear, README has working examples. Mark task [-] in tasks.md before starting, log implementation with log-implementation tool after completion, then mark [x] when complete._\n",
  "fileStats": {
    "size": 24038,
    "lines": 243,
    "lastModified": "2025-11-29T19:16:26.077Z"
  },
  "comments": []
}