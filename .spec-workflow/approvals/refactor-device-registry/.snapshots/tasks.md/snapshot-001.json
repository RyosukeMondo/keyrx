{
  "id": "snapshot_1766157054798_6pb4zhpc6",
  "approvalId": "approval_1766157054729_x03obx6gz",
  "approvalTitle": "Tasks for Refactoring Device Registry",
  "version": 1,
  "timestamp": "2025-12-19T15:10:54.798Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n- [ ] 1. Create DeviceConfig model\n  - File: packages/core_logic/lib/models/device_config.dart\n  - Define `DeviceConfig` using Freezed.\n  - Purpose: Data structure for persistence.\n  - _Leverage: freezed_\n  - _Requirements: 1_\n  - _Prompt: Role: Dart Developer | Task: Create `DeviceConfig` model in `packages/core_logic` with a list of `DeviceIdentity`. Use Freezed. | Restrictions: None. | Success: Model generates without error._\n\n- [ ] 2. Implement DeviceConfigRepository\n  - File: packages/core_logic/lib/repositories/device_config_repository.dart\n  - Implement JSON file reading/writing using `dart:io`.\n  - Handle platform-specific config paths (XDG on Linux).\n  - Purpose: Persistence layer.\n  - _Requirements: 1, Non-Functional (Modularity)_\n  - _Prompt: Role: Backend Developer | Task: Implement `DeviceConfigRepository`. Use `path_provider` (or manual env var check if package not available in pure dart) to find `~/.config/keyrx`. Implement load/save with atomic write pattern. | Restrictions: Must work in pure Dart (no Flutter deps). | Success: Repository can save and load config from disk._\n\n- [ ] 3. Create Shared DeviceRegistryService\n  - File: packages/core_logic/lib/services/device_registry_service.dart\n  - Port logic from `ui/.../device_registry_service.dart`.\n  - Replace `SharedPreferences` with `DeviceConfigRepository`.\n  - Purpose: Unified logic.\n  - _Leverage: ui/lib/services/device_registry_service.dart_\n  - _Requirements: 2_\n  - _Prompt: Role: Refactoring Specialist | Task: Port `DeviceRegistryService` to `packages/core_logic`. Inject `KeyrxBridge` and `DeviceConfigRepository`. Implement merging logic. | Restrictions: No Flutter imports. | Success: Service compiles and passes unit tests._\n\n- [ ] 4. Update CLI to use new Service\n  - File: apps/cli_tool/lib/command_processor.dart\n  - Inject `DeviceRegistryService` into the command processor.\n  - Update `listDevices` to use the service instead of raw Bridge.\n  - Add commands: `addVirtual`, `removeVirtual`, `setLabel`.\n  - Purpose: CLI capabilities.\n  - _Requirements: 3_\n  - _Prompt: Role: Tooling Engineer | Task: Update CLI `CommandProcessor` to use `DeviceRegistryService`. Add support for `addVirtual`, `removeVirtual`, `setLabel` commands. | Restrictions: None. | Success: CLI commands modify the JSON config file._\n\n- [ ] 5. Refactor UI to use Shared Service\n  - File: ui/lib/services/device_registry_service.dart\n  - Delete old implementation.\n  - Re-implement as a wrapper/provider around the `core_logic` service.\n  - Purpose: UI consistency.\n  - _Requirements: 4_\n  - _Prompt: Role: Flutter Developer | Task: Update `ui/lib/services/device_registry_service.dart` to simply export or provide the `core_logic` service. Update Riverpod providers to construct the shared service with the repository. | Restrictions: Ensure UI still compiles. | Success: UI displays devices from the JSON config._\n\n- [ ] 6. Verify Consistency\n  - File: scripts/verify_registry_consistency.sh\n  - Script that adds a device via CLI and asserts existence in the config file.\n  - Purpose: Verification.\n  - _Requirements: 3_\n  - _Prompt: Role: QA Engineer | Task: Create a verification script. | Restrictions: None. | Success: Script passes._\n",
  "fileStats": {
    "size": 3236,
    "lines": 51,
    "lastModified": "2025-12-19T15:10:54.657Z"
  },
  "comments": []
}