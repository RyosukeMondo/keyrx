{
  "id": "snapshot_1764768193761_3geu0e93x",
  "approvalId": "approval_1764767190512_wq4xy2r6t",
  "approvalTitle": "CLI Exit Code Refactor - Design",
  "version": 2,
  "timestamp": "2025-12-03T13:23:13.761Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design introduces a type-safe exit code system using Rust's type system to propagate exit codes through the command hierarchy. The core innovation is the `CommandResult<T>` type that carries both the result value and the intended exit code, eliminating string-based exit code extraction.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **CLI First**: Reliable CLI is foundational\n- **Semantic Exit Codes**: Documented in tech.md (0=success, 1=error, 2=assertion, 3=timeout)\n- **Error Handling**: Structured errors with context\n\n### Project Structure (structure.md)\n- Entry point remains at `core/src/bin/keyrx.rs` but shrinks to ~150 LOC\n- Command structs move to `core/src/cli/commands/`\n- Exit code types in `core/src/cli/exit_codes.rs`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`config/exit_codes.rs`**: Already defines exit code constants\n- **`anyhow::Result`**: Base error handling (wrap, don't replace)\n- **clap derive macros**: Keep existing command parsing\n\n### Integration Points\n- **All 20+ commands**: Must return `CommandResult<T>`\n- **Error types**: Must implement `HasExitCode` trait\n- **Main function**: Simplified dispatch logic\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Entry Point (keyrx.rs)\"\n        MAIN[main] --> DISPATCH[dispatch_command]\n        DISPATCH --> EXIT[determine_exit_code]\n    end\n\n    subgraph \"Command Layer\"\n        DISPATCH --> RUN[RunCommand]\n        DISPATCH --> CHECK[CheckCommand]\n        DISPATCH --> TEST[TestCommand]\n        DISPATCH --> SIM[SimulateCommand]\n    end\n\n    subgraph \"Result Types\"\n        RUN --> CR[CommandResult<T>]\n        CHECK --> CR\n        TEST --> CR\n        SIM --> CR\n        CR --> EC[ExitCode]\n    end\n\n    subgraph \"Error Types\"\n        CE[CommandError] --> HEC[HasExitCode trait]\n        VE[ValidationError] --> HEC\n        TE[TestError] --> HEC\n    end\n```\n\n### Modular Design Principles\n- **Single File Responsibility**: `keyrx.rs` only dispatches, commands implement\n- **Component Isolation**: Commands don't know about each other\n- **Service Layer Separation**: Parsing (clap) → Dispatch → Command → Core logic\n- **Utility Modularity**: Shared error handling in `cli/error.rs`\n\n## Components and Interfaces\n\n### Component 1: ExitCode Enum\n\n- **Purpose:** Type-safe exit code representation with semantics\n- **Interfaces:**\n  ```rust\n  #[derive(Debug, Clone, Copy, PartialEq, Eq)]\n  #[repr(u8)]\n  pub enum ExitCode {\n      Success = 0,\n      GeneralError = 1,\n      AssertionFailed = 2,\n      Timeout = 3,\n      ValidationFailed = 4,\n      PermissionDenied = 5,\n      DeviceNotFound = 6,\n      ScriptError = 7,\n      // Reserved: 100+ for signals, 101 for panic\n  }\n\n  impl ExitCode {\n      pub fn as_u8(self) -> u8 { self as u8 }\n      pub fn as_process_code(self) -> std::process::ExitCode {\n          std::process::ExitCode::from(self.as_u8())\n      }\n      pub fn description(self) -> &'static str { ... }\n  }\n  ```\n- **Dependencies:** None\n- **Reuses:** Constants from `config/exit_codes.rs`\n\n### Component 2: CommandResult<T>\n\n- **Purpose:** Carry both success value and potential exit code through command execution\n- **Interfaces:**\n  ```rust\n  pub struct CommandResult<T> {\n      value: Option<T>,\n      exit_code: ExitCode,\n      messages: Vec<String>,\n  }\n\n  impl<T> CommandResult<T> {\n      pub fn success(value: T) -> Self;\n      pub fn success_with_message(value: T, msg: impl Into<String>) -> Self;\n      pub fn failure(code: ExitCode, msg: impl Into<String>) -> Self;\n      pub fn from_result(result: Result<T, impl HasExitCode>) -> Self;\n\n      pub fn exit_code(&self) -> ExitCode;\n      pub fn is_success(&self) -> bool;\n      pub fn value(self) -> Option<T>;\n  }\n  ```\n- **Dependencies:** `ExitCode`\n- **Reuses:** Pattern from Rust's `Result`\n\n### Component 3: HasExitCode Trait\n\n- **Purpose:** Allow any error type to specify its exit code\n- **Interfaces:**\n  ```rust\n  pub trait HasExitCode {\n      fn exit_code(&self) -> ExitCode;\n  }\n\n  impl HasExitCode for anyhow::Error {\n      fn exit_code(&self) -> ExitCode {\n          self.downcast_ref::<CommandError>()\n              .map(|e| e.exit_code())\n              .unwrap_or(ExitCode::GeneralError)\n      }\n  }\n  ```\n- **Dependencies:** `ExitCode`\n- **Reuses:** Rust trait pattern\n\n### Component 4: CommandError\n\n- **Purpose:** Structured command errors with exit codes and context\n- **Interfaces:**\n  ```rust\n  #[derive(Debug, thiserror::Error)]\n  pub enum CommandError {\n      #[error(\"Validation failed: {message}\")]\n      Validation { message: String, location: Option<Location> },\n\n      #[error(\"Test failed: {passed}/{total} tests passed\")]\n      TestFailure { passed: usize, total: usize },\n\n      #[error(\"Device not found: {device_id}\")]\n      DeviceNotFound { device_id: String },\n\n      #[error(\"Permission denied: {resource}\")]\n      PermissionDenied { resource: String },\n\n      #[error(\"Timeout after {duration:?}\")]\n      Timeout { duration: Duration },\n\n      #[error(\"{message}\")]\n      Other { message: String, code: ExitCode },\n  }\n\n  impl HasExitCode for CommandError {\n      fn exit_code(&self) -> ExitCode {\n          match self {\n              Self::Validation { .. } => ExitCode::ValidationFailed,\n              Self::TestFailure { .. } => ExitCode::AssertionFailed,\n              Self::DeviceNotFound { .. } => ExitCode::DeviceNotFound,\n              Self::PermissionDenied { .. } => ExitCode::PermissionDenied,\n              Self::Timeout { .. } => ExitCode::Timeout,\n              Self::Other { code, .. } => *code,\n          }\n      }\n  }\n  ```\n- **Dependencies:** `ExitCode`, `thiserror`\n- **Reuses:** `thiserror` derive pattern\n\n### Component 5: Command Trait\n\n- **Purpose:** Standardize command execution interface\n- **Interfaces:**\n  ```rust\n  pub trait Command {\n      type Output;\n\n      fn execute(&self, ctx: &CommandContext) -> CommandResult<Self::Output>;\n\n      fn name(&self) -> &'static str;\n  }\n\n  pub struct CommandContext {\n      pub output_format: OutputFormat,\n      pub verbosity: Verbosity,\n      pub color: ColorChoice,\n  }\n  ```\n- **Dependencies:** `CommandResult`\n- **Reuses:** clap command pattern\n\n## Data Models\n\n### Location\n```rust\n#[derive(Debug, Clone)]\npub struct Location {\n    pub file: PathBuf,\n    pub line: usize,\n    pub column: usize,\n}\n```\n\n### OutputFormat\n```rust\n#[derive(Debug, Clone, Copy, Default)]\npub enum OutputFormat {\n    #[default]\n    Human,\n    Json,\n    Quiet,\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Command parsing failure (clap)**\n   - **Handling:** clap returns exit code 2 by default\n   - **User Impact:** Usage help displayed\n\n2. **Validation error in script**\n   - **Handling:** `CommandError::Validation` with location\n   - **User Impact:** File:line:col shown with error message\n\n3. **Test assertion failure**\n   - **Handling:** `CommandError::TestFailure` with pass/fail counts\n   - **User Impact:** Summary and exit code 2\n\n4. **Unhandled panic**\n   - **Handling:** Panic hook sets exit code 101\n   - **User Impact:** Stack trace in debug mode, clean message in release\n\n## Testing Strategy\n\n### Unit Testing\n- Test each `ExitCode` variant serializes correctly\n- Test `CommandResult` construction and access\n- Test `HasExitCode` implementations\n\n### Integration Testing\n- Run each command with expected success/failure inputs\n- Verify exit codes match documentation\n- Test error message formatting\n\n### End-to-End Testing\n- Script that runs commands and checks `$?`\n- CI job that verifies exit codes\n",
  "fileStats": {
    "size": 7552,
    "lines": 267,
    "lastModified": "2025-12-03T12:59:41.785Z"
  },
  "comments": []
}