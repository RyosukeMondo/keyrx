{
  "id": "snapshot_1764767190871_6qh5qrst7",
  "approvalId": "approval_1764767190862_cde43nxfa",
  "approvalTitle": "CLI Exit Code Refactor - Tasks",
  "version": 1,
  "timestamp": "2025-12-03T13:06:30.871Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n## Phase 1: Foundation Types\n\n- [ ] 1. Create ExitCode enum\n  - File: `core/src/cli/exit_codes.rs`\n  - Define enum with all exit code variants (0-7, reserved 100+)\n  - Implement `as_u8()`, `as_process_code()`, `description()`\n  - Add Display impl for human-readable output\n  - Purpose: Type-safe exit code representation\n  - _Leverage: Existing constants in `config/exit_codes.rs`_\n  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in type design | Task: Create ExitCode enum in core/src/cli/exit_codes.rs with all variants and conversions | Restrictions: Use repr(u8) for stable ABI, implement Into<std::process::ExitCode>, follow existing config pattern | _Leverage: config/exit_codes.rs constants | Success: Enum compiles, all variants have correct values, conversions work | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 2. Create CommandResult<T> type\n  - File: `core/src/cli/result.rs`\n  - Define struct with value, exit_code, messages fields\n  - Implement success(), failure(), from_result() constructors\n  - Add is_success(), exit_code(), value() accessors\n  - Purpose: Carry exit codes through command execution\n  - _Leverage: Rust Result pattern_\n  - _Requirements: 2.1, 2.2, 2.3_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with type system expertise | Task: Create CommandResult<T> in core/src/cli/result.rs following requirements 2.1-2.3 | Restrictions: Must be ergonomic to use, support message chaining, preserve exit codes | _Leverage: Rust Result/Option patterns | Success: Type compiles, constructors work, exit codes preserved through operations | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 3. Create HasExitCode trait\n  - File: `core/src/cli/traits.rs`\n  - Define trait with exit_code() method\n  - Implement for anyhow::Error (downcast to CommandError)\n  - Implement for std::io::Error (map to appropriate codes)\n  - Purpose: Allow any error to specify exit code\n  - _Leverage: Rust trait patterns_\n  - _Requirements: 2.1, 2.2_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with trait design expertise | Task: Create HasExitCode trait in core/src/cli/traits.rs with implementations for common error types | Restrictions: Must work with anyhow::Error via downcast, provide sensible defaults | _Leverage: anyhow downcast pattern | Success: Trait compiles, implementations work, errors carry exit codes | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 4. Create CommandError enum\n  - File: `core/src/cli/error.rs`\n  - Define variants: Validation, TestFailure, DeviceNotFound, PermissionDenied, Timeout, Other\n  - Implement HasExitCode for each variant\n  - Use thiserror for Display/Error derives\n  - Purpose: Structured command errors with context\n  - _Leverage: thiserror crate, existing error patterns_\n  - _Requirements: 4.1, 4.2, 4.3, 4.4_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in error handling | Task: Create CommandError enum in core/src/cli/error.rs with context fields and HasExitCode impl | Restrictions: Use thiserror, include location info where relevant, implement HasExitCode | _Leverage: thiserror patterns, existing error types | Success: Error variants compile, HasExitCode returns correct codes, Display shows context | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 2: Command Infrastructure\n\n- [ ] 5. Create Command trait\n  - File: `core/src/cli/command.rs`\n  - Define trait with execute(), name() methods\n  - Create CommandContext struct for shared state\n  - Add OutputFormat and Verbosity enums\n  - Purpose: Standardize command interface\n  - _Leverage: clap command patterns_\n  - _Requirements: 3.1, 3.2_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with CLI expertise | Task: Create Command trait and CommandContext in core/src/cli/command.rs | Restrictions: Must work with clap, support output formats, be async-compatible if needed | _Leverage: clap derive patterns | Success: Trait compiles, CommandContext has all needed fields, integrates with clap | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 6. Refactor entry point dispatch\n  - File: `core/src/bin/keyrx.rs`\n  - Remove string-based exit code extraction\n  - Use CommandResult for all command returns\n  - Reduce file to ~150 LOC (dispatch only)\n  - Purpose: Clean entry point\n  - _Leverage: New Command trait, CommandResult_\n  - _Requirements: 3.2, 2.1_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer refactoring CLI | Task: Refactor keyrx.rs to use Command trait and CommandResult, remove string parsing | Restrictions: Must maintain all existing functionality, reduce to ~150 LOC, use type-safe dispatch | _Leverage: Command trait, CommandResult from previous tasks | Success: Entry point compiles, all commands work, no string-based exit code logic | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 7. Add panic handler for exit code 101\n  - File: `core/src/bin/keyrx.rs`\n  - Set panic hook to catch panics\n  - Log panic info at error level\n  - Return exit code 101 (Rust convention)\n  - Purpose: Graceful panic handling\n  - _Leverage: std::panic::set_hook_\n  - _Requirements: Non-functional (reliability)_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with panic handling expertise | Task: Add panic hook in keyrx.rs that logs and returns exit code 101 | Restrictions: Must not lose panic info, log appropriately, use std::panic | _Leverage: std::panic::set_hook | Success: Panics caught, logged, exit code 101 returned | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 3: Command Migration\n\n- [ ] 8. Migrate RunCommand\n  - File: `core/src/cli/commands/run.rs`\n  - Update to return CommandResult<()>\n  - Extract command struct if not already separate\n  - Implement Command trait\n  - Purpose: First command migration\n  - _Leverage: Existing run.rs, Command trait_\n  - _Requirements: 3.1, 2.1_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer migrating commands | Task: Migrate RunCommand to use CommandResult and Command trait | Restrictions: Maintain all existing functionality, return appropriate exit codes | _Leverage: Existing run.rs, Command trait | Success: RunCommand uses new types, exit codes correct, tests pass | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 9. Migrate CheckCommand\n  - File: `core/src/cli/commands/check.rs`\n  - Return CommandResult with ValidationFailed on error\n  - Include validation errors with location info\n  - Purpose: Validation command migration\n  - _Leverage: Existing check.rs, CommandError::Validation_\n  - _Requirements: 3.1, 4.3_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer migrating commands | Task: Migrate CheckCommand to use CommandResult with proper validation errors | Restrictions: Include file:line:col in errors, return ValidationFailed exit code | _Leverage: Existing check.rs, CommandError::Validation | Success: CheckCommand uses new types, validation errors include location | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 10. Migrate TestCommand and UatCommand\n  - Files: `core/src/cli/commands/test.rs`, `core/src/cli/commands/uat.rs`\n  - Return CommandResult with AssertionFailed on test failure\n  - Include pass/fail counts in error\n  - Purpose: Test commands migration\n  - _Leverage: Existing test.rs/uat.rs, CommandError::TestFailure_\n  - _Requirements: 3.1, 1.3_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer migrating commands | Task: Migrate TestCommand and UatCommand to use CommandResult with test failure info | Restrictions: Return AssertionFailed (exit 2) on failures, include pass/fail counts | _Leverage: Existing test/uat commands, CommandError::TestFailure | Success: Test commands use new types, exit code 2 on failures | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 11. Migrate SimulateCommand\n  - File: `core/src/cli/commands/simulate.rs`\n  - Return CommandResult with appropriate errors\n  - Handle timeout with CommandError::Timeout\n  - Purpose: Simulate command migration\n  - _Leverage: Existing simulate.rs_\n  - _Requirements: 3.1, 1.4_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer migrating commands | Task: Migrate SimulateCommand to use CommandResult with timeout handling | Restrictions: Return Timeout exit code on timeout, proper error context | _Leverage: Existing simulate.rs, CommandError::Timeout | Success: SimulateCommand uses new types, timeout handled correctly | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 12. Migrate remaining commands\n  - Files: All remaining `core/src/cli/commands/*.rs`\n  - Apply same pattern to: doctor, bench, state, discover, etc.\n  - Ensure consistent Command trait implementation\n  - Purpose: Complete command migration\n  - _Leverage: Pattern from previous migrations_\n  - _Requirements: 3.1, 3.3_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer completing migration | Task: Migrate all remaining commands to use CommandResult and Command trait | Restrictions: Apply consistent pattern, maintain functionality, proper exit codes | _Leverage: Pattern from previous command migrations | Success: All commands migrated, consistent interface, all tests pass | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 4: Documentation & Testing\n\n- [ ] 13. Add exit-codes subcommand\n  - File: `core/src/cli/commands/exit_codes.rs`\n  - List all exit codes with descriptions\n  - Support --json output format\n  - Purpose: Exit code documentation\n  - _Leverage: ExitCode enum_\n  - _Requirements: 5.2_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating CLI command | Task: Create exit-codes subcommand showing all exit codes with descriptions | Restrictions: Support human and JSON output, list all codes with meanings | _Leverage: ExitCode enum, OutputFormat | Success: Command shows all exit codes, supports --json, helpful descriptions | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 14. Update --help with exit code info\n  - File: `core/src/bin/keyrx.rs`\n  - Add exit code section to main help\n  - Reference exit-codes subcommand\n  - Purpose: Discoverability\n  - _Leverage: clap after_help_\n  - _Requirements: 5.1_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer improving CLI help | Task: Add exit code documentation to --help output | Restrictions: Use clap after_help, reference exit-codes subcommand | _Leverage: clap documentation features | Success: --help shows exit code summary, points to detailed command | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 15. Add exit code integration tests\n  - File: `core/tests/cli_exit_codes_test.rs`\n  - Test each exit code scenario\n  - Verify codes match documentation\n  - Purpose: Exit code verification\n  - _Leverage: assert_cmd crate_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Test Developer | Task: Create integration tests verifying exit codes for all command scenarios | Restrictions: Test actual CLI invocation, verify all documented exit codes | _Leverage: assert_cmd crate | Success: Tests cover all exit code scenarios, run in CI | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 16. Update CHANGELOG with exit code changes\n  - File: `CHANGELOG.md`\n  - Document new exit code system\n  - List all exit codes and meanings\n  - Note any breaking changes\n  - Purpose: Release documentation\n  - _Leverage: Keep a Changelog format_\n  - _Requirements: 5.4_\n  - _Prompt: Implement the task for spec cli-exit-code-refactor, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer | Task: Update CHANGELOG with exit code system documentation | Restrictions: Follow Keep a Changelog format, document all codes, note breaking changes | _Leverage: Existing CHANGELOG format | Success: CHANGELOG updated, exit codes documented, migration notes if needed | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n",
  "fileStats": {
    "size": 15073,
    "lines": 163,
    "lastModified": "2025-12-03T12:59:42.168Z"
  },
  "comments": []
}