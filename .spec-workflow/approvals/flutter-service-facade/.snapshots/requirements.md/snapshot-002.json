{
  "id": "snapshot_1764765680933_fn1d6t1eo",
  "approvalId": "approval_1764763013482_ux53rkawj",
  "approvalTitle": "Flutter Service Facade - Requirements",
  "version": 2,
  "timestamp": "2025-12-03T12:41:20.933Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThe Flutter UI layer has grown to 19 services in `ui/lib/services/` with complex interdependencies. Pages like `editor_page.dart` must inject 7+ services, making testing difficult and refactoring risky. This spec introduces a Service Facade pattern that provides a unified, simplified API surface while maintaining the flexibility of the underlying service architecture.\n\n## Alignment with Product Vision\n\nThis feature supports KeyRx's product principles:\n- **Visual > Abstract**: Clean service layer enables focused UI development without plumbing concerns\n- **Testable Configs**: Single facade mock replaces 7+ service mocks in tests\n- **Progressive Complexity**: Simple facade for common operations, direct service access for advanced cases\n\nPer tech.md: \"Dependency Injection: All external dependencies injected for testability\" and the existing ServiceRegistry pattern.\n\n## Requirements\n\n### Requirement 1: Unified Service Facade\n\n**User Story:** As a Flutter developer, I want to access common KeyRx operations through a single facade, so that I don't need to inject and coordinate 7+ services in each page.\n\n#### Acceptance Criteria\n\n1. WHEN a page needs engine, device, and script operations THEN it SHALL inject only `KeyrxFacade`\n2. IF a facade method wraps multiple service calls THEN it SHALL coordinate them atomically\n3. WHEN errors occur in underlying services THEN the facade SHALL translate them to user-friendly messages\n4. IF a rare operation is needed THEN the developer MAY access underlying services through facade getters\n\n### Requirement 2: Simplified Testing Interface\n\n**User Story:** As a test developer, I want to mock a single facade instead of 7+ services, so that widget tests are easier to write and maintain.\n\n#### Acceptance Criteria\n\n1. WHEN testing a page THEN the test SHALL inject a `MockKeyrxFacade`\n2. IF the facade interface changes THEN only the mock needs updating (not 7+ service mocks)\n3. WHEN stubbing facade methods THEN the test SHALL use standard Mockito patterns\n4. IF integration tests need real services THEN they SHALL use `KeyrxFacade.real()` factory\n\n### Requirement 3: State Aggregation\n\n**User Story:** As a Flutter developer, I want the facade to provide aggregated state streams, so that I can observe combined engine/device/script state in one subscription.\n\n#### Acceptance Criteria\n\n1. WHEN engine state changes THEN the facade SHALL emit an aggregated state update\n2. IF device connection changes THEN the aggregated state SHALL include device status\n3. WHEN script validation completes THEN the aggregated state SHALL include validation results\n4. IF multiple state changes occur rapidly THEN the facade SHALL debounce emissions (100ms)\n\n### Requirement 4: Operation Coordination\n\n**User Story:** As a Flutter developer, I want the facade to handle multi-step operations, so that I don't need to manually sequence service calls.\n\n#### Acceptance Criteria\n\n1. WHEN starting the engine with a script THEN the facade SHALL validate → load → start in sequence\n2. IF any step fails THEN the facade SHALL rollback partial changes and report the failure point\n3. WHEN stopping the engine THEN the facade SHALL stop recording → stop engine → clean up state\n4. IF an operation is in progress THEN calling another operation SHALL queue or reject appropriately\n\n### Requirement 5: Error Translation\n\n**User Story:** As a Flutter developer, I want technical errors translated to user-friendly messages, so that I can display them directly in the UI.\n\n#### Acceptance Criteria\n\n1. WHEN a Rust FFI error occurs THEN the facade SHALL translate it using `ErrorTranslator`\n2. IF a network timeout occurs THEN the facade SHALL provide a retry-able error type\n3. WHEN validation fails THEN the facade SHALL include structured validation errors\n4. IF an unexpected error occurs THEN the facade SHALL log details and provide generic user message\n\n### Requirement 6: Backward Compatibility with ServiceRegistry\n\n**User Story:** As a maintainer, I want the facade to coexist with ServiceRegistry, so that migration can be incremental.\n\n#### Acceptance Criteria\n\n1. WHEN creating a facade THEN it SHALL accept a ServiceRegistry as dependency\n2. IF legacy code uses ServiceRegistry directly THEN it SHALL continue to work unchanged\n3. WHEN both facade and direct service access are used THEN state SHALL remain consistent\n4. IF full migration completes THEN ServiceRegistry MAY be deprecated but not removed\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Facade handles coordination, services handle domain logic\n- **Modular Design**: Each facade method is independently testable\n- **Dependency Management**: Facade depends on ServiceRegistry, not individual services\n- **Clear Interfaces**: Abstract `KeyrxFacade` interface enables mock injection\n\n### Performance\n- Facade method calls SHALL add < 1ms overhead over direct service calls\n- State aggregation SHALL use lazy evaluation (compute only when observed)\n- Memory overhead SHALL be < 1MB for facade + state management\n\n### Security\n- Facade SHALL NOT expose internal service implementation details\n- Error messages SHALL NOT leak sensitive information (file paths, stack traces)\n- All public methods SHALL validate inputs before forwarding to services\n\n### Reliability\n- Facade SHALL handle service disposal gracefully\n- Concurrent facade calls SHALL be thread-safe (Dart isolate-safe)\n- Tests SHALL achieve 90% coverage of facade methods\n\n### Usability\n- Migrating a page to use facade SHALL require < 30 minutes\n- Facade API SHALL be discoverable through IDE autocomplete\n- Common operations (start/stop engine, load script) SHALL be single method calls\n",
  "fileStats": {
    "size": 5765,
    "lines": 111,
    "lastModified": "2025-12-03T11:56:30.133Z"
  },
  "comments": []
}