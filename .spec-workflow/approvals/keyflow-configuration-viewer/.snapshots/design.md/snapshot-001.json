{
  "id": "snapshot_1765698922332_7zuacdvd5",
  "approvalId": "approval_1765698922258_3n82hzgit",
  "approvalTitle": "Approve design for keyflow-configuration-viewer",
  "version": 1,
  "timestamp": "2025-12-14T07:55:22.332Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nKeyFlow Configuration Viewer makes the existing UI concept fully live: a read-only graph of devices → hardware profiles (wiring) → virtual layouts → keymaps/actions, enriched with runtime overlays and telemetry. It uses existing FFI-backed services (DeviceRegistryService, HardwareService, LayoutService, KeymapService, RuntimeService) to fetch real data, listens to bridge events for live updates, and exposes perf/health metrics through ObservabilityService/OTEL.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- Follow hexagonal layering: widgets depend on view-models; view-models depend on services; services wrap FFI (KeyrxBridge).\n- Dependency injection via ServiceRegistry; no direct DynamicLibrary usage in widgets.\n- Error handling: fail fast with typed results, user-safe messages, and structured logs.\n- Performance targets: keep UI responsive (≥55fps), avoid blocking UI thread on FFI; use Futures/isolates where needed.\n\n### Project Structure (structure.md)\n- UI additions live under `ui/lib/pages/` and `ui/lib/widgets/`; view models/adapters under `ui/lib/state/` or `ui/lib/services/facade/`.\n- No cross-layer imports from widgets into services; reuse existing service contracts.\n\n## Code Reuse Analysis\n- **DeviceRegistryService / HardwareService / LayoutService / KeymapService / RuntimeService**: primary data sources for devices, wiring, layouts, keymaps, runtime state.\n- **KeyrxBridge event callbacks**: already surface device connect/disconnect and state updates.\n- **ServiceRegistry**: DI entry point for services; mirror pattern from wiring/mapping dashboards.\n- **ObservabilityService / MetricsService**: capture OTEL metrics where enabled.\n- **Visual components**: reuse `VirtualLayoutRenderer`, `VisualKeyboard`, wiring badges styles from wiring page as available.\n\n### Existing Components to Leverage\n- `ui/lib/widgets/virtual_layout_renderer.dart`: render keys and layouts.\n- `ui/lib/pages/wiring.dart`: wiring data handling patterns and error states.\n- `ui/lib/pages/mapping/mapping_dashboard.dart`: list-loading patterns with services.\n- `ui/lib/services/device_registry_service.dart`: device stream and remap toggles.\n- `ui/lib/services/runtime_service.dart`: runtime config and slots (for layer/active state).\n\n### Integration Points\n- **FFI**: Through existing services only. No new bridge methods initially; derive runtime overlays from BridgeStateUpdate stream.\n- **Telemetry**: ObservabilityService/OTEL metrics for fetch latency, render timing, parse failures.\n\n## Architecture\n\n- **View models**: `KeyFlowViewModel` orchestrates load/refresh; maintains:\n  - devices (with remap status, freshness)\n  - profiles + wiring maps\n  - virtual layouts and keymaps/actions\n  - runtime overlays (active layers/mods, recent events)\n  - derived gaps/conflicts counts\n- **Data adapters**: Map FFI/service models to lightweight view structs for rendering; isolate parsing/validation.\n- **Event flow**:\n  1) On screen mount: parallel fetch devices, profiles, layouts, keymaps; compute wiring completeness.\n  2) Subscribe to device stream and bridge state updates; apply incremental mutations without full reload.\n  3) Render via list + graph + details; highlight gaps/conflicts and runtime indicators.\n- **Error handling**: per-pane inline errors; banner for bridge availability; stale-data indicator if runtime silent >5s.\n- **Telemetry**: wrap fetches and render cycles with timers + success/failure counts.\n\n### Modular Design Principles\n- Single File Responsibility: separate view-model, repository/facade, widgets (list, graph, details, runtime overlay).\n- Component Isolation: keep rendering stateless; state in view-model with ChangeNotifier/ValueNotifier.\n- Service Layer Separation: services untouched; a thin facade composes multi-service reads.\n\n```mermaid\nflowchart TD\n  UI[KeyFlow Screen] --> VM[KeyFlowViewModel]\n  VM --> Repo[KeyFlowRepository]\n  Repo --> DevSvc[DeviceRegistryService]\n  Repo --> HwSvc[HardwareService]\n  Repo --> LayoutSvc[LayoutService]\n  Repo --> KeymapSvc[KeymapService]\n  Repo --> RuntimeSvc[RuntimeService]\n  VM --> Telemetry[ObservabilityService/MetricsService]\n  RuntimeEvents[BridgeStateUpdate stream] --> VM\n```\n\n## Components and Interfaces\n\n### KeyFlowRepository (new, facade)\n- **Purpose:** Aggregate data from services into cohesive DTOs for KeyFlow.\n- **Interfaces:** `Future<KeyFlowSnapshot> loadAll()`, `Future<KeyFlowSnapshot> refreshDevices()`, `Stream<RuntimeOverlay> runtimeStream()`.\n- **Dependencies:** DeviceRegistryService, HardwareService, LayoutService, KeymapService, RuntimeService.\n- **Reuses:** Existing list/fetch methods; bridge event stream subscription.\n\n### KeyFlowViewModel (new)\n- **Purpose:** Manage UI state, trigger loads, react to events, expose derived stats (gaps/conflicts/staleness).\n- **Interfaces:** `load()`, `refresh()`, `selectDevice(id)`, `selectKey(keyId)`, `dispose()`.\n- **Dependencies:** KeyFlowRepository, ObservabilityService/MetricsService.\n- **Reuses:** ChangeNotifier pattern used in other pages.\n\n### UI Widgets\n- **KeyFlowScreen**: scaffolds banner, list, graph, details, telemetry indicators.\n- **DeviceListPane**: devices with remap status, last-refresh, error badges.\n- **FlowGraphPane**: wiring visualization using VirtualLayoutRenderer + edge badges for missing/duplicate wiring.\n- **DetailsPane**: selected virtual key actions/layers; runtime overlay indicators.\n- **RuntimeStrip**: recent events + active layers/modifiers from runtime deltas.\n- **Empty/Error States**: reusable banners consistent with wiring/mapping pages.\n\n## Data Models\n\n### KeyFlowSnapshot\n```\ndevices: List<KeyFlowDevice>\nprofiles: Map<String, HardwareProfile>\nlayouts: Map<String, VirtualLayout>\nkeymaps: Map<String, Keymap>\nruntime: RuntimeOverlay? (last)\ngeneratedAt: DateTime\nerrors: List<KeyFlowError>\n```\n\n### KeyFlowDevice\n```\nid: String (device key)\ndisplayName: String\nremapEnabled: bool\nprofileId: String?\nwiring: Map<int, String> // physical -> virtual id\nlayoutId: String?\ngaps: int\nconflicts: int\n```\n\n### RuntimeOverlay\n```\nactiveLayers: List<String>\nactiveModifiers: List<String>\nrecentEvents: List<RuntimeEvent>\nisBypassed: bool\nlastUpdate: DateTime\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **Bridge unavailable or protocol mismatch**\n   - **Handling:** Show banner with retry; fall back to cached snapshot if any.\n   - **User Impact:** Read-only view with freshness warning.\n2. **Partial data failures (e.g., layouts fetch fails)**\n   - **Handling:** Render available panes; inline error for failed pane; telemetry logged.\n   - **User Impact:** Can inspect other data; knows which part failed.\n3. **Runtime stream stalls >5s**\n   - **Handling:** Show “runtime paused” badge and manual refresh; keep last overlay.\n   - **User Impact:** Understands live data is stale; can retry.\n4. **Schema/parse mismatch from FFI**\n   - **Handling:** Capture structured error (operation, payload size), surface user-safe message, drop bad payload.\n   - **User Impact:** Viewer stays up; missing data called out.\n\n## Testing Strategy\n\n### Unit Testing\n- View-model logic: wiring gap/conflict computation, staleness timers, selection behavior.\n- Repository: data aggregation and error propagation with mocked services.\n\n### Integration Testing\n- Widget tests with mocked services to verify banners, empty/error states, and render of wiring/graph panes.\n- Event handling: simulate device stream updates and runtime deltas to confirm UI updates without full reload.\n\n### End-to-End Testing\n- Happy path: bridge available, devices+profiles+layouts present; verify wiring badges and runtime overlay.\n- Failure path: bridge unavailable -> banner + cached snapshot; partial fetch failure -> inline pane error.\n",
  "fileStats": {
    "size": 7773,
    "lines": 156,
    "lastModified": "2025-12-14T07:55:06.468Z"
  },
  "comments": []
}