{
  "id": "snapshot_1765699281383_z7ks2v4w6",
  "approvalId": "approval_1765699281318_vzrlbl3hf",
  "approvalTitle": "Approve tasks for keyflow-configuration-viewer",
  "version": 1,
  "timestamp": "2025-12-14T08:01:21.383Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n- [ ] 1. Create KeyFlow repository facade\n  - File: ui/lib/services/facade/keyflow_repository.dart\n  - Aggregate devices, profiles, layouts, keymaps, runtime overlay into `KeyFlowSnapshot`\n  - Provide `loadAll()`, `refreshDevices()`, `runtimeStream()` using existing services (DeviceRegistryService, HardwareService, LayoutService, KeymapService, RuntimeService)\n  - _Leverage: ui/lib/services/device_registry_service.dart, ui/lib/services/hardware_service.dart, ui/lib/services/layout_service.dart, ui/lib/services/keymap_service.dart, ui/lib/services/runtime_service.dart_\n  - _Requirements: 1, 2, 3, 4_\n  - _Prompt: Implement the task for spec keyflow-configuration-viewer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter/Dart service engineer. Task: Build a KeyFlowRepository that composes existing services to produce KeyFlowSnapshot data and exposes a runtime overlay stream. Restrictions: Do not call FFI directly; use existing services; keep it read-only; ensure per-call error isolation. _Leverage: listed services. _Requirements: 1,2,3,4. Success: repository returns aggregated data with gap/conflict counts, handles partial failures with errors collected, and provides runtime overlay updates without blocking UI._\n\n- [ ] 2. Add KeyFlow view model\n  - File: ui/lib/state/keyflow_view_model.dart\n  - Manage loading, selection, staleness timers, gap/conflict derivation, error states; expose ChangeNotifier API\n  - _Leverage: ui/lib/services/facade/keyflow_repository.dart_\n  - _Requirements: 1, 2, 3, 4_\n  - _Prompt: Implement the task for spec keyflow-configuration-viewer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter state-management developer. Task: Create KeyFlowViewModel that loads snapshots, subscribes to runtime stream, tracks selection and staleness, exposes derived counts and UI-safe errors. Restrictions: No widget logic; keep under 300 lines; debounce refreshes; staleness at 5s. _Leverage: KeyFlowRepository. _Requirements: 1,2,3,4. Success: view model notifies listeners on data/runtime updates, maintains selection without resets on device updates, and marks runtime stale after 5s silence._\n\n- [ ] 3. Build KeyFlow screen and panes\n  - File: ui/lib/pages/keyflow_page.dart\n  - Compose DeviceListPane, FlowGraphPane, DetailsPane, RuntimeStrip; wire to KeyFlowViewModel\n  - _Leverage: ui/lib/widgets/virtual_layout_renderer.dart, ui/lib/pages/wiring.dart (patterns), ui/lib/pages/mapping/mapping_dashboard.dart (load patterns)_\n  - _Requirements: 1, 2, 3_\n  - _Prompt: Implement the task for spec keyflow-configuration-viewer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter UI engineer. Task: Create KeyFlowPage with panes for devices, wiring graph, key details, and runtime strip, consuming KeyFlowViewModel. Restrictions: Read-only; preserve scroll/selection on updates; show banners for bridge errors and stale runtime; keep widgets split into panes in same file or subwidgets. _Leverage: listed widgets/pages. _Requirements: 1,2,3. Success: screen renders live data, flags gaps/conflicts, shows runtime overlays, and handles empty/error states clearly._\n\n- [ ] 4. Add telemetry hooks for KeyFlow\n  - File: ui/lib/services/metrics_service.dart (extend) and/or ui/lib/services/observability_service.dart usage within keyflow repository/view model\n  - Record fetch latency (p95), success/failure counts, render timing for large layouts; capture parse errors with source + payload size only\n  - _Leverage: ui/lib/services/metrics_service.dart, ui/lib/services/observability_service.dart_\n  - _Requirements: 4_\n  - _Prompt: Implement the task for spec keyflow-configuration-viewer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Observability-focused engineer. Task: Add metrics around KeyFlowRepository calls and rendering hooks (exposed via view model) capturing success/failure counts, p95 latency, and render timing for large layouts (>150 keys or 5+ layers). Restrictions: No PII; redact serials; avoid heavy logging on UI thread. _Leverage: metrics/observability services. _Requirements: 4. Success: metrics emitted when enabled, lightweight when disabled, and errors include operation + payload size only._\n\n- [ ] 5. Tests for repository and view model\n  - Files: ui/test/keyflow_repository_test.dart, ui/test/keyflow_view_model_test.dart\n  - Mock services to cover aggregation, partial failures, staleness, gap/conflict computation\n  - _Leverage: existing test fixtures/patterns in ui/test_\n  - _Requirements: 1, 2, 3, 4_\n  - _Prompt: Implement the task for spec keyflow-configuration-viewer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter/Dart QA engineer. Task: Write unit tests for KeyFlowRepository and KeyFlowViewModel using mocked services to validate aggregation, error propagation, staleness, and selection preservation. Restrictions: No real FFI; use fakes; keep tests deterministic. _Leverage: ui/test helpers. _Requirements: 1,2,3,4. Success: tests cover happy/failure paths, staleness timer at 5s, gap/conflict counts, and runtime updates propagate correctly._\n\n- [ ] 6. Widget tests for KeyFlow page\n  - File: ui/test/keyflow_page_test.dart\n  - Verify rendering of panes, empty/error states, runtime stale banner, selection persistence\n  - _Leverage: Flutter widget testing patterns in repo_\n  - _Requirements: 1, 2, 3_\n  - _Prompt: Implement the task for spec keyflow-configuration-viewer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter widget test engineer. Task: Add widget tests for KeyFlowPage to cover empty/error states, device list updates, gap/conflict badges, runtime overlays, and stale indicator. Restrictions: Use mock view model/provider; avoid golden tests unless already used. _Leverage: existing widget test utilities. _Requirements: 1,2,3. Success: widget tests assert correct banners, panes render with mock data, selections persist across updates, and runtime stale state shows expected UI._\n",
  "fileStats": {
    "size": 6158,
    "lines": 45,
    "lastModified": "2025-12-14T08:01:12.981Z"
  },
  "comments": []
}