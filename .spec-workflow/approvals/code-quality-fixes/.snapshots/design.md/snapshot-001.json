{
  "id": "snapshot_1764744166019_u78yjm3v5",
  "approvalId": "approval_1764744166014_sgt8p5k2s",
  "approvalTitle": "Design: Code Quality Fixes",
  "version": 1,
  "timestamp": "2025-12-03T06:42:46.019Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Code Quality Fixes\n\n## Overview\n\nThis design addresses code quality violations by:\n1. Fixing a failing unit test related to environment variable handling\n2. Refactoring 12 files exceeding the 500-line limit into smaller, focused modules\n\nAll refactoring maintains backward compatibility through re-exports in `mod.rs` files.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Modular Design**: Split files by single responsibility\n- **No Global State**: Use `OnceLock` patterns only at FFI boundary (already in place)\n- **Trait Abstraction**: Maintain existing trait patterns\n\n### Project Structure (structure.md)\n- **Max 500 lines/file**: Target for all refactored files\n- **Module naming**: `snake_case.rs` for new modules\n- **Re-exports**: Maintain public API through `mod.rs`\n\n## Code Reuse Analysis\n\n### Existing Patterns to Follow\n- **FFI module pattern**: `exports.rs`, `exports_device.rs`, `exports_engine.rs` already split by domain\n- **UAT module pattern**: Already has `mod.rs` with re-exports\n- **Test utilities**: `serial_test` crate for environment isolation\n\n### Integration Points\n- All FFI functions must remain accessible via `ffi::*`\n- All UAT types must remain accessible via `uat::*`\n\n## Architecture\n\n### Refactoring Strategy\n\n```mermaid\ngraph TD\n    subgraph \"FFI Module Refactoring\"\n        ES[exports_session.rs<br/>2894 lines] --> ES1[exports_script.rs<br/>~300 lines]\n        ES --> ES2[exports_discovery.rs<br/>~450 lines]\n        ES --> ES3[exports_recording.rs<br/>~400 lines]\n        ES --> ES4[exports_analysis.rs<br/>~350 lines]\n        ES --> ES5[exports_testing.rs<br/>~300 lines]\n        ES --> ES6[exports_diagnostics.rs<br/>~200 lines]\n    end\n\n    subgraph \"UAT Module Refactoring\"\n        RP[report.rs<br/>1828 lines] --> RP1[report_data.rs<br/>~200 lines]\n        RP --> RP2[report_markdown.rs<br/>~400 lines]\n        RP --> RP3[report_html.rs<br/>~400 lines]\n        RP --> RP4[report_json.rs<br/>~200 lines]\n    end\n```\n\n## Components and Interfaces\n\n### Component 1: Test Fix (discovery/types.rs)\n\n- **Purpose**: Fix `device_profiles_dir_prefers_xdg_config_home` test\n- **Issue**: Race condition with parallel tests modifying environment variables\n- **Solution**: Use `serial_test` crate's `#[serial]` attribute for env var tests\n- **Files**: `src/discovery/types.rs`\n\n### Component 2: FFI Session Split\n\nSplit `exports_session.rs` (2894 lines) into 6 focused modules:\n\n| New Module | Functions | Lines |\n|------------|-----------|-------|\n| `exports_script.rs` | keyrx_load_script, keyrx_check_script, keyrx_eval | ~300 |\n| `exports_testing.rs` | keyrx_discover_tests, keyrx_run_tests, keyrx_simulate | ~350 |\n| `exports_discovery.rs` | keyrx_start_discovery, keyrx_process_discovery_event, keyrx_cancel_discovery, keyrx_get_discovery_progress, callbacks | ~450 |\n| `exports_recording.rs` | keyrx_start_recording, keyrx_stop_recording, keyrx_is_recording, keyrx_get_recording_path, state management | ~400 |\n| `exports_analysis.rs` | keyrx_list_sessions, keyrx_analyze_session, keyrx_replay_session | ~350 |\n| `exports_diagnostics.rs` | keyrx_run_benchmark, keyrx_run_doctor, platform diagnostics | ~300 |\n\n### Component 3: UAT Report Split\n\nSplit `report.rs` (1828 lines) into domain modules:\n\n| New Module | Contents | Lines |\n|------------|----------|-------|\n| `report_data.rs` | ReportData, CategoryStats structs and methods | ~200 |\n| `report_markdown.rs` | Markdown generation methods | ~400 |\n| `report_html.rs` | HTML generation methods | ~400 |\n| `report_json.rs` | JSON serialization | ~200 |\n| `report.rs` | ReportGenerator, re-exports | ~300 |\n\n### Component 4: UAT Golden Split\n\nSplit `golden.rs` (1295 lines):\n\n| New Module | Contents | Lines |\n|------------|----------|-------|\n| `golden_types.rs` | GoldenSession, GoldenEvent, GoldenVerifyResult structs | ~250 |\n| `golden_manager.rs` | GoldenSessionManager implementation | ~400 |\n| `golden_comparison.rs` | compare_outputs, outputs_match helpers | ~200 |\n| `golden.rs` | Re-exports, remaining logic | ~300 |\n\n### Component 5: UAT Performance Split\n\nSplit `perf.rs` (1430 lines):\n\n| New Module | Contents | Lines |\n|------------|----------|-------|\n| `perf_types.rs` | Performance data structures | ~200 |\n| `perf_runner.rs` | Test execution and measurement | ~400 |\n| `perf_analysis.rs` | Statistical analysis, regression detection | ~400 |\n| `perf.rs` | Re-exports, coordination | ~300 |\n\n### Component 6: UAT Runner/Gates/Fuzz/Coverage\n\nSimilar splits for remaining oversized files:\n\n| File | Strategy |\n|------|----------|\n| `runner.rs` (1079) | Split: discovery, execution, filtering |\n| `gates.rs` (1011) | Split: gate definitions, evaluation, reporting |\n| `fuzz.rs` (650) | Split: generators, execution (or keep if under 700) |\n| `coverage.rs` (637) | Split: tracking, reporting (or keep if under 700) |\n\n### Component 7: Engine/CLI Files\n\n| File | Strategy |\n|------|----------|\n| `engine/tracing.rs` (621) | Split: types, span management, formatters |\n| `cli/ci_check.rs` (789) | Split: phases, summary, output |\n| `cli/regression.rs` (543) | Keep as-is (close to limit) |\n\n## Data Models\n\nNo new data models. Existing structures remain unchanged, only moved between files.\n\n## Error Handling\n\n### Error Scenarios\n1. **Import path changes**: Use re-exports to maintain backward compatibility\n2. **Test isolation failures**: Use `#[serial]` for env var tests\n\n## Testing Strategy\n\n### Unit Testing\n- All existing tests must pass after refactoring\n- New modules get tests moved from original files\n- Test environment isolation verified\n\n### Integration Testing\n- FFI exports verified via existing FFI tests\n- UAT functionality verified via existing UAT tests\n\n### Verification\n- Run `cargo test --lib` - 0 failures\n- Run `cargo llvm-cov` - >= 80% coverage\n- Verify no file exceeds 500 lines: `find src -name \"*.rs\" -exec wc -l {} \\; | awk '$1 > 500'`\n",
  "fileStats": {
    "size": 5911,
    "lines": 157,
    "lastModified": "2025-12-03T06:42:40.888Z"
  },
  "comments": []
}