{
  "id": "snapshot_1764747231120_m1f8frasm",
  "approvalId": "approval_1764744316615_yuete57q3",
  "approvalTitle": "Tasks: Code Quality Fixes (24 tasks)",
  "version": 2,
  "timestamp": "2025-12-03T07:33:51.120Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: Code Quality Fixes\n\n## Phase 1: Fix Failing Test\n\n- [x] 1. Fix device_profiles_dir_prefers_xdg_config_home test\n  - File: `src/discovery/types.rs`\n  - Add `#[serial]` attribute from `serial_test` crate to isolate env var tests\n  - Ensure proper cleanup of environment variables\n  - Purpose: Fix the 1 failing unit test\n  - _Leverage: `serial_test` crate already in Cargo.toml_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Fix the failing test `device_profiles_dir_prefers_xdg_config_home` in src/discovery/types.rs by adding `#[serial]` attribute to prevent race conditions with parallel tests that modify environment variables. Also add it to `device_profiles_dir_falls_back_to_home` test. Import `use serial_test::serial;` | Restrictions: Do not change test logic, only add isolation | Success: `cargo test device_profiles_dir` passes. Mark task [-] in_progress before starting, use log-implementation after completion, then mark [x] complete._\n\n## Phase 2: FFI Module Refactoring\n\n- [x] 2. Create exports_script.rs module\n  - File: `src/ffi/exports_script.rs`\n  - Move: `keyrx_load_script`, `keyrx_check_script`, `keyrx_eval` from exports_session.rs\n  - Move: `ValidationError`, `ValidationResult` structs\n  - Purpose: Isolate script loading/validation FFI functions\n  - _Leverage: Existing pattern in exports.rs, exports_device.rs_\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust FFI Developer | Task: Create src/ffi/exports_script.rs by extracting keyrx_load_script (lines 26-77), keyrx_check_script (lines 103-164), keyrx_eval (lines 533-557), and ValidationError/ValidationResult structs from exports_session.rs. Add proper module documentation and imports. | Restrictions: Keep function signatures identical, add `#![allow(unsafe_code)]` | Success: Functions compile and are accessible. Mark task [-] before starting, log-implementation after, mark [x] when complete._\n\n- [x] 3. Create exports_testing.rs module\n  - File: `src/ffi/exports_testing.rs`\n  - Move: `keyrx_discover_tests`, `keyrx_run_tests`, `keyrx_simulate` from exports_session.rs\n  - Move: Related structs (DiscoveredTestJson, TestResultJson, etc.)\n  - Purpose: Isolate testing/simulation FFI functions\n  - _Leverage: Existing FFI patterns_\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust FFI Developer | Task: Create src/ffi/exports_testing.rs by extracting keyrx_discover_tests (lines 183-259), keyrx_run_tests (lines 261-404), keyrx_simulate (lines 406-531) and related structs from exports_session.rs | Restrictions: Maintain all function signatures | Success: Test-related FFI functions compile. Mark [-] before, log after, mark [x] complete._\n\n- [x] 4. Create exports_discovery.rs module\n  - File: `src/ffi/exports_discovery.rs`\n  - Move: `keyrx_on_discovery_*`, `keyrx_start_discovery`, `keyrx_process_discovery_event`, `keyrx_cancel_discovery`, `keyrx_get_discovery_progress`\n  - Move: Discovery session state management, callback setup\n  - Purpose: Isolate device discovery FFI functions\n  - _Leverage: Existing callback patterns_\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust FFI Developer | Task: Create src/ffi/exports_discovery.rs with all discovery-related functions: keyrx_on_discovery_progress/duplicate/summary (lines 559-578), refresh_discovery_sink, discovery_sink, discovery_session_slot, keyrx_start_discovery (lines 1036-1207), keyrx_process_discovery_event, keyrx_cancel_discovery, keyrx_get_discovery_progress, and DiscoverySessionState struct | Restrictions: Keep OnceLock patterns | Success: Discovery FFI works. Mark [-] before, log after, mark [x] complete._\n\n- [x] 5. Create exports_recording.rs module\n  - File: `src/ffi/exports_recording.rs`\n  - Move: `keyrx_start_recording`, `keyrx_stop_recording`, `keyrx_is_recording`, `keyrx_get_recording_path`\n  - Move: RecordingState, recording_state_slot, set_active_recorder, with_active_recorder\n  - Purpose: Isolate session recording FFI functions\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust FFI Developer | Task: Create src/ffi/exports_recording.rs with recording functions: RecordingState struct, RECORDING_STATE OnceLock, recording_state_slot, keyrx_start_recording (lines 1551-1657), keyrx_stop_recording, keyrx_is_recording, keyrx_get_recording_path, set_active_recorder, with_active_recorder, get_recording_request, clear_recording_state | Restrictions: Maintain state management patterns | Success: Recording FFI works. Mark [-] before, log after, mark [x] complete._\n\n- [x] 6. Create exports_analysis.rs module\n  - File: `src/ffi/exports_analysis.rs`\n  - Move: `keyrx_list_sessions`, `keyrx_analyze_session`, `keyrx_replay_session`\n  - Move: Related JSON output structs\n  - Purpose: Isolate session analysis FFI functions\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust FFI Developer | Task: Create src/ffi/exports_analysis.rs with analysis functions: keyrx_list_sessions (lines 629-730), keyrx_analyze_session (lines 732-829), keyrx_replay_session (lines 831-929), and their related JSON structs (SessionListJson, AnalysisResultJson, ReplayResultJson) | Restrictions: Keep JSON serialization patterns | Success: Analysis FFI works. Mark [-] before, log after, mark [x] complete._\n\n- [x] 7. Create exports_diagnostics.rs module\n  - File: `src/ffi/exports_diagnostics.rs`\n  - Move: `keyrx_run_benchmark`, `keyrx_run_doctor`\n  - Move: run_linux_diagnostics, run_windows_diagnostics helpers\n  - Purpose: Isolate diagnostic FFI functions\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust FFI Developer | Task: Create src/ffi/exports_diagnostics.rs with keyrx_run_benchmark (lines 931-993), keyrx_run_doctor (lines 1333-1399), run_linux_diagnostics (lines 1401-1466), run_windows_diagnostics (lines 1468-1497) | Restrictions: Keep platform-specific #[cfg] attributes | Success: Diagnostic FFI works. Mark [-] before, log after, mark [x] complete._\n\n- [x] 8. Update ffi/mod.rs with re-exports\n  - File: `src/ffi/mod.rs`\n  - Add module declarations for new files\n  - Add re-exports to maintain public API\n  - Remove exports_session.rs or keep minimal\n  - Purpose: Maintain backward compatibility\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Update src/ffi/mod.rs to declare new modules (exports_script, exports_testing, exports_discovery, exports_recording, exports_analysis, exports_diagnostics) and re-export all public FFI functions. Delete or minimize exports_session.rs. | Restrictions: All existing FFI function names must remain accessible | Success: `cargo build` succeeds, FFI tests pass. Mark [-] before, log after, mark [x] complete._\n\n## Phase 3: UAT Report Module Refactoring\n\n- [-] 9. Create uat/report_data.rs module\n  - File: `src/uat/report_data.rs`\n  - Move: `ReportData`, `CategoryStats` structs and their impl blocks\n  - Purpose: Isolate report data structures\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create src/uat/report_data.rs by extracting ReportData struct (line 17), CategoryStats struct (line 126), and all their impl blocks from report.rs. Add proper imports and module documentation. | Restrictions: Keep all method signatures | Success: Structs compile. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 10. Create uat/report_markdown.rs module\n  - File: `src/uat/report_markdown.rs`\n  - Move: Markdown generation methods from ReportGenerator\n  - Purpose: Isolate markdown report generation\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create src/uat/report_markdown.rs by extracting markdown generation methods (generate_markdown, generate_markdown_summary, etc.) from ReportGenerator impl in report.rs. Create a MarkdownReportGenerator struct or use free functions. | Restrictions: Maintain output format | Success: Markdown generation works. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 11. Create uat/report_html.rs module\n  - File: `src/uat/report_html.rs`\n  - Move: HTML generation methods from ReportGenerator\n  - Move: escape_html helper function\n  - Purpose: Isolate HTML report generation\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create src/uat/report_html.rs by extracting HTML generation methods and escape_html helper from report.rs. | Restrictions: Maintain HTML output format | Success: HTML generation works. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 12. Update uat/report.rs and mod.rs\n  - Files: `src/uat/report.rs`, `src/uat/mod.rs`\n  - Keep ReportGenerator as coordinator\n  - Add re-exports for backward compatibility\n  - Purpose: Complete report module refactoring\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Update src/uat/report.rs to import from new modules and keep ReportGenerator as facade. Update src/uat/mod.rs with new module declarations and re-exports. Verify report.rs is under 500 lines. | Restrictions: Maintain public API | Success: UAT report tests pass, file under 500 lines. Mark [-] before, log after, mark [x] complete._\n\n## Phase 4: UAT Golden Module Refactoring\n\n- [ ] 13. Create uat/golden_types.rs module\n  - File: `src/uat/golden_types.rs`\n  - Move: GoldenSession, GoldenEvent, GoldenVerifyResult, GoldenDifference, ExpectedOutput structs\n  - Move: GoldenSessionError, RecordResult, UpdateResult\n  - Purpose: Isolate golden session type definitions\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create src/uat/golden_types.rs with all golden-related type definitions from golden.rs: GoldenSession, GoldenSessionMetadata, GoldenEvent, ExpectedOutput, GoldenVerifyResult, GoldenDifference, DifferenceType, GoldenSessionError, RecordResult, UpdateResult | Restrictions: Keep serde derives | Success: Types compile. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 14. Create uat/golden_comparison.rs module\n  - File: `src/uat/golden_comparison.rs`\n  - Move: compare_outputs, outputs_match, remove_timestamps, find_number_end helpers\n  - Purpose: Isolate comparison logic\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create src/uat/golden_comparison.rs with comparison functions: compare_outputs (line 604), outputs_match (line 665), remove_timestamps (line 684), find_number_end (line 706) | Restrictions: Keep function signatures | Success: Comparison logic works. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 15. Update uat/golden.rs and mod.rs\n  - Files: `src/uat/golden.rs`, `src/uat/mod.rs`\n  - Keep GoldenSessionManager in golden.rs\n  - Add re-exports\n  - Purpose: Complete golden module refactoring\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Update src/uat/golden.rs to import from golden_types.rs and golden_comparison.rs, keeping GoldenSessionManager implementation. Update mod.rs with re-exports. Verify golden.rs is under 500 lines. | Restrictions: Maintain public API | Success: Golden tests pass, file under 500 lines. Mark [-] before, log after, mark [x] complete._\n\n## Phase 5: UAT Performance Module Refactoring\n\n- [ ] 16. Create uat/perf_types.rs module\n  - File: `src/uat/perf_types.rs`\n  - Move: Performance-related structs and enums\n  - Purpose: Isolate performance type definitions\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create src/uat/perf_types.rs with performance data structures from perf.rs (PerformanceResult, PerformanceStats, RegressionCheck, etc.) | Restrictions: Keep serde derives | Success: Types compile. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 17. Create uat/perf_analysis.rs module\n  - File: `src/uat/perf_analysis.rs`\n  - Move: Statistical analysis and regression detection functions\n  - Purpose: Isolate analysis logic\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create src/uat/perf_analysis.rs with statistical analysis functions from perf.rs (calculate_stats, detect_regression, compare_baselines, etc.) | Restrictions: Keep calculation accuracy | Success: Analysis functions work. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 18. Update uat/perf.rs and mod.rs\n  - Files: `src/uat/perf.rs`, `src/uat/mod.rs`\n  - Keep test runner coordination in perf.rs\n  - Add re-exports\n  - Purpose: Complete perf module refactoring\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Update src/uat/perf.rs to import from perf_types.rs and perf_analysis.rs. Update mod.rs with re-exports. Verify perf.rs is under 500 lines. | Restrictions: Maintain public API | Success: Perf tests pass, file under 500 lines. Mark [-] before, log after, mark [x] complete._\n\n## Phase 6: UAT Runner/Gates Refactoring\n\n- [ ] 19. Refactor uat/runner.rs\n  - File: `src/uat/runner.rs`\n  - Split into: runner_discovery.rs (test discovery), runner_execution.rs (test execution)\n  - Keep runner.rs as coordinator under 500 lines\n  - Purpose: Split runner module\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Split src/uat/runner.rs (1079 lines) into runner_discovery.rs (test file discovery, metadata parsing) and runner_execution.rs (test execution logic). Keep UatRunner struct and coordination in runner.rs. Update mod.rs. | Restrictions: Maintain UatRunner public API | Success: Runner tests pass, all files under 500 lines. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 20. Refactor uat/gates.rs\n  - File: `src/uat/gates.rs`\n  - Split into: gates_definitions.rs (gate types), gates_evaluation.rs (gate checking)\n  - Keep gates.rs as coordinator under 500 lines\n  - Purpose: Split gates module\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Split src/uat/gates.rs (1011 lines) into gates_definitions.rs (Gate struct, GateResult, GateType enums) and gates_evaluation.rs (check_gate, evaluate functions). Keep coordination in gates.rs. Update mod.rs. | Restrictions: Maintain Gate public API | Success: Gates tests pass, all files under 500 lines. Mark [-] before, log after, mark [x] complete._\n\n## Phase 7: Engine/CLI Refactoring\n\n- [ ] 21. Refactor engine/tracing.rs\n  - File: `src/engine/tracing.rs`\n  - Split into: tracing_types.rs (span types), tracing_formatters.rs (output formatters)\n  - Keep tracing.rs as coordinator under 500 lines\n  - Purpose: Split tracing module\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Split src/engine/tracing.rs (621 lines) into tracing_types.rs (TraceSpan, TraceEvent structs) and tracing_formatters.rs (formatting/display logic). Keep TracingEngine in tracing.rs. Update engine/mod.rs. | Restrictions: Maintain tracing API | Success: Engine tests pass, all files under 500 lines. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 22. Refactor cli/commands/ci_check.rs\n  - File: `src/cli/commands/ci_check.rs`\n  - Split into: ci_check_phases.rs (phase runners), ci_check_summary.rs (summary generation)\n  - Keep ci_check.rs as main command under 500 lines\n  - Purpose: Split CI check command\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Split src/cli/commands/ci_check.rs (789 lines) into ci_check_phases.rs (individual phase check functions) and ci_check_summary.rs (CiCheckSummary, CheckPhaseResult, output generation). Keep CiCheckCommand in ci_check.rs. Update commands/mod.rs. | Restrictions: Maintain CLI interface | Success: CI check command works, all files under 500 lines. Mark [-] before, log after, mark [x] complete._\n\n## Phase 8: Verification\n\n- [ ] 23. Run full test suite\n  - Run: `cargo test --lib` - verify 0 failures\n  - Run: `cargo test --test '*'` - verify integration tests pass\n  - Purpose: Ensure all tests pass after refactoring\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Run full test suite: `cargo test --lib` and `cargo test --test '*'`. Fix any failures introduced by refactoring. | Restrictions: Do not skip tests | Success: All tests pass. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 24. Verify file sizes and coverage\n  - Run: `find src -name \"*.rs\" -exec wc -l {} \\; | awk '$1 > 500'` - verify no violations\n  - Run: `cargo llvm-cov --lib --summary-only` - verify >= 80% coverage\n  - Purpose: Final verification of code quality metrics\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec code-quality-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Verify all files are under 500 lines and test coverage is >= 80%. Run file size check and coverage report. Document results. | Restrictions: All metrics must pass | Success: No files over 500 lines, coverage >= 80%. Mark [-] before, log after, mark [x] complete._\n",
  "fileStats": {
    "size": 19488,
    "lines": 208,
    "lastModified": "2025-12-03T07:31:59.224Z"
  },
  "comments": []
}