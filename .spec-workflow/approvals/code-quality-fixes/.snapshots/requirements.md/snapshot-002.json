{
  "id": "snapshot_1764744067018_yfzuinwgi",
  "approvalId": "approval_1764744024627_8s08kp325",
  "approvalTitle": "Requirements: Code Quality Fixes",
  "version": 2,
  "timestamp": "2025-12-03T06:41:07.018Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: Code Quality Fixes\n\n## Introduction\n\nThis spec addresses code quality violations identified during a comprehensive audit of the KeyRx Rust core codebase. The audit found:\n- 1 failing unit test\n- 12 files exceeding the 500-line limit defined in steering documents\n- Several files with function counts that may benefit from decomposition\n\nThese fixes ensure compliance with the code quality standards defined in `structure.md` and `CLAUDE.md`.\n\n## Alignment with Product Vision\n\nPer `structure.md` Code Size Guidelines:\n- **Max 500 lines/file** (excluding comments/blank lines)\n- **Max 50 lines/function**\n- **80% test coverage minimum** (currently at 80.96% - passing)\n\nPer `tech.md` Key Patterns:\n- **Modular Drivers**: OS adapters implement generic traits\n- **No Global State**: All instances are self-contained structs\n\n## Requirements\n\n### REQ-1: Fix Failing Test\n\n**User Story:** As a developer, I want all unit tests to pass, so that CI/CD pipelines succeed and code quality is maintained.\n\n#### Acceptance Criteria\n\n1. WHEN running `cargo test --lib` THEN the system SHALL report 0 failures\n2. IF test `device_profiles_dir_prefers_xdg_config_home` runs THEN it SHALL pass with correct XDG_CONFIG_HOME handling\n3. WHEN environment variables are set in tests THEN the system SHALL properly isolate test environments\n\n### REQ-2: Refactor FFI Module (exports_session.rs)\n\n**User Story:** As a maintainer, I want FFI exports organized by domain, so that the codebase is easier to navigate and maintain.\n\n#### Acceptance Criteria\n\n1. WHEN `exports_session.rs` is refactored THEN each resulting file SHALL be under 500 lines\n2. IF FFI functions are split THEN the public API SHALL remain unchanged\n3. WHEN modules are separated THEN they SHALL follow single-responsibility principle:\n   - Recording functions in dedicated module\n   - Discovery functions in dedicated module\n   - Testing/simulation functions in dedicated module\n   - Session analysis functions in dedicated module\n\n### REQ-3: Refactor UAT Module Files\n\n**User Story:** As a maintainer, I want UAT module files to comply with size limits, so that code remains readable and maintainable.\n\n#### Acceptance Criteria\n\n1. WHEN `uat/report.rs` (1828 lines) is refactored THEN resulting files SHALL be under 500 lines\n2. WHEN `uat/perf.rs` (1430 lines) is refactored THEN resulting files SHALL be under 500 lines\n3. WHEN `uat/golden.rs` (1295 lines) is refactored THEN resulting files SHALL be under 500 lines\n4. WHEN `uat/runner.rs` (1079 lines) is refactored THEN resulting files SHALL be under 500 lines\n5. WHEN `uat/gates.rs` (1011 lines) is refactored THEN resulting files SHALL be under 500 lines\n6. WHEN `uat/fuzz.rs` (650 lines) is refactored THEN resulting files SHALL be under 500 lines\n7. WHEN `uat/coverage.rs` (637 lines) is refactored THEN resulting files SHALL be under 500 lines\n8. IF modules are split THEN existing public APIs SHALL remain unchanged\n\n### REQ-4: Refactor Engine/CLI Files\n\n**User Story:** As a maintainer, I want engine and CLI files to comply with size limits for better code organization.\n\n#### Acceptance Criteria\n\n1. WHEN `engine/tracing.rs` (621 lines) is refactored THEN resulting files SHALL be under 500 lines\n2. WHEN `cli/commands/ci_check.rs` (789 lines) is refactored THEN resulting files SHALL be under 500 lines\n3. WHEN `cli/commands/regression.rs` (543 lines) is refactored THEN resulting files SHALL be under 500 lines\n4. IF modules are split THEN existing public APIs SHALL remain unchanged\n\n### REQ-5: Maintain Test Coverage\n\n**User Story:** As a developer, I want test coverage to remain at or above 80% after refactoring, so that code quality is maintained.\n\n#### Acceptance Criteria\n\n1. WHEN all refactoring is complete THEN `cargo llvm-cov` SHALL report >= 80% coverage\n2. IF new modules are created THEN they SHALL have unit tests\n3. WHEN tests are moved THEN they SHALL continue to pass\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Each file should have a single, well-defined purpose\n- **Modular Design**: Split files logically by domain/function\n- **Clear Interfaces**: Maintain existing public APIs through re-exports in mod.rs\n\n### Performance\n- Refactoring SHALL NOT impact runtime performance\n- Compilation time may increase slightly due to more files\n\n### Reliability\n- All existing tests SHALL pass after refactoring\n- No behavioral changes to existing functionality\n\n### Maintainability\n- Each resulting file SHALL have clear purpose documented in module-level comments\n- Re-exports in mod.rs SHALL maintain backward compatibility\n",
  "fileStats": {
    "size": 4643,
    "lines": 103,
    "lastModified": "2025-12-03T06:40:17.671Z"
  },
  "comments": []
}