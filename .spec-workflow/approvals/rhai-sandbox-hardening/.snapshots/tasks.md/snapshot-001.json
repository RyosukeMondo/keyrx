{
  "id": "snapshot_1764770438936_k6hnuu261",
  "approvalId": "approval_1764770438906_kdb9vl1m6",
  "approvalTitle": "Rhai Sandbox Hardening Tasks (17 tasks)",
  "version": 1,
  "timestamp": "2025-12-03T14:00:38.936Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n## Phase 1: Core Types\n\n- [ ] 1. Create ScriptCapability enum\n  - File: `core/src/scripting/sandbox/capability.rs`\n  - Define Safe, Standard, Advanced, Internal tiers\n  - Add is_allowed_in method\n  - Purpose: Function categorization\n  - _Leverage: Enum patterns_\n  - _Requirements: 2.1, 2.2_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating types | Task: Create ScriptCapability enum with tiers | Restrictions: Clear tier semantics, ordered | _Leverage: Enum patterns | Success: Capabilities defined clearly | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 2. Create ResourceBudget\n  - File: `core/src/scripting/sandbox/budget.rs`\n  - Track instructions, recursion, memory, timeout\n  - Atomic counters for thread safety\n  - Purpose: Resource tracking\n  - _Leverage: Atomic operations_\n  - _Requirements: 1.1, 1.2, 1.3, 1.4_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating resource tracker | Task: Create ResourceBudget with limits | Restrictions: Thread-safe, low overhead, configurable | _Leverage: Atomics | Success: Resources tracked and limited | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 3. Create ResourceConfig\n  - File: `core/src/scripting/sandbox/budget.rs`\n  - Configurable limits with sensible defaults\n  - Serializable for config file\n  - Purpose: Limit configuration\n  - _Leverage: serde_\n  - _Requirements: 1.1_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating config | Task: Create ResourceConfig with defaults | Restrictions: Sensible defaults, configurable | _Leverage: serde | Success: Limits configurable | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 2: Capability Registry\n\n- [ ] 4. Create CapabilityRegistry\n  - File: `core/src/scripting/sandbox/registry.rs`\n  - HashMap-based O(1) lookup\n  - KeyCode to function mapping\n  - Purpose: Fast capability lookup\n  - _Leverage: HashMap_\n  - _Requirements: 2.3, 4.1, 4.2_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating registry | Task: Create CapabilityRegistry with O(1) lookup | Restrictions: HashMap-based, KeyCode mapping | _Leverage: HashMap | Success: Lookup is O(1) | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 5. Categorize existing functions\n  - Files: `core/src/scripting/bindings.rs`, `builtins.rs`\n  - Assign capability tier to each function\n  - Document tier rationale\n  - Purpose: Function categorization\n  - _Leverage: ScriptCapability_\n  - _Requirements: 2.1_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer categorizing | Task: Assign capability tiers to all functions | Restrictions: Conservative tiers, document rationale | _Leverage: ScriptCapability | Success: All functions categorized | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 6. Migrate registry to HashMap\n  - File: `core/src/scripting/registry.rs`\n  - Replace O(n) lookup with HashMap\n  - Add KeyCode indexing\n  - Purpose: Performance optimization\n  - _Leverage: CapabilityRegistry_\n  - _Requirements: 4.1, 4.2, 4.3_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer optimizing | Task: Migrate registry to HashMap for O(1) lookup | Restrictions: Same API, faster lookup | _Leverage: HashMap | Success: Registry lookup is O(1) | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 3: Input Validation\n\n- [ ] 7. Create InputValidator trait\n  - File: `core/src/scripting/sandbox/validation.rs`\n  - Define validation interface\n  - Add ValidationError type\n  - Purpose: Input validation abstraction\n  - _Leverage: Trait patterns_\n  - _Requirements: 3.1, 3.2_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating traits | Task: Create InputValidator trait | Restrictions: Pluggable, clear errors | _Leverage: Trait patterns | Success: Validation interface defined | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 8. Implement common validators\n  - File: `core/src/scripting/sandbox/validators/`\n  - RangeValidator, TypeValidator, KeyCodeValidator\n  - Purpose: Reusable validation\n  - _Leverage: InputValidator trait_\n  - _Requirements: 3.1, 3.3, 3.4_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer implementing validators | Task: Implement common validators | Restrictions: Reusable, composable | _Leverage: InputValidator | Success: Common validations available | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 9. Add validation to existing functions\n  - Files: `core/src/scripting/bindings.rs`, `builtins.rs`\n  - Add validators to function registrations\n  - Purpose: Input validation\n  - _Leverage: Validators_\n  - _Requirements: 3.1_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer adding validation | Task: Add input validators to all functions | Restrictions: Appropriate validation per function | _Leverage: Validators | Success: All functions validate input | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 4: Sandbox Integration\n\n- [ ] 10. Create ScriptSandbox\n  - File: `core/src/scripting/sandbox/mod.rs`\n  - Combine capability checks, validation, resources\n  - Configure Rhai engine limits\n  - Purpose: Unified sandbox\n  - _Leverage: All sandbox components_\n  - _Requirements: 1.1, 2.2, 3.1_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating sandbox | Task: Create ScriptSandbox combining all safety | Restrictions: All checks, configurable | _Leverage: All components | Success: Unified sandbox works | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 11. Configure Rhai engine limits\n  - File: `core/src/scripting/runtime.rs`\n  - Set max_operations, max_call_stack_depth\n  - Configure memory limits\n  - Purpose: Engine-level limits\n  - _Leverage: Rhai configuration_\n  - _Requirements: 1.1, 1.2_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer configuring Rhai | Task: Configure Rhai engine resource limits | Restrictions: Use Rhai built-in limits | _Leverage: Rhai config | Success: Engine limits configured | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 12. Integrate sandbox into engine\n  - File: `core/src/engine/scripting.rs`\n  - Use ScriptSandbox for all script execution\n  - Handle sandbox errors\n  - Purpose: Engine integration\n  - _Leverage: ScriptSandbox_\n  - _Requirements: 1.1, 2.2_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer integrating | Task: Integrate ScriptSandbox into engine | Restrictions: All script calls through sandbox | _Leverage: ScriptSandbox | Success: Engine uses sandbox | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 5: Safe Mode Enforcement\n\n- [ ] 13. Implement ScriptMode switching\n  - File: `core/src/scripting/sandbox/mod.rs`\n  - Safe/Standard/Full mode switching\n  - Enforce tier restrictions\n  - Purpose: Mode enforcement\n  - _Leverage: ScriptCapability_\n  - _Requirements: 2.2, 2.4_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer implementing modes | Task: Implement ScriptMode enforcement | Restrictions: Strict enforcement, clear errors | _Leverage: ScriptCapability | Success: Modes enforced correctly | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 14. Add safe_mode to config\n  - File: `core/src/config/scripting.rs`\n  - User-configurable script mode\n  - Default to Standard\n  - Purpose: User control\n  - _Leverage: Config patterns_\n  - _Requirements: 2.2_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer adding config | Task: Add script mode to configuration | Restrictions: User-configurable, sensible default | _Leverage: Config | Success: Users can set script mode | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 6: Testing and Documentation\n\n- [ ] 15. Add sandbox fuzz tests\n  - File: `core/tests/fuzz/sandbox_fuzz.rs`\n  - Fuzz script inputs\n  - Test resource exhaustion\n  - Purpose: Security testing\n  - _Leverage: Fuzzing frameworks_\n  - _Requirements: Non-functional (security)_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Security Developer | Task: Create sandbox fuzz tests | Restrictions: Test all limit types, input validation | _Leverage: Fuzzing | Success: No bypasses found | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 16. Add sandbox benchmarks\n  - File: `core/benches/sandbox_bench.rs`\n  - Benchmark validation overhead\n  - Benchmark capability checks\n  - Purpose: Performance verification\n  - _Leverage: criterion_\n  - _Requirements: 2.3, 4.1_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Benchmark Developer | Task: Create sandbox benchmarks | Restrictions: Test overhead, compare to baseline | _Leverage: criterion | Success: Overhead targets met | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 17. Document sandbox security model\n  - File: `docs/scripting-security.md`\n  - Explain capability tiers\n  - Document resource limits\n  - Purpose: User documentation\n  - _Leverage: Implementation knowledge_\n  - _Requirements: Non-functional (documentation)_\n  - _Prompt: Implement the task for spec rhai-sandbox-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer | Task: Document sandbox security model | Restrictions: Clear tiers, limit explanations | _Leverage: Implementation | Success: Security model documented | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n",
  "fileStats": {
    "size": 12558,
    "lines": 165,
    "lastModified": "2025-12-03T13:58:42.168Z"
  },
  "comments": []
}