{
  "id": "snapshot_1764770437853_0zbr8wmvm",
  "approvalId": "approval_1764770437830_knqvae1zo",
  "approvalTitle": "FFI Marshaling Optimization Tasks (17 tasks)",
  "version": 1,
  "timestamp": "2025-12-03T14:00:37.853Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n## Phase 1: Core Types\n\n- [ ] 1. Create FfiMarshaler trait\n  - File: `core/src/ffi/marshal/traits.rs`\n  - Define trait with CRepr associated type\n  - Add streaming support\n  - Purpose: Unified marshaling interface\n  - _Leverage: Trait patterns_\n  - _Requirements: 1.1, 1.2_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating traits | Task: Create FfiMarshaler trait with CRepr | Restrictions: Generic, streaming-aware, type-safe | _Leverage: Trait patterns | Success: Trait defines marshaling contract | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 2. Create FfiResult type\n  - File: `core/src/ffi/marshal/result.rs`\n  - C-compatible result representation\n  - Error pointer management\n  - Purpose: Safe result passing\n  - _Leverage: C ABI_\n  - _Requirements: 1.3, 2.1_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating types | Task: Create FfiResult with C ABI | Restrictions: repr(C), memory-safe, error support | _Leverage: C ABI | Success: Results cross FFI safely | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 3. Create FfiError type\n  - File: `core/src/ffi/marshal/error.rs`\n  - Error with code, message, hint, context\n  - C-compatible allocation\n  - Purpose: Error marshaling\n  - _Leverage: Error patterns_\n  - _Requirements: 2.1, 2.2, 2.3, 2.4_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating errors | Task: Create FfiError with C-compatible layout | Restrictions: Preserve codes, context, safe free | _Leverage: Error patterns | Success: Errors cross FFI with details | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 2: Common Marshalers\n\n- [ ] 4. Implement primitive marshalers\n  - File: `core/src/ffi/marshal/impls/primitives.rs`\n  - u8, u16, u32, u64, bool, f32, f64\n  - Direct C representation\n  - Purpose: Basic type support\n  - _Leverage: FfiMarshaler trait_\n  - _Requirements: 1.1_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer implementing traits | Task: Implement FfiMarshaler for primitives | Restrictions: Zero-copy where possible | _Leverage: FfiMarshaler | Success: Primitives marshal efficiently | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 5. Implement string marshaler\n  - File: `core/src/ffi/marshal/impls/string.rs`\n  - String and &str support\n  - Null-terminated C strings\n  - Purpose: String support\n  - _Leverage: FfiMarshaler trait_\n  - _Requirements: 1.1_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer implementing marshalers | Task: Implement FfiMarshaler for strings | Restrictions: Null-terminated, UTF-8 safe | _Leverage: FfiMarshaler | Success: Strings marshal safely | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 6. Implement array/Vec marshaler\n  - File: `core/src/ffi/marshal/impls/array.rs`\n  - Generic Vec<T> support\n  - FfiArray C representation\n  - Purpose: Collection support\n  - _Leverage: FfiMarshaler trait_\n  - _Requirements: 1.1, 3.3_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer implementing marshalers | Task: Implement FfiMarshaler for Vec<T> | Restrictions: Length-prefixed, batch encoding | _Leverage: FfiMarshaler | Success: Arrays marshal efficiently | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 7. Implement JSON marshaler\n  - File: `core/src/ffi/marshal/impls/json.rs`\n  - JsonWrapper<T> for complex types\n  - Fallback for non-C-compatible types\n  - Purpose: Complex type support\n  - _Leverage: serde_json_\n  - _Requirements: 1.4_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer implementing marshalers | Task: Implement JSON marshaler for complex types | Restrictions: Efficient JSON, streaming for large | _Leverage: serde | Success: Complex types marshal via JSON | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 3: Large Data Support\n\n- [ ] 8. Create FfiStreamMarshaler trait\n  - File: `core/src/ffi/marshal/stream.rs`\n  - Chunked transfer for large data\n  - Iterator-based API\n  - Purpose: Large data transfer\n  - _Leverage: Trait patterns_\n  - _Requirements: 3.1, 3.4_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating traits | Task: Create FfiStreamMarshaler for chunked transfer | Restrictions: Fixed chunk size, resumable | _Leverage: Trait patterns | Success: Large data streams efficiently | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 9. Implement streaming for session data\n  - File: `core/src/ffi/marshal/impls/session.rs`\n  - Stream recording/replay data\n  - Efficient chunking\n  - Purpose: Session data transfer\n  - _Leverage: FfiStreamMarshaler_\n  - _Requirements: 3.1, 3.2_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer implementing streaming | Task: Implement streaming for session data | Restrictions: Efficient chunks, minimal copies | _Leverage: FfiStreamMarshaler | Success: Sessions transfer efficiently | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 4: Callback System\n\n- [ ] 10. Create FfiCallback trait\n  - File: `core/src/ffi/marshal/callback.rs`\n  - Unified callback interface\n  - Type-safe invocation\n  - Purpose: Callback abstraction\n  - _Leverage: Trait patterns_\n  - _Requirements: 4.1, 4.3_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating traits | Task: Create FfiCallback trait | Restrictions: Type-safe, async-compatible | _Leverage: Trait patterns | Success: Callbacks have unified interface | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 11. Create CallbackRegistry\n  - File: `core/src/ffi/marshal/callback.rs`\n  - Register/unregister callbacks\n  - Thread-safe invocation\n  - Purpose: Callback management\n  - _Leverage: DashMap_\n  - _Requirements: 4.1, 4.2_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating registry | Task: Create CallbackRegistry for FFI callbacks | Restrictions: Thread-safe, ID-based | _Leverage: DashMap | Success: Callbacks managed centrally | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 12. Add callback error handling\n  - File: `core/src/ffi/marshal/callback.rs`\n  - Fallback on callback failure\n  - Error reporting\n  - Purpose: Robust callbacks\n  - _Leverage: FfiError_\n  - _Requirements: 4.4_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer adding error handling | Task: Add fallback and error handling for callbacks | Restrictions: Never panic, log failures | _Leverage: FfiError | Success: Callback failures handled gracefully | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 5: Derive Macro\n\n- [ ] 13. Create FfiMarshaler derive macro\n  - File: `core-macros/src/ffi_marshaler.rs`\n  - Auto-generate implementations\n  - Strategy attribute (json/c_struct/auto)\n  - Purpose: Reduce boilerplate\n  - _Leverage: proc-macro_\n  - _Requirements: 1.2_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Macro Developer | Task: Create FfiMarshaler derive macro | Restrictions: Strategy selection, correct generation | _Leverage: proc-macro | Success: Derive generates correct impl | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 6: Migration\n\n- [ ] 14. Migrate exports_engine.rs\n  - File: `core/src/ffi/exports_engine.rs`\n  - Use FfiMarshaler for all exports\n  - Consolidate error handling\n  - Purpose: Engine FFI migration\n  - _Leverage: FfiMarshaler_\n  - _Requirements: 1.1, 2.1_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer migrating code | Task: Migrate exports_engine.rs to FfiMarshaler | Restrictions: Same API surface, better internals | _Leverage: FfiMarshaler | Success: Engine exports use marshaler | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 15. Migrate exports_discovery.rs\n  - File: `core/src/ffi/exports_discovery.rs`\n  - Use FfiMarshaler for device data\n  - Consolidate callbacks\n  - Purpose: Discovery FFI migration\n  - _Leverage: FfiMarshaler_\n  - _Requirements: 1.1, 4.1_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer migrating code | Task: Migrate exports_discovery.rs to FfiMarshaler | Restrictions: Same API, unified callbacks | _Leverage: FfiMarshaler | Success: Discovery exports use marshaler | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 16. Migrate remaining exports\n  - Files: `core/src/ffi/exports_*.rs`\n  - Use FfiMarshaler throughout\n  - Remove duplicate marshaling code\n  - Purpose: Complete migration\n  - _Leverage: FfiMarshaler_\n  - _Requirements: 1.1_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer migrating code | Task: Migrate remaining FFI exports to FfiMarshaler | Restrictions: All exports, consistent patterns | _Leverage: FfiMarshaler | Success: All FFI uses marshaler | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 17. Add FFI benchmarks\n  - File: `core/benches/ffi_bench.rs`\n  - Benchmark marshaling overhead\n  - Compare JSON vs C struct\n  - Purpose: Performance verification\n  - _Leverage: criterion_\n  - _Requirements: Non-functional (performance)_\n  - _Prompt: Implement the task for spec ffi-marshaling-optimization, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Benchmark Developer | Task: Create FFI marshaling benchmarks | Restrictions: Compare strategies, realistic data | _Leverage: criterion | Success: Performance targets met | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n",
  "fileStats": {
    "size": 12618,
    "lines": 167,
    "lastModified": "2025-12-03T13:58:40.802Z"
  },
  "comments": []
}