{
  "id": "snapshot_1767426281655_kw0y09ird",
  "approvalId": "approval_1767022112100_kq1ytwe1b",
  "approvalTitle": "Real-Time Daemon Dashboard - Design",
  "version": 2,
  "timestamp": "2026-01-03T07:44:41.655Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Architecture\n\n```\nDaemon Event Loop → WebSocket Broadcast → React Dashboard\n     ↓                       ↓                    ↓\n  Events/State         JSON Messages      useWebSocket hook\n                                                  ↓\n                                            Zustand Store\n                                                  ↓\n                                          Dashboard Components\n```\n\n## Components\n\n### 1. WebSocket Event Broadcaster (Rust - keyrx_daemon/src/web/ws.rs)\n- Add broadcast channel: `tokio::sync::broadcast`\n- Publish events from daemon main loop\n- Batch updates every 50ms when >100 events/sec\n\n### 2. useDaemonWebSocket Hook (keyrx_ui/src/hooks/useDaemonWebSocket.ts)\n- Wrap react-use-websocket\n- Auto-reconnect on disconnect\n- Parse incoming JSON messages\n- Update Zustand store\n\n### 3. Dashboard Store (keyrx_ui/src/store/dashboardStore.ts)\n- Zustand store for daemon state\n- `currentState: { modifiers, locks, layer }`\n- `events: Event[]` (last 100)\n- `metrics: LatencyStats`\n\n### 4. DashboardPage Component (keyrx_ui/src/pages/DashboardPage.tsx)\n\n**UI Layout:**\n```\n+---------------------------------------------------------------+\n| Real-Time Dashboard                          [●  Connected]   |\n+---------------------------------------------------------------+\n| Current State                                                 |\n| Active Modifiers: [MD_00] [MD_01]        Layer: base          |\n| Active Locks: [LK_00]                                         |\n+---------------------------------------------------------------+\n| Latency Metrics (Live)                                        |\n| Min: 0.8ms  Avg: 1.2ms  Max: 3.5ms  P95: 2.1ms  P99: 2.8ms  |\n| [============================] (last 60 sec chart)            |\n+---------------------------------------------------------------+\n| Event Timeline (Last 100)                      [Pause]        |\n| 14:23:45.123 A↓ → A↓ (base)                  1.2ms           |\n| 14:23:45.234 A↑ → A↑ (base)                  0.9ms           |\n| 14:23:45.456 KEY_LEFTSHIFT↓ → MD_00+         1.5ms           |\n| ...                                                            |\n+---------------------------------------------------------------+\n```\n\n### 5. StateIndicatorPanel (keyrx_ui/src/components/StateIndicatorPanel.tsx)\n- Display active modifiers/locks/layer\n- Badges with color coding (blue=modifier, orange=lock, green=layer)\n\n### 6. MetricsChart (keyrx_ui/src/components/MetricsChart.tsx)\n- Line chart (recharts) showing latency over time\n- 60-second rolling window\n- Red highlight when >5ms\n\n### 7. EventTimeline (keyrx_ui/src/components/EventTimeline.tsx)\n- Virtualized list (react-window) for performance\n- FIFO (100 events max)\n- Pause/resume functionality\n\n## Data Models\n\n```typescript\ninterface DaemonState {\n  modifiers: string[];  // [\"MD_00\", \"MD_01\"]\n  locks: string[];      // [\"LK_00\"]\n  layer: string;        // \"base\"\n}\n\ninterface KeyEvent {\n  timestamp: number;    // Unix timestamp in μs\n  keyCode: string;      // \"KEY_A\"\n  eventType: 'press' | 'release';\n  input: string;        // Input key\n  output: string;       // Output key (after mapping)\n  latency: number;      // Processing latency in μs\n}\n\ninterface LatencyStats {\n  min: number;\n  avg: number;\n  max: number;\n  p95: number;\n  p99: number;\n  timestamp: number;\n}\n\ntype WebSocketMessage = \n  | { type: 'state', payload: DaemonState }\n  | { type: 'event', payload: KeyEvent }\n  | { type: 'latency', payload: LatencyStats };\n```\n\n## WebSocket Message Protocol\n\n**State Update:**\n```json\n{\n  \"type\": \"state\",\n  \"payload\": {\n    \"modifiers\": [\"MD_00\"],\n    \"locks\": [],\n    \"layer\": \"base\"\n  }\n}\n```\n\n**Key Event:**\n```json\n{\n  \"type\": \"event\",\n  \"payload\": {\n    \"timestamp\": 1735654345123456,\n    \"keyCode\": \"KEY_A\",\n    \"eventType\": \"press\",\n    \"input\": \"A\",\n    \"output\": \"B\",\n    \"latency\": 1200\n  }\n}\n```\n\n**Latency Metrics:**\n```json\n{\n  \"type\": \"latency\",\n  \"payload\": {\n    \"min\": 800,\n    \"avg\": 1200,\n    \"max\": 3500,\n    \"p95\": 2100,\n    \"p99\": 2800,\n    \"timestamp\": 1735654345000000\n  }\n}\n```\n\n## Dependencies\n\n- `react-use-websocket@^4.8.1`\n- `zustand@^4.5.0`\n- `recharts@^2.10.0`\n- `react-window@^1.8.10`\n\n## Sources\n\n- [Real-Time Data Visualization in React using WebSockets](https://www.syncfusion.com/blogs/post/view-real-time-data-using-websocket)\n- [Building Real-Time Dashboards with React and WebSockets](https://www.wildnetedge.com/blogs/building-real-time-dashboards-with-react-and-websockets)\n",
  "fileStats": {
    "size": 4552,
    "lines": 159,
    "lastModified": "2025-12-29T15:22:09.503Z"
  },
  "comments": []
}