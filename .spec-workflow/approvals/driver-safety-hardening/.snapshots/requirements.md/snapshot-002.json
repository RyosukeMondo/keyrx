{
  "id": "snapshot_1764768205098_98hww8brq",
  "approvalId": "approval_1764767194297_s0acuj1ff",
  "approvalTitle": "Driver Safety Hardening - Requirements",
  "version": 2,
  "timestamp": "2025-12-03T13:23:25.098Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThe Windows driver has 8 unsafe blocks in `hook.rs` (562 LOC) with raw calls to `SetWindowsHookEx`, `GetAsyncKeyState`, and thread-local storage for event routing. The Linux driver uses evdev/uinput with complex error handling. This spec isolates unsafe code into minimal safety wrappers with thorough documentation and testing.\n\n## Alignment with Product Vision\n\nThis feature supports KeyRx's product principles:\n- **Safety First**: Minimal unsafe code with maximum safety guarantees\n- **Performance > Features**: Safety wrappers must not impact latency\n- **Reliability**: Drivers must handle all edge cases gracefully\n\nPer tech.md: \"Minimize unsafe blocks and encapsulate in safe wrappers\"\n\n## Requirements\n\n### Requirement 1: Unsafe Isolation\n\n**User Story:** As a developer, I want unsafe code isolated in dedicated safety modules, so that I can audit and reason about unsafe behavior.\n\n#### Acceptance Criteria\n\n1. WHEN unsafe code exists THEN it SHALL be in a `safety/` submodule\n2. IF a function has unsafe internals THEN it SHALL expose a safe public API\n3. WHEN adding unsafe code THEN it SHALL have a SAFETY comment explaining invariants\n4. IF unsafe code is spread across functions THEN it SHALL be consolidated\n\n### Requirement 2: Windows Hook Safety\n\n**User Story:** As a Windows user, I want keyboard hooks to be robust, so that my keyboard never becomes unusable.\n\n#### Acceptance Criteria\n\n1. WHEN the hook is set THEN the handle SHALL be stored for cleanup\n2. IF the hook callback panics THEN the hook SHALL remain functional\n3. WHEN the application exits THEN the hook SHALL be removed\n4. IF SetWindowsHookEx fails THEN a clear error SHALL be returned\n\n### Requirement 3: Thread-Local Safety\n\n**User Story:** As a developer, I want thread-local storage to be safe, so that events route correctly without races.\n\n#### Acceptance Criteria\n\n1. WHEN thread-local storage is used THEN it SHALL be encapsulated in a type\n2. IF multiple threads access state THEN synchronization SHALL be used\n3. WHEN thread-local is accessed THEN it SHALL never panic\n4. IF initialization fails THEN a fallback SHALL be available\n\n### Requirement 4: Linux evdev Safety\n\n**User Story:** As a Linux user, I want device handling to be robust, so that device disconnection doesn't crash the engine.\n\n#### Acceptance Criteria\n\n1. WHEN a device disconnects THEN the driver SHALL return an error, not panic\n2. IF device permissions are denied THEN a helpful error SHALL be shown\n3. WHEN grabbing a device THEN exclusive access SHALL be verified\n4. IF uinput creation fails THEN cleanup SHALL be performed\n\n### Requirement 5: Error Recovery\n\n**User Story:** As a user, I want drivers to recover from errors, so that temporary issues don't require restarts.\n\n#### Acceptance Criteria\n\n1. WHEN a temporary error occurs THEN the driver SHALL retry with backoff\n2. IF recovery fails THEN the user SHALL be notified with suggested actions\n3. WHEN errors occur THEN detailed logs SHALL be available at debug level\n4. IF the keyboard is stuck THEN the emergency exit (Ctrl+Alt+Shift+Esc) SHALL work\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Safety modules wrap one unsafe API\n- **Modular Design**: Each platform has its own safety module\n- **Dependency Management**: Safe wrappers don't depend on each other\n- **Clear Interfaces**: Safe APIs with unsafe internals\n\n### Performance\n- Safety wrappers SHALL add < 10 microseconds overhead\n- Hook callbacks SHALL complete in < 100 microseconds\n- No additional allocations in hot path\n\n### Security\n- Hooks SHALL only process keyboard events, not inject malware\n- Drivers SHALL not elevate privileges\n- Error messages SHALL not leak sensitive system info\n\n### Reliability\n- Drivers SHALL handle all documented error codes\n- Panics in drivers SHALL be caught and logged\n- Device disconnection SHALL be handled gracefully\n\n### Usability\n- Driver errors SHALL suggest solutions\n- Platform-specific issues SHALL be documented\n- Debugging drivers SHALL be possible with environment flags\n",
  "fileStats": {
    "size": 4117,
    "lines": 100,
    "lastModified": "2025-12-03T13:05:54.647Z"
  },
  "comments": []
}