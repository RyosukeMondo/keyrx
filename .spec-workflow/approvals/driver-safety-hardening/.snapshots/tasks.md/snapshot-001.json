{
  "id": "snapshot_1764767194983_22pr1ebrm",
  "approvalId": "approval_1764767194974_4pvsb58cy",
  "approvalTitle": "Driver Safety Hardening - Tasks",
  "version": 1,
  "timestamp": "2025-12-03T13:06:34.983Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n## Phase 1: Infrastructure\n\n- [ ] 1. Create DriverError type\n  - File: `core/src/drivers/common/error.rs`\n  - Define error variants with hints\n  - Implement is_retryable() and suggested_action()\n  - Purpose: Unified driver error handling\n  - _Leverage: thiserror, existing error patterns_\n  - _Requirements: 5.2, 5.3_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating error types | Task: Create DriverError in core/src/drivers/common/error.rs | Restrictions: Include recovery hints, is_retryable flag, suggested actions | _Leverage: thiserror patterns | Success: Error variants cover all driver scenarios, hints are helpful | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 2. Create safety module structure\n  - Files: `core/src/drivers/{windows,linux}/safety/mod.rs`\n  - Set up module hierarchy\n  - Add documentation explaining safety approach\n  - Purpose: Foundation for safety wrappers\n  - _Leverage: Rust module patterns_\n  - _Requirements: 1.1_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer setting up modules | Task: Create safety module structure in drivers | Restrictions: Clear documentation, proper visibility | _Leverage: Rust module patterns | Success: Module structure ready for safety wrappers | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 2: Windows Safety Wrappers\n\n- [ ] 3. Create HookCallback with panic catching\n  - File: `core/src/drivers/windows/safety/callback.rs`\n  - Implement panic-safe callback wrapper\n  - Log panics for debugging\n  - Return PassThrough on panic\n  - Purpose: Prevent panics from breaking hooks\n  - _Leverage: std::panic::catch_unwind_\n  - _Requirements: 2.2_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with panic handling expertise | Task: Create HookCallback with panic catching in safety/callback.rs | Restrictions: Catch all panics, log details, safe fallback | _Leverage: std::panic::catch_unwind | Success: Panics in callbacks don't break hooks | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 4. Create ThreadLocalState wrapper\n  - File: `core/src/drivers/windows/safety/thread_local.rs`\n  - Encapsulate thread-local storage\n  - Safe initialization and access\n  - Purpose: Type-safe thread-local access\n  - _Leverage: std::cell, thread_local!_\n  - _Requirements: 3.1, 3.2, 3.3, 3.4_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with thread-local expertise | Task: Create ThreadLocalState in safety/thread_local.rs | Restrictions: Safe access, no panics, proper initialization | _Leverage: thread_local! macro | Success: Thread-local access is safe and documented | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 5. Create SafeHook wrapper\n  - File: `core/src/drivers/windows/safety/hook.rs`\n  - Wrap SetWindowsHookEx with safe API\n  - Implement Drop for cleanup\n  - Add SAFETY comments to all unsafe blocks\n  - Purpose: Safe hook lifecycle management\n  - _Leverage: windows-rs, existing hook.rs_\n  - _Requirements: 1.2, 1.3, 2.1, 2.3, 2.4_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with Windows API expertise | Task: Create SafeHook in safety/hook.rs with SAFETY comments | Restrictions: RAII for cleanup, document invariants, handle all errors | _Leverage: windows-rs, existing hook.rs | Success: Hook lifecycle is safe, cleanup guaranteed | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 6. Update WindowsInputSource to use safety wrappers\n  - File: `core/src/drivers/windows/mod.rs`\n  - Replace direct unsafe with SafeHook\n  - Use ThreadLocalState for event routing\n  - Reduce unsafe blocks in main code\n  - Purpose: Integrate safety wrappers\n  - _Leverage: SafeHook, ThreadLocalState_\n  - _Requirements: 1.4_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer integrating safety | Task: Update WindowsInputSource to use safety wrappers | Restrictions: Remove direct unsafe, use wrappers, maintain functionality | _Leverage: SafeHook, ThreadLocalState | Success: Windows driver uses safe wrappers, less unsafe code | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 3: Linux Safety Wrappers\n\n- [ ] 7. Create SafeDevice wrapper\n  - File: `core/src/drivers/linux/safety/device.rs`\n  - Wrap evdev device operations\n  - Handle disconnection gracefully\n  - RAII for grab/ungrab\n  - Purpose: Safe device lifecycle\n  - _Leverage: evdev crate_\n  - _Requirements: 1.2, 4.1, 4.3_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with Linux input expertise | Task: Create SafeDevice in safety/device.rs | Restrictions: RAII for grab, handle disconnection, document SAFETY | _Leverage: evdev crate | Success: Device operations are safe, disconnection handled | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 8. Create SafeUinput wrapper\n  - File: `core/src/drivers/linux/safety/uinput.rs`\n  - Wrap uinput device creation\n  - Validate events before injection\n  - RAII for cleanup\n  - Purpose: Safe virtual device\n  - _Leverage: uinput crate_\n  - _Requirements: 1.2, 4.4_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with uinput expertise | Task: Create SafeUinput in safety/uinput.rs | Restrictions: RAII for cleanup, validate events, document SAFETY | _Leverage: uinput crate | Success: Virtual device operations are safe | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 9. Add permission error handling\n  - File: `core/src/drivers/linux/safety/permissions.rs`\n  - Check and report permission issues\n  - Provide helpful hints (input group, udev rules)\n  - Purpose: User-friendly permission errors\n  - _Leverage: DriverError_\n  - _Requirements: 4.2_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with Linux permissions knowledge | Task: Create permission checking in safety/permissions.rs | Restrictions: Check /dev/input access, suggest input group, udev rules | _Leverage: DriverError | Success: Permission errors have actionable suggestions | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 10. Update LinuxInputSource to use safety wrappers\n  - File: `core/src/drivers/linux/mod.rs`\n  - Replace direct device operations with SafeDevice\n  - Use SafeUinput for injection\n  - Reduce unsafe blocks\n  - Purpose: Integrate safety wrappers\n  - _Leverage: SafeDevice, SafeUinput_\n  - _Requirements: 1.4_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer integrating safety | Task: Update LinuxInputSource to use safety wrappers | Restrictions: Remove direct unsafe, use wrappers, maintain functionality | _Leverage: SafeDevice, SafeUinput | Success: Linux driver uses safe wrappers, less unsafe code | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 4: Error Recovery\n\n- [ ] 11. Implement retry with backoff\n  - File: `core/src/drivers/common/recovery.rs`\n  - Add exponential backoff for retryable errors\n  - Configure max retries and delays\n  - Purpose: Automatic error recovery\n  - _Leverage: DriverError::is_retryable_\n  - _Requirements: 5.1_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer implementing recovery | Task: Create retry logic in common/recovery.rs | Restrictions: Exponential backoff, configurable, log attempts | _Leverage: DriverError::is_retryable | Success: Temporary errors are retried, recovery works | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 12. Ensure emergency exit always works\n  - Files: Both Windows and Linux drivers\n  - Verify Ctrl+Alt+Shift+Esc is never blocked\n  - Test in error scenarios\n  - Purpose: User safety\n  - _Leverage: Emergency exit logic_\n  - _Requirements: 5.4_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer ensuring safety | Task: Verify emergency exit works in all error scenarios | Restrictions: Never block emergency combo, test with stuck states | _Leverage: Existing emergency exit logic | Success: Emergency exit works even during errors | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 5: Documentation & Testing\n\n- [ ] 13. Audit and document all unsafe blocks\n  - Files: All driver files\n  - Add SAFETY comments to every unsafe block\n  - Explain invariants and guarantees\n  - Purpose: Safety documentation\n  - _Leverage: Rust unsafe documentation guidelines_\n  - _Requirements: 1.3_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer documenting safety | Task: Audit all unsafe blocks and add SAFETY comments | Restrictions: Every unsafe has SAFETY comment, explain invariants | _Leverage: Rust unsafe documentation guidelines | Success: All unsafe blocks documented, clear invariants | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 14. Add driver integration tests\n  - File: `core/tests/integration/drivers/`\n  - Test error handling paths\n  - Test recovery scenarios\n  - Mock device operations where possible\n  - Purpose: Driver reliability\n  - _Leverage: Test fixtures_\n  - _Requirements: Non-functional (reliability)_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Test Developer | Task: Create driver integration tests | Restrictions: Test error paths, mock where needed, platform-specific | _Leverage: Test fixtures | Success: Error handling tested, recovery verified | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 15. Create driver debugging guide\n  - File: `docs/driver-debugging.md`\n  - Document environment flags for debugging\n  - Explain common issues and solutions\n  - Platform-specific troubleshooting\n  - Purpose: Developer/user support\n  - _Leverage: Implementation knowledge_\n  - _Requirements: Non-functional (usability)_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer | Task: Create driver debugging documentation | Restrictions: Cover both platforms, common issues, env flags | _Leverage: Implementation knowledge | Success: Documentation helps debug driver issues | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 16. Verify unsafe block count reduction\n  - Files: All driver files\n  - Count unsafe blocks before/after\n  - Report reduction percentage\n  - Purpose: Measure success\n  - _Leverage: Code metrics_\n  - _Requirements: Non-functional (quality)_\n  - _Prompt: Implement the task for spec driver-safety-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Developer | Task: Count and verify unsafe block reduction | Restrictions: Measure before/after, report improvement | _Leverage: grep for unsafe blocks | Success: Documented reduction in unsafe code, metrics captured | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n",
  "fileStats": {
    "size": 13562,
    "lines": 164,
    "lastModified": "2025-12-03T13:05:55.454Z"
  },
  "comments": []
}