{
  "id": "snapshot_1765468849270_advgyqq2l",
  "approvalId": "approval_1765468849172_y4hdpl68s",
  "approvalTitle": "Fix Failing Tests - Requirements Document",
  "version": 1,
  "timestamp": "2025-12-11T16:00:49.270Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThe KeyRx test suite currently has **2 failing tests** that block CI/CD pipeline and prevent code coverage measurement. This spec addresses the #3 priority improvement: fixing these test failures to unblock quality metrics and ensure build stability.\n\n**Problem Statement:**\n- 2 tests failing out of 2,440 total tests\n- CI/CD pipeline broken (`just ci-check` fails)\n- Cannot measure code coverage with `cargo llvm-cov`\n- Blocks confident PR merges\n- Prevents quality improvements\n- Failing tests:\n  1. `ffi::domains::device_registry::tests::test_c_api_null_label_clears` (line 571)\n  2. `scripting::docs::test_example::tests::test_macro_generates_doc` (line 46)\n\n**Value Proposition:**\n- **Unblocks CI/CD pipeline** - enables automated quality checks\n- **Enables coverage measurement** - can verify 80%/90% targets\n- **Confident merges** - tests validate all changes\n- **Fast fix** - 1-2 hours estimated\n- **High impact** - unblocks all other quality improvements\n\n## Alignment with Product Vision\n\nThis feature supports the core development principles outlined in `~/.claude/CLAUDE.md`:\n\n- **Code Quality Enforcement**: Pre-commit hooks require passing tests\n- **80% test coverage minimum**: Can't measure without passing test suite\n- **Development velocity**: Broken tests slow down all development\n\n## Requirements\n\n### Requirement 1: Fix FFI Device Registry Test\n\n**User Story:** As a developer, I want the FFI device registry test to pass, so that FFI layer functionality is validated.\n\n**Test Location:** `core/src/ffi/domains/device_registry.rs:571`\n**Test Name:** `test_c_api_null_label_clears`\n**Error:** `assertion failed: msg.starts_with(\"ok:\")`\n\n#### Acceptance Criteria\n\n1. WHEN test is run THEN it SHALL pass without assertion failures\n2. WHEN null label is passed to C API THEN it SHALL clear the label correctly\n3. WHEN response is returned THEN it SHALL have correct format (starts with \"ok:\")\n4. IF response format changed THEN test SHALL be updated to match new format\n5. WHEN fix is implemented THEN it SHALL not break other device registry tests\n\n**Possible Root Causes:**\n- Response format changed but test not updated\n- Null handling changed in implementation\n- Serialization format changed\n- Test expectation incorrect\n\n**Success Metrics:**\n- Test passes consistently (not flaky)\n- Other device registry tests still pass\n- FFI C API null handling validated\n\n### Requirement 2: Fix Scripting Documentation Test\n\n**User Story:** As a developer, I want the scripting documentation test to pass, so that doc generation is validated.\n\n**Test Location:** `core/src/scripting/docs/test_example.rs:46`\n**Test Name:** `test_macro_generates_doc`\n**Error:** `Documentation should be registered`\n\n#### Acceptance Criteria\n\n1. WHEN test is run THEN it SHALL pass without assertion failures\n2. WHEN `#[rhai_doc]` macro is used THEN documentation SHALL be registered in registry\n3. WHEN registry is queried THEN documentation SHALL be found\n4. IF registry initialization changed THEN test setup SHALL be updated\n5. WHEN fix is implemented THEN it SHALL not break other doc tests\n\n**Possible Root Causes:**\n- Doc registry not initialized in test\n- Macro expansion changed\n- Registration logic changed\n- Test setup incomplete\n\n**Success Metrics:**\n- Test passes consistently\n- Other documentation tests still pass\n- Doc registration validated\n\n### Requirement 3: Verify No Regressions\n\n**User Story:** As a QA engineer, I want comprehensive testing after fixes, so that I can verify no regressions were introduced.\n\n#### Acceptance Criteria\n\n1. WHEN fixes are complete THEN full test suite SHALL pass (2,440 tests)\n2. WHEN `cargo test --lib` is run THEN all library tests SHALL pass\n3. WHEN `cargo test --all` is run THEN all tests SHALL pass\n4. IF other tests fail THEN they SHALL be investigated and fixed\n5. WHEN tests pass THEN coverage measurement SHALL be enabled\n\n**Testing Checklist:**\n- [ ] `cargo test --lib` passes\n- [ ] `cargo test --all` passes\n- [ ] `cargo clippy` passes\n- [ ] `cargo build --release` succeeds\n- [ ] `just ci-check` passes\n\n**Success Metrics:**\n- 100% test pass rate (2,440/2,440)\n- Zero test failures\n- CI pipeline green\n- Coverage measurement works\n\n### Requirement 4: Enable Code Coverage Measurement\n\n**User Story:** As a project maintainer, I want to measure code coverage after tests pass, so that I can verify compliance with 80%/90% targets.\n\n#### Acceptance Criteria\n\n1. WHEN tests pass THEN `cargo llvm-cov` SHALL run successfully\n2. WHEN coverage is measured THEN overall coverage percentage SHALL be reported\n3. WHEN coverage report is generated THEN it SHALL identify gaps\n4. IF coverage is below 80% THEN gaps SHALL be documented\n5. WHEN critical paths are measured THEN coverage SHALL be checked against 90% target\n\n**Coverage Targets:**\n- **Overall:** ≥80% line coverage\n- **Critical paths:** ≥90% line coverage (services, API, engine, FFI)\n- **New code:** 100% coverage for new implementations\n\n**Success Metrics:**\n- Coverage measurement runs successfully\n- Overall coverage percentage known\n- Critical path coverage verified\n- Gaps identified for future work\n\n## Non-Functional Requirements\n\n### Reliability\n\n- **Test Stability**: Fixed tests SHALL pass consistently (not flaky)\n- **Deterministic**: Test failures SHALL be reproducible\n- **Isolated**: Tests SHALL not depend on external state\n- **Fast**: Test fixes SHALL not slow down test suite\n\n### Maintainability\n\n- **Clear Fixes**: Root cause SHALL be documented\n- **Prevent Recurrence**: Fix SHALL prevent similar issues\n- **Understandable**: Code changes SHALL be clear and well-commented\n- **Minimal**: Fixes SHALL be minimal and focused\n\n### Performance\n\n- **No Slowdown**: Fixes SHALL not increase test runtime\n- **Quick Execution**: Fixed tests SHALL complete in <100ms\n- **CI Impact**: Total test suite time SHALL remain <3s\n\n### Documentation\n\n- **Root Cause**: Document why test failed\n- **Fix Explanation**: Explain what changed\n- **Prevention**: Note how to prevent similar issues\n- **Test Purpose**: Clarify what test validates\n",
  "fileStats": {
    "size": 6099,
    "lines": 164,
    "lastModified": "2025-12-11T16:00:32.800Z"
  },
  "comments": []
}