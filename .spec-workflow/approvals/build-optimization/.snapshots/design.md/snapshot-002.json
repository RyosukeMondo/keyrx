{
  "id": "snapshot_1764768918357_wfpsgtf8g",
  "approvalId": "approval_1764768821054_myp96a2sn",
  "approvalTitle": "Build Optimization Design",
  "version": 2,
  "timestamp": "2025-12-03T13:35:18.357Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design optimizes the Cargo workspace configuration for minimal dependencies and proper platform gates. The core innovation is a layered feature system where base features are minimal and platform/optional features are additive. Build profiles are optimized for both dev speed and release size.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Minimal Dependencies**: Only what's needed\n- **Platform Gates**: Clear cfg annotations\n- **Feature Flags**: Additive feature system\n\n### Project Structure (structure.md)\n- Workspace in `core/Cargo.toml`\n- Platform code in `drivers/{windows,linux}/`\n- Features documented in README\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **Cargo workspace**: Already configured\n- **cfg attributes**: Already used in some places\n- **Profile settings**: Can be enhanced\n\n### Integration Points\n- **All crates**: Use optimized features\n- **CI/CD**: Use appropriate profiles\n- **FFI**: Platform-specific builds\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Cargo Workspace\"\n        WS[Workspace] --> |profile| DEV[Dev Profile]\n        WS --> |profile| REL[Release Profile]\n        WS --> |features| FEAT[Feature System]\n    end\n\n    subgraph \"Feature System\"\n        FEAT --> BASE[Base Features]\n        FEAT --> WIN[Windows Features]\n        FEAT --> LIN[Linux Features]\n        FEAT --> OPT[Optional Features]\n    end\n\n    subgraph \"Build Output\"\n        DEV --> |fast| DEBUG[Debug Binary]\n        REL --> |optimized| RELEASE[Release Binary]\n    end\n```\n\n### Modular Design Principles\n- **Additive Features**: Features only add, never remove\n- **Platform Isolation**: Platform code in separate modules\n- **Minimal Defaults**: Base config is minimal\n- **Explicit Opt-in**: Optional features require explicit enable\n\n## Components and Interfaces\n\n### Component 1: Workspace Cargo.toml\n\n- **Purpose:** Workspace-wide configuration\n- **Interfaces:**\n  ```toml\n  [workspace]\n  members = [\"core\", \"core-ffi\"]\n  resolver = \"2\"\n\n  [workspace.dependencies]\n  # Shared dependencies with minimal features\n  tokio = { version = \"1\", default-features = false }\n  serde = { version = \"1\", default-features = false }\n\n  [profile.dev]\n  opt-level = 0\n  debug = true\n  incremental = true\n\n  [profile.release]\n  opt-level = \"z\"  # Optimize for size\n  lto = \"thin\"\n  codegen-units = 1\n  strip = true\n  panic = \"abort\"\n  ```\n- **Dependencies:** All workspace crates\n- **Reuses:** Cargo workspace patterns\n\n### Component 2: Core Cargo.toml Features\n\n- **Purpose:** Feature-gated dependencies\n- **Interfaces:**\n  ```toml\n  [features]\n  default = []\n  full = [\"windows-driver\", \"linux-driver\", \"cli\"]\n\n  # Platform features\n  windows-driver = [\"dep:windows\"]\n  linux-driver = [\"dep:evdev\", \"dep:uinput\"]\n\n  # Optional features\n  cli = [\"dep:clap\"]\n  ffi = []\n  metrics = [\"dep:hdrhistogram\"]\n\n  [dependencies]\n  # Always needed\n  log = \"0.4\"\n  thiserror = \"1\"\n\n  # Feature-gated\n  tokio = { workspace = true, features = [\"rt\", \"sync\"], optional = true }\n  windows = { version = \"0.58\", optional = true, features = [...] }\n  evdev = { version = \"0.12\", optional = true }\n\n  [target.'cfg(windows)'.dependencies]\n  windows = { workspace = true }\n\n  [target.'cfg(target_os = \"linux\")'.dependencies]\n  evdev = { workspace = true }\n  ```\n- **Dependencies:** Based on features\n- **Reuses:** Cargo feature patterns\n\n### Component 3: Platform Conditional Compilation\n\n- **Purpose:** Platform-specific code isolation\n- **Interfaces:**\n  ```rust\n  // In drivers/mod.rs\n  #[cfg(windows)]\n  pub mod windows;\n\n  #[cfg(target_os = \"linux\")]\n  pub mod linux;\n\n  // Platform-specific type alias\n  #[cfg(windows)]\n  pub type NativeDriver = windows::WindowsInputSource;\n\n  #[cfg(target_os = \"linux\")]\n  pub type NativeDriver = linux::LinuxInputSource;\n\n  // Feature-gated code\n  #[cfg(feature = \"metrics\")]\n  pub mod metrics;\n\n  #[cfg(not(feature = \"metrics\"))]\n  pub mod metrics {\n      pub struct NoOpMetrics;\n  }\n  ```\n- **Dependencies:** Platform-specific crates\n- **Reuses:** Rust cfg patterns\n\n### Component 4: Build Profiles\n\n- **Purpose:** Optimized build configurations\n- **Interfaces:**\n  ```toml\n  # Fast dev builds\n  [profile.dev]\n  opt-level = 0\n  debug = 2\n  incremental = true\n  split-debuginfo = \"unpacked\"\n\n  # Fast dev dependencies\n  [profile.dev.package.\"*\"]\n  opt-level = 2\n\n  # Size-optimized release\n  [profile.release]\n  opt-level = \"z\"\n  lto = \"thin\"\n  codegen-units = 1\n  strip = true\n  panic = \"abort\"\n\n  # Debug release for profiling\n  [profile.release-debug]\n  inherits = \"release\"\n  debug = 2\n  strip = false\n  ```\n- **Dependencies:** Cargo\n- **Reuses:** Profile optimization patterns\n\n### Component 5: Tokio Feature Minimization\n\n- **Purpose:** Minimal tokio configuration\n- **Interfaces:**\n  ```toml\n  # Before: tokio = { version = \"1\", features = [\"full\"] }\n  # After:\n  [dependencies.tokio]\n  version = \"1\"\n  default-features = false\n  features = [\n      \"rt\",           # Runtime\n      \"sync\",         # Channels\n      \"time\",         # Timers (if needed)\n      \"macros\",       # #[tokio::main] (if needed)\n  ]\n  ```\n- **Dependencies:** tokio\n- **Reuses:** Feature selection patterns\n\n### Component 6: Windows Feature Minimization\n\n- **Purpose:** Minimal windows-rs configuration\n- **Interfaces:**\n  ```toml\n  [target.'cfg(windows)'.dependencies.windows]\n  version = \"0.58\"\n  features = [\n      \"Win32_Foundation\",\n      \"Win32_UI_Input_KeyboardAndMouse\",\n      \"Win32_UI_WindowsAndMessaging\",\n      # Only what's actually used\n  ]\n  ```\n- **Dependencies:** windows-rs\n- **Reuses:** Windows API selection\n\n## Data Models\n\n### Build Metrics\n```rust\npub struct BuildMetrics {\n    pub dev_time_secs: f64,\n    pub release_time_secs: f64,\n    pub binary_size_bytes: u64,\n    pub dependencies_count: u32,\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Missing platform feature**\n   - **Handling:** Clear compile error with hint\n   - **User Impact:** Knows which feature to enable\n\n2. **Incompatible features**\n   - **Handling:** Cargo feature resolver handles\n   - **User Impact:** Build fails with explanation\n\n## Testing Strategy\n\n### Build Testing\n- Test all feature combinations\n- Verify cross-compilation works\n- Measure build times\n\n### Size Testing\n- Track binary sizes\n- Verify stripping works\n- Test on all platforms\n\n### CI Integration\n- Test minimal feature set\n- Test full feature set\n- Test platform-specific builds\n",
  "fileStats": {
    "size": 6432,
    "lines": 269,
    "lastModified": "2025-12-03T13:33:14.001Z"
  },
  "comments": []
}