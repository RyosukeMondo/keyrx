{
  "id": "snapshot_1764755867959_ug5mvt6hf",
  "approvalId": "approval_1764755525209_sxopslhov",
  "approvalTitle": "Requirements: Configuration Centralization",
  "version": 2,
  "timestamp": "2025-12-03T09:57:47.959Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: Configuration Centralization\n\n## Introduction\n\nThis specification addresses the elimination of magic numbers and strings scattered throughout the KeyRx codebase by establishing a systematic, centralized configuration architecture. The goal is to consolidate 90+ magic numbers and 50+ magic strings into well-organized, documented configuration modules that are easy to maintain, test, and modify.\n\n## Alignment with Product Vision\n\nThis feature supports several key product principles from product.md:\n\n- **Performance > Features**: Centralized timing constants (tap_timeout, combo_window) are critical for the sub-1ms latency guarantee\n- **CLI First**: All config values will be CLI-overridable for rapid trial and AI agent development\n- **Progressive Complexity**: Users can use defaults (simple) or override specific values (advanced)\n- **Testable Configs**: Configuration constants enable deterministic testing without hardcoded values\n\n## Requirements\n\n### Requirement 1: Rust Configuration Module\n\n**User Story:** As a Rust developer, I want all magic numbers and strings centralized in dedicated config modules, so that I can easily find, modify, and understand configuration values.\n\n#### Acceptance Criteria\n\n1. WHEN a developer looks for a timing constant THEN the system SHALL provide it in `core/src/config/timing.rs`\n2. WHEN a developer needs key code constants THEN the system SHALL provide them in `core/src/config/keys.rs`\n3. WHEN a developer needs path constants THEN the system SHALL provide them in `core/src/config/paths.rs`\n4. WHEN a developer needs capacity/threshold limits THEN the system SHALL provide them in `core/src/config/limits.rs`\n5. WHEN a developer needs CLI exit codes THEN the system SHALL provide them in `core/src/config/exit_codes.rs`\n6. IF a constant is used in multiple places THEN the system SHALL use a single definition from the config module\n\n### Requirement 2: Dart Configuration Module\n\n**User Story:** As a Flutter developer, I want all UI constants and FFI-related strings centralized in config files, so that I can maintain consistency across the UI layer.\n\n#### Acceptance Criteria\n\n1. WHEN a developer needs UI timing constants (animation, debounce) THEN the system SHALL provide them in `ui/lib/config/timing_config.dart`\n2. WHEN a developer needs UI dimension constants (padding, elevation) THEN the system SHALL provide them in `ui/lib/config/ui_constants.dart`\n3. WHEN a developer needs SharedPreferences keys THEN the system SHALL provide them in `ui/lib/config/storage_keys.dart`\n4. WHEN a developer needs FFI function names or JSON keys THEN the system SHALL provide them in `ui/lib/config/ffi_constants.dart`\n5. WHEN a developer imports config THEN the system SHALL provide a single barrel export via `ui/lib/config/config.dart`\n\n### Requirement 3: Runtime Configuration File\n\n**User Story:** As a power user, I want to customize timing thresholds and behavior parameters via a config file, so that I can tune KeyRx to my typing style without modifying code.\n\n#### Acceptance Criteria\n\n1. WHEN KeyRx starts THEN it SHALL look for `.keyrx/config.toml` in standard XDG locations\n2. IF config file exists THEN the system SHALL load and validate values at startup\n3. IF config file is missing THEN the system SHALL use compiled-in defaults\n4. WHEN a config value is invalid (out of range, wrong type) THEN the system SHALL log a warning and use the default\n5. WHEN CLI arguments are provided THEN they SHALL override config file values\n6. IF `--config <path>` is specified THEN the system SHALL use that file instead of default location\n\n### Requirement 4: Configuration Documentation\n\n**User Story:** As a new developer or power user, I want clear documentation of all configuration options, so that I can understand what each value controls.\n\n#### Acceptance Criteria\n\n1. WHEN a constant is defined THEN it SHALL have a doc comment explaining its purpose and valid range\n2. WHEN a config file is created THEN it SHALL include inline comments explaining each section\n3. IF a developer reads the config module THEN they SHALL find a reference to where each constant is used\n\n### Requirement 5: Backward Compatibility\n\n**User Story:** As an existing user, I want my current setup to continue working after this change, so that I don't need to reconfigure anything.\n\n#### Acceptance Criteria\n\n1. WHEN no config file exists THEN the system SHALL behave identically to pre-change behavior\n2. IF existing `.keyrx/quality-gates.toml` exists THEN it SHALL continue to work unchanged\n3. WHEN default values are extracted THEN they SHALL match current hardcoded values exactly\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Each config module handles one domain (timing, keys, paths, UI)\n- **Modular Design**: Config modules are isolated and independently importable\n- **Dependency Management**: Config modules have no external dependencies beyond std/dart:core\n- **Clear Interfaces**: All constants are public with doc comments\n\n### Performance\n- Configuration loading SHALL complete in < 10ms\n- Config values SHALL be resolved at startup, not on every access\n- No runtime overhead for accessing constants (compile-time resolved where possible)\n\n### Security\n- Config file parsing SHALL not execute arbitrary code\n- Invalid config values SHALL be bounded to safe ranges\n- No sensitive defaults (API keys, passwords) in config modules\n\n### Reliability\n- Missing config file SHALL not cause crashes\n- Invalid config values SHALL fall back to safe defaults\n- Config module compilation errors SHALL be caught at build time\n\n### Usability\n- Config constants SHALL have self-documenting names\n- Config file format (TOML) SHALL be human-readable\n- IDE autocomplete SHALL work for all config values\n",
  "fileStats": {
    "size": 5826,
    "lines": 103,
    "lastModified": "2025-12-03T09:48:33.588Z"
  },
  "comments": []
}