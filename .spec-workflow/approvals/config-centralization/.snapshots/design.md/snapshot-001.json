{
  "id": "snapshot_1764755525280_9jiwk55ck",
  "approvalId": "approval_1764755525272_854fzfr6z",
  "approvalTitle": "Design: Configuration Centralization",
  "version": 1,
  "timestamp": "2025-12-03T09:52:05.280Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Configuration Centralization\n\n## Overview\n\nThis design establishes a systematic configuration architecture for KeyRx that eliminates 90+ magic numbers and 50+ magic strings by organizing them into domain-specific modules. The architecture spans both Rust (core engine) and Dart (Flutter UI) codebases, with an optional TOML runtime config file for user customization.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Dependency Injection**: Config values are injectable, enabling test overrides\n- **CLI First**: All timing config is CLI-overridable via `--tap-timeout`, `--combo-timeout` flags\n- **Trait Abstraction**: Config loading uses a trait for testability\n- **No Global State**: Config structs are passed explicitly, not global singletons\n\n### Project Structure (structure.md)\n- **File Naming**: `snake_case.rs` for Rust, `snake_case.dart` for Dart\n- **Constants**: `UPPER_SNAKE_CASE` in Rust, `lowerCamelCase` or `UPPER_SNAKE_CASE` in Dart\n- **Module Organization**: Config modules follow existing patterns with `mod.rs` re-exports\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`core/src/engine/decision/timing.rs`**: Already has `TimingConfig` struct - extend it\n- **`core/src/discovery/types.rs`**: Uses `device_profiles_dir()` - align path resolution\n- **`.keyrx/quality-gates.toml`**: Existing TOML config pattern - reuse loading approach\n- **`ui/lib/services/service_registry.dart`**: DI pattern for config injection\n\n### Integration Points\n- **CLI Parsing**: `core/src/bin/keyrx.rs` (clap) - add config overrides\n- **Engine Initialization**: Inject `Config` struct into `Engine::new()`\n- **Flutter State**: Add config to `ServiceRegistry` for UI access\n\n## Architecture\n\n### Configuration Hierarchy\n\n```\nPriority (highest to lowest):\n1. CLI arguments (--tap-timeout 150)\n2. Environment variables (KEYRX_TAP_TIMEOUT=150)\n3. Config file (~/.config/keyrx/config.toml)\n4. Compiled defaults (constants in config modules)\n```\n\n### Module Structure\n\n```\nkeyrx/\n├── .keyrx/\n│   ├── quality-gates.toml     # (existing)\n│   └── config.toml            # NEW: User runtime config (optional)\n│\n├── core/src/config/\n│   ├── mod.rs                 # Re-exports all config modules\n│   ├── timing.rs              # Timing constants (tap_timeout, combo_window, etc.)\n│   ├── keys.rs                # Key code constants (evdev, VK codes)\n│   ├── paths.rs               # Path constants (uinput, config dirs)\n│   ├── limits.rs              # Capacity limits (max_pending, max_modifiers)\n│   ├── exit_codes.rs          # CLI exit codes\n│   └── loader.rs              # TOML config file loader\n│\n└── ui/lib/config/\n    ├── config.dart            # Barrel export\n    ├── timing_config.dart     # UI timing (animation, debounce)\n    ├── ui_constants.dart      # Dimensions (padding, elevation, scale)\n    ├── storage_keys.dart      # SharedPreferences keys\n    └── ffi_constants.dart     # FFI function names, JSON response keys\n```\n\n### Modular Design Principles\n- **Single File Responsibility**: Each file handles one configuration domain\n- **Component Isolation**: Config modules have zero dependencies on business logic\n- **Service Layer Separation**: Config loading separate from config usage\n- **Utility Modularity**: Each config domain independently importable\n\n```mermaid\ngraph TD\n    subgraph \"Rust Config Module\"\n        RC[config/mod.rs] --> RT[timing.rs]\n        RC --> RK[keys.rs]\n        RC --> RP[paths.rs]\n        RC --> RL[limits.rs]\n        RC --> RE[exit_codes.rs]\n        RC --> RLoader[loader.rs]\n    end\n\n    subgraph \"Dart Config Module\"\n        DC[config.dart] --> DT[timing_config.dart]\n        DC --> DU[ui_constants.dart]\n        DC --> DS[storage_keys.dart]\n        DC --> DF[ffi_constants.dart]\n    end\n\n    subgraph \"Config Sources\"\n        TOML[.keyrx/config.toml]\n        CLI[CLI Arguments]\n        ENV[Environment Variables]\n    end\n\n    RLoader --> TOML\n    CLI --> Engine\n    ENV --> RLoader\n    RC --> Engine[Engine]\n    DC --> Flutter[Flutter UI]\n```\n\n## Components and Interfaces\n\n### Component 1: Rust Config Module (`core/src/config/`)\n\n- **Purpose:** Centralize all Rust-side constants and provide config loading\n- **Interfaces:**\n  ```rust\n  // Public API\n  pub use timing::{TimingConfig, DEFAULT_TAP_TIMEOUT_MS, ...};\n  pub use keys::{KeyCodes, EVDEV_KEY_ESC, VK_ESCAPE, ...};\n  pub use paths::{Paths, UINPUT_PATH, ...};\n  pub use limits::{Limits, MAX_PENDING_DECISIONS, ...};\n  pub use exit_codes::{ExitCode, SUCCESS, ERROR, ...};\n  pub use loader::{load_config, Config};\n  ```\n- **Dependencies:** `toml` crate (already used), `dirs` crate for XDG\n- **Reuses:** Existing `TimingConfig` struct pattern\n\n### Component 2: Dart Config Module (`ui/lib/config/`)\n\n- **Purpose:** Centralize all Flutter-side constants\n- **Interfaces:**\n  ```dart\n  // Barrel export from config.dart\n  export 'timing_config.dart';\n  export 'ui_constants.dart';\n  export 'storage_keys.dart';\n  export 'ffi_constants.dart';\n  ```\n- **Dependencies:** None (pure Dart)\n- **Reuses:** Existing pattern from `ui/lib/ui/styles/surfaces.dart`\n\n### Component 3: Config Loader (`core/src/config/loader.rs`)\n\n- **Purpose:** Load and validate TOML config file with fallbacks\n- **Interfaces:**\n  ```rust\n  pub struct Config {\n      pub timing: TimingConfig,\n      pub paths: PathConfig,\n      pub limits: LimitConfig,\n  }\n\n  pub fn load_config(path: Option<&Path>) -> Config;\n  pub fn merge_cli_overrides(config: &mut Config, cli: &CliArgs);\n  ```\n- **Dependencies:** `toml`, `serde`, `dirs`\n- **Reuses:** Pattern from quality-gates.toml loading\n\n## Data Models\n\n### Config File Schema (TOML)\n\n```toml\n# ~/.config/keyrx/config.toml\n# KeyRx Runtime Configuration\n\n[timing]\n# Duration (ms) to distinguish tap from hold. Range: 50-1000\ntap_timeout_ms = 200\n\n# Window (ms) for detecting simultaneous keypresses. Range: 10-200\ncombo_timeout_ms = 50\n\n# Delay (ms) before considering a hold. Range: 0-100\nhold_delay_ms = 0\n\n[ui]\n# Maximum events to retain in debugger history. Range: 100-1000\nmax_events_history = 300\n\n# Animation duration in milliseconds. Range: 50-500\nanimation_duration_ms = 150\n\n[performance]\n# Latency warning threshold in microseconds. Range: 1000-100000\nlatency_warning_us = 20000\n\n# Latency caution threshold in microseconds. Range: 500-50000\nlatency_caution_us = 10000\n\n# Performance regression threshold in microseconds. Range: 10-1000\nregression_threshold_us = 100\n\n[paths]\n# Directory for user scripts (relative to config dir)\nscripts_dir = \"scripts\"\n\n# Temporary directory for validation files\ntemp_dir = \"/tmp\"\n```\n\n### Rust Config Struct\n\n```rust\n#[derive(Debug, Clone, Deserialize)]\n#[serde(default)]\npub struct Config {\n    pub timing: TimingConfig,\n    pub ui: UiConfig,\n    pub performance: PerformanceConfig,\n    pub paths: PathConfig,\n}\n\nimpl Default for Config {\n    fn default() -> Self {\n        Self {\n            timing: TimingConfig::default(),\n            ui: UiConfig::default(),\n            performance: PerformanceConfig::default(),\n            paths: PathConfig::default(),\n        }\n    }\n}\n```\n\n### Dart Constants Classes\n\n```dart\n/// UI timing constants\nabstract class TimingConfig {\n  static const int animationDurationMs = 150;\n  static const int debounceMs = 500;\n  static const int pulseAnimationMs = 300;\n}\n\n/// UI dimension constants\nabstract class UiConstants {\n  static const double defaultPadding = 16.0;\n  static const double smallPadding = 8.0;\n  static const double tinyPadding = 4.0;\n  static const double defaultElevation = 6.0;\n  static const double minKeyboardScale = 0.5;\n  static const double maxKeyboardScale = 1.0;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Config file not found**\n   - **Handling:** Log info message, use compiled defaults\n   - **User Impact:** Silent - application works with defaults\n\n2. **Config file parse error (invalid TOML)**\n   - **Handling:** Log warning with line number, use defaults\n   - **User Impact:** Warning in logs, app continues with defaults\n\n3. **Config value out of range**\n   - **Handling:** Log warning, clamp to valid range\n   - **User Impact:** Warning that value was adjusted\n\n4. **Config value wrong type**\n   - **Handling:** Log warning, use default for that field\n   - **User Impact:** Warning that value was ignored\n\n## Testing Strategy\n\n### Unit Testing\n- Test each config module in isolation\n- Test default values match expected hardcoded values\n- Test config loading with valid/invalid/missing files\n- Test CLI override merging\n- Test value range clamping\n\n### Integration Testing\n- Test full config resolution chain (CLI > env > file > default)\n- Test engine initialization with custom config\n- Test Flutter app startup with config injection\n\n### End-to-End Testing\n- Create config file, verify timing behavior changes\n- Verify CLI overrides work in actual commands\n- Test backward compatibility - no config file = same behavior\n\n## Constants Inventory\n\n### Rust Constants to Extract\n\n| Module | Constant | Current Value | Source File |\n|--------|----------|---------------|-------------|\n| timing | `DEFAULT_TAP_TIMEOUT_MS` | 200 | `engine/decision/timing.rs:23` |\n| timing | `DEFAULT_COMBO_TIMEOUT_MS` | 50 | `engine/decision/timing.rs:24` |\n| timing | `DEFAULT_HOLD_DELAY_MS` | 0 | `engine/decision/timing.rs:25` |\n| timing | `MICROS_PER_MS` | 1000 | `engine/decision/pending.rs:5` |\n| limits | `MAX_PENDING_DECISIONS` | 32 | `engine/decision/pending.rs:86` |\n| limits | `MIN_COMBO_KEYS` | 2 | `engine/decision/pending.rs:144` |\n| limits | `MAX_COMBO_KEYS` | 4 | `engine/decision/pending.rs:144` |\n| limits | `MAX_MODIFIER_ID` | 255 | `engine/state/modifiers.rs:68` |\n| limits | `MAX_TIMEOUT_MS` | 5000 | `scripting/builtins.rs:236` |\n| keys | `EVDEV_KEY_ESC` | 1 | `drivers/linux/reader.rs:27` |\n| keys | `EVDEV_KEY_LEFTCTRL` | 29 | `drivers/linux/reader.rs:21` |\n| keys | `EVDEV_KEY_LEFTSHIFT` | 42 | `drivers/linux/reader.rs:23` |\n| keys | `EVDEV_KEY_LEFTALT` | 56 | `drivers/linux/reader.rs:25` |\n| keys | `EVDEV_KEY_RIGHTCTRL` | 97 | `drivers/linux/reader.rs:22` |\n| keys | `EVDEV_KEY_RIGHTSHIFT` | 54 | `drivers/linux/reader.rs:24` |\n| keys | `EVDEV_KEY_RIGHTALT` | 100 | `drivers/linux/reader.rs:26` |\n| keys | `VK_ESCAPE` | 0x1B | `drivers/windows/hook.rs:28` |\n| keys | `VK_CONTROL` | 0x11 | `drivers/windows/hook.rs:29` |\n| keys | `VK_SHIFT` | 0x10 | `drivers/windows/hook.rs:30` |\n| keys | `VK_MENU` | 0x12 | `drivers/windows/hook.rs:31` |\n| paths | `UINPUT_PATH` | \"/dev/uinput\" | `drivers/linux/mod.rs:25` |\n| paths | `UINPUT_DEVICE_NAME` | \"KeyRx Virtual Keyboard\" | `drivers/linux/writer.rs:17` |\n| paths | `REPL_HISTORY_FILE` | \".keyrx_repl_history\" | `cli/commands/repl.rs:12` |\n| paths | `PERF_BASELINE_FILE` | \"target/perf-baseline.json\" | `uat/perf.rs:27` |\n| exit_codes | `SUCCESS` | 0 | Various CLI commands |\n| exit_codes | `ERROR` | 1 | Various CLI commands |\n| exit_codes | `VERIFICATION_FAILED` | 2 | Various CLI commands |\n| exit_codes | `TIMEOUT` | 3 | Various CLI commands |\n\n### Dart Constants to Extract\n\n| Module | Constant | Current Value | Source File |\n|--------|----------|---------------|-------------|\n| timing | `animationDurationMs` | 150 | `pages/debugger_page.dart:29` |\n| timing | `pulseAnimationMs` | 300 | `pages/debugger_page.dart:51` |\n| timing | `debounceMs` | 500 | `pages/debugger_page.dart:73` |\n| timing | `keyAnimationMs` | 100 | `widgets/visual_keyboard_keys.dart:96` |\n| timing | `typingTimeLimitSec` | 30 | `pages/typing_simulator.dart:33` |\n| ui | `defaultPadding` | 16.0 | `pages/editor_page.dart:127` |\n| ui | `smallPadding` | 8.0 | Various |\n| ui | `tinyPadding` | 4.0 | `pages/trade_off_widgets.dart:41` |\n| ui | `defaultElevation` | 6.0 | `ui/styles/surfaces.dart:19` |\n| ui | `minKeyboardScale` | 0.5 | `widgets/visual_keyboard.dart:146` |\n| ui | `maxKeyboardScale` | 1.0 | `widgets/visual_keyboard.dart:147` |\n| ui | `defaultIconSize` | 24.0 | `pages/trade_off_widgets.dart:79` |\n| limits | `maxEventsHistory` | 300 | `pages/debugger_page.dart:33` |\n| limits | `minKeystrokes` | 10 | `pages/typing_simulator.dart:65` |\n| limits | `pauseThresholdMs` | 2000 | `pages/typing_simulator.dart:83` |\n| thresholds | `latencyWarningUs` | 20000 | `pages/debugger_meters.dart:14` |\n| thresholds | `latencyCautionUs` | 10000 | `pages/debugger_meters.dart:15` |\n| thresholds | `warningThresholdNs` | 1000000 | `pages/developer/benchmark_page.dart` |\n| storage | `developerModeKey` | \"developer_mode\" | `state/app_state.dart:13` |\n| storage | `trainingProgressKey` | \"keyrx_training_progress\" | `pages/keyrx_training_screen.dart:26` |\n| paths | `defaultScriptPath` | \"scripts/generated.rhai\" | `pages/editor_page.dart:66` |\n| paths | `tempValidationPath` | \"/tmp/keyrx_validation.rhai\" | `pages/editor_page.dart:67` |\n",
  "fileStats": {
    "size": 12877,
    "lines": 344,
    "lastModified": "2025-12-03T09:49:44.414Z"
  },
  "comments": []
}