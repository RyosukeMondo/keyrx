{
  "id": "snapshot_1764768817873_xnpfqi8cl",
  "approvalId": "approval_1764768817848_x8rhg6yni",
  "approvalTitle": "Widget Decomposition Design",
  "version": 1,
  "timestamp": "2025-12-03T13:33:37.873Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design extracts the monolithic `editor_widgets.dart` into a feature-based widget hierarchy. The core innovation is the `widgets/` directory structure that mirrors the page hierarchy, with a `common/` folder for shared components. Each widget file contains exactly one widget with its associated state and helper methods.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Max 500 lines/file**: Each widget file < 300 lines\n- **Single Responsibility**: One widget per file\n- **Testability**: Widgets isolated for testing\n\n### Project Structure (structure.md)\n- Widgets in `ui/lib/widgets/`\n- Feature subdirectories: `editor/`, `preview/`, `settings/`\n- Shared widgets: `common/`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **Theme Extensions**: Existing theme for styling\n- **Provider**: State management already in use\n- **GoRouter**: Navigation patterns\n\n### Integration Points\n- **Pages**: Import widgets from `widgets/` directory\n- **Services**: Widgets access via Provider\n- **State**: Shared state through ChangeNotifier\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Widget Hierarchy\"\n        EW[editor_widgets.dart] --> |Extract| ED[editor/]\n        EW --> |Extract| CM[common/]\n    end\n\n    subgraph \"editor/\"\n        ED --> KL[key_legend.dart]\n        ED --> KB[key_button.dart]\n        ED --> KG[key_grid.dart]\n        ED --> LP[layer_panel.dart]\n        ED --> BP[binding_panel.dart]\n    end\n\n    subgraph \"common/\"\n        CM --> IC[icon_button.dart]\n        CM --> TF[text_field.dart]\n        CM --> DI[dialog.dart]\n        CM --> SN[snackbar.dart]\n    end\n\n    subgraph \"Pages\"\n        EP[EditorPage] --> ED\n        EP --> CM\n    end\n```\n\n### Modular Design Principles\n- **Single File Responsibility**: One widget class per file\n- **Component Isolation**: Widgets don't import each other directly\n- **Barrel Exports**: Index files for clean imports\n- **Feature Cohesion**: Related widgets in same directory\n\n## Components and Interfaces\n\n### Component 1: KeyLegend Widget\n\n- **Purpose:** Display key legend with color coding\n- **Interfaces:**\n  ```dart\n  class KeyLegend extends StatelessWidget {\n    const KeyLegend({\n      super.key,\n      required this.items,\n      this.orientation = Axis.horizontal,\n    });\n\n    final List<LegendItem> items;\n    final Axis orientation;\n  }\n\n  class LegendItem {\n    final String label;\n    final Color color;\n    final IconData? icon;\n  }\n  ```\n- **Dependencies:** Theme\n- **Reuses:** Existing legend rendering logic\n\n### Component 2: KeyButton Widget\n\n- **Purpose:** Interactive key representation\n- **Interfaces:**\n  ```dart\n  class KeyButton extends StatelessWidget {\n    const KeyButton({\n      super.key,\n      required this.keyCode,\n      required this.label,\n      this.onTap,\n      this.onLongPress,\n      this.isSelected = false,\n      this.isHighlighted = false,\n      this.size = KeyButtonSize.medium,\n    });\n\n    final int keyCode;\n    final String label;\n    final VoidCallback? onTap;\n    final VoidCallback? onLongPress;\n    final bool isSelected;\n    final bool isHighlighted;\n    final KeyButtonSize size;\n  }\n\n  enum KeyButtonSize { small, medium, large }\n  ```\n- **Dependencies:** Theme, gestures\n- **Reuses:** Key rendering from editor_widgets\n\n### Component 3: KeyGrid Widget\n\n- **Purpose:** Grid layout of keyboard keys\n- **Interfaces:**\n  ```dart\n  class KeyGrid extends StatelessWidget {\n    const KeyGrid({\n      super.key,\n      required this.layout,\n      required this.onKeyTap,\n      this.selectedKeys = const {},\n      this.highlightedKeys = const {},\n    });\n\n    final KeyboardLayout layout;\n    final void Function(int keyCode) onKeyTap;\n    final Set<int> selectedKeys;\n    final Set<int> highlightedKeys;\n  }\n  ```\n- **Dependencies:** KeyButton\n- **Reuses:** Grid layout logic\n\n### Component 4: LayerPanel Widget\n\n- **Purpose:** Layer selection and management\n- **Interfaces:**\n  ```dart\n  class LayerPanel extends StatelessWidget {\n    const LayerPanel({\n      super.key,\n      required this.layers,\n      required this.activeLayer,\n      required this.onLayerSelect,\n      this.onLayerAdd,\n      this.onLayerDelete,\n    });\n\n    final List<Layer> layers;\n    final int activeLayer;\n    final void Function(int) onLayerSelect;\n    final VoidCallback? onLayerAdd;\n    final void Function(int)? onLayerDelete;\n  }\n  ```\n- **Dependencies:** Theme, layer models\n- **Reuses:** Layer panel from editor_widgets\n\n### Component 5: BindingPanel Widget\n\n- **Purpose:** Key binding configuration\n- **Interfaces:**\n  ```dart\n  class BindingPanel extends StatefulWidget {\n    const BindingPanel({\n      super.key,\n      required this.binding,\n      required this.onSave,\n      this.onCancel,\n    });\n\n    final KeyBinding? binding;\n    final void Function(KeyBinding) onSave;\n    final VoidCallback? onCancel;\n  }\n  ```\n- **Dependencies:** Form widgets, binding models\n- **Reuses:** Binding form from editor_widgets\n\n### Component 6: Barrel Exports\n\n- **Purpose:** Clean import paths\n- **Interfaces:**\n  ```dart\n  // widgets/editor/editor.dart\n  export 'key_legend.dart';\n  export 'key_button.dart';\n  export 'key_grid.dart';\n  export 'layer_panel.dart';\n  export 'binding_panel.dart';\n\n  // widgets/widgets.dart\n  export 'common/common.dart';\n  export 'editor/editor.dart';\n  ```\n- **Dependencies:** All widgets\n- **Reuses:** Dart barrel export pattern\n\n## Data Models\n\n### KeyboardLayout\n```dart\nclass KeyboardLayout {\n  final String name;\n  final List<KeyRow> rows;\n  final double keySpacing;\n}\n\nclass KeyRow {\n  final List<KeyDefinition> keys;\n  final double offsetX;\n}\n```\n\n### LegendItem\n```dart\nclass LegendItem {\n  final String label;\n  final Color color;\n  final IconData? icon;\n  final String? tooltip;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Missing key definition**\n   - **Handling:** Show placeholder widget\n   - **User Impact:** Unknown key displayed gracefully\n\n2. **Invalid layer reference**\n   - **Handling:** Log warning, use default layer\n   - **User Impact:** Seamless fallback\n\n3. **Widget build failure**\n   - **Handling:** ErrorWidget with message\n   - **User Impact:** Clear error indication\n\n## Testing Strategy\n\n### Unit Testing\n- Test each widget in isolation\n- Mock dependencies\n- Verify render output\n\n### Widget Testing\n- Test widget interactions\n- Verify callbacks fire\n- Test state changes\n\n### Golden Testing\n- Screenshot comparison for visual widgets\n- Test different sizes and themes\n- Verify accessibility\n",
  "fileStats": {
    "size": 6512,
    "lines": 271,
    "lastModified": "2025-12-03T13:33:10.164Z"
  },
  "comments": []
}