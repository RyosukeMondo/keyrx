{
  "id": "snapshot_1764768198578_cgkuou4m0",
  "approvalId": "approval_1764767192235_oucnebu06",
  "approvalTitle": "Test Organization - Requirements",
  "version": 2,
  "timestamp": "2025-12-03T13:23:18.578Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThe test codebase has organizational issues: `validation_integration.rs` is 27K LOC, `phase_1_3_integration_test.rs` is 21K LOC, and 118 `#[cfg(test)]` modules are scattered throughout source files. This spec establishes a consistent test organization strategy with manageable file sizes and clear categorization.\n\n## Alignment with Product Vision\n\nThis feature supports KeyRx's product principles:\n- **Testable Configs**: Tests must be maintainable to remain valuable\n- **CLI First, GUI Later**: Test infrastructure supports both CLI and GUI testing\n- **Safety First**: Comprehensive tests catch regressions\n\nPer CLAUDE.md: \"80% test coverage minimum (90% for critical paths)\" and \"Max 500 lines/file\"\n\n## Requirements\n\n### Requirement 1: Test File Size Limits\n\n**User Story:** As a developer, I want test files under 500 LOC, so that I can navigate and understand test suites.\n\n#### Acceptance Criteria\n\n1. WHEN a test file exceeds 500 LOC THEN it SHALL be split into focused sub-files\n2. IF tests share setup THEN shared fixtures SHALL be extracted to helper modules\n3. WHEN splitting THEN test names SHALL remain stable for CI reporting\n4. IF a category has many tests THEN subdirectories SHALL be used\n\n### Requirement 2: Test Categorization\n\n**User Story:** As a developer, I want tests organized by type (unit, integration, e2e), so that I can run the appropriate level of testing.\n\n#### Acceptance Criteria\n\n1. WHEN running `cargo test` THEN unit tests SHALL run by default\n2. IF integration tests are needed THEN `cargo test --test integration` SHALL run them\n3. WHEN tests require real devices THEN they SHALL be marked `#[ignore]` with reason\n4. IF e2e tests exist THEN they SHALL be in `tests/e2e/` directory\n\n### Requirement 3: Inline Test Extraction\n\n**User Story:** As a developer, I want inline tests moved to test files, so that source files focus on implementation.\n\n#### Acceptance Criteria\n\n1. WHEN source has > 100 LOC of inline tests THEN they SHALL be moved to test files\n2. IF tests need private access THEN `#[cfg(test)]` helpers SHALL be exposed\n3. WHEN moving tests THEN coverage SHALL remain the same or improve\n4. IF inline tests remain THEN they SHALL be for truly internal behavior only\n\n### Requirement 4: Shared Test Fixtures\n\n**User Story:** As a test developer, I want shared fixtures and builders, so that I don't duplicate test setup across files.\n\n#### Acceptance Criteria\n\n1. WHEN multiple tests need similar setup THEN a shared fixture SHALL be available\n2. IF fixtures need cleanup THEN they SHALL implement Drop\n3. WHEN builders are used THEN they SHALL follow builder pattern consistently\n4. IF fixtures are expensive THEN lazy initialization SHALL be used\n\n### Requirement 5: Test Documentation\n\n**User Story:** As a new developer, I want test organization documented, so that I know where to add new tests.\n\n#### Acceptance Criteria\n\n1. WHEN adding a test THEN the test README SHALL explain where it goes\n2. IF a test category exists THEN its purpose SHALL be documented\n3. WHEN tests fail THEN the error message SHALL indicate the test's purpose\n4. IF naming conventions exist THEN they SHALL be documented\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Each test file tests one module/feature\n- **Modular Design**: Test utilities are reusable across test files\n- **Dependency Management**: Tests don't depend on test execution order\n- **Clear Interfaces**: Fixtures have clear setup/teardown\n\n### Performance\n- Unit tests SHALL complete in < 30 seconds total\n- Integration tests SHALL complete in < 5 minutes\n- Parallel test execution SHALL be supported\n\n### Security\n- Tests SHALL not require elevated privileges unless testing drivers\n- Test fixtures SHALL not leave artifacts on disk\n\n### Reliability\n- Tests SHALL be deterministic (no flaky tests)\n- Tests SHALL run in any order\n- Tests SHALL clean up after themselves\n\n### Usability\n- Finding tests for a module SHALL take < 30 seconds\n- Adding a new test SHALL be obvious from documentation\n- Test failures SHALL clearly indicate what failed and why\n",
  "fileStats": {
    "size": 4157,
    "lines": 99,
    "lastModified": "2025-12-03T13:05:52.327Z"
  },
  "comments": []
}