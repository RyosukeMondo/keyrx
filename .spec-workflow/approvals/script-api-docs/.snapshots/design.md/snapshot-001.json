{
  "id": "snapshot_1764768822147_9x88bbxcs",
  "approvalId": "approval_1764768822120_4956knbvi",
  "approvalTitle": "Script API Documentation Design",
  "version": 1,
  "timestamp": "2025-12-03T13:33:42.147Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design creates a documentation extraction system for Rhai functions registered in KeyRx. The core innovation is a `#[rhai_doc]` attribute macro that captures function signatures and doc comments at compile time, building a documentation registry that can be exported to multiple formats.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Documentation**: Auto-generated from source\n- **Testing**: Examples are tests\n- **Type Safety**: Type info from Rust types\n\n### Project Structure (structure.md)\n- Rhai registration in `core/src/scripting/`\n- Doc generation in `core/src/scripting/docs/`\n- Output to `docs/scripting/`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **Rhai Engine**: Already registers functions\n- **Doc comments**: Already exist on some functions\n- **Build script**: Can generate docs\n\n### Integration Points\n- **Rhai registration**: Extract doc metadata\n- **Build process**: Generate docs\n- **Flutter UI**: Display docs in-app\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Source Code\"\n        SRC[Rhai Functions] --> |#[rhai_doc]| META[Doc Metadata]\n        SRC --> |register| ENG[Rhai Engine]\n    end\n\n    subgraph \"Doc Registry\"\n        META --> REG[DocRegistry]\n        REG --> FN[FunctionDoc]\n        REG --> TY[TypeDoc]\n        REG --> EX[ExampleDoc]\n    end\n\n    subgraph \"Output\"\n        REG --> |generate| HTML[HTML Docs]\n        REG --> |generate| MD[Markdown]\n        REG --> |generate| JSON[JSON Schema]\n    end\n```\n\n### Modular Design Principles\n- **Single Source**: Code is documentation source\n- **Compile-Time Extraction**: Metadata captured at build\n- **Multiple Outputs**: Same data, different formats\n- **Testable Examples**: Examples run as tests\n\n## Components and Interfaces\n\n### Component 1: DocRegistry\n\n- **Purpose:** Central registry of API documentation\n- **Interfaces:**\n  ```rust\n  pub struct DocRegistry {\n      modules: HashMap<String, ModuleDoc>,\n      types: HashMap<String, TypeDoc>,\n      examples: Vec<Example>,\n  }\n\n  impl DocRegistry {\n      pub fn global() -> &'static Self;\n      pub fn register_function(&mut self, doc: FunctionDoc);\n      pub fn register_type(&mut self, doc: TypeDoc);\n      pub fn add_example(&mut self, example: Example);\n      pub fn get_module(&self, name: &str) -> Option<&ModuleDoc>;\n      pub fn all_functions(&self) -> impl Iterator<Item = &FunctionDoc>;\n      pub fn search(&self, query: &str) -> Vec<SearchResult>;\n  }\n  ```\n- **Dependencies:** None\n- **Reuses:** Registry pattern\n\n### Component 2: FunctionDoc\n\n- **Purpose:** Documentation for a single Rhai function\n- **Interfaces:**\n  ```rust\n  #[derive(Debug, Clone, Serialize)]\n  pub struct FunctionDoc {\n      pub name: String,\n      pub module: String,\n      pub signature: FunctionSignature,\n      pub description: String,\n      pub parameters: Vec<ParamDoc>,\n      pub returns: Option<ReturnDoc>,\n      pub examples: Vec<String>,\n      pub since: Option<String>,\n      pub deprecated: Option<String>,\n  }\n\n  #[derive(Debug, Clone, Serialize)]\n  pub struct FunctionSignature {\n      pub params: Vec<(String, String)>,  // (name, type)\n      pub return_type: Option<String>,\n  }\n\n  #[derive(Debug, Clone, Serialize)]\n  pub struct ParamDoc {\n      pub name: String,\n      pub type_name: String,\n      pub description: String,\n      pub optional: bool,\n      pub default: Option<String>,\n  }\n\n  #[derive(Debug, Clone, Serialize)]\n  pub struct ReturnDoc {\n      pub type_name: String,\n      pub description: String,\n  }\n  ```\n- **Dependencies:** serde\n- **Reuses:** Documentation patterns\n\n### Component 3: TypeDoc\n\n- **Purpose:** Documentation for Rhai types\n- **Interfaces:**\n  ```rust\n  #[derive(Debug, Clone, Serialize)]\n  pub struct TypeDoc {\n      pub name: String,\n      pub description: String,\n      pub methods: Vec<FunctionDoc>,\n      pub properties: Vec<PropertyDoc>,\n      pub constructors: Vec<FunctionDoc>,\n  }\n\n  #[derive(Debug, Clone, Serialize)]\n  pub struct PropertyDoc {\n      pub name: String,\n      pub type_name: String,\n      pub description: String,\n      pub readonly: bool,\n  }\n  ```\n- **Dependencies:** FunctionDoc\n- **Reuses:** Type documentation patterns\n\n### Component 4: rhai_doc Attribute Macro\n\n- **Purpose:** Extract documentation at compile time\n- **Interfaces:**\n  ```rust\n  /// Document a Rhai function.\n  ///\n  /// # Example\n  /// ```rust\n  /// #[rhai_doc(module = \"keys\", since = \"0.1.0\")]\n  /// /// Emits a key press event.\n  /// ///\n  /// /// # Parameters\n  /// /// - `key`: The key code to press\n  /// ///\n  /// /// # Example\n  /// /// ```rhai\n  /// /// emit_key(Key::A);\n  /// /// ```\n  /// fn emit_key(key: KeyCode) -> Result<(), RhaiError> {\n  ///     // implementation\n  /// }\n  /// ```\n  #[proc_macro_attribute]\n  pub fn rhai_doc(attr: TokenStream, item: TokenStream) -> TokenStream;\n  ```\n- **Dependencies:** proc-macro2, syn, quote\n- **Reuses:** Attribute macro patterns\n\n### Component 5: DocGenerator\n\n- **Purpose:** Generate documentation in various formats\n- **Interfaces:**\n  ```rust\n  pub struct DocGenerator {\n      registry: &'static DocRegistry,\n  }\n\n  impl DocGenerator {\n      pub fn new() -> Self;\n\n      // Output formats\n      pub fn generate_html(&self, output_dir: &Path) -> io::Result<()>;\n      pub fn generate_markdown(&self, output_dir: &Path) -> io::Result<()>;\n      pub fn generate_json_schema(&self, output: &Path) -> io::Result<()>;\n\n      // Index for search\n      pub fn generate_search_index(&self) -> SearchIndex;\n  }\n\n  pub struct SearchIndex {\n      entries: Vec<SearchEntry>,\n  }\n  ```\n- **Dependencies:** DocRegistry, templating\n- **Reuses:** Documentation generation patterns\n\n### Component 6: Example Runner\n\n- **Purpose:** Test documentation examples\n- **Interfaces:**\n  ```rust\n  pub struct ExampleRunner {\n      engine: Engine,\n  }\n\n  impl ExampleRunner {\n      pub fn new() -> Self;\n      pub fn run_example(&self, code: &str) -> Result<(), ExampleError>;\n      pub fn run_all_examples(&self) -> Vec<ExampleResult>;\n  }\n\n  pub struct ExampleResult {\n      pub function: String,\n      pub code: String,\n      pub passed: bool,\n      pub error: Option<String>,\n  }\n  ```\n- **Dependencies:** Rhai engine\n- **Reuses:** Test runner patterns\n\n## Data Models\n\n### SearchResult\n```rust\n#[derive(Debug, Clone, Serialize)]\npub struct SearchResult {\n    pub kind: SearchResultKind,\n    pub name: String,\n    pub module: String,\n    pub description: String,\n    pub score: f64,\n}\n\n#[derive(Debug, Clone, Copy, Serialize)]\npub enum SearchResultKind {\n    Function,\n    Type,\n    Property,\n    Example,\n}\n```\n\n### ModuleDoc\n```rust\n#[derive(Debug, Clone, Serialize)]\npub struct ModuleDoc {\n    pub name: String,\n    pub description: String,\n    pub functions: Vec<FunctionDoc>,\n    pub types: Vec<TypeDoc>,\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Missing documentation**\n   - **Handling:** Build warning, generate placeholder\n   - **User Impact:** Incomplete but usable docs\n\n2. **Example failure**\n   - **Handling:** Build warning, mark example as broken\n   - **User Impact:** Clear indication of issue\n\n3. **Type extraction failure**\n   - **Handling:** Use \"any\" type, log warning\n   - **User Impact:** Less precise type info\n\n## Testing Strategy\n\n### Unit Testing\n- Test doc extraction\n- Test generation outputs\n- Test search functionality\n\n### Example Testing\n- Run all examples as tests\n- Verify example output\n- Test error examples\n\n### Integration Testing\n- Full doc generation pipeline\n- HTML rendering verification\n- Search index accuracy\n",
  "fileStats": {
    "size": 7556,
    "lines": 300,
    "lastModified": "2025-12-03T13:33:15.334Z"
  },
  "comments": []
}