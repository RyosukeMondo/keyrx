{
  "id": "snapshot_1764770435685_j5yh908yt",
  "approvalId": "approval_1764770435653_zvip50s9o",
  "approvalTitle": "Unwrap/Panic Hardening Tasks (18 tasks)",
  "version": 1,
  "timestamp": "2025-12-03T14:00:35.685Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n## Phase 1: Infrastructure\n\n- [ ] 1. Create CriticalError type\n  - File: `core/src/errors/critical.rs`\n  - Define error variants with fallback actions\n  - Implement is_recoverable and fallback_action\n  - Purpose: Error type for critical path\n  - _Leverage: thiserror_\n  - _Requirements: 2.2, 2.3_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating error types | Task: Create CriticalError with fallback actions | Restrictions: All variants have recovery path, serializable | _Leverage: thiserror | Success: Error type covers all critical failures | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 2. Create CriticalResult type\n  - File: `core/src/errors/critical_result.rs`\n  - Implement without panic-inducing methods\n  - Add unwrap_or_fallback and similar safe methods\n  - Purpose: Result type that can't panic\n  - _Leverage: Rust type system_\n  - _Requirements: 2.1, 2.4_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating types | Task: Create CriticalResult without unwrap/expect | Restrictions: No panic methods, must_use, safe fallbacks | _Leverage: Type system | Success: Type prevents panic at compile time | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 3. Create PanicGuard\n  - File: `core/src/safety/panic_guard.rs`\n  - Implement catch_unwind wrapper\n  - Add backtrace capture and logging\n  - Purpose: Catch panics in critical code\n  - _Leverage: std::panic::catch_unwind_\n  - _Requirements: 3.1, 3.2, 3.3_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with panic handling expertise | Task: Create PanicGuard with backtrace logging | Restrictions: Catch all panics, preserve backtraces | _Leverage: std::panic | Success: Panics caught and logged | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 4. Create CircuitBreaker\n  - File: `core/src/safety/circuit_breaker.rs`\n  - Implement state machine (Closed/Open/HalfOpen)\n  - Add configurable thresholds and timeouts\n  - Purpose: Prevent repeated failures\n  - _Leverage: Atomic operations_\n  - _Requirements: 3.4, 4.1_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer implementing patterns | Task: Create CircuitBreaker with state machine | Restrictions: Thread-safe, configurable, lock-free | _Leverage: Atomics | Success: Circuit breaker prevents cascading failures | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 2: Fallback Infrastructure\n\n- [ ] 5. Create FallbackEngine\n  - File: `core/src/engine/fallback.rs`\n  - Implement minimal passthrough engine\n  - Add activation/deactivation with reason tracking\n  - Purpose: Fallback when main engine fails\n  - _Leverage: Null object pattern_\n  - _Requirements: 4.1, 4.3_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating fallback | Task: Create FallbackEngine for passthrough mode | Restrictions: Minimal, always works, no dependencies | _Leverage: Null object pattern | Success: Fallback passes keys through | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 6. Create extension traits for safe unwrapping\n  - File: `core/src/safety/extensions.rs`\n  - OptionExt with unwrap_or_log\n  - ResultExt with map_critical\n  - Purpose: Migration helpers\n  - _Leverage: Extension traits_\n  - _Requirements: 2.1, 2.4_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating utilities | Task: Create OptionExt and ResultExt traits | Restrictions: Log on fallback, preserve context | _Leverage: Extension traits | Success: Easy migration from unwrap | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 3: Critical Path Audit\n\n- [ ] 7. Audit and fix driver unwraps (Windows)\n  - Files: `core/src/drivers/windows/*.rs`\n  - Replace unwrap/expect with error handling\n  - Wrap hook callback in PanicGuard\n  - Purpose: Safe Windows driver\n  - _Leverage: CriticalResult, PanicGuard_\n  - _Requirements: 1.1, 1.3, 3.1_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with Windows expertise | Task: Remove unwraps from Windows driver, add PanicGuard | Restrictions: Zero unwraps in hook callback, panic recovery | _Leverage: PanicGuard | Success: Windows driver panic-safe | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 8. Audit and fix driver unwraps (Linux)\n  - Files: `core/src/drivers/linux/*.rs`\n  - Replace unwrap/expect with error handling\n  - Ensure existing catch_unwind is comprehensive\n  - Purpose: Safe Linux driver\n  - _Leverage: CriticalResult, PanicGuard_\n  - _Requirements: 1.1, 1.3, 3.1_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with Linux expertise | Task: Remove unwraps from Linux driver | Restrictions: Zero unwraps in reader loop, complete catch_unwind | _Leverage: PanicGuard | Success: Linux driver panic-safe | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 9. Audit and fix engine unwraps\n  - Files: `core/src/engine/*.rs`\n  - Replace unwrap/expect with CriticalResult\n  - Add state recovery on errors\n  - Purpose: Safe engine core\n  - _Leverage: CriticalResult_\n  - _Requirements: 1.1, 1.2, 2.1_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer auditing code | Task: Remove unwraps from engine core | Restrictions: Zero unwraps in process path, state recovery | _Leverage: CriticalResult | Success: Engine handles all errors | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 10. Audit and fix FFI boundary unwraps\n  - Files: `core/src/ffi/exports_*.rs`\n  - Replace unwrap/expect with error returns\n  - Never panic across FFI boundary\n  - Purpose: Safe FFI\n  - _Leverage: CriticalResult_\n  - _Requirements: 1.1, 2.1_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer fixing FFI | Task: Remove unwraps from FFI boundary | Restrictions: Never panic across FFI, return errors | _Leverage: CriticalResult | Success: FFI never panics | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 4: Discovery and Config\n\n- [ ] 11. Fix discovery module unwraps\n  - Files: `core/src/discovery/*.rs`\n  - Replace device parsing unwraps\n  - Handle missing/invalid devices gracefully\n  - Purpose: Robust device discovery\n  - _Leverage: CriticalResult_\n  - _Requirements: 1.1, 4.2_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer fixing discovery | Task: Remove unwraps from discovery module | Restrictions: Handle invalid devices, graceful fallback | _Leverage: CriticalResult | Success: Discovery never panics | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 12. Fix config loading unwraps\n  - Files: `core/src/config/*.rs`\n  - Use defaults on parse failure\n  - Log errors but continue\n  - Purpose: Robust config loading\n  - _Leverage: Extension traits_\n  - _Requirements: 4.2_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer fixing config | Task: Remove unwraps from config loading | Restrictions: Use defaults on failure, warn user | _Leverage: Extension traits | Success: Config always loads | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 5: Integration\n\n- [ ] 13. Integrate CircuitBreaker into drivers\n  - Files: `core/src/drivers/mod.rs`\n  - Wrap driver operations in circuit breaker\n  - Activate fallback when circuit opens\n  - Purpose: Automatic failure recovery\n  - _Leverage: CircuitBreaker, FallbackEngine_\n  - _Requirements: 3.4, 4.1_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer integrating safety | Task: Add CircuitBreaker to driver operations | Restrictions: Auto-fallback on repeated failures | _Leverage: CircuitBreaker | Success: Drivers recover automatically | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 14. Add panic telemetry to FFI\n  - File: `core/src/ffi/exports_telemetry.rs`\n  - Export panic counts and recovery events\n  - Enable Flutter to show recovery notifications\n  - Purpose: User visibility into issues\n  - _Leverage: FFI patterns_\n  - _Requirements: 3.3_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer adding telemetry | Task: Export panic telemetry via FFI | Restrictions: Recovery events, panic counts, backtraces | _Leverage: FFI patterns | Success: Flutter shows recovery notifications | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 15. Verify emergency exit always works\n  - Files: All driver files\n  - Test emergency exit in panic scenarios\n  - Test in circuit breaker open state\n  - Purpose: User safety guarantee\n  - _Leverage: Testing_\n  - _Requirements: 1.4_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Developer testing safety | Task: Verify emergency exit works in all scenarios | Restrictions: Must work during panic, during fallback | _Leverage: Testing | Success: Emergency exit always works | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 6: Testing and Verification\n\n- [ ] 16. Add panic injection tests\n  - File: `core/tests/panic_recovery_test.rs`\n  - Inject panics at various points\n  - Verify recovery and logging\n  - Purpose: Verify panic handling\n  - _Leverage: Test fixtures_\n  - _Requirements: 3.1, 3.2_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Test Developer | Task: Create panic injection tests | Restrictions: Test all critical paths, verify recovery | _Leverage: Test fixtures | Success: All panics recovered | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 17. Add lint to prevent new unwraps\n  - File: `.cargo/config.toml` or clippy.toml\n  - Deny unwrap/expect in critical modules\n  - Allow only with explicit annotation\n  - Purpose: Prevent regression\n  - _Leverage: Clippy lints_\n  - _Requirements: 1.1_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer configuring lints | Task: Add clippy lint to deny unwrap in critical paths | Restrictions: Deny in drivers/engine, allow with annotation | _Leverage: Clippy | Success: New unwraps cause build failure | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 18. Document panic handling architecture\n  - File: `docs/panic-handling.md`\n  - Explain PanicGuard usage\n  - Document fallback behavior\n  - Purpose: Developer documentation\n  - _Leverage: Implementation knowledge_\n  - _Requirements: Non-functional (documentation)_\n  - _Prompt: Implement the task for spec unwrap-panic-hardening, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer | Task: Document panic handling architecture | Restrictions: Cover all components, usage examples | _Leverage: Implementation | Success: Developers understand panic handling | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n",
  "fileStats": {
    "size": 13917,
    "lines": 176,
    "lastModified": "2025-12-03T13:58:38.273Z"
  },
  "comments": []
}