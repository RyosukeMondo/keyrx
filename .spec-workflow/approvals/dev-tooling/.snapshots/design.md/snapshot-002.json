{
  "id": "snapshot_1764461350900_afu7gz2bo",
  "approvalId": "approval_1764461077558_6dkp3cwie",
  "approvalTitle": "Dev-Tooling Design Document",
  "version": 2,
  "timestamp": "2025-11-30T00:09:10.900Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: dev-tooling\n\n## Overview\n\nThis design establishes development infrastructure for KeyRx including pre-commit hooks, CI/CD pipelines, error handling patterns, documentation, and enhanced mock infrastructure. The goal is to enable fast, reliable iteration for both human developers and AI agents.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Code Quality Tools**: clippy, rustfmt, cargo test as specified\n- **Testing Framework**: proptest for fuzzing, criterion for benchmarks\n- **Error Handling**: anyhow for application errors, thiserror for library errors\n\n### Project Structure (structure.md)\n- Configuration files at repository root\n- Documentation in `docs/` directory\n- CI configuration in `.github/workflows/`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **anyhow**: Already in Cargo.toml for error handling\n- **thiserror**: Already in Cargo.toml for custom errors\n- **tracing**: Already configured for structured logging\n- **serde/serde_json**: Already available for JSON output\n\n### Integration Points\n- **RhaiRuntime**: Refactor error handling, remove Rc<RefCell>\n- **CLI Commands**: Replace process::exit with Result returns\n- **Mock implementations**: Extend with call tracking and error injection\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Development Flow\"\n        A[git commit] --> B[pre-commit hooks]\n        B --> C{All pass?}\n        C -->|Yes| D[Commit created]\n        C -->|No| E[Block + Show errors]\n    end\n\n    subgraph \"Pre-commit Hooks\"\n        B --> F[cargo fmt --check]\n        B --> G[cargo clippy -D warnings]\n        B --> H[cargo test]\n    end\n\n    subgraph \"CI Pipeline\"\n        I[PR opened] --> J[GitHub Actions]\n        J --> K[Build Linux]\n        J --> L[Build Windows]\n        J --> M[Run tests]\n        J --> N[Clippy + Format]\n        K & L & M & N --> O{All pass?}\n        O -->|Yes| P[PR mergeable]\n        O -->|No| Q[PR blocked]\n    end\n```\n\n## Components and Interfaces\n\n### Component 1: Pre-commit Hook System\n- **Purpose**: Enforce code quality before commits\n- **Technology**: Shell scripts + cargo commands (no external deps)\n- **Files**:\n  - `scripts/install-hooks.sh` - One-command hook installation\n  - `.githooks/pre-commit` - Hook script\n- **Interfaces**: Exit 0 on success, non-zero on failure\n\n### Component 2: GitHub Actions CI\n- **Purpose**: Automated build and test on PR\n- **Files**:\n  - `.github/workflows/ci.yml` - Main CI workflow\n- **Jobs**:\n  - `check` - Format and lint\n  - `test` - Run all tests\n  - `build-linux` - Build Linux binary\n  - `build-windows` - Cross-compile Windows binary\n- **Triggers**: PR open, push to main\n\n### Component 3: Error Handling Refactor\n- **Purpose**: Replace silent failures with proper error propagation\n- **Pattern**: All functions return `Result<T, E>`, errors bubble up\n- **Files to modify**:\n  - `scripting/runtime.rs` - Rhai function error returns\n  - `cli/commands/*.rs` - Remove process::exit\n  - `traits/script_runtime.rs` - Add error variants\n\n### Component 4: Custom Error Types\n- **Purpose**: Structured errors with context\n- **Files**:\n  - `core/src/error.rs` - KeyRx error hierarchy\n- **Interface**:\n  ```rust\n  #[derive(Debug, thiserror::Error)]\n  pub enum KeyRxError {\n      #[error(\"Unknown key '{0}'\")]\n      UnknownKey(String),\n      #[error(\"Script error: {0}\")]\n      ScriptError(#[from] rhai::EvalAltResult),\n      #[error(\"IO error: {0}\")]\n      IoError(#[from] std::io::Error),\n  }\n  ```\n\n### Component 5: Documentation\n- **Purpose**: Enable autonomous script development\n- **Files**:\n  - `docs/SCRIPTING.md` - Rhai API reference\n  - `docs/KEYS.md` - Complete key name reference\n- **Format**: Markdown with examples\n\n### Component 6: Enhanced Mocks\n- **Purpose**: Enable comprehensive testing including error paths\n- **Files**:\n  - `mocks/mock_input.rs` - Add error injection\n  - `mocks/mock_runtime.rs` - Add call tracking\n  - `mocks/mock_state.rs` - Add history tracking\n- **Interface**:\n  ```rust\n  impl MockInput {\n      pub fn with_error_after(n: usize, error: anyhow::Error) -> Self;\n      pub fn call_history(&self) -> &[MockCall];\n  }\n  ```\n\n### Component 7: Configuration Files\n- **Purpose**: Consistent code style across team\n- **Files**:\n  - `rustfmt.toml` - Formatting rules\n  - `clippy.toml` - Lint configuration\n  - `Cargo.toml` - Profile optimization\n- **Settings**: 100 char lines, Rust 2021 edition imports\n\n## Data Models\n\n### KeyRxError Enum\n```rust\n#[derive(Debug, thiserror::Error)]\npub enum KeyRxError {\n    #[error(\"Unknown key: '{key}'\")]\n    UnknownKey { key: String },\n\n    #[error(\"Script compilation failed: {message}\")]\n    ScriptCompileError { message: String, line: Option<usize> },\n\n    #[error(\"Script execution failed: {message}\")]\n    ScriptRuntimeError { message: String },\n\n    #[error(\"Invalid path: {path}\")]\n    InvalidPath { path: String },\n\n    #[error(\"IO error: {0}\")]\n    Io(#[from] std::io::Error),\n\n    #[error(\"Platform error: {message}\")]\n    PlatformError { message: String },\n}\n```\n\n### MockCall Tracking\n```rust\n#[derive(Debug, Clone)]\npub enum MockCall {\n    Start,\n    Stop,\n    PollEvents,\n    SendOutput(OutputAction),\n    LoadFile(String),\n    Execute(String),\n    CallHook(String),\n    LookupRemap(KeyCode),\n}\n\npub struct CallTracker {\n    calls: Vec<MockCall>,\n}\n```\n\n## Error Handling\n\n### Strategy: Result Everywhere\n\n**Before (silent failure)**:\n```rust\nfn remap(from: &str, to: &str) {\n    let from_key = match KeyCode::from_name(from) {\n        Some(k) => k,\n        None => {\n            tracing::warn!(\"Unknown key: {}\", from);\n            return;  // Silent failure!\n        }\n    };\n}\n```\n\n**After (error propagation)**:\n```rust\nfn remap(from: &str, to: &str) -> Result<(), KeyRxError> {\n    let from_key = KeyCode::from_name(from)\n        .ok_or_else(|| KeyRxError::UnknownKey { key: from.to_string() })?;\n    let to_key = KeyCode::from_name(to)\n        .ok_or_else(|| KeyRxError::UnknownKey { key: to.to_string() })?;\n    // ...\n    Ok(())\n}\n```\n\n### CLI Error Handling\n\n**Before**:\n```rust\npub fn run(&self) -> Result<()> {\n    match self.validate() {\n        Ok(_) => { /* ... */ }\n        Err(e) => {\n            eprintln!(\"Error: {}\", e);\n            std::process::exit(2);  // Hard exit!\n        }\n    }\n}\n```\n\n**After**:\n```rust\npub fn run(&self) -> Result<()> {\n    self.validate()?;  // Propagate error\n    // ...\n    Ok(())\n}\n\n// In main.rs:\nfn main() {\n    if let Err(e) = run_cli() {\n        eprintln!(\"Error: {}\", e);\n        std::process::exit(1);\n    }\n}\n```\n\n## Testing Strategy\n\n### Unit Testing\n- All new error types have tests\n- Mock call tracking verified\n- Error injection paths tested\n\n### Integration Testing\n- Pre-commit hooks tested in CI\n- Error propagation end-to-end tested\n- Documentation examples validated\n\n### Validation Testing\n- `cargo fmt --check` passes\n- `cargo clippy -D warnings` passes\n- All existing tests continue to pass\n\n## File Changes Summary\n\n| File | Action | Purpose |\n|------|--------|---------|\n| `scripts/install-hooks.sh` | Create | One-command hook installation |\n| `.githooks/pre-commit` | Create | Pre-commit hook script |\n| `.github/workflows/ci.yml` | Create | CI pipeline |\n| `rustfmt.toml` | Create | Formatting config |\n| `clippy.toml` | Create | Lint config |\n| `core/src/error.rs` | Create | Custom error types |\n| `core/src/lib.rs` | Modify | Export error module |\n| `core/src/scripting/runtime.rs` | Modify | Error returns, remove Rc<RefCell> |\n| `core/src/cli/commands/check.rs` | Modify | Remove process::exit |\n| `core/src/cli/commands/run.rs` | Modify | Fix path handling |\n| `core/src/mocks/mock_input.rs` | Modify | Add error injection + tracking |\n| `core/src/mocks/mock_runtime.rs` | Modify | Add call tracking |\n| `core/src/mocks/mock_state.rs` | Modify | Add history tracking |\n| `core/src/traits/script_runtime.rs` | Modify | Error-returning methods |\n| `docs/SCRIPTING.md` | Create | Rhai API documentation |\n| `docs/KEYS.md` | Create | Key name reference |\n| `Cargo.toml` | Modify | Dev profile optimization |\n",
  "fileStats": {
    "size": 8048,
    "lines": 280,
    "lastModified": "2025-11-30T00:02:39.196Z"
  },
  "comments": []
}