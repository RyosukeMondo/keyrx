{
  "id": "snapshot_1766145576244_cuy2vm3b8",
  "approvalId": "approval_1766145576209_9lnxqt2gu",
  "approvalTitle": "Design for Dart CLI Layer",
  "version": 1,
  "timestamp": "2025-12-19T11:59:36.244Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe design involves refactoring the existing Flutter application structure to extract the FFI bridge and data models into a shared, pure Dart package (`core_logic`). A new Dart CLI application (`apps/cli_tool`) will be created to consume this shared package, providing a headless interface for testing and automation.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\nThis design implements the \"Headless Dart Harness Strategy\" defined in the updated `tech.md`. It adheres to the 3-Layer Hybrid Architecture by explicitly separating the Core Layer access (FFI) from the UI Layer.\n\n### Project Structure (structure.md)\nThe new directory structure follows the updated `structure.md`:\n- `packages/core_logic/`: Shared code.\n- `apps/cli_tool/`: New CLI entry point.\n- `ui/`: Depends on `core_logic`.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **FFI Bindings**: The existing `rust_lib` (or equivalent) generated bindings will be moved to `core_logic`.\n- **Freezed Models**: Existing data models in `ui/lib/models` will be moved to `core_logic/lib/models` to be shared.\n- **Service Logic**: Any non-UI business logic currently in `ui/lib/services` that doesn't depend on Flutter widgets will be candidate for migration.\n\n### Integration Points\n- **Rust Core**: The FFI bridge remains the primary integration point. The `core_logic` package will handle the `dart:ffi` initialization.\n- **Flutter UI**: The UI will need to be refactored to import from `package:core_logic` instead of local relative paths for models and FFI.\n\n## Architecture\n\n### Modular Design Principles\n- **Package-Based Architecture**: Separation is enforced by Dart package boundaries. `core_logic` cannot accidental import Flutter classes because it won't have `flutter` in its `pubspec.yaml`.\n- **Command Pattern**: The CLI will use a Command pattern to map JSON inputs to executable actions.\n\n```mermaid\ngraph TD\n    Rust[Rust Core] <-->|FFI| CorePkg[package:core_logic]\n    CorePkg -->|Imports| Models[Shared Models]\n    CorePkg -->|Imports| Bridge[FFI Bridge]\n    \n    UI[Flutter UI] -->|Depends on| CorePkg\n    CLI[Dart CLI Tool] -->|Depends on| CorePkg\n    \n    Test[Test Scripts] -->|Stdio/JSON| CLI\n```\n\n## Components and Interfaces\n\n### Package: core_logic\n- **Purpose:** Encapsulate FFI bindings and shared domain models.\n- **Interfaces:**\n  - `KeyrxCore.init()`: Initialize FFI.\n  - `KeyrxCore.api`: Access to Rust methods.\n  - `Models`: UserProfile, Config, etc.\n- **Dependencies:** `ffi`, `freezed_annotation`.\n\n### App: cli_tool\n- **Purpose:** Headless execution of core logic.\n- **Interfaces:** CLI arguments (`--json`, `--cmd`).\n- **Dependencies:** `core_logic`, `args`.\n\n## Data Models\n\n### JSON Command Protocol\nThe CLI will accept a standardized JSON wrapper for commands:\n```json\n{\n  \"command\": \"update_profile\",\n  \"payload\": {\n    \"name\": \"Alice\",\n    \"age\": 30\n  }\n}\n```\n\n### JSON Response Protocol\n```json\n{\n  \"status\": \"success\",\n  \"data\": { ... }\n}\n```\nOR\n```json\n{\n  \"status\": \"error\",\n  \"error\": \"Validation failed\"\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **FFI Load Failure:**\n   - **Handling:** `core_logic` throws a specific `FfiInitError`. CLI catches and prints `{\"status\": \"error\", \"code\": \"FFI_LOAD_FAILED\"}`.\n2. **Invalid JSON Input:**\n   - **Handling:** CLI validation layer rejects before calling core. Prints `{\"status\": \"error\", \"code\": \"INVALID_JSON\"}`.\n\n## Testing Strategy\n\n### Unit Testing (Dart)\n- Test `core_logic` models and parsers using standard `dart test`.\n\n### Integration Testing (Headless)\n- Write Dart tests in `apps/cli_tool/test` that invoke the core logic via FFI (requires built Rust library).\n- Shell scripts that pipe JSON to the compiled CLI binary and assert on output using `jq`.\n",
  "fileStats": {
    "size": 3786,
    "lines": 107,
    "lastModified": "2025-12-19T11:59:36.167Z"
  },
  "comments": []
}