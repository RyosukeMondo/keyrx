{
  "id": "snapshot_1769032441832_uuw2q5xgm",
  "approvalId": "approval_1769032441689_lwek1nin1",
  "approvalTitle": "Design Document for UAT UI Fixes",
  "version": 1,
  "timestamp": "2026-01-21T21:54:01.832Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: UAT UI Fixes\n\n## Overview\n\nThis specification addresses critical UI/UX issues identified during User Acceptance Testing. The implementation focuses on improving dashboard device indicators, replacing destructive device deletion with non-destructive enable/disable toggles, enhancing profile management UX, fixing navigation consistency, resolving RPC errors, expanding layer display to full 256-layer support, and populating empty key dropdowns.\n\nAll changes are frontend-focused, maintaining backward compatibility with the existing REST API while improving the user experience through better visual indicators, safer operations, and complete feature access.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**Frontend Architecture:**\n- Follows React component-based architecture with TypeScript\n- Maintains separation of concerns: API layer → hooks → components\n- Uses existing patterns for state management (Zustand/Context)\n- Follows SOLID principles with dependency injection via hooks\n\n**Code Quality:**\n- All new components under 500 lines per file\n- Functions under 50 lines\n- Test coverage maintained (unit tests for new functionality)\n- No backward compatibility breaks (additive changes only)\n\n**Error Handling:**\n- Graceful degradation for API failures\n- User-facing error messages via toast notifications\n- Fail-fast validation at entry points\n\n### Project Structure (structure.md)\n\n**Implementation follows standard locations:**\n- `keyrx_ui/src/types/` - TypeScript interfaces (DeviceEntry, ProfileEntry)\n- `keyrx_ui/src/api/` - API client functions (devices.ts, profiles.ts)\n- `keyrx_ui/src/hooks/` - Custom React hooks (useDevices, useProfiles)\n- `keyrx_ui/src/components/` - Reusable components (ProfileCard, LayerSwitcher)\n- `keyrx_ui/src/pages/` - Page components (DashboardPage, DevicesPage, ProfilesPage, ConfigPage)\n- `keyrx_ui/src/__tests__/` - Test files co-located with tested modules\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **DeviceEntry Interface** (`src/types/index.ts`): Extended with `isVirtual` and `enabled` fields\n- **ProfileCard Component** (`src/components/ProfileCard.tsx`): Enhanced with inline editing and active state styling\n- **LayerSwitcher Component** (`src/components/LayerSwitcher.tsx`): Refactored to show full 256-layer range\n- **API Client Pattern** (`src/api/`): Consistent REST API wrapper pattern used for new endpoints\n- **Custom Hooks Pattern** (`src/hooks/`): Used for device enable/disable and profile operations\n- **Toast/Notification System**: Leveraged existing notification patterns for success messages\n- **Test Utilities** (`tests/testUtils.tsx`): Used `renderWithProviders` for component testing\n\n### Integration Points\n\n- **REST API**: No backend changes required - all features use existing endpoints or frontend-only state\n- **WebSocket RPC**: Fixed client-side payload format to match server expectations\n- **localStorage**: Used as fallback for device enabled state if backend doesn't support persistence\n- **React Router**: Enhanced navigation to pass state between pages (Profiles → Config)\n\n## Architecture\n\n### Modular Design Principles\n\nThe implementation follows strict modular design:\n\n1. **Single File Responsibility**: Each component file handles one UI concern (ProfileCard for profile display/editing, LayerSwitcher for layer selection)\n2. **API Layer Separation**: All backend communication isolated in `src/api/` modules\n3. **Hook-Based State Management**: Business logic and API calls encapsulated in custom hooks\n4. **Component Composition**: Small, focused components composed into page-level components\n\n### Data Flow Architecture\n\n```mermaid\ngraph TD\n    A[User Action] --> B[Component Event Handler]\n    B --> C[Custom Hook]\n    C --> D[API Client]\n    D --> E[REST API / WebSocket]\n    E --> F[Backend Response]\n    F --> G[Hook State Update]\n    G --> H[Component Re-render]\n\n    subgraph Frontend\n        B\n        C\n        D\n        G\n        H\n    end\n\n    subgraph Backend\n        E\n    end\n```\n\n### Feature Modules\n\n```mermaid\ngraph LR\n    subgraph Dashboard\n        A[DashboardPage] --> B[StateIndicatorPanel]\n        B --> C[Device Type Badge]\n    end\n\n    subgraph Devices\n        D[DevicesPage] --> E[DeviceRow]\n        E --> F[Enable/Disable Toggle]\n        F --> G[useDevices Hook]\n    end\n\n    subgraph Profiles\n        H[ProfilesPage] --> I[ProfileCard]\n        I --> J[Inline Editor]\n        I --> K[Active Indicator]\n        I --> L[Activation Button]\n        L --> M[Toast Notification]\n    end\n\n    subgraph Config\n        N[ConfigPage] --> O[LayerSwitcher]\n        N --> P[KeyAssignmentPanel]\n        N --> Q[DeviceSelector]\n        O --> R[256 Layer List]\n        P --> S[Key Dropdown]\n    end\n```\n\n## Components and Interfaces\n\n### Dashboard: Device Type Indicator\n\n**Component: StateIndicatorPanel (enhanced)**\n- **Purpose:** Display device list with virtual/physical indicators\n- **Interfaces:**\n  - Props: `devices: DeviceEntry[]`\n  - DeviceEntry extended: `{ id, name, layout, isVirtual: boolean }`\n- **Dependencies:** `src/api/devices.ts` (fetchDevices)\n- **Reuses:** Existing StateIndicatorPanel structure, icon system\n- **Implementation:** Badge component with conditional icon/color based on `isVirtual` field\n\n### Devices: Enable/Disable Toggle\n\n**Component: DeviceRow (enhanced)**\n- **Purpose:** Display device with toggle switch instead of delete button\n- **Interfaces:**\n  - Props: `device: DeviceEntry`, `onToggle: (id: string, enabled: boolean) => void`\n  - DeviceEntry extended: `{ id, name, layout, enabled: boolean }`\n- **Dependencies:** `useDevices` hook with `setDeviceEnabled` function\n- **Reuses:** Existing device row layout, toggle switch component\n- **Implementation:**\n  - Toggle component replaces delete button\n  - Disabled state: opacity 0.5, \"(Disabled)\" badge\n  - State persisted to localStorage (or backend if available)\n\n**Hook: useDevices (enhanced)**\n- **Purpose:** Manage device list and enabled state\n- **Interfaces:**\n  - Returns: `devices: DeviceEntry[]`, `setDeviceEnabled(id, enabled): Promise<void>`\n- **Dependencies:** `src/api/devices.ts`\n- **Reuses:** Existing useDevices pattern\n- **Implementation:** Optimistic updates with localStorage fallback\n\n**Component: DeviceSelector (filtered)**\n- **Purpose:** Show only enabled devices in config page dropdown\n- **Interfaces:** Props: `devices: DeviceEntry[]`, `onSelect: (id) => void`\n- **Dependencies:** Filtered device list from useDevices\n- **Reuses:** Existing DeviceSelector component\n- **Implementation:** Filter `devices.filter(d => d.enabled !== false)` before rendering\n\n### Profiles: Inline Editing & Active Indicator\n\n**Component: ProfileCard (enhanced)**\n- **Purpose:** Display profile with inline editing and clear active state\n- **Interfaces:**\n  - Props: `profile: ProfileEntry`, `isActive: boolean`, `onUpdate: (profile) => void`, `onActivate: () => void`\n  - ProfileEntry: `{ name, description, file_path }`\n- **Dependencies:** `useProfiles` hook with `renameProfile`, `activateProfile` functions\n- **Reuses:** Existing ProfileCard layout, edit patterns\n- **Implementation:**\n  - Name/description: click to edit, blur to save (500ms debounce)\n  - Active state: 4px left border, background gradient, \"ACTIVE\" badge\n  - Inactive profiles: \"Activate\" button visible\n  - Active profile: No activation button\n\n**Component: Toast Notification**\n- **Purpose:** Show success message on profile activation\n- **Interfaces:** `showToast(message: string, duration?: number)`\n- **Dependencies:** Existing notification system or lightweight toast component\n- **Reuses:** Notification patterns from other parts of UI\n- **Implementation:** Top-right positioned, auto-dismiss 5s, check icon\n\n### Config: Navigation Sync\n\n**Implementation: React Router State**\n- **Purpose:** Pass selected profile from ProfilesPage to ConfigPage\n- **Interfaces:** URL query param: `?profile=<name>`\n- **Dependencies:** React Router's `useNavigate`, `useLocation`, `useSearchParams`\n- **Reuses:** Existing routing setup in App.tsx\n- **Implementation:**\n  - ProfilesPage: Navigate with `navigate('/config?profile=' + profileName)`\n  - ConfigPage: Read param with `useSearchParams()`, select profile\n  - Sidebar: Use `NavLink` active state for highlighting\n\n### Config: RPC Error Fix\n\n**Fix: useProfileConfig Hook**\n- **Purpose:** Correct WebSocket RPC payload format\n- **Root Cause:** Client sending wrong payload structure - server expects `{ content: object }`\n- **Dependencies:** `src/hooks/useProfileConfig.ts`, WebSocket client\n- **Implementation:**\n  - Fixed payload serialization to match server contract\n  - Added validation before sending\n  - Test coverage to prevent regression\n\n### Config: 256-Layer Display\n\n**Component: LayerSwitcher (refactored)**\n- **Purpose:** Display all 256 layers in scrollable vertical list\n- **Interfaces:**\n  - Props: `selectedLayer: number`, `onSelectLayer: (layer: number) => void`\n  - Layers: Base (0) + MD_00 through MD_FF (1-255)\n- **Dependencies:** Layer data from profile config\n- **Reuses:** Existing LayerSwitcher component structure\n- **Implementation:**\n  - Vertical layout: `max-height: 400px`, `overflow-y: scroll`\n  - Programmatic generation: `[\"Base\", ...Array.from({length: 256}, (_, i) => \"MD_\" + i.toString(16).toUpperCase().padStart(2, \"0\"))]`\n  - Search/filter input for quick navigation\n  - Selected layer highlighted\n\n### Config: Key Dropdown Population\n\n**Component: KeyAssignmentPanel (fixed)**\n- **Purpose:** Populate key selection dropdown with all available keys\n- **Root Cause:** Key list not imported or incomplete\n- **Dependencies:** `src/utils/keyCodeMapping.ts`\n- **Reuses:** Existing KeyAssignmentPanel modal\n- **Implementation:**\n  - Categories: Letters (A-Z), Numbers (0-9), Function (F1-F24), Modifiers (Shift/Ctrl/Alt/Meta), Navigation (Arrows/Home/End/PgUp/PgDn), Numpad (0-9/+/-/*/./Enter), Special (Tab/Enter/Backspace/Escape/Space/Caps)\n  - Dropdown shows grouped options with category headers\n  - Key codes match evdev/HID standard expected by daemon\n\n## Data Models\n\n### DeviceEntry (Extended)\n\n```typescript\ninterface DeviceEntry {\n  id: string;              // Existing: unique device identifier\n  name: string;            // Existing: device display name\n  layout?: string;         // Existing: keyboard layout\n  isVirtual: boolean;      // NEW: true if device name === \"keyrx\"\n  enabled: boolean;        // NEW: true if device is enabled (default: true)\n}\n```\n\n### ProfileEntry (Unchanged)\n\n```typescript\ninterface ProfileEntry {\n  name: string;           // Profile name (editable inline)\n  description: string;    // Profile description (editable inline)\n  file_path: string;      // .krx file path\n}\n```\n\n### LayerIdentifier (Extended Range)\n\n```typescript\ntype LayerIdentifier = \"Base\" | `MD_${string}`; // MD_00 through MD_FF (hex format)\n```\n\n### KeyCategory (New)\n\n```typescript\ninterface KeyCategory {\n  name: \"Letters\" | \"Numbers\" | \"Function\" | \"Modifiers\" | \"Navigation\" | \"Numpad\" | \"Special\";\n  keys: Array<{ code: number, label: string }>;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Device Enable/Disable Fails**\n   - **Handling:** Revert optimistic update, show error toast\n   - **User Impact:** \"Failed to update device. Please try again.\"\n\n2. **Profile Activation Fails**\n   - **Handling:** Keep previous profile active, show error toast\n   - **User Impact:** \"Failed to activate profile '{name}'. Error: {message}\"\n\n3. **Profile Rename Conflict**\n   - **Handling:** Revert name to previous, show error toast\n   - **User Impact:** \"Profile name '{name}' already exists.\"\n\n4. **RPC Payload Format Error**\n   - **Handling:** Validate payload before sending, log detailed error\n   - **User Impact:** \"Failed to save configuration. Invalid format.\"\n\n5. **Navigation Without Profile Context**\n   - **Handling:** Load default profile or show profile selector\n   - **User Impact:** Smooth navigation, no error shown\n\n6. **Key Dropdown Empty**\n   - **Handling:** Fallback to minimal key set (A-Z, 0-9) if full list unavailable\n   - **User Impact:** Reduced key selection but functional\n\n## Testing Strategy\n\n### Unit Testing\n\n**Components to Test:**\n- DeviceRow: Toggle functionality, disabled state styling\n- ProfileCard: Inline editing (name/description), save on blur, active indicator visibility\n- LayerSwitcher: Renders all 256 layers, scroll behavior, selection\n- KeyAssignmentPanel: Dropdown populated with keys, category grouping\n\n**Hooks to Test:**\n- useDevices: `setDeviceEnabled` updates state, localStorage persistence\n- useProfiles: `renameProfile` API call, `activateProfile` triggers notification\n- useProfileConfig: RPC payload format validation\n\n**Test Pattern:**\n```typescript\nimport { renderWithProviders } from 'tests/testUtils';\nimport { screen, fireEvent } from '@testing-library/react';\n\ntest('Device toggle changes enabled state', () => {\n  const mockOnToggle = jest.fn();\n  renderWithProviders(<DeviceRow device={mockDevice} onToggle={mockOnToggle} />);\n\n  const toggle = screen.getByRole('switch');\n  fireEvent.click(toggle);\n\n  expect(mockOnToggle).toHaveBeenCalledWith(mockDevice.id, false);\n});\n```\n\n### Integration Testing\n\n**Key Flows:**\n1. **Device Lifecycle:**\n   - List devices → Disable device → Verify grayed out → Re-enable → Verify active\n   - Disable device → Navigate to Config → Verify device not in selector\n\n2. **Profile Management:**\n   - Create profile → Edit name inline → Activate → Verify toast → Check active indicator\n   - Navigate from Profiles (file path link) → Config page → Verify sidebar highlighted\n\n3. **Configuration:**\n   - Open config → Select layer → Verify all 256 layers available\n   - Add key mapping → Open key dropdown → Verify all keys present\n\n### End-to-End Testing\n\n**User Scenarios:**\n1. **New User Discovers Virtual Device:**\n   - Open dashboard → See device list → Identify virtual device by icon/badge\n\n2. **User Disables Test Keyboard:**\n   - Go to Devices → Toggle off test device → Verify grayed out → Go to Config → Verify not in dropdown\n\n3. **User Creates and Activates Profile:**\n   - Create profile → Edit name inline → Activate → See success toast → Verify active badge\n\n4. **User Configures 256-Layer Mapping:**\n   - Open config → Scroll layer list → Select MD_FF → Add mapping → Save\n\n**E2E Test Implementation:**\n- Leverage existing E2E framework (Cypress/Playwright if available)\n- Mock backend responses for deterministic testing\n- Test across Chrome/Firefox/Safari\n\n## Implementation Notes\n\n### Breaking Changes\nNone - all changes are additive or frontend-only.\n\n### Performance Considerations\n- **256-layer list**: Virtual scrolling not required (smooth with native scroll)\n- **Key dropdown**: ~150 keys, grouped by category (no performance issues)\n- **Inline editing debounce**: 500ms prevents excessive API calls\n\n### Accessibility\n- Toggle switches: ARIA labels, keyboard accessible\n- Active profile indicator: High contrast border, screen reader announcement\n- Layer selection: Keyboard navigation (arrow keys)\n- Key dropdown: Type-ahead search support\n\n### Browser Compatibility\n- Target: Chrome/Firefox/Safari/Edge (latest 2 versions)\n- No modern JS features requiring polyfills\n- CSS features: Grid, Flexbox, Scroll (widely supported)\n\n## Future Enhancements\n\n1. **Device Groups**: Allow grouping multiple physical keyboards\n2. **Profile Templates**: Pre-built profiles for common use cases\n3. **Layer Visualization**: Show key mappings for each layer in matrix view\n4. **Key Binding Conflicts**: Highlight conflicting mappings across layers\n5. **Undo/Redo**: For config changes within a session\n",
  "fileStats": {
    "size": 15706,
    "lines": 402,
    "lastModified": "2026-01-21T21:53:48.156Z"
  },
  "comments": []
}