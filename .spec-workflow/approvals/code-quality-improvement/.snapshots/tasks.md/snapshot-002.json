{
  "id": "snapshot_1764729445143_i8sfusfda",
  "approvalId": "approval_1764717707411_oku6o1l5u",
  "approvalTitle": "Code Quality Improvement - Tasks Document",
  "version": 2,
  "timestamp": "2025-12-03T02:37:25.143Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document\n\n## Phase 1: Rust Testability\n\n- [x] 1. Create RuntimeContext to replace global RUNTIME_SLOT\n  - Files: core/src/scripting/context.rs (new), core/src/scripting/runtime.rs (modify)\n  - Extract runtime state into injectable struct, remove global static\n  - _Leverage: existing runtime.rs patterns_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust systems engineer | Task: Create RuntimeContext struct containing Engine, pending_ops Vec, and Registry. Remove RUNTIME_SLOT global from runtime.rs. Pass context as parameter instead of accessing global | Restrictions: ≤200 lines for context.rs; update all callers; maintain thread safety via Arc<Mutex> if needed | _Leverage: runtime.rs | _Requirements: 1 | Success: Tests can run in parallel without #[serial] attribute._\n\n- [x] 2. Create BypassController to replace global bypass state\n  - Files: core/src/drivers/bypass.rs (new), core/src/drivers/emergency_exit.rs (modify)\n  - Extract bypass mode into injectable component\n  - _Leverage: existing emergency_exit.rs_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust systems engineer | Task: Create BypassController struct with AtomicBool and optional callback. Remove BYPASS_MODE and BYPASS_CALLBACK globals. Inject controller into engine | Restrictions: ≤80 lines; maintain atomic operations; backward compatible API | _Leverage: emergency_exit.rs | _Requirements: 1 | Success: Bypass mode testable in isolation._\n\n- [x] 3. Make FFI callbacks injectable\n  - Files: core/src/ffi/exports.rs (modify), core/src/ffi/callbacks.rs (new)\n  - Extract callback holders into injectable registry\n  - _Leverage: existing exports.rs patterns_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust FFI engineer | Task: Create CallbackRegistry struct holding discovery and state callbacks. Replace static OnceLock with injectable registry. Pass registry to FFI init function | Restrictions: ≤100 lines; maintain C ABI compatibility | _Leverage: exports.rs | _Requirements: 1 | Success: FFI callbacks mockable in tests._\n\n- [x] 4. Add engine dependency traits\n  - Files: core/src/traits/state.rs (new), core/src/engine/advanced.rs (modify)\n  - Create KeyStateProvider, ModifierProvider, LayerProvider traits\n  - _Leverage: existing traits/mod.rs patterns_\n  - _Requirements: 9_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust architect | Task: Create traits: KeyStateProvider (is_pressed, press, release), ModifierProvider (is_active, activate, deactivate), LayerProvider (active_layer, push, pop). Make AdvancedEngine generic over these traits | Restrictions: ≤150 lines; implement traits for existing concrete types | _Leverage: traits/mod.rs | _Requirements: 9 | Success: Engine accepts mock state providers._\n\n## Phase 2: Rust Complexity Reduction\n\n- [x] 5. Split process_event_traced into sub-functions\n  - Files: core/src/engine/processing.rs (new), core/src/engine/advanced.rs (modify)\n  - Extract 5 focused functions from 98-line function\n  - _Leverage: existing advanced.rs_\n  - _Requirements: 5_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust refactoring engineer | Task: Split process_event_traced into: validate_and_check_safe_mode(), update_key_state(), resolve_decision(), apply_decision(), trace_event(). Each ≤50 lines. Main function ≤20 lines orchestrating calls | Restrictions: Maintain exact behavior; add unit tests for each sub-function | _Leverage: advanced.rs | _Requirements: 5 | Success: All sub-functions ≤50 lines with tests._\n\n- [x] 6. Split run.rs (713 lines)\n  - Files: core/src/cli/commands/run.rs (modify), run_builder.rs (new), run_recorder.rs (new), run_tracer.rs (new)\n  - Extract builder, recorder, tracer into separate modules\n  - _Leverage: existing run.rs_\n  - _Requirements: 6_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust modularization engineer | Task: Split run.rs into: run.rs (RunCommand, ≤200 lines), run_builder.rs (RuntimeBuilder, ≤200 lines), run_recorder.rs (RecordingConfig, ≤150 lines), run_tracer.rs (TracingConfig, ≤150 lines) | Restrictions: Each file ≤500 lines; maintain public API | _Leverage: run.rs | _Requirements: 6 | Success: All files ≤500 lines._\n\n- [x] 7. Split discover.rs (712 lines)\n  - Files: core/src/cli/commands/discover.rs (modify), discover_session.rs (new), discover_validation.rs (new)\n  - Extract session management and validation\n  - _Leverage: existing discover.rs_\n  - _Requirements: 6_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust modularization engineer | Task: Split discover.rs into: discover.rs (DiscoverCommand, ≤200 lines), discover_session.rs (DiscoverySession state machine, ≤250 lines), discover_validation.rs (validation logic, ≤200 lines) | Restrictions: Each file ≤500 lines; clear module boundaries | _Leverage: discover.rs | _Requirements: 6 | Success: All files ≤500 lines._\n\n- [x] 8. Split runtime.rs (683 lines)\n  - Files: core/src/scripting/runtime.rs (modify), pending_ops.rs (new), registry_sync.rs (new)\n  - Extract pending operations and registry sync\n  - _Leverage: existing runtime.rs_\n  - _Requirements: 6_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust modularization engineer | Task: Split runtime.rs into: runtime.rs (RhaiRuntime core, ≤250 lines), pending_ops.rs (PendingOp handling, ≤200 lines), registry_sync.rs (Registry synchronization, ≤200 lines) | Restrictions: Each file ≤500 lines | _Leverage: runtime.rs | _Requirements: 6 | Success: All files ≤500 lines._\n\n## Phase 3: Rust DRY\n\n- [x] 9. Unify layer action handlers\n  - Files: core/src/engine/layer_actions.rs (new), core/src/engine/decision_engine.rs (modify)\n  - Merge handle_layer_action and execute_layer_action\n  - _Leverage: existing decision_engine.rs_\n  - _Requirements: 8_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust refactoring engineer | Task: Create apply_layer_action() taking optional event context. Implement handle_layer_action and execute_layer_action as thin wrappers. Remove 95% duplicate code | Restrictions: ≤120 lines; backward compatible; add tests | _Leverage: decision_engine.rs | _Requirements: 8 | Success: Single implementation for layer actions._\n\n- [x] 10. Extract error handling helper for pending ops\n  - Files: core/src/scripting/pending_ops.rs (modify)\n  - Create apply_op helper for repeated pattern\n  - _Leverage: existing runtime.rs patterns_\n  - _Requirements: 8_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust engineer | Task: Create apply_op<F, T>() helper that executes operation and logs errors. Replace 12 repetitions of if let Err pattern with helper calls | Restrictions: ≤30 lines for helper; maintain logging behavior | _Leverage: pending_ops.rs | _Requirements: 8 | Success: Error pattern used once, called 12 times._\n\n## Phase 4: Flutter Testability\n\n- [x] 11. Refactor EditorPage for constructor injection\n  - Files: ui/lib/pages/editor_page.dart (modify)\n  - Accept required services via constructor, remove nullable fields\n  - _Leverage: existing editor_page.dart_\n  - _Requirements: 2_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter engineer | Task: Change EditorPage to accept required EngineService and MappingRepository via constructor. Remove nullable _engine field. Remove Provider.of in initState. Update instantiation sites | Restrictions: ≤50 lines changed; maintain functionality | _Leverage: editor_page.dart | _Requirements: 2 | Success: EditorPage testable with mock services._\n\n- [x] 12. Refactor ConsolePage for constructor injection\n  - Files: ui/lib/pages/console.dart (modify)\n  - Accept required services via constructor\n  - _Leverage: existing console.dart_\n  - _Requirements: 2_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter engineer | Task: Change ConsolePage to accept required EngineService via constructor. Remove nullable field and Provider.of in initState | Restrictions: ≤40 lines changed | _Leverage: console.dart | _Requirements: 2 | Success: ConsolePage testable with mock services._\n\n- [x] 13. Refactor DebuggerPage for constructor injection\n  - Files: ui/lib/pages/debugger_page.dart (modify)\n  - Accept required services via constructor\n  - _Leverage: existing debugger_page.dart_\n  - _Requirements: 2_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter engineer | Task: Change DebuggerPage to accept required EngineService and state Stream via constructor. Remove nullable fields and Provider.of in initState | Restrictions: ≤40 lines changed | _Leverage: debugger_page.dart | _Requirements: 2 | Success: DebuggerPage testable with mock services._\n\n- [x] 14. Refactor TrainingScreen for constructor injection\n  - Files: ui/lib/pages/training_screen.dart (modify)\n  - Accept required services via constructor\n  - _Leverage: existing training_screen.dart_\n  - _Requirements: 2_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter engineer | Task: Change TrainingScreen to accept required AudioService via constructor. Remove nullable fields and Provider.of in initState | Restrictions: ≤40 lines changed | _Leverage: training_screen.dart | _Requirements: 2 | Success: TrainingScreen testable with mock services._\n\n## Phase 5: Flutter SSOT\n\n- [x] 15. Create MappingRepository\n  - Files: ui/lib/repositories/mapping_repository.dart (new)\n  - Single source of truth for key mappings\n  - _Leverage: existing editor_page.dart mapping patterns_\n  - _Requirements: 3_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter architect | Task: Create MappingRepository extending ChangeNotifier with: _mappings Map, _combos List, _tapHolds List. Add CRUD methods, generateScript(). Register in ServiceRegistry | Restrictions: ≤120 lines; immutable getters | _Leverage: editor_page.dart | _Requirements: 3 | Success: Single source for all mapping data._\n\n- [x] 16. Consolidate layer state in AppState\n  - Files: ui/lib/state/app_state.dart (modify), ui/lib/pages/editor_page.dart (modify)\n  - Remove duplicate layer state from EditorPage\n  - _Leverage: existing app_state.dart_\n  - _Requirements: 3_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter state engineer | Task: Ensure AppState has definitive layer list with add/remove/setActive methods. Remove _layers from EditorPage. Use context.watch<AppState>().layers in build | Restrictions: ≤60 lines changed total | _Leverage: app_state.dart | _Requirements: 3 | Success: Layers stored in one place only._\n\n- [x] 17. Unify mapping models between editors\n  - Files: ui/lib/pages/editor_page.dart (modify), ui/lib/pages/visual_editor_page.dart (modify)\n  - Both editors use MappingRepository\n  - _Leverage: MappingRepository from task 15_\n  - _Requirements: 3_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter engineer | Task: Modify EditorPage and VisualEditorPage to use shared MappingRepository instead of local state. Remove local _mappings fields | Restrictions: ≤80 lines changed total; switching editors preserves data | _Leverage: mapping_repository.dart | _Requirements: 3 | Success: Both editors share same mapping data._\n\n## Phase 6: Flutter Complexity Reduction\n\n- [x] 18. Extract MappingValidator service\n  - Files: ui/lib/services/mapping_validator.dart (new), ui/lib/pages/editor_page.dart (modify)\n  - Move validation logic out of EditorPage\n  - _Leverage: existing editor_page.dart validation code_\n  - _Requirements: 7_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter service engineer | Task: Create MappingValidator with validate(fromKey, mapping) returning ValidationResult. Move all validation from EditorPage._applyMapping to validator. EditorPage calls validator | Restrictions: ≤80 lines; testable without UI | _Leverage: editor_page.dart | _Requirements: 7 | Success: Validation logic in isolated service._\n\n- [x] 19. Extract ConsoleParser service\n  - Files: ui/lib/services/console_parser.dart (new), ui/lib/pages/console.dart (modify)\n  - Move parsing/classification logic out of ConsolePage\n  - _Leverage: existing console.dart parsing code_\n  - _Requirements: 7_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter service engineer | Task: Create ConsoleParser with classify(text) returning ConsoleEntryType, needsInitButton(text) returning bool. Move parsing from _buildEntry to parser | Restrictions: ≤60 lines; pure functions | _Leverage: console.dart | _Requirements: 7 | Success: Parsing logic in isolated service._\n\n- [x] 20. Extract ScriptFileService\n  - Files: ui/lib/services/script_file_service.dart (new), ui/lib/pages/editor_page.dart (modify)\n  - Move file I/O out of EditorPage\n  - _Leverage: existing editor_page.dart file operations_\n  - _Requirements: 7_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter service engineer | Task: Create ScriptFileService with saveScript(path, content) and loadScript(path). Move file operations from EditorPage._saveScript. Add to ServiceRegistry | Restrictions: ≤60 lines; async methods | _Leverage: editor_page.dart | _Requirements: 7 | Success: File I/O in isolated service._\n\n- [x] 21. Split exports.rs (635 lines)\n  - Files: core/src/ffi/exports.rs (modify), exports_device.rs (new), exports_session.rs (new), exports_engine.rs (new)\n  - Split FFI exports by domain\n  - _Leverage: existing exports.rs_\n  - _Requirements: 6_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust modularization engineer | Task: Split exports.rs into: exports.rs (init/common, ≤200 lines), exports_device.rs (device functions, ≤150 lines), exports_session.rs (session/replay, ≤150 lines), exports_engine.rs (engine control, ≤150 lines) | Restrictions: Each ≤500 lines; re-export from exports.rs | _Leverage: exports.rs | _Requirements: 6 | Success: All files ≤500 lines._\n\n## Phase 7: Flutter DRY\n\n- [x] 22. Create StreamSubscriber mixin\n  - Files: ui/lib/mixins/stream_subscriber.dart (new)\n  - Extract repeated stream subscription pattern\n  - _Leverage: existing debugger_page.dart, training_screen.dart patterns_\n  - _Requirements: 8_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter engineer | Task: Create StreamSubscriber mixin with subscribe<S>() method handling mounted checks, error handling, and auto-dispose. Track subscriptions in list, cancel all in dispose | Restrictions: ≤50 lines; generic over stream type | _Leverage: debugger_page.dart | _Requirements: 8 | Success: Stream subscription pattern in one place._\n\n- [x] 23. Apply StreamSubscriber mixin to pages\n  - Files: ui/lib/pages/debugger_page.dart (modify), ui/lib/pages/training_screen.dart (modify)\n  - Replace manual subscription code with mixin\n  - _Leverage: StreamSubscriber from task 22_\n  - _Requirements: 8_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter engineer | Task: Add StreamSubscriber mixin to DebuggerPage and TrainingScreen. Replace manual StreamSubscription fields and dispose logic with mixin subscribe() calls | Restrictions: ≤30 lines changed per file; maintain behavior | _Leverage: stream_subscriber.dart | _Requirements: 8 | Success: Subscription boilerplate removed._\n\n## Phase 8: Verification\n\n- [x] 24. Add unit tests for extracted Rust functions\n  - Files: core/src/engine/processing.rs (add tests), core/src/engine/layer_actions.rs (add tests)\n  - Test each new sub-function\n  - _Leverage: existing test patterns_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust test engineer | Task: Add #[cfg(test)] module to processing.rs and layer_actions.rs. Write unit tests for each extracted function. Cover happy path and error cases | Restrictions: ≥80% coverage for new code | _Leverage: existing tests | _Requirements: All | Success: All new functions have tests._\n\n- [x] 25. Add widget tests for refactored Flutter pages\n  - Files: ui/test/pages/editor_page_test.dart (new), ui/test/pages/console_test.dart (new)\n  - Test pages with mock services\n  - _Leverage: Flutter test patterns_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter test engineer | Task: Create widget tests for EditorPage and ConsolePage using mock services. Test key user flows: add mapping, validate error, execute command | Restrictions: ≥80% coverage; use mockito or manual mocks | _Leverage: Flutter testing | _Requirements: All | Success: Pages testable with mocks._\n\n- [x] 26. Verify parallel test execution\n  - Files: N/A (CI verification)\n  - Confirm tests run in parallel without failures\n  - _Leverage: cargo nextest_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA engineer | Task: Remove all #[serial] attributes from Rust tests. Run cargo nextest run without --test-threads=1. Verify no race conditions or flaky tests | Restrictions: All tests must pass in parallel | _Leverage: nextest | _Requirements: 1 | Success: Tests pass with parallel execution._\n\n- [x] 27. Verify no performance regression\n  - Files: N/A (benchmark verification)\n  - Run benchmarks before/after, compare\n  - _Leverage: existing benches/_\n  - _Requirements: All NFRs_\n  - _Prompt: Implement the task for spec code-quality-improvement, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Performance engineer | Task: Run cargo bench before starting refactoring (save baseline). Run again after completion. Verify no regression >5% on any metric | Restrictions: Document any performance changes | _Leverage: benches/ | _Requirements: All | Success: Performance within 5% of baseline._\n",
  "fileStats": {
    "size": 20164,
    "lines": 207,
    "lastModified": "2025-12-03T02:03:39.054Z"
  },
  "comments": []
}