{
  "id": "snapshot_1766076159617_991zsvi4u",
  "approvalId": "approval_1766076093653_eu6lur7mr",
  "approvalTitle": "Tasks for Unified FFI/IPC Codegen",
  "version": 2,
  "timestamp": "2025-12-18T16:42:39.617Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document\n\n## 1. Core Generator Infrastructure\n\n- [ ] 1. Create `ipc_client_gen.rs` module structure\n  - File: `core/tools/generate_dart_bindings/src/ipc_client_gen.rs`\n  - Create the new module file and register it in `lib.rs`\n  - Implement basic structs for holding generation state\n  - _Leverage: core/tools/generate_dart_bindings/src/bindings_gen.rs_\n  - _Requirements: 1.1, Requirement 1 (Non-Functional)_\n  - _Prompt: Role: Rust Developer specializing in code generation tools | Task: Create the `ipc_client_gen.rs` module structure and register it in `lib.rs`, implementing basic structs for generation state following requirement 1.1 and non-functional requirement 1, leveraging patterns from `bindings_gen.rs` | Restrictions: Follow existing module patterns, ensure clean separation of concerns, no logic implementation yet | Success: Module compiles, struct definitions match the needs of the generator, registered in lib.rs_\n\n- [ ] 2. Implement `IpcClientGenerator` class generation logic\n  - File: `core/tools/generate_dart_bindings/src/ipc_client_gen.rs`\n  - Implement function to generate the `DaemonClient` class shell\n  - Add imports (dart:async, dart:convert, models.dart)\n  - _Leverage: core/tools/generate_dart_bindings/src/templates.rs_\n  - _Requirements: 3.1, 2.1_\n  - _Prompt: Role: Rust Developer with expertise in template-based code generation | Task: Implement the `DaemonClient` class shell generation logic in `ipc_client_gen.rs`, adding necessary imports including models, following requirements 3.1 and 2.1 and leveraging `templates.rs` | Restrictions: Must use existing template system, ensure correct imports for Dart, class must be extensible | Success: Generates valid Dart class code with correct imports and constructor_\n\n## 2. Method and Event Generation\n\n- [ ] 3. Implement IPC Method generation\n  - File: `core/tools/generate_dart_bindings/src/ipc_client_gen.rs`\n  - Map `FfiContract` functions to Dart `Future<T>` methods\n  - Generate code to serialize args -> `sendRequest` -> deserialize result\n  - Handle `void` returns and custom model returns\n  - _Leverage: core/tools/generate_dart_bindings/src/models_gen.rs (for type mapping)_\n  - _Requirements: 1.2, 3.2, 3.3, 3.4_\n  - _Prompt: Role: Rust Developer specializing in FFI/IPC code generation | Task: Implement IPC method generation logic mapping `FfiContract` functions to Dart `Future<T>` methods, handling serialization/deserialization and return types following requirements 1.2, 3.2, 3.3, and 3.4, leveraging `models_gen.rs` type mapping | Restrictions: Must correctly map all supported FFI types to JSON-compatible Dart types, ensure type safety in generated code | Success: Generates correct Dart methods that call `sendRequest` with properly serialized parameters and return types_\n\n- [ ] 4. Implement IPC Event generation\n  - File: `core/tools/generate_dart_bindings/src/ipc_client_gen.rs`\n  - Map `FfiContract` events to Dart `Stream<T>` getters\n  - Generate code to expose stream from `DaemonService`\n  - _Requirements: 1.3, 4.1, 4.2_\n  - _Prompt: Role: Rust Developer with expertise in event-driven systems and code generation | Task: Implement IPC event generation logic mapping `FfiContract` events to Dart `Stream<T>` getters following requirements 1.3, 4.1, and 4.2 | Restrictions: Must ensure streams are properly typed, reuse model classes for event payloads | Success: Generates correct Dart getters returning typed Streams for all contract events_\n\n## 3. Integration & Tooling\n\n- [ ] 5. Update `pipeline.rs` to include IPC generation\n  - File: `core/tools/generate_dart_bindings/src/pipeline.rs`\n  - Update `generate_code` to call `ipc_client_gen::generate`\n  - Add `generate_ipc_client` function to pipeline\n  - Write output to `ui/lib/services/generated/ipc_client.dart`\n  - _Leverage: core/tools/generate_dart_bindings/src/writer.rs_\n  - _Requirements: 1.1, 1.4_\n  - _Prompt: Role: Rust Developer specializing in CLI tool architecture | Task: Update `pipeline.rs` to integrate `ipc_client_gen`, adding `generate_ipc_client` function and writing output to `ui/lib/services/generated/ipc_client.dart` following requirements 1.1 and 1.4 | Restrictions: Maintain backward compatibility with FFI generation, ensure clean error handling during file writing | Success: Pipeline successfully invokes IPC generator and writes the output file to the correct location_\n\n- [ ] 6. Update `DaemonService` to support generated clients\n  - File: `ui/lib/services/daemon_service.dart`\n  - Ensure `sendRequest` generic signature matches generated code expectations\n  - Expose raw `notification` stream if not already available\n  - _Requirements: Requirement 3 (Design)_\n  - _Prompt: Role: Dart/Flutter Developer with expertise in asynchronous programming and services | Task: Refactor `DaemonService` to support generated clients, ensuring `sendRequest` signature matches expectations and exposing raw notification stream following Design Requirement 3 | Restrictions: Do not break existing manual usages yet, ensure backward compatibility | Success: DaemonService provides the necessary public API for the generated client to function_\n\n## 4. Validation\n\n- [ ] 7. Verify with `consistency_check`\n  - Run the generator\n  - Verify `ui/lib/services/generated/ipc_client.dart` exists and is valid Dart\n  - Run `dart analyze`\n  - _Requirements: Non-Functional (Clean Output)_\n  - _Prompt: Role: QA Engineer / Tooling Specialist | Task: Verify the full generation pipeline by running the tool, checking for file existence, and running `dart analyze` on the output following Non-Functional requirements | Restrictions: Must pass without any analyzer errors or warnings | Success: Generator runs without error, Dart code is valid and type-safe_\n",
  "fileStats": {
    "size": 5745,
    "lines": 65,
    "lastModified": "2025-12-18T16:41:28.564Z"
  },
  "comments": []
}