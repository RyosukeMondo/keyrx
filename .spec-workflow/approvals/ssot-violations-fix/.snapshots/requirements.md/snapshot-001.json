{
  "id": "snapshot_1766250094883_xmruiunwz",
  "approvalId": "approval_1766250094714_7x30hqtj8",
  "approvalTitle": "Requirements: SSOT Violations Fix",
  "version": 1,
  "timestamp": "2025-12-20T17:01:34.883Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThis specification addresses the remaining Single Source of Truth (SSOT) violations in the KeyRX codebase. SSOT violations occur when classes, business logic, or interfaces are duplicated between the UI and core_logic layers, violating the principle that each piece of knowledge should exist in exactly one location. These violations create maintenance burden, potential inconsistencies, and architectural debt.\n\nThe remaining 37 violations break down as:\n- **3 duplicate classes** (LogEntry, DeviceRegistryService, DeviceRegistryServiceImpl)\n- **32 business logic in UI violations** (direct FFI bridge usage)\n- **2 interface inconsistency violations**\n\nThis work builds on previous SSOT cleanup that successfully eliminated 19 violations (34% reduction from 56 to 37).\n\n## Alignment with Product Vision\n\nThis refactoring supports the architectural goal of maintaining clean separation between UI and core logic layers, ensuring:\n- **Maintainability**: Changes need to happen in one place only\n- **Testability**: Core logic can be tested independently of UI\n- **Reusability**: Core logic can be shared across Flutter UI and CLI tools\n- **Platform Independence**: Core logic remains pure Dart without Flutter dependencies\n\n## Requirements\n\n### Requirement 1: Eliminate Duplicate Classes\n\n**User Story:** As a developer, I want duplicate classes consolidated into core_logic, so that I maintain a single source of truth for data structures\n\n#### Acceptance Criteria\n\n1. WHEN LogEntry class exists in both UI and core_logic THEN the UI SHALL import from core_logic OR rename its class to avoid conflict\n2. WHEN DeviceRegistryService exists in both layers THEN the UI version SHALL be renamed or refactored to clearly indicate its role as a UI adapter\n3. WHEN DeviceRegistryServiceImpl exists in both layers THEN duplicate implementation SHALL be eliminated while preserving UI-specific functionality\n\n### Requirement 2: Move Business Logic to Core Layer\n\n**User Story:** As a developer, I want FFI bridge usage isolated in core_logic services, so that UI components remain platform-independent and testable\n\n#### Acceptance Criteria\n\n1. WHEN UI code directly calls FFI bridge methods THEN it SHALL use core_logic service wrappers instead\n2. WHEN device_stream_provider uses FFI bridge THEN it SHALL delegate to core_logic DeviceService\n3. WHEN providers_setup uses FFI bridge THEN it SHALL use dependency injection with core_logic services\n4. WHEN keyflow_repository uses FFI bridge THEN it SHALL delegate to appropriate core_logic services\n5. WHEN FlowValidator contains business logic THEN it SHALL move to core_logic OR be clearly identified as UI-specific validation\n6. WHEN MappingValidator contains business logic THEN it SHALL move to core_logic OR be clearly identified as UI-specific validation\n\n### Requirement 3: Fix Interface Inconsistencies\n\n**User Story:** As a developer, I want service interfaces to be consistent across implementations, so that services are properly polymorphic and testable\n\n#### Acceptance Criteria\n\n1. WHEN a service has FFI and web implementations THEN both SHALL implement the same interface with matching signatures\n2. WHEN interface inconsistencies exist THEN they SHALL be resolved by aligning method signatures\n3. IF platform-specific methods are needed THEN they SHALL be documented as extensions with clear reasoning\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Source of Truth**: Each class exists in exactly one location\n- **Layer Separation**: UI depends on core_logic, never the reverse\n- **Platform Independence**: Core logic contains no Flutter dependencies\n- **Service Wrappers**: All FFI access goes through well-defined service interfaces\n\n### Performance\n- Refactoring SHALL NOT degrade runtime performance\n- Service indirection SHALL be minimal (inline or simple delegation)\n\n### Compatibility\n- Existing functionality SHALL be preserved\n- UI behavior SHALL remain unchanged from user perspective\n- Breaking changes SHALL be avoided in public APIs\n\n### Testing\n- Core logic services SHALL have unit tests\n- UI components SHALL be testable with mocked services\n- Integration tests SHALL verify UI-to-core communication\n",
  "fileStats": {
    "size": 4249,
    "lines": 78,
    "lastModified": "2025-12-20T16:57:40.840Z"
  },
  "comments": []
}