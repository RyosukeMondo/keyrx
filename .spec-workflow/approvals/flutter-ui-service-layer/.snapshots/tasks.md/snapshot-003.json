{
  "id": "snapshot_1764564961752_f7rhoj71a",
  "approvalId": "approval_1764548950500_0t2zr5pto",
  "approvalTitle": "Update tasks for flutter-ui-service-layer with FFI wiring and UI refactors",
  "version": 3,
  "timestamp": "2025-12-01T04:56:01.752Z",
  "trigger": "approved",
  "status": "pending",
  "content": "- [x] 1. Define service contracts (Dart)\n  - File: ui/lib/services/audio_service.dart, ui/lib/services/permission_service.dart, ui/lib/services/error_translator.dart\n  - Define interfaces for AudioService, PermissionService, ErrorTranslator (enums, signatures, UserMessage model).\n  - Purpose: Establish DI-ready contracts and typed results.\n  - _Leverage: ui/lib/ffi/bridge.dart (for types), permission_handler package_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec flutter-ui-service-layer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Dart architect | Task: Define AudioService/PermissionService/ErrorTranslator interfaces and data models following requirement 1, with enums for permission and error categories | Restrictions: No concrete FFI calls here, interface-only; keep files under ui/lib/services | _Leverage: ui/lib/ffi, permission_handler | _Requirements: 1 | Success: Interfaces compile, enums cover cases (granted/denied/permanentlyDenied/restricted; info/warning/error), no direct FFI calls in interfaces.\n\n- [x] 2. Implement real services\n  - File: ui/lib/services/audio_service_impl.dart, ui/lib/services/permission_service_impl.dart, ui/lib/services/error_translator_impl.dart\n  - Implement interfaces using FFI bridge and permission_handler; translate Rust errors to UserMessage.\n  - Purpose: Concrete, observable services wrapping FFI.\n  - _Leverage: ui/lib/ffi/bridge.dart, permission_handler, tracing/log utilities_\n  - _Requirements: 1, 3_\n  - _Prompt: Implement the task for spec flutter-ui-service-layer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter engineer with FFI experience | Task: Implement concrete AudioService/PermissionService/ErrorTranslator with telemetry hooks; start/stop/set BPM, stream subscription, permission requests; map engine errors to user-friendly messages | Restrictions: No UI imports; log trace events for start/stop/permission/stream; handle dispose; no globals | _Leverage: ffi bridge, permission_handler | _Requirements: 1,3 | Success: Services usable via interfaces, logs emitted, errors translated, stream cancel safe.\n\n- [x] 3. Add service registry/provider\n  - File: ui/lib/services/service_registry.dart\n  - Provide factory for real vs. mock services; simple DI entry point.\n  - Purpose: Allow injection/testing without globals.\n  - _Leverage: new service interfaces and impls_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec flutter-ui-service-layer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Software architect | Task: Add ServiceRegistry that wires real PermissionService/AudioService/ErrorTranslator and allows overriding with mocks for tests | Restrictions: No singletons with implicit globals; pass registry down; keep constructors cheap | _Requirements: 1 | Success: Screens can obtain services from registry; tests can supply mocks easily.\n\n- [x] 4. Shared UI widgets and styles\n  - File: ui/lib/ui/widgets/app_error_dialog.dart, ui/lib/ui/widgets/loading_overlay.dart, ui/lib/ui/styles/surfaces.dart\n  - Implement standardized error dialog, loading overlay, and surface container helper.\n  - Purpose: DRY/KISS for presentation, consistent UX.\n  - _Leverage: existing theme, widgets patterns in ui/lib/widgets_\n  - _Requirements: 2_\n  - _Prompt: Implement the task for spec flutter-ui-service-layer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter UI engineer | Task: Build reusable error dialog, loading overlay, and surface style helper per requirement 2 | Restrictions: Stateless where possible; theming consistent; no business logic | _Requirements: 2 | Success: Widgets reusable across screens; compile without screen dependencies.\n\n- [x] 5. Wire services into screens\n  - File: ui/lib/pages/training_screen.dart (and related screens if present)\n  - Replace direct FFI calls with service layer; use shared widgets for errors/loading.\n  - Purpose: Enforce new architecture and UX consistency.\n  - _Leverage: new services, shared widgets_\n  - _Requirements: 1,2,3_\n  - _Prompt: Implement the task for spec flutter-ui-service-layer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter integrator | Task: Refactor training (and relevant) screens to use PermissionService/AudioService/ErrorTranslator and shared widgets; add telemetry hooks usage | Restrictions: No raw FFI imports in screens; keep stateful logic lean; handle dispose of streams | _Requirements: 1,2,3 | Success: Screens compile, use services, show standardized dialogs/overlays, telemetry fired on start/stop/permission/stream.\n\n- [x] 6. Tests (unit + widget)\n  - File: ui/test/services/audio_service_test.dart; ui/test/widgets/shared_widgets_test.dart (or similar)\n  - Add unit tests for services with mocks; widget tests for shared widgets and service-wired screen flows.\n  - Purpose: Ensure testability and regression safety.\n  - _Leverage: mocktail or existing test utils_\n  - _Requirements: 1,2,3_\n  - _Prompt: Implement the task for spec flutter-ui-service-layer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter QA | Task: Write unit tests for services (permission outcomes, start/stop errors, stream) and widget tests for dialogs/overlays/service-wired screen paths | Restrictions: Use mocks for FFI/permissions; no network; ensure dispose coverage | _Requirements: 1,2,3 | Success: Tests pass, cover success/failure paths, no leaks.\n\n- [x] 7. Wire AudioService to real FFI start/stop/BPM + stream\n  - File: ui/lib/services/audio_service_impl.dart, ui/lib/services/service_registry.dart, ui/lib/ffi/bridge.dart\n  - Replace TODO stubs with real bridge calls (init/start/stop/setBpm) and hook classification stream into registry wiring; allow bridge injection to avoid hard singleton reliance.\n  - Purpose: Make the service actually control the engine and emit live classifications.\n  - _Leverage: ffi bridge, ErrorTranslator, PermissionService_\n  - _Requirements: 1,3_\n  - _Prompt: Implement the task for spec flutter-ui-service-layer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter engineer with FFI experience | Task: Implement real FFI calls for audio lifecycle and subscribe to the engine’s classification stream; ensure bridge is injectable (no hard singleton) | Restrictions: Remove TODOs; translate errors; ensure stream cancel safety | _Requirements: 1,3 | Success: start/stop/setBpm call FFI successfully, classificationStream emits from engine, bridge can be injected for tests (no mandatory global).\n\n- [x] 8. Remove direct bridge usage from UI/AppState and other screens\n  - File: ui/lib/state/app_state.dart, ui/lib/pages/*.dart (editor/debugger/console)\n  - Route initialization/loading through services or a lightweight engine context; eliminate direct KeyrxBridge references in UI.\n  - Purpose: Enforce UI → services → FFI layering and remove global state in UI.\n  - _Leverage: ServiceRegistry, AudioService, PermissionService, ErrorTranslator_\n  - _Requirements: 1,2,3_\n  - _Prompt: Implement the task for spec flutter-ui-service-layer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter integrator | Task: Refactor AppState and remaining screens to use injected services instead of KeyrxBridge; apply shared widgets for errors/loading where applicable | Restrictions: No raw FFI imports/singletons in UI; ensure dispose/stream cleanup | _Requirements: 1,2,3 | Success: UI files compile without KeyrxBridge imports; services drive engine state; shared widgets used for errors/loading.\n\n- [x] 9. Extend tests for real service + UI integration\n  - File: ui/test/services/audio_service_test.dart, ui/test/pages/* (add), ui/test/widgets/shared_widgets_test.dart\n  - Add tests covering real FFI call paths via injected fake bridge and classification stream; cover refactored screens for error/loading states.\n  - Purpose: Validate new wiring and prevent regressions.\n  - _Leverage: mocktail/fake bridge, ServiceRegistry overrides, shared widgets_\n  - _Requirements: 1,2,3_\n  - _Prompt: Implement the task for spec flutter-ui-service-layer, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter QA | Task: Add tests for AudioServiceImpl with fake bridge (start/stop/BPM success/failure, stream delivery) and widget tests for refactored screens using ServiceRegistry overrides; verify shared widgets behavior | Restrictions: No network; use fakes/mocks; ensure disposal and stream cancel covered | _Requirements: 1,2,3 | Success: Tests pass and cover real call paths and UI flows, including error/loading states.\n",
  "fileStats": {
    "size": 8810,
    "lines": 72,
    "lastModified": "2025-12-01T00:58:22.030Z"
  },
  "comments": []
}