{
  "id": "snapshot_1764538389669_9uic5uafu",
  "approvalId": "approval_1764538139826_2aim4ii24",
  "approvalTitle": "Approve requirements for flutter-ui-service-layer",
  "version": 2,
  "timestamp": "2025-11-30T21:33:09.669Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nFlutter-facing improvements to decouple UI from FFI, provide reusable presentation primitives, and surface user-friendly errors. This phase introduces a Dart service layer (audio/permission/error), shared widgets for dialogs/loading/containers, and baseline telemetry to make the UI observable and testable.\n\n## Alignment with Product Vision\n\nDelivers “CLI first, GUI later” parity by keeping UI thin over the already-capable Rust engine, while making the GUI debuggable and safe (no global state, explicit services). Improves visibility (“Visual > Abstract”) via reusable UI primitives and structured error handling that mirrors engine guarantees.\n\n## Requirements\n\n### Requirement 1\n\n**User Story:** As a power user, I want the Flutter UI to call a typed service layer instead of raw FFI so that behaviors are consistent, testable, and mockable.\n\n#### Acceptance Criteria\n\n1. WHEN the UI starts training or calibration THEN it SHALL obtain microphone permission via a `PermissionService` abstraction and block start if denied.\n2. IF audio start fails in Rust THEN the `AudioService` SHALL surface a structured error enum and a user-friendly message (no raw Rust strings in UI).\n3. WHEN requesting classification stream THEN the UI SHALL subscribe via the service and be able to swap in a mock service in tests without code changes to screens.\n\n### Requirement 2\n\n**User Story:** As a user, I want consistent UI affordances (errors/loading/containers) so that the app looks coherent and is easy to reason about.\n\n#### Acceptance Criteria\n\n1. WHEN an operation is in progress THEN a shared loading overlay SHALL be used instead of bespoke spinners.\n2. WHEN an error is shown THEN a shared error dialog component SHALL be used with standardized title/body/actions.\n3. WHEN displaying grouped content THEN a shared container style helper SHALL be applied (padding, radius, surface color) instead of ad-hoc Containers.\n\n### Requirement 3\n\n**User Story:** As a developer, I want telemetry hooks for UI actions so that I can debug and analyze flows quickly.\n\n#### Acceptance Criteria\n\n1. WHEN audio start/stop succeeds or fails THEN a trace/log entry SHALL be emitted with outcome and duration.\n2. WHEN a permission request completes THEN the result SHALL be logged (allow/deny/permanently denied) without leaking PII.\n3. WHEN classification stream subscription starts/stops THEN events SHALL be logged for timing analysis.\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Services isolate FFI concerns; widgets isolate presentation; screens orchestrate only.\n- **Modular Design**: Services in `lib/services`, widgets in `lib/ui/widgets`, styles in `lib/ui/styles`, no circular deps.\n- **Dependency Management**: UI depends on services via interfaces; services depend on FFI bridge; no UI→FFI direct imports.\n- **Clear Interfaces**: PermissionService/AudioService/ErrorTranslator exposed as interfaces with mock implementations for tests.\n\n### Performance\n- Service calls and error translation SHALL add <1ms overhead per call on a mid-tier device.\n- Shared widgets SHALL not regress initial render time by more than 5%.\n\n### Security\n- No raw Rust error strings shown; user-facing messages are sanitized.\n- Permission state is not persisted beyond session; no extra storage of PII.\n\n### Reliability\n- Service layer must be fully mockable for widget tests; failures are surfaced as typed results, not thrown exceptions.\n- UI must handle stream cancellation gracefully (no unhandled exceptions on dispose).\n\n### Usability\n- Error dialogs use actionable, plain-language messages with a single primary action.\n- Loading overlay blocks interaction and is dismissible only when operations complete.\n",
  "fileStats": {
    "size": 3801,
    "lines": 66,
    "lastModified": "2025-11-30T21:28:55.810Z"
  },
  "comments": []
}