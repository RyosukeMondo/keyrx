{
  "id": "snapshot_1764712295127_zk82fbuh1",
  "approvalId": "approval_1764712249087_9ngdcu823",
  "approvalTitle": "Build System - Design Document",
  "version": 2,
  "timestamp": "2025-12-02T21:51:35.127Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design implements a comprehensive build system for KeyRx, including a task runner (just), CI/CD pipelines (GitHub Actions), and developer experience tooling. The system provides one-command setup, automated quality gates, cross-platform builds, and release automation.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **Build Profiles**: Implements dev, release, and profiling profiles as specified\n- **Feature Flags**: Uses documented feature flags (linux, windows, tracing, profiling)\n- **Cross-Platform**: Targets documented platforms (Linux x64, Windows x64, with ARM64 planned)\n- **CI Pipeline**: Follows documented pipeline architecture (ci.yml, release.yml, maintenance.yml)\n- **Developer Tools**: Installs documented tools (just, cargo-nextest, cargo-watch, etc.)\n\n### Project Structure (structure.md)\n\n```\nkeyrx/\n├── justfile                    # Task runner (NEW)\n├── cliff.toml                  # Changelog generator config (NEW)\n├── .github/\n│   └── workflows/\n│       ├── ci.yml              # Enhanced CI (MODIFY)\n│       ├── release.yml         # Release automation (NEW)\n│       └── maintenance.yml     # Maintenance automation (NEW)\n├── .vscode/\n│   ├── settings.json           # IDE settings (NEW)\n│   ├── extensions.json         # Recommended extensions (NEW)\n│   └── launch.json             # Debug configurations (NEW)\n├── .devcontainer/\n│   └── devcontainer.json       # Dev container config (NEW)\n├── scripts/\n│   ├── install-hooks.sh        # Pre-commit hook installer (EXISTS)\n│   └── release.sh              # Release helper script (NEW)\n└── core/\n    └── .config/\n        └── nextest.toml        # Nextest CI profile (NEW)\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **scripts/install-hooks.sh**: Existing hook installer - will be enhanced with better error handling\n- **.github/workflows/ci.yml**: Existing CI workflow - will be significantly enhanced\n- **core/benches/latency.rs**: Existing benchmark - will be integrated into CI regression detection\n\n### Integration Points\n\n- **Cargo.toml**: Add release profile optimizations\n- **pubspec.yaml**: Version synchronization for releases\n- **pre-commit hook**: Already exists, will be formalized\n\n## Architecture\n\n### Build System Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                           Developer Workstation                          │\n├─────────────────────────────────────────────────────────────────────────┤\n│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐     │\n│  │    justfile     │    │   Pre-commit    │    │   IDE Config    │     │\n│  │   Task Runner   │    │     Hooks       │    │    (.vscode)    │     │\n│  └────────┬────────┘    └────────┬────────┘    └─────────────────┘     │\n│           │                      │                                       │\n│           ▼                      ▼                                       │\n│  ┌─────────────────────────────────────────────────────────────────┐   │\n│  │                    Local Development Loop                        │   │\n│  │  just setup → just dev → just check → git commit → pre-commit   │   │\n│  └─────────────────────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────────────────────┘\n                                    │\n                                    │ git push\n                                    ▼\n┌─────────────────────────────────────────────────────────────────────────┐\n│                           GitHub Actions                                 │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  on: push/PR                          on: tag v*                         │\n│  ┌─────────────────────┐              ┌─────────────────────┐           │\n│  │      ci.yml         │              │    release.yml      │           │\n│  │  ┌───────────────┐  │              │  ┌───────────────┐  │           │\n│  │  │ check (fast)  │  │              │  │ build-linux   │  │           │\n│  │  │ fmt + clippy  │  │              │  │ build-windows │  │           │\n│  │  └───────┬───────┘  │              │  └───────┬───────┘  │           │\n│  │          ▼          │              │          ▼          │           │\n│  │  ┌───────────────┐  │              │  ┌───────────────┐  │           │\n│  │  │ test matrix   │  │              │  │   package     │  │           │\n│  │  │ linux/windows │  │              │  │ tar.gz / zip  │  │           │\n│  │  └───────┬───────┘  │              │  └───────┬───────┘  │           │\n│  │          ▼          │              │          ▼          │           │\n│  │  ┌───────────────┐  │              │  ┌───────────────┐  │           │\n│  │  │ coverage      │  │              │  │   publish     │  │           │\n│  │  │ security      │  │              │  │ GitHub Release│  │           │\n│  │  │ benchmark     │  │              │  └───────────────┘  │           │\n│  │  └───────────────┘  │              │                     │           │\n│  └─────────────────────┘              └─────────────────────┘           │\n│                                                                          │\n│  on: schedule (weekly)                                                   │\n│  ┌─────────────────────┐                                                │\n│  │  maintenance.yml    │                                                │\n│  │  deps update + PR   │                                                │\n│  │  security audit     │                                                │\n│  └─────────────────────┘                                                │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each workflow handles one concern (CI, release, maintenance)\n- **Component Isolation**: justfile recipes are independent and composable\n- **Fail Fast**: Lint checks run before expensive test jobs\n- **Caching**: All workflows use appropriate caching strategies\n\n## Components and Interfaces\n\n### Component 1: justfile (Task Runner)\n\n**Purpose:** Provide unified, discoverable commands for all development workflows\n\n**File:** `justfile`\n\n**Interfaces (Recipes):**\n```just\n# Development\nsetup          # One-command environment setup\ndev            # Watch mode for Rust (clippy + tests)\nui             # Run Flutter with hot reload\n\n# Quality\ncheck          # Run all checks (fmt + clippy + test)\nfmt            # Format all code\nclippy         # Run clippy lints\ntest           # Run all tests\n\n# Build\nbuild          # Build release for current platform\nbuild-all      # Build for all platforms\nbuild-linux    # Build Linux x64\nbuild-windows  # Build Windows x64 (via cross)\n\n# Release\nbench          # Run latency benchmarks\nrelease ver    # Prepare release with version\n```\n\n**Dependencies:** just, cargo, flutter, cross\n\n### Component 2: CI Workflow (ci.yml)\n\n**Purpose:** Automated quality gates on every push and PR\n\n**File:** `.github/workflows/ci.yml`\n\n**Jobs:**\n```yaml\njobs:\n  check:        # Fast: fmt + clippy (2 min)\n  test:         # Matrix: ubuntu + windows (5 min)\n  test-flutter: # Flutter analyze + test (3 min)\n  coverage:     # cargo-llvm-cov → Codecov (4 min)\n  security:     # cargo audit (1 min)\n  benchmark:    # PR only: criterion regression (3 min)\n```\n\n**Dependencies:** dtolnay/rust-toolchain, Swatinem/rust-cache, subosito/flutter-action, codecov/codecov-action\n\n### Component 3: Release Workflow (release.yml)\n\n**Purpose:** Automated cross-platform builds and GitHub Release publishing\n\n**File:** `.github/workflows/release.yml`\n\n**Jobs:**\n```yaml\njobs:\n  build:        # Matrix: linux-x64, windows-x64\n    steps:\n      - Build Rust core\n      - Build Flutter UI\n      - Package artifacts (tar.gz/zip)\n      - Upload artifacts\n\n  publish:      # Depends on build\n    steps:\n      - Download all artifacts\n      - Generate release notes\n      - Create GitHub Release\n```\n\n**Dependencies:** softprops/action-gh-release\n\n### Component 4: Maintenance Workflow (maintenance.yml)\n\n**Purpose:** Automated dependency updates and security monitoring\n\n**File:** `.github/workflows/maintenance.yml`\n\n**Jobs:**\n```yaml\njobs:\n  update-dependencies:  # cargo update + create PR\n  security-audit:       # cargo audit with notifications\n```\n\n**Dependencies:** peter-evans/create-pull-request, rustsec/audit-check\n\n### Component 5: Pre-commit Hook\n\n**Purpose:** Block commits that don't pass quality checks\n\n**File:** `.git/hooks/pre-commit` (installed by `scripts/install-hooks.sh`)\n\n**Interfaces:**\n```bash\n# Checks run in order (fail fast)\n1. cargo fmt --check\n2. cargo clippy -- -D warnings\n3. cargo test --lib\n```\n\n**Exit Codes:** 0 = pass, 1 = fail\n\n### Component 6: IDE Configuration\n\n**Purpose:** Optimal VS Code setup for Rust + Flutter development\n\n**Files:**\n- `.vscode/settings.json` - rust-analyzer, formatOnSave, clippy\n- `.vscode/extensions.json` - recommended extensions list\n- `.vscode/launch.json` - debug configurations\n\n### Component 7: Development Container\n\n**Purpose:** Reproducible development environment\n\n**File:** `.devcontainer/devcontainer.json`\n\n**Features:**\n- Rust stable toolchain\n- just task runner\n- Auto-runs `just setup` on create\n\n### Component 8: Nextest Configuration\n\n**Purpose:** Fast test runner with CI-specific profile\n\n**File:** `core/.config/nextest.toml`\n\n**Profiles:**\n```toml\n[profile.default]\nretries = 0\n\n[profile.ci]\nretries = 2\nfail-fast = false\n```\n\n### Component 9: Changelog Generator (cliff.toml)\n\n**Purpose:** Generate changelog from conventional commits\n\n**File:** `cliff.toml`\n\n**Commit Parsing:**\n- `feat` → Added\n- `fix` → Fixed\n- `perf` → Performance\n- `refactor` → Changed\n\n## Data Models\n\n### Nextest Config (TOML)\n\n```toml\n[profile.default]\nretries = 0\nslow-timeout = { period = \"60s\" }\n\n[profile.ci]\nretries = 2\nfail-fast = false\n```\n\n### Devcontainer Config (JSON)\n\n```json\n{\n  \"name\": \"KeyRx Development\",\n  \"image\": \"mcr.microsoft.com/devcontainers/rust:1-bookworm\",\n  \"features\": {\n    \"ghcr.io/devcontainers/features/rust:1\": {},\n    \"ghcr.io/aspect-build/aspect-workflows-images/features/just:1\": {}\n  },\n  \"postCreateCommand\": \"just setup\"\n}\n```\n\n### VS Code Settings (JSON)\n\n```json\n{\n  \"rust-analyzer.cargo.features\": \"all\",\n  \"rust-analyzer.check.command\": \"clippy\",\n  \"editor.formatOnSave\": true\n}\n```\n\n### Cliff Config (TOML)\n\n```toml\n[changelog]\nheader = \"# Changelog\\n\"\nbody = \"{% for group, commits in commits %}...\"\n\n[git]\nconventional_commits = true\ncommit_parsers = [\n  { message = \"^feat\", group = \"Added\" },\n  { message = \"^fix\", group = \"Fixed\" }\n]\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Pre-commit hook fails**\n   - **Handling:** Display specific failure (fmt/clippy/test) with fix command\n   - **User Impact:** Commit blocked, user runs suggested fix command\n\n2. **CI workflow fails**\n   - **Handling:** Job-level failure with logs, GitHub status check blocks merge\n   - **User Impact:** PR cannot be merged until fixed\n\n3. **Release build fails**\n   - **Handling:** Workflow fails, no GitHub Release created\n   - **User Impact:** Maintainer investigates logs, re-triggers after fix\n\n4. **Benchmark regression detected**\n   - **Handling:** CI warning annotation (not failure by default)\n   - **User Impact:** PR author reviews benchmark results\n\n5. **Security vulnerability found**\n   - **Handling:** `cargo audit` fails CI, weekly audit sends notification\n   - **User Impact:** Team addresses vulnerability before merge\n\n6. **Setup fails (missing tool)**\n   - **Handling:** Clear error message with installation command\n   - **User Impact:** User runs suggested installation command\n\n## Testing Strategy\n\n### Unit Testing\n\nNot applicable - build system is tested via integration.\n\n### Integration Testing\n\n1. **Pre-commit hook test:**\n   ```bash\n   # Test that hook blocks bad commits\n   echo \"bad code\" >> test.rs\n   git commit -m \"test\" # Should fail\n   ```\n\n2. **justfile recipe test:**\n   ```bash\n   just check  # Should pass on clean repo\n   ```\n\n3. **CI workflow test:**\n   - Push to feature branch\n   - Verify all jobs pass\n   - Verify caching works (second run faster)\n\n### End-to-End Testing\n\n1. **Full release flow:**\n   ```bash\n   git tag v0.0.1-test\n   git push origin v0.0.1-test\n   # Verify GitHub Release created with artifacts\n   git push --delete origin v0.0.1-test\n   ```\n\n2. **New contributor setup:**\n   ```bash\n   git clone ...\n   just setup\n   just check  # Should pass\n   ```\n\n## Implementation Sequence\n\n1. **justfile** - Foundation for all other tasks\n2. **nextest.toml** - CI test profile\n3. **ci.yml enhancement** - Full CI pipeline\n4. **Pre-commit hook update** - Better error messages\n5. **VS Code config** - IDE setup\n6. **devcontainer.json** - Container environment\n7. **cliff.toml** - Changelog generation\n8. **release.yml** - Release automation\n9. **maintenance.yml** - Maintenance automation\n10. **release.sh** - Release helper script\n",
  "fileStats": {
    "size": 15821,
    "lines": 411,
    "lastModified": "2025-12-02T21:50:42.776Z"
  },
  "comments": []
}