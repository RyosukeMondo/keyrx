{
  "id": "snapshot_1764765557789_cefx439w5",
  "approvalId": "approval_1764765557779_0ggtl6slp",
  "approvalTitle": "FFI Architecture Overhaul - Tasks",
  "version": 1,
  "timestamp": "2025-12-03T12:39:17.789Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n## Phase 1: Foundation\n\n- [ ] 1. Create FfiError and FfiResult types\n  - File: `core/src/ffi/error.rs`\n  - Define `FfiError` struct with code, message, details fields\n  - Implement `FfiResult<T>` type alias and serialization\n  - Add helper constructors: `invalid_input`, `internal`, `not_found`\n  - Purpose: Standardized error handling across all FFI exports\n  - _Leverage: Existing error patterns in `exports_discovery.rs`_\n  - _Requirements: 4.1, 4.2_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in error handling and FFI | Task: Create FfiError and FfiResult types in core/src/ffi/error.rs following requirements 4.1 and 4.2, with JSON serialization producing \"ok:{...}\" or \"error:{code, message, details}\" format | Restrictions: Do not modify existing exports yet, maintain backward compatibility, use serde for serialization | _Leverage: Review exports_discovery.rs for current error patterns | Success: Types compile, serialize correctly to expected JSON format, unit tests pass for all error constructors | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 2. Create FfiContext handle-based state management\n  - File: `core/src/ffi/context.rs`\n  - Define `FfiContext` struct with handle, domain state storage\n  - Implement `new()`, `get_domain<T>()`, `get_domain_mut<T>()`\n  - Add handle registry for safe pointer management\n  - Purpose: Replace global OnceLock statics with instance-scoped state\n  - _Leverage: Current state patterns in `exports_discovery.rs` (lines 68-78)_\n  - _Requirements: 3.1, 3.2, 3.3_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with FFI and memory safety expertise | Task: Create FfiContext in core/src/ffi/context.rs implementing handle-based state per requirements 3.1-3.3, replacing global statics pattern | Restrictions: Must be thread-safe, no global mutable state, use Arc<RwLock> for shared access | _Leverage: Study DISCOVERY_SESSION static in exports_discovery.rs:68-78 for current pattern | Success: Context can store/retrieve typed domain state, handles are unique, tests run in parallel without interference | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 3. Create EventRegistry for unified callbacks\n  - File: `core/src/ffi/events.rs`\n  - Define `EventType` enum covering all callback categories\n  - Implement `EventRegistry` with register/invoke methods\n  - Add callback type definition: `extern \"C\" fn(*const u8, usize)`\n  - Purpose: Single callback registration system replacing per-domain functions\n  - _Leverage: `CallbackRegistry` in `ffi/callbacks.rs`_\n  - _Requirements: 2.1, 2.2, 2.3, 2.4_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in callback systems | Task: Create EventRegistry in core/src/ffi/events.rs implementing unified callback management per requirements 2.1-2.4 | Restrictions: Must handle null callbacks gracefully, thread-safe invocation, no memory leaks | _Leverage: Study CallbackRegistry in ffi/callbacks.rs for current pattern | Success: Single registration point for all event types, callbacks invoked with JSON payloads, replaces 3+ individual callback functions | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 4. Create FfiExportable trait definition\n  - File: `core/src/ffi/traits.rs`\n  - Define `FfiExportable` trait with DOMAIN const, init(), cleanup()\n  - Add documentation with usage examples\n  - Create `FfiDomain` marker for domain type storage\n  - Purpose: Contract for FFI-exportable domain modules\n  - _Leverage: `InputSource` trait pattern from `core/src/traits/`_\n  - _Requirements: 1.1, 1.4_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with trait design expertise | Task: Create FfiExportable trait in core/src/ffi/traits.rs following requirements 1.1 and 1.4 | Restrictions: Trait must be object-safe where possible, clear documentation required, follow existing trait patterns | _Leverage: Review InputSource trait in core/src/traits/ for design patterns | Success: Trait compiles, can be implemented by domain modules, documentation is complete | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 2: Procedural Macro\n\n- [ ] 5. Set up procedural macro crate\n  - Files: `core/ffi-macros/Cargo.toml`, `core/ffi-macros/src/lib.rs`\n  - Create new crate `keyrx-ffi-macros` as proc-macro\n  - Add dependencies: syn, quote, proc-macro2\n  - Wire up to main Cargo.toml as workspace member\n  - Purpose: Foundation for #[ffi_export] macro\n  - _Leverage: Rust proc-macro best practices_\n  - _Requirements: 1.1_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with procedural macro experience | Task: Set up keyrx-ffi-macros crate in core/ffi-macros/ with proper workspace configuration | Restrictions: Must be proc-macro crate type, use stable Rust features only, follow workspace conventions | _Leverage: Standard Rust proc-macro crate structure | Success: Crate compiles, is recognized by workspace, can define proc-macro attributes | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 6. Implement #[ffi_export] attribute macro\n  - File: `core/ffi-macros/src/lib.rs`\n  - Parse method signatures with syn\n  - Generate C-ABI wrapper functions with error handling\n  - Handle string parameters (null check, UTF-8 validation)\n  - Purpose: Auto-generate FFI wrappers from Rust methods\n  - _Leverage: Current wrapper patterns in `exports_discovery.rs:114-270`_\n  - _Requirements: 1.1, 1.2, 1.3_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with deep proc-macro expertise | Task: Implement #[ffi_export] macro generating C-ABI wrappers per requirements 1.1-1.3 | Restrictions: Generated code must handle all error cases, match existing wrapper quality, compile without warnings | _Leverage: Study keyrx_start_discovery in exports_discovery.rs:114-270 for target output pattern | Success: Macro generates correct wrappers, null checks work, UTF-8 validation works, JSON serialization works | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 7. Add panic catching to generated wrappers\n  - File: `core/ffi-macros/src/lib.rs`\n  - Wrap method calls in `std::panic::catch_unwind`\n  - Convert panics to FfiError with INTERNAL_ERROR code\n  - Log panic details for debugging\n  - Purpose: Prevent panics from crossing FFI boundary\n  - _Leverage: catch_unwind patterns_\n  - _Requirements: 4.2 (error handling)_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with FFI safety expertise | Task: Add panic catching to #[ffi_export] generated wrappers using catch_unwind | Restrictions: Must catch all panics, convert to error responses, log for debugging, not affect performance significantly | _Leverage: std::panic::catch_unwind documentation | Success: Panics in domain code don't crash FFI caller, error response returned instead, panic logged | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 3: First Domain Migration (Discovery)\n\n- [ ] 8. Create DiscoveryFfi implementing FfiExportable\n  - File: `core/src/ffi/domains/discovery.rs`\n  - Implement FfiExportable trait for DiscoveryFfi\n  - Move state from global statics to domain struct\n  - Implement init() and cleanup() methods\n  - Purpose: First domain using new pattern\n  - _Leverage: Current `exports_discovery.rs` implementation_\n  - _Requirements: 5.1, 3.1_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer migrating FFI code | Task: Create DiscoveryFfi in core/src/ffi/domains/discovery.rs implementing FfiExportable trait | Restrictions: Must maintain same functionality as exports_discovery.rs, no global statics, state in struct | _Leverage: exports_discovery.rs as source, FfiExportable trait from task 4 | Success: DiscoveryFfi has same capabilities as current exports, uses instance state, passes existing tests | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 9. Apply #[ffi_export] to Discovery methods\n  - File: `core/src/ffi/domains/discovery.rs`\n  - Add #[ffi_export] to start_discovery, process_event, cancel, get_progress\n  - Remove manual C-ABI wrapper code\n  - Verify generated exports match existing signatures\n  - Purpose: Validate macro with real domain\n  - _Leverage: Existing FFI function signatures_\n  - _Requirements: 1.1, 1.2, 1.3_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer applying new patterns | Task: Apply #[ffi_export] macro to DiscoveryFfi methods, removing manual wrapper code | Restrictions: Generated exports must match existing function signatures exactly, all tests must pass | _Leverage: Current exports_discovery.rs function signatures | Success: Discovery FFI works with macro-generated wrappers, code reduced by ~200 lines, tests pass | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 10. Migrate Discovery callbacks to EventRegistry\n  - File: `core/src/ffi/domains/discovery.rs`\n  - Replace keyrx_on_discovery_progress/duplicate/summary with EventRegistry\n  - Add DiscoveryProgress, DiscoveryDuplicate, DiscoverySummary event types\n  - Update callback invocation to use EventRegistry\n  - Purpose: Unified callback system for Discovery\n  - _Leverage: `callbacks.rs` and `EventRegistry` from task 3_\n  - _Requirements: 2.1, 2.2, 2.3_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer refactoring callbacks | Task: Migrate Discovery callbacks to EventRegistry, replacing 3 separate callback functions | Restrictions: Callback behavior must remain identical, existing Flutter code must work with shim | _Leverage: EventRegistry from task 3, current callback pattern in callbacks.rs | Success: Discovery uses EventRegistry, backward-compatible shims exist, Flutter works unchanged | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 11. Create backward-compatible shims for Discovery\n  - File: `core/src/ffi/compat/discovery_compat.rs`\n  - Create thin wrappers: keyrx_on_discovery_progress â†’ EventRegistry.register\n  - Mark as #[deprecated] with migration guidance\n  - Keep existing function signatures exactly\n  - Purpose: Allow incremental Flutter migration\n  - _Leverage: Existing exports_discovery.rs functions_\n  - _Requirements: 5.3 (deprecation warnings)_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating compatibility layer | Task: Create backward-compatible shims in core/src/ffi/compat/discovery_compat.rs for existing callback functions | Restrictions: Must not change existing function signatures, must emit deprecation warnings, must forward to EventRegistry | _Leverage: Current exports_discovery.rs callback functions | Success: Existing Flutter code works unchanged, deprecation warnings appear, new code can use EventRegistry directly | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 4: Additional Domain Migrations\n\n- [ ] 12. Migrate ValidationFfi\n  - File: `core/src/ffi/domains/validation.rs`\n  - Implement FfiExportable for ValidationFfi\n  - Apply #[ffi_export] to validation functions\n  - Migrate validation callbacks to EventRegistry\n  - Purpose: Validate pattern with second domain\n  - _Leverage: `exports_validation.rs`, DiscoveryFfi pattern_\n  - _Requirements: 5.1, 1.1_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer migrating FFI code | Task: Migrate exports_validation.rs to ValidationFfi following DiscoveryFfi pattern | Restrictions: Maintain same functionality, use #[ffi_export] macro, migrate to EventRegistry | _Leverage: exports_validation.rs as source, DiscoveryFfi as pattern | Success: ValidationFfi works with new architecture, code reduced, tests pass | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 13. Migrate EngineFfi\n  - File: `core/src/ffi/domains/engine.rs`\n  - Implement FfiExportable for EngineFfi\n  - Apply #[ffi_export] to engine functions\n  - Migrate engine callbacks to EventRegistry\n  - Purpose: Core engine FFI migration\n  - _Leverage: `exports_engine.rs`, established pattern_\n  - _Requirements: 5.1, 1.1_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer migrating FFI code | Task: Migrate exports_engine.rs to EngineFfi following established pattern | Restrictions: Maintain same functionality, use #[ffi_export] macro, handle engine state carefully | _Leverage: exports_engine.rs as source, DiscoveryFfi as pattern | Success: EngineFfi works with new architecture, state management correct, tests pass | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 14. Migrate remaining domains (Device, Testing, Analysis, Diagnostics, Script)\n  - Files: `core/src/ffi/domains/{device,testing,analysis,diagnostics,script}.rs`\n  - Apply same pattern to all remaining exports_*.rs files\n  - Consolidate smaller domains if < 3 functions\n  - Create compat shims as needed\n  - Purpose: Complete FFI migration\n  - _Leverage: Established pattern, remaining exports_*.rs files_\n  - _Requirements: 5.1, 5.2_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer completing FFI migration | Task: Migrate remaining exports_*.rs files to new domain pattern | Restrictions: Apply consistent pattern, consolidate small domains, maintain all functionality | _Leverage: All remaining exports_*.rs files, established pattern | Success: All FFI domains migrated, consistent architecture, all tests pass | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 5: Dart Binding Generation\n\n- [ ] 15. Create Dart binding generator script\n  - File: `scripts/generate_dart_bindings.py`\n  - Parse Rust FFI exports (from macro annotations or cbindgen output)\n  - Generate Dart FFI bindings with type conversions\n  - Output to `ui/lib/ffi/generated/`\n  - Purpose: Automated Dart binding synchronization\n  - _Leverage: ffigen or custom parsing_\n  - _Requirements: 6.1, 6.2, 6.3_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Python/Dart Developer with FFI experience | Task: Create binding generator script producing Dart FFI bindings from Rust exports | Restrictions: Must generate type-safe bindings, handle all parameter types, output to ui/lib/ffi/generated/ | _Leverage: dart:ffi documentation, current KeyrxBridge patterns | Success: Script generates correct Dart bindings, types match Rust, integration works | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 16. Integrate binding generation into build\n  - Files: `core/Cargo.toml`, `ui/pubspec.yaml`, `scripts/build.sh`\n  - Add build.rs or Makefile step to run generator\n  - Add Flutter pre-build hook to verify bindings\n  - Fail build if bindings out of sync\n  - Purpose: Automatic binding synchronization\n  - _Leverage: Cargo build scripts, Flutter build hooks_\n  - _Requirements: 6.4_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Build Engineer with Rust/Flutter expertise | Task: Integrate binding generation into build pipeline with sync verification | Restrictions: Must fail build on mismatch, integrate with existing build, minimal build time impact | _Leverage: Cargo build.rs, Flutter build hooks | Success: Build runs generator automatically, fails on mismatch, CI catches binding drift | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 17. Update KeyrxBridge to use generated bindings\n  - File: `ui/lib/ffi/bridge.dart`\n  - Replace manual FFI function lookups with generated bindings\n  - Add unified callback registration via EventRegistry\n  - Maintain backward compatibility during transition\n  - Purpose: Flutter integration with new FFI\n  - _Leverage: Current KeyrxBridge implementation, generated bindings_\n  - _Requirements: 2.1, 6.1_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Developer with FFI expertise | Task: Update KeyrxBridge to use generated bindings and unified callback registration | Restrictions: Maintain backward compatibility, all existing functionality must work, gradual migration | _Leverage: Current bridge.dart, generated bindings from task 15 | Success: KeyrxBridge uses generated bindings, callbacks work with EventRegistry, tests pass | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 6: Testing & Cleanup\n\n- [ ] 18. Add parallel FFI tests\n  - File: `core/src/ffi/tests/parallel_tests.rs`\n  - Create tests that run FFI operations in parallel\n  - Verify no state interference between contexts\n  - Use cargo nextest for true parallelism\n  - Purpose: Validate isolated state management\n  - _Leverage: FfiContext, existing FFI tests_\n  - _Requirements: 3.4_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Test Developer | Task: Create parallel FFI tests verifying isolated state management | Restrictions: Tests must actually run in parallel, verify no state leakage, use nextest | _Leverage: FfiContext from task 2, existing FFI tests | Success: Parallel tests pass with nextest, no state interference, CI runs them parallel | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 19. Add FFI fuzz tests\n  - File: `core/src/ffi/tests/fuzz_tests.rs`\n  - Use proptest to generate random FFI inputs\n  - Verify no panics escape FFI boundary\n  - Test edge cases: empty strings, max lengths, null bytes\n  - Purpose: Robustness testing for FFI layer\n  - _Leverage: proptest, FfiError_\n  - _Requirements: Non-functional (reliability)_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Security/Test Developer | Task: Create FFI fuzz tests using proptest for robustness validation | Restrictions: Must catch all panics, test realistic edge cases, integrate with CI | _Leverage: proptest documentation, FfiError from task 1 | Success: Fuzz tests run, no panics escape, edge cases handled gracefully | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 20. Remove deprecated exports and clean up\n  - Files: Delete `core/src/ffi/exports_*.rs` (old files)\n  - Remove backward-compat shims after Flutter migration\n  - Update mod.rs to export new structure\n  - Update documentation\n  - Purpose: Complete migration, reduce code\n  - _Leverage: New domain structure_\n  - _Requirements: 5.3_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer completing cleanup | Task: Remove deprecated FFI exports after Flutter migration complete | Restrictions: Only remove after all Flutter code migrated, update all imports, update docs | _Leverage: New ffi/domains/ structure | Success: Old exports_*.rs deleted, code compiles, tests pass, docs updated | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 21. Update FFI documentation\n  - File: `docs/ffi-architecture.md`\n  - Document new trait-based architecture\n  - Add migration guide for adding new FFI exports\n  - Include examples for common patterns\n  - Purpose: Developer documentation\n  - _Leverage: Implementation from previous tasks_\n  - _Requirements: Non-functional (usability)_\n  - _Prompt: Implement the task for spec ffi-architecture-overhaul, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer with Rust expertise | Task: Create comprehensive FFI architecture documentation | Restrictions: Cover all new patterns, include examples, migration guide for new exports | _Leverage: Implementation details from all previous tasks | Success: Documentation is complete, examples work, developers can add new exports easily | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n",
  "fileStats": {
    "size": 23196,
    "lines": 224,
    "lastModified": "2025-12-03T12:38:57.328Z"
  },
  "comments": []
}