{
  "id": "snapshot_1764479170693_65jv3o0vm",
  "approvalId": "approval_1764477820993_rn2pu0i9b",
  "approvalTitle": "Tasks: Advanced Remapping Engine",
  "version": 2,
  "timestamp": "2025-11-30T05:06:10.693Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: advanced-remapping-engine\n\n## Phase 1: State Management (Layer 1)\n\n- [ ] 1. Create KeyStateTracker\n  - File: `core/src/engine/state/key_state.rs` (new)\n  - Implement `KeyStateTracker` struct with HashMap<KeyCode, u64>\n  - Methods: `key_down()`, `key_up()`, `is_pressed()`, `press_time()`, `pressed_keys()`\n  - Handle duplicate key-down (is_repeat) correctly\n  - Add comprehensive unit tests\n  - Purpose: Track which physical keys are currently held with timestamps\n  - _Leverage: InputEvent.timestamp_us, KeyCode from keycodes.rs_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create KeyStateTracker in core/src/engine/state/key_state.rs that tracks pressed keys with timestamps, handles duplicates, and provides iteration | Restrictions: No heap allocation on key_down/key_up hot path, use HashMap with reserved capacity | Success: All unit tests pass, benchmarks show <100ns per operation | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 2. Create ModifierState with virtual modifiers\n  - File: `core/src/engine/state/modifiers.rs` (new)\n  - Implement `VirtualModifiers` bitmap (256 bits = [u64; 4])\n  - Implement `StandardModifiers` for OS modifiers\n  - Implement `OneShotState` for sticky modifiers\n  - Implement `ModifierState` combining all three\n  - Methods: `activate()`, `deactivate()`, `is_active()`, `arm_one_shot()`, `consume_one_shot()`\n  - Add unit tests for all modifier operations\n  - Purpose: Track standard and virtual modifier state\n  - _Leverage: Pattern from MockState_\n  - _Requirements: REQ-3, REQ-7_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in bit manipulation | Task: Create ModifierState in core/src/engine/state/modifiers.rs with 256-bit virtual modifier bitmap and one-shot state machine | Restrictions: Use bitwise ops for speed, no heap allocation | Success: Supports 255 virtual modifiers, one-shot cycle works, tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 3. Create LayerStack system\n  - File: `core/src/engine/state/layers.rs` (new)\n  - Define `Layer` struct with name, mappings, transparent flag\n  - Define `LayerAction` enum (Remap, Block, TapHold, LayerPush, etc.)\n  - Implement `LayerStack` with push/pop/toggle operations\n  - Implement `lookup()` with top-to-bottom priority and transparency\n  - Add unit tests for layer operations\n  - Purpose: Manage keyboard layers with priority\n  - _Leverage: RemapRegistry pattern_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create LayerStack in core/src/engine/state/layers.rs with Layer struct, LayerAction enum, and priority-based lookup with transparency | Restrictions: Lookup must be O(layers * 1), no deep cloning | Success: Push/pop/toggle work, transparent fallthrough works, tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 4. Create state module with re-exports\n  - File: `core/src/engine/state/mod.rs` (new)\n  - Re-export KeyStateTracker, ModifierState, LayerStack\n  - Update `core/src/engine/mod.rs` to include state module\n  - Ensure all public types are accessible\n  - Purpose: Organize state management code\n  - _Requirements: REQ-1, REQ-3, REQ-4_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create state/mod.rs with proper re-exports, update engine/mod.rs | Restrictions: Maintain backward compatibility | Success: All state types importable from keyrx::engine::state | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n## Phase 2: Decision System (Layer 2)\n\n- [ ] 5. Create TimingConfig\n  - File: `core/src/engine/decision/timing.rs` (new)\n  - Implement `TimingConfig` struct with all timing parameters\n  - Implement `Default` with values from tech.md spec\n  - Add `Serialize`/`Deserialize` for config files\n  - Add builder pattern for fluent configuration\n  - Purpose: Configurable timing parameters\n  - _Requirements: REQ-8_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create TimingConfig in core/src/engine/decision/timing.rs with tap_timeout_ms, combo_timeout_ms, hold_delay_ms, eager_tap, permissive_hold, retro_tap | Restrictions: All fields must have sensible defaults | Success: Default matches tech.md, serialization works | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 6. Create PendingDecision and DecisionQueue\n  - File: `core/src/engine/decision/pending.rs` (new)\n  - Define `PendingDecision` enum (TapHold, Combo variants)\n  - Define `DecisionResolution` enum for outcomes\n  - Implement `DecisionQueue` with add, check_event, check_timeouts\n  - Handle permissive_hold interrupt tracking\n  - Handle eager_tap immediate emission\n  - Add comprehensive unit tests for all resolution scenarios\n  - Purpose: Track and resolve timing-based decisions\n  - _Leverage: TimingConfig from task 5_\n  - _Requirements: REQ-2, REQ-5, REQ-10_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create DecisionQueue in core/src/engine/decision/pending.rs with tap-hold resolution (tap on early release, hold on timeout), permissive_hold, eager_tap support | Restrictions: O(n) check is acceptable for small queue, cap at 32 pending | Success: Tap/hold/interrupt scenarios all tested and working | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 7. Create ComboRegistry\n  - File: `core/src/engine/decision/combos.rs` (new)\n  - Define `ComboDef` struct with keys and action\n  - Implement `ComboRegistry` with register and find methods\n  - Implement order-independent key matching\n  - Add unit tests for combo matching\n  - Purpose: Store and match combo definitions\n  - _Requirements: REQ-6_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create ComboRegistry in core/src/engine/decision/combos.rs with order-independent key set matching | Restrictions: Use SmallVec for keys to avoid allocation | Success: 2-key and 3-key combos work regardless of press order | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 8. Create decision module with re-exports\n  - File: `core/src/engine/decision/mod.rs` (new)\n  - Re-export TimingConfig, DecisionQueue, ComboRegistry\n  - Update `core/src/engine/mod.rs` to include decision module\n  - Purpose: Organize decision system code\n  - _Requirements: REQ-2, REQ-5, REQ-6_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create decision/mod.rs with proper re-exports, update engine/mod.rs | Restrictions: Maintain backward compatibility | Success: All decision types importable from keyrx::engine::decision | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n## Phase 3: Advanced Engine Integration\n\n- [ ] 9. Create AdvancedEngine\n  - File: `core/src/engine/advanced.rs` (new)\n  - Implement `AdvancedEngine<I, S>` struct with all state components\n  - Implement `process_event()` with full 9-step flow from design\n  - Implement `tick()` for timeout checking\n  - Implement safe mode toggle (Ctrl+Alt+Shift+Escape)\n  - Wire up all components (KeyState, Modifiers, Layers, Decisions)\n  - Purpose: Orchestrate all components into cohesive engine\n  - _Leverage: Existing Engine pattern, all state/decision components_\n  - _Requirements: REQ-1 through REQ-11_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Create AdvancedEngine in core/src/engine/advanced.rs implementing the 9-step event processing flow with all state components | Restrictions: Keep process_event under 50 lines by delegating to helpers | Success: Full event flow works, safe mode works, all unit tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 10. Add engine state inspection methods\n  - File: `core/src/engine/advanced.rs` (extend)\n  - Add `key_state()`, `modifiers()`, `layers()`, `pending()` accessors\n  - Create `EngineState` struct for serializable state snapshot\n  - Implement `snapshot()` method returning EngineState\n  - Purpose: Enable GUI/FFI state inspection\n  - _Requirements: REQ-10_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Add state inspection methods to AdvancedEngine and create EngineState struct for serializable snapshots | Restrictions: EngineState must be Serialize for FFI | Success: All state accessible, snapshot serializes to JSON | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n## Phase 4: Rhai Script Integration\n\n- [ ] 11. Add tap_hold() Rhai function\n  - File: `core/src/scripting/runtime.rs` (extend)\n  - Register `tap_hold(key, tap_key, hold_key)` function\n  - Register `tap_hold_mod(key, tap_key, hold_modifier)` variant\n  - Store tap-hold configs in registry for engine access\n  - Add tests for tap-hold registration\n  - Purpose: Enable tap-hold configuration via Rhai scripts\n  - _Leverage: Existing remap() registration pattern_\n  - _Requirements: REQ-5, REQ-9_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Add tap_hold() and tap_hold_mod() Rhai functions to runtime.rs, store in TapHoldRegistry | Restrictions: Use existing pending ops pattern | Success: Scripts can define tap-hold, tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 12. Add combo() Rhai function\n  - File: `core/src/scripting/runtime.rs` (extend)\n  - Register `combo(keys_array, action_key)` function\n  - Parse key array from Rhai Array type\n  - Store combos in ComboRegistry\n  - Add tests for combo registration\n  - Purpose: Enable combo configuration via Rhai scripts\n  - _Leverage: Existing remap() registration pattern_\n  - _Requirements: REQ-6, REQ-9_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Add combo() Rhai function that accepts array of keys and action | Restrictions: Validate key array has 2-4 keys | Success: Scripts can define combos, tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 13. Add layer control Rhai functions\n  - File: `core/src/scripting/runtime.rs` (extend)\n  - Register `layer_define(name, transparent)` function\n  - Register `layer_map(layer_name, key, action)` function\n  - Register `layer_push(name)`, `layer_pop()`, `layer_toggle(name)` functions\n  - Register `is_layer_active(name)` query function\n  - Add tests for layer operations\n  - Purpose: Enable layer configuration via Rhai scripts\n  - _Leverage: LayerStack from task 3_\n  - _Requirements: REQ-4, REQ-9_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Add layer_define(), layer_map(), layer_push(), layer_pop(), layer_toggle(), is_layer_active() Rhai functions | Restrictions: Layer names must be validated | Success: Scripts can define and control layers, tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 14. Add modifier control Rhai functions\n  - File: `core/src/scripting/runtime.rs` (extend)\n  - Register `define_modifier(name)` function (returns modifier ID)\n  - Register `modifier_on(name)`, `modifier_off(name)` functions\n  - Register `one_shot(name)` function\n  - Register `is_modifier_active(name)` query function\n  - Add tests for modifier operations\n  - Purpose: Enable virtual modifier control via Rhai scripts\n  - _Leverage: ModifierState from task 2_\n  - _Requirements: REQ-3, REQ-7, REQ-9_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Add define_modifier(), modifier_on(), modifier_off(), one_shot(), is_modifier_active() Rhai functions | Restrictions: Max 255 modifiers, validate names | Success: Scripts can define and control virtual modifiers, one-shot works, tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 15. Add timing config Rhai functions\n  - File: `core/src/scripting/runtime.rs` (extend)\n  - Register `set_tap_timeout(ms)` function\n  - Register `set_combo_timeout(ms)` function\n  - Register `set_hold_delay(ms)` function\n  - Register `set_eager_tap(bool)`, `set_permissive_hold(bool)`, `set_retro_tap(bool)` functions\n  - Add tests for timing configuration\n  - Purpose: Enable timing configuration via Rhai scripts\n  - _Leverage: TimingConfig from task 5_\n  - _Requirements: REQ-8, REQ-9_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Add timing configuration Rhai functions | Restrictions: Validate ranges (e.g., timeout 1-5000ms) | Success: Scripts can configure timing, tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n## Phase 5: CLI Integration\n\n- [ ] 16. Update simulate command for advanced features\n  - File: `core/src/cli/commands/simulate.rs` (extend)\n  - Support `--hold-ms` flag for simulating key holds\n  - Support `--combo` flag for simultaneous keys\n  - Show pending decisions in output\n  - Show layer state in output\n  - Purpose: Enable testing advanced behaviors via CLI\n  - _Leverage: AdvancedEngine from task 9_\n  - _Requirements: REQ-9_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Update simulate command to support hold duration and combo simulation, show pending decisions | Restrictions: Maintain backward compatibility with existing simulate | Success: keyrx simulate --input \"CapsLock:hold:300\" works | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 17. Add state command for debugging\n  - File: `core/src/cli/commands/state.rs` (new or extend)\n  - Add `--pending` flag to show pending decisions\n  - Add `--layers` flag to show active layers\n  - Add `--modifiers` flag to show active modifiers\n  - Add `--json` output format\n  - Purpose: Enable debugging of engine state via CLI\n  - _Leverage: AdvancedEngine.snapshot() from task 10_\n  - _Requirements: REQ-10_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer | Task: Add/extend state command with flags for pending, layers, modifiers, and JSON output | Restrictions: JSON format must match EngineState struct | Success: keyrx state --pending --json shows pending decisions | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n## Phase 6: Testing & Verification\n\n- [ ] 18. Create integration tests for tap-hold\n  - File: `core/tests/tap_hold_test.rs` (new)\n  - Test tap scenario (quick release)\n  - Test hold scenario (timeout expires)\n  - Test permissive_hold (interrupt resolves as hold)\n  - Test eager_tap (immediate emit + correction)\n  - Test retro_tap (tap on release after hold)\n  - Purpose: Verify tap-hold behavior end-to-end\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Create comprehensive tap-hold integration tests covering all scenarios | Restrictions: Use mock clock for deterministic timing | Success: All 5 scenarios tested and passing | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 19. Create integration tests for combos\n  - File: `core/tests/combo_test.rs` (new)\n  - Test 2-key combo (simultaneous)\n  - Test 3-key combo\n  - Test combo with different press order\n  - Test combo timeout (partial keys pass through)\n  - Purpose: Verify combo behavior end-to-end\n  - _Requirements: REQ-6_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Create comprehensive combo integration tests | Restrictions: Test order-independence | Success: All combo scenarios tested and passing | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 20. Create integration tests for layers\n  - File: `core/tests/layer_test.rs` (new)\n  - Test layer push/pop\n  - Test layer toggle\n  - Test transparent layer fallthrough\n  - Test layer with tap-hold\n  - Purpose: Verify layer behavior end-to-end\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Create comprehensive layer integration tests | Restrictions: Test interaction with tap-hold | Success: All layer scenarios tested and passing | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 21. Run benchmarks and verify latency\n  - Run `cargo bench` on all new code paths\n  - Benchmark `process_event()` with pending decisions\n  - Benchmark layer lookup with 5+ layers\n  - Benchmark combo matching with 10+ combos\n  - Document results, ensure < 1ms total\n  - Purpose: Verify performance requirements\n  - _Requirements: REQ-8 (non-functional)_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Performance Engineer | Task: Run benchmarks on all new code paths, document results | Restrictions: Fail if any operation > 100 microseconds | Success: All benchmarks pass, documented in implementation log | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n\n- [ ] 22. Create example scripts demonstrating features\n  - File: `scripts/examples/tap_hold.rhai` (new)\n  - File: `scripts/examples/combos.rhai` (new)\n  - File: `scripts/examples/layers.rhai` (new)\n  - File: `scripts/examples/home_row_mods.rhai` (new)\n  - Document each with comments explaining usage\n  - Purpose: Provide users with working examples\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec advanced-remapping-engine, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer | Task: Create 4 example Rhai scripts demonstrating tap-hold, combos, layers, and home row mods | Restrictions: Must be copy-paste usable | Success: All scripts work when run with keyrx run --script | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, mark [x] when done_\n",
  "fileStats": {
    "size": 21317,
    "lines": 252,
    "lastModified": "2025-11-30T04:43:28.032Z"
  },
  "comments": []
}