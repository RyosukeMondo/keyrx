{
  "id": "snapshot_1764771447148_6gnd8l2n3",
  "approvalId": "approval_1764770436771_v7igd5okd",
  "approvalTitle": "State Machine Audit Tasks (17 tasks)",
  "version": 2,
  "timestamp": "2025-12-03T14:17:27.148Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document\n\n## Phase 1: Audit\n\n- [ ] 1. Catalog all state types\n  - Files: Entire codebase\n  - Document each state type, location, purpose\n  - Identify overlaps and duplicates\n  - Purpose: Complete inventory\n  - _Leverage: Code search_\n  - _Requirements: 1.1, 1.2_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer auditing code | Task: Catalog all state types in codebase | Restrictions: Document location, purpose, overlaps | _Leverage: Code search | Success: Complete state inventory | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 2. Document state ownership\n  - File: `docs/state-audit.md`\n  - Map state types to owning components\n  - Document lifecycle of each state\n  - Purpose: Clear ownership\n  - _Leverage: Audit results_\n  - _Requirements: 1.3_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer | Task: Document state ownership and lifecycle | Restrictions: Clear ownership boundaries, lifecycle docs | _Leverage: Audit | Success: Ownership is clear | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 3. Create consolidation plan\n  - File: `docs/state-audit.md`\n  - Plan for merging duplicates\n  - Plan for extracting common patterns\n  - Purpose: Roadmap for cleanup\n  - _Leverage: Audit results_\n  - _Requirements: 1.4_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Architect | Task: Create state consolidation plan | Restrictions: Minimize breaking changes, clear migration | _Leverage: Audit | Success: Clear plan for consolidation | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 2: Core Types\n\n- [ ] 4. Create StateTransition enum\n  - File: `core/src/engine/transitions/transition.rs`\n  - Define all valid transitions\n  - Add metadata (timestamp, category)\n  - Purpose: Explicit transitions\n  - _Leverage: Audit results_\n  - _Requirements: 2.1, 2.2_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating types | Task: Create StateTransition enum with all variants | Restrictions: Cover all transitions, serializable | _Leverage: Audit | Success: All transitions enumerated | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 5. Create StateKind enum\n  - File: `core/src/engine/transitions/state_kind.rs`\n  - Define high-level state categories\n  - Map to transition validity\n  - Purpose: State categorization\n  - _Leverage: Audit results_\n  - _Requirements: 2.1_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating types | Task: Create StateKind enum for state categories | Restrictions: Cover all states, clear semantics | _Leverage: Audit | Success: States categorized | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 6. Create StateGraph\n  - File: `core/src/engine/transitions/graph.rs`\n  - Define valid transition rules\n  - Implement is_valid and apply\n  - Purpose: Transition enforcement\n  - _Leverage: StateTransition, StateKind_\n  - _Requirements: 2.2, 2.3, 2.4_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating state machine | Task: Create StateGraph with transition rules | Restrictions: Enforce validity, reject invalid | _Leverage: StateTransition | Success: Invalid transitions rejected | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 3: Validation\n\n- [ ] 7. Create Invariant trait\n  - File: `core/src/engine/transitions/invariant.rs`\n  - Define invariant interface\n  - Add InvariantViolation type\n  - Purpose: Pluggable validation\n  - _Leverage: Trait patterns_\n  - _Requirements: 3.1, 3.2_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating traits | Task: Create Invariant trait for validation | Restrictions: Pluggable, clear errors | _Leverage: Traits | Success: Invariant interface defined | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 8. Implement core invariants\n  - File: `core/src/engine/transitions/invariants/`\n  - NoOrphanedModifiers, LayerStackNotEmpty, etc.\n  - Purpose: Common validations\n  - _Leverage: Invariant trait_\n  - _Requirements: 3.1_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer implementing invariants | Task: Implement core state invariants | Restrictions: Cover all critical invariants | _Leverage: Invariant trait | Success: Key invariants enforced | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 9. Create StateValidator\n  - File: `core/src/engine/transitions/validator.rs`\n  - Combine invariants\n  - Add debug-only extra validation\n  - Purpose: Comprehensive validation\n  - _Leverage: Invariant implementations_\n  - _Requirements: 3.1, 3.3, 3.4_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating validator | Task: Create StateValidator combining invariants | Restrictions: Debug extra checks, clear errors | _Leverage: Invariants | Success: All invariants checked | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 4: Logging\n\n- [ ] 10. Create TransitionEntry type\n  - File: `core/src/engine/transitions/log.rs`\n  - State before/after, transition, timing\n  - Serializable for export\n  - Purpose: Log entry structure\n  - _Leverage: serde_\n  - _Requirements: 4.1, 4.2_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating types | Task: Create TransitionEntry for logging | Restrictions: Complete state capture, serializable | _Leverage: serde | Success: Entries capture all info | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 11. Create TransitionLog\n  - File: `core/src/engine/transitions/log.rs`\n  - Ring buffer implementation\n  - Search and export\n  - Purpose: Transition history\n  - _Leverage: Ring buffer patterns_\n  - _Requirements: 4.1, 4.2, 4.3_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer creating logger | Task: Create TransitionLog with ring buffer | Restrictions: Bounded memory, searchable, exportable | _Leverage: Ring buffer | Success: History tracked efficiently | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 12. Add zero-cost disable\n  - File: `core/src/engine/transitions/log.rs`\n  - Feature flag for logging\n  - Compile-time removal when disabled\n  - Purpose: Zero overhead option\n  - _Leverage: Feature flags_\n  - _Requirements: 4.4_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer optimizing | Task: Add feature flag for zero-cost log disable | Restrictions: Compile-time removal, zero overhead | _Leverage: Feature flags | Success: No overhead when disabled | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 5: Integration\n\n- [ ] 13. Integrate StateGraph into Engine\n  - Files: `core/src/engine/mod.rs`\n  - Route all changes through graph\n  - Add validation on transitions\n  - Purpose: Engine integration\n  - _Leverage: StateGraph_\n  - _Requirements: 2.4, 3.1_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer integrating | Task: Integrate StateGraph into Engine | Restrictions: All changes through graph, validate | _Leverage: StateGraph | Success: Engine uses state graph | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 14. Add transition logging\n  - Files: `core/src/engine/mod.rs`\n  - Log all transitions when enabled\n  - Add FFI export for log\n  - Purpose: Debugging support\n  - _Leverage: TransitionLog_\n  - _Requirements: 4.1, 4.3_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer adding logging | Task: Add transition logging to engine | Restrictions: Configurable, FFI export | _Leverage: TransitionLog | Success: Transitions logged for debugging | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n## Phase 6: Consolidation\n\n- [ ] 15. Merge duplicate EngineState definitions\n  - Files: `core/src/engine/advanced.rs`, `core/src/engine/mod.rs`\n  - Create single canonical definition\n  - Update all references\n  - Purpose: Remove duplication\n  - _Leverage: Consolidation plan_\n  - _Requirements: 1.4_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer consolidating | Task: Merge duplicate EngineState definitions | Restrictions: Single definition, update all refs | _Leverage: Plan | Success: One EngineState definition | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 16. Extract common SessionState\n  - Files: `core/src/engine/recording.rs`, `core/src/engine/replay.rs`\n  - Create shared SessionState base\n  - Compose into Recording/ReplayState\n  - Purpose: Remove duplication\n  - _Leverage: Consolidation plan_\n  - _Requirements: 1.4_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer consolidating | Task: Extract common SessionState for recording/replay | Restrictions: Composition over inheritance | _Leverage: Plan | Success: Shared session state | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n\n- [ ] 17. Add state transition tests\n  - File: `core/tests/unit/engine/state_transitions_test.rs`\n  - Test all valid transitions\n  - Test invalid transition rejection\n  - Purpose: Verify state machine\n  - _Leverage: StateGraph_\n  - _Requirements: 2.3_\n  - _Prompt: Implement the task for spec state-machine-audit, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Test Developer | Task: Create state transition tests | Restrictions: All transitions, valid and invalid | _Leverage: StateGraph | Success: All transitions tested | After completion: Mark task [-] as in-progress before starting, use log-implementation tool to record artifacts, then mark [x] when complete_\n",
  "fileStats": {
    "size": 12420,
    "lines": 166,
    "lastModified": "2025-12-03T14:13:34.695Z"
  },
  "comments": []
}