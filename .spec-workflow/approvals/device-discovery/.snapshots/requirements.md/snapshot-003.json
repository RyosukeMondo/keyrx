{
  "id": "snapshot_1764491427771_fgjg9djfx",
  "approvalId": "approval_1764490399671_f2pv1jpiw",
  "approvalTitle": "Requirements document for device-discovery",
  "version": 3,
  "timestamp": "2025-11-30T08:30:27.771Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nDevice Discovery adds a first-run and on-demand workflow that maps physical keyboards to KeyRx’s blank-canvas model. It guides users through identifying new keyboards, captures physical positions (row/column) per key, and persists per-device profiles so remapping logic can be consistent across OS layouts. The feature must be CLI-first with hooks for future GUI integration, fail-safe, and fast enough to run during normal setup.\n\n## Alignment with Product Vision\n\n- Reinforces the “True Blank Canvas” pillar by treating every keyboard as a grid of buttons, not predefined key names.\n- Supports “Safety First” by ensuring discovery cannot lock users out and keeps an emergency exit intact.\n- Advances “CLI First” by making discovery fully operable headless before GUI surfaces.\n- Enables “Testable Configs” by producing deterministic device profiles usable in simulation and replay flows.\n\n## Requirements\n\n### Requirement 1: Detect and prompt for unknown devices\n\n**User Story:** As a power user connecting a keyboard for the first time, I want KeyRx to recognize it and offer to discover its layout so I can remap by physical position without manual config digging.\n\n#### Acceptance Criteria\n\n1. WHEN a keyboard with (vendor_id, product_id) not in the registry is connected THEN the CLI SHALL prompt to start discovery (with skip/defer option) within 2 seconds.\n2. IF the user skips discovery THEN the system SHALL load the fallback default profile and continue running without blocking input.\n3. WHEN a known device reconnects THEN the system SHALL load its saved profile automatically without re-prompting.\n\n### Requirement 2: Guided physical layout capture\n\n**User Story:** As a user running discovery, I want a guided sequence to press keys in order so KeyRx can map each physical position accurately.\n\n#### Acceptance Criteria\n\n1. WHEN discovery starts THEN the system SHALL display progress (current row/column or key count) and expected next key prompt.\n2. IF a key press is ambiguous or duplicated THEN the system SHALL surface a clear error and require re-press without corrupting prior progress.\n3. WHEN the user completes all required positions THEN the system SHALL summarize the discovered grid (rows, cols, unmapped keys) and ask for confirmation before saving.\n\n### Requirement 3: Per-device profile persistence and retrieval\n\n**User Story:** As a user with multiple keyboards, I want each device to keep its own discovered profile so switching devices is seamless.\n\n#### Acceptance Criteria\n\n1. WHEN discovery is confirmed THEN the system SHALL write a JSON profile under `~/.config/keyrx/devices/{vendor_id}_{product_id}.json` including scan_code→position mapping, dimensions, alias metadata, and timestamp.\n2. WHEN the same device reconnects THEN the system SHALL load the stored profile and validate schema version before use; on version mismatch it SHALL fallback to default and prompt for re-discovery.\n3. IF profile loading fails (corruption, missing file) THEN the system SHALL log the failure, fall back to default, and prompt for optional re-discovery without crashing.\n\n### Requirement 4: Re-discovery and edits\n\n**User Story:** As a user whose keyboard changed (firmware/layout), I want to rerun discovery or edit aliases without losing the original profile history.\n\n#### Acceptance Criteria\n\n1. WHEN the user invokes `keyrx discover --device {vendor_id}:{product_id}` THEN the system SHALL run discovery using existing dimensions as defaults and create a new versioned profile file on save.\n2. WHEN aliases are edited (e.g., naming keys) THEN the system SHALL update the profile while preserving scan_code and position integrity.\n3. IF re-discovery is canceled mid-process THEN the system SHALL keep the previous profile active and discard partial data.\n\n### Requirement 5: Safety and interoperability\n\n**User Story:** As a safety-conscious user, I want discovery to be non-intrusive and respect the emergency exit combo.\n\n#### Acceptance Criteria\n\n1. DURING discovery the emergency exit combo (Ctrl+Alt+Shift+Esc) SHALL always bypass the discovery flow and restore normal input handling.\n2. WHEN discovery is running THEN the system SHALL not intercept non-discovery keyboards/mice; only the target device events are captured exclusively.\n3. Discovery SHALL operate headless via CLI and expose hooks/events for GUI visualization without duplicating logic.\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- Single responsibility per file (driver detection, discovery flow controller, profile persistence, CLI command).\n- Discovery logic reusable by both CLI and future GUI via shared Rust module.\n- Clear trait-based boundaries for input sources and persistence to allow mocking in tests.\n\n### Performance\n- New device prompt within 2 seconds of connection.\n- Full discovery session for 104-key layouts completes in < 90 seconds with responsive prompts.\n- Profile load overhead under 5 ms on reconnect.\n\n### Security\n- No elevated privileges beyond existing driver requirements; never executes user-supplied scripts during discovery.\n- Profiles stored under user config directory with sanitized filenames and validated JSON schema.\n\n### Reliability\n- Discovery flow recoverable after interruption; partial progress does not corrupt existing profiles.\n- Corrupt profiles fall back to default without panics and emit actionable diagnostics.\n- Deterministic replay hooks for discovery sessions to support testing.\n\n### Usability\n- CLI prompts are concise with progress indicators and clear retry guidance.\n- Summary confirmation before saving changes.\n- Default fallback ensures users retain keyboard control even if discovery fails.\n",
  "fileStats": {
    "size": 5747,
    "lines": 91,
    "lastModified": "2025-11-30T08:13:16.186Z"
  },
  "comments": []
}