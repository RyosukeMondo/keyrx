{
  "id": "snapshot_1766587814135_0mrcchuwc",
  "approvalId": "approval_1766586998328_gg4xdxtys",
  "approvalTitle": "Requirements: Windows Platform Support",
  "version": 2,
  "timestamp": "2025-12-24T14:50:14.135Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements: Windows Platform Support\n\n**Spec Name**: windows-platform-support\n**Created**: 2024-12-24\n**Status**: Draft\n**Version**: 0.1.0\n\n---\n\n## Overview\n\n### Problem Statement\n\nKeyRx currently supports Linux only (via evdev/uinput), limiting adoption to ~3% of desktop users. Windows represents ~73% of desktop market share and includes the majority of competitive gamers and professional power users—the primary target audience for sub-millisecond keyboard remapping.\n\n**Current Gap**: Windows users cannot use KeyRx despite having the same need for low-latency keyboard customization.\n\n### Business Value\n\n- **Market Expansion**: Access to 73% of desktop users (Windows) vs current 3% (Linux)\n- **Target User Alignment**: Competitive gamers primarily use Windows\n- **Feature Parity**: Achieve cross-platform consistency for v0.2.0 release\n- **Competitive Positioning**: Match competitors (AutoHotkey, PowerToys) while delivering superior latency\n\n### Success Criteria\n\n**Technical**:\n- ✅ <1ms end-to-end remapping latency on Windows (same as Linux target)\n- ✅ Feature parity: All core features work identically on Windows and Linux\n- ✅ 95% test coverage for Windows-specific code\n- ✅ CI/CD builds for Windows x86_64 (windows-msvc target)\n\n**User Experience**:\n- ✅ Installation: Single .exe file (portable) or MSI installer\n- ✅ Configuration: Same .krx files work on both platforms\n- ✅ Control: System tray icon for quick start/stop/reload\n\n**Performance**:\n- ✅ Latency: <1ms processing time (keyboard input → remapped output)\n- ✅ Resource usage: <50MB RAM, <1% CPU idle\n\n---\n\n## User Stories\n\n### Epic 1: Windows Keyboard Interception\n\n#### US-1.1: As a Windows user, I want keyboard events intercepted before applications see them\n\n**Acceptance Criteria**:\n- WHEN I run `keyrx_daemon.exe run --config my-config.krx`\n- THEN the daemon installs a low-level keyboard hook (WH_KEYBOARD_LL)\n- AND all keyboard events are intercepted before reaching applications\n- AND hook installation succeeds within 100ms\n\n**EARS Criteria**:\n- **Event**: User starts daemon with valid config file\n- **Action**: Install Windows keyboard hook (SetWindowsHookEx)\n- **Response**: Hook handle returned, all keyboard events routed to callback\n- **State**: N/A (stateless installation)\n\n**Priority**: P0 (Critical)\n**Estimated Effort**: 3 days\n\n---\n\n#### US-1.2: As a Windows user, I want the daemon to release keyboard hooks cleanly on exit\n\n**Acceptance Criteria**:\n- WHEN I close the daemon (tray icon \"Exit\" or Ctrl+C)\n- THEN the keyboard hook is uninstalled (UnhookWindowsHookEx)\n- AND keyboard events return to normal OS routing\n- AND cleanup completes within 50ms\n\n**EARS Criteria**:\n- **Event**: User triggers daemon shutdown (exit command, SIGTERM, or window close)\n- **Action**: Call UnhookWindowsHookEx with hook handle\n- **Response**: Hook removed, events pass through unmodified\n- **State**: Hook must be installed (cannot unhook if not hooked)\n\n**Priority**: P0 (Critical)\n**Estimated Effort**: 1 day\n\n---\n\n### Epic 2: Virtual Key Code Mapping\n\n#### US-2.1: As a Windows user, I want Windows Virtual Key codes mapped to KeyRx KeyCode enum\n\n**Acceptance Criteria**:\n- WHEN a keyboard event arrives with a Virtual Key code (e.g., VK_A = 0x41)\n- THEN it is mapped to the corresponding KeyRx KeyCode (e.g., KeyCode::A)\n- AND all standard keys are supported (letters, numbers, modifiers, function keys)\n- AND unsupported keys are logged with warning (not crash)\n\n**EARS Criteria**:\n- **Event**: Windows keyboard hook receives KBDLLHOOKSTRUCT with vkCode\n- **Action**: Look up vkCode in bidirectional mapping table\n- **Response**: Return corresponding KeyCode variant\n- **State**: N/A (stateless lookup)\n\n**Priority**: P0 (Critical)\n**Estimated Effort**: 2 days\n\n---\n\n#### US-2.2: As a developer, I want comprehensive tests for all Virtual Key mappings\n\n**Acceptance Criteria**:\n- WHEN I run the test suite\n- THEN all standard VK codes (letters A-Z, numbers 0-9, modifiers, function keys) have tests\n- AND edge cases (unmapped codes, extended keys) are tested\n- AND bidirectional mapping is verified (VK→KeyCode→VK roundtrip)\n\n**EARS Criteria**:\n- **Event**: Test execution\n- **Action**: Test all VK_* constants against mapping table\n- **Response**: All mappings verified correct, edge cases handled\n- **State**: N/A\n\n**Priority**: P1 (High)\n**Estimated Effort**: 1 day\n\n---\n\n### Epic 3: Event Injection\n\n#### US-3.1: As a Windows user, I want remapped keys injected into the input stream\n\n**Acceptance Criteria**:\n- WHEN a key is remapped (e.g., CapsLock → Escape)\n- THEN the output key event is injected via SendInput API\n- AND the injected event appears to applications as a real keyboard press\n- AND injection latency is <100μs\n\n**EARS Criteria**:\n- **Event**: Remapping logic outputs KeyCode (e.g., KeyCode::Escape)\n- **Action**: Convert KeyCode to VK code, create INPUT structure, call SendInput\n- **Response**: Event injected, applications receive remapped key\n- **State**: Original event must be blocked (hook returns 1)\n\n**Priority**: P0 (Critical)\n**Estimated Effort**: 2 days\n\n---\n\n#### US-3.2: As a Windows user, I want modifier states (Shift, Ctrl, Alt, Win) preserved during remapping\n\n**Acceptance Criteria**:\n- WHEN I hold Shift and press a remapped key\n- THEN the Shift modifier is preserved in the output\n- AND modified output keys include correct modifier flags\n- AND modifier-only keys (Shift down/up) are handled correctly\n\n**EARS Criteria**:\n- **Event**: Keyboard event with modifier flags set (e.g., Shift held)\n- **Action**: Extract modifier state, apply to remapped output\n- **Response**: Output event includes correct modifier flags\n- **State**: Modifier state tracked across events\n\n**Priority**: P0 (Critical)\n**Estimated Effort**: 2 days\n\n---\n\n### Epic 4: System Tray Integration\n\n#### US-4.1: As a Windows user, I want a system tray icon to control the daemon\n\n**Acceptance Criteria**:\n- WHEN the daemon starts\n- THEN a tray icon appears in the Windows system tray\n- AND the icon shows daemon status (active/inactive)\n- AND hovering shows tooltip: \"KeyRx Daemon - Active\"\n\n**EARS Criteria**:\n- **Event**: Daemon startup completes\n- **Action**: Create tray icon with Shell_NotifyIcon API\n- **Response**: Icon appears in system tray notification area\n- **State**: N/A\n\n**Priority**: P1 (High)\n**Estimated Effort**: 2 days\n\n---\n\n#### US-4.2: As a Windows user, I want a tray context menu for daemon control\n\n**Acceptance Criteria**:\n- WHEN I right-click the tray icon\n- THEN a context menu appears with options:\n  - \"Reload Config\" (re-reads .krx file without restart)\n  - \"Exit\" (cleanly shuts down daemon)\n- AND selecting \"Reload Config\" reloads the configuration\n- AND selecting \"Exit\" terminates the daemon\n\n**EARS Criteria**:\n- **Event**: User right-clicks tray icon\n- **Action**: Display TrackPopupMenu with menu items\n- **Response**: Menu appears, user selection triggers corresponding action\n- **State**: N/A\n\n**Priority**: P1 (High)\n**Estimated Effort**: 2 days\n\n---\n\n### Epic 5: Platform Abstraction\n\n#### US-5.1: As a developer, I want Windows-specific code isolated behind the Platform trait\n\n**Acceptance Criteria**:\n- WHEN I examine the codebase\n- THEN Windows-specific code is in `keyrx_daemon/src/platform/windows.rs`\n- AND it implements the `Platform` trait (input/output device interfaces)\n- AND no Windows-specific code leaks into cross-platform modules\n\n**EARS Criteria**:\n- **Event**: Code inspection\n- **Action**: Verify module boundaries and trait implementation\n- **Response**: Clean separation of concerns confirmed\n- **State**: N/A\n\n**Priority**: P0 (Critical)\n**Estimated Effort**: 1 day (refactoring existing stub)\n\n---\n\n### Epic 6: Configuration Compatibility\n\n#### US-6.1: As a Windows user, I want to use the same .krx config files as Linux\n\n**Acceptance Criteria**:\n- WHEN I copy a .krx file from Linux to Windows\n- THEN the daemon loads it successfully\n- AND all mappings work identically\n- AND device-specific configs match by device name (not Linux-specific paths)\n\n**EARS Criteria**:\n- **Event**: User provides .krx file path via --config argument\n- **Action**: Load file via rkyv deserialization (platform-agnostic)\n- **Response**: Configuration loaded, mappings active\n- **State**: N/A\n\n**Priority**: P0 (Critical)\n**Estimated Effort**: 1 day (verification only, already implemented in core)\n\n---\n\n### Epic 7: Testing & Quality\n\n#### US-7.1: As a developer, I want automated tests for Windows-specific code\n\n**Acceptance Criteria**:\n- WHEN I run `cargo test --target x86_64-pc-windows-msvc`\n- THEN all Windows-specific tests pass\n- AND test coverage is ≥95% for `platform/windows.rs`\n- AND tests include:\n  - Hook installation/cleanup\n  - VK code mapping (all standard keys)\n  - Event injection\n  - Tray icon creation/destruction\n\n**EARS Criteria**:\n- **Event**: CI/CD pipeline executes tests\n- **Action**: Run test suite on Windows target\n- **Response**: All tests pass, coverage meets threshold\n- **State**: N/A\n\n**Priority**: P1 (High)\n**Estimated Effort**: 3 days\n\n---\n\n#### US-7.2: As a developer, I want CI/CD builds for Windows binaries\n\n**Acceptance Criteria**:\n- WHEN code is pushed to main branch\n- THEN GitHub Actions builds Windows x86_64 binary\n- AND binary is uploaded as release artifact\n- AND release workflow creates GitHub release on version tags\n\n**EARS Criteria**:\n- **Event**: Git push to main or tag creation\n- **Action**: GitHub Actions workflow builds with `--target x86_64-pc-windows-msvc`\n- **Response**: Binary artifact created, release published (on tags)\n- **State**: N/A\n\n**Priority**: P2 (Medium)\n**Estimated Effort**: 1 day (workflow already exists, needs verification)\n\n---\n\n## Non-Functional Requirements\n\n### NFR-1: Performance\n\n**Latency Budget**:\n- Hook processing: <50μs\n- KeyCode mapping: <10μs\n- Event injection: <50μs\n- **Total end-to-end**: <1ms (matching Linux target)\n\n**Resource Usage**:\n- Memory: <50MB RAM (excluding config file size)\n- CPU: <1% idle, <5% under 1000 events/sec load\n\n---\n\n### NFR-2: Compatibility\n\n**Windows Versions**:\n- Windows 10 (version 1909+)\n- Windows 11 (all versions)\n\n**Architecture**:\n- x86_64 only (no ARM/x86 initially)\n\n---\n\n### NFR-3: Reliability\n\n**Error Handling**:\n- Hook installation failures logged with actionable error messages\n- Config file errors prevent daemon start (fail-fast)\n- Graceful degradation: If tray icon fails, daemon continues via CLI\n\n**Crash Recovery**:\n- Hooks must be cleaned up even on panic (Drop trait implementation)\n\n---\n\n### NFR-4: Security\n\n**Privileges**:\n- No admin rights required for basic operation\n- Hook installation works in user context\n- Config files validated before loading (prevent code injection via malformed .krx)\n\n**Anti-Cheat Compatibility**:\n- Document limitations: Some games with kernel-level anti-cheat may detect hooks\n- Provide workaround: Suspend remapping (future feature)\n\n---\n\n## Out of Scope (v0.2.0)\n\n### Deferred to Later Versions\n\n- **Kernel-mode driver**: Low-level hooks are sufficient for v0.2.0\n- **Web UI**: Focus on tray icon, defer web interface to v0.3.0\n- **MSI installer**: Portable .exe first, installer in v0.3.0\n- **Gaming mode**: Suspend/resume feature deferred to v0.3.0\n- **Per-application configs**: Window title-based rules deferred to v0.3.0\n- **macOS support**: Not planned (Windows + Linux sufficient for target users)\n\n---\n\n## Dependencies\n\n### External Dependencies\n\n- **Windows SDK**: For Win32 API headers (provided by windows-sys crate)\n- **Rust toolchain**: MSVC target (x86_64-pc-windows-msvc)\n\n### Internal Dependencies\n\n- **keyrx_core**: Platform-agnostic logic (already implemented)\n- **keyrx_compiler**: .krx generation (already implemented)\n\n---\n\n## Assumptions & Constraints\n\n### Assumptions\n\n1. Users have Windows 10 1909+ or Windows 11\n2. Users have basic CLI familiarity (`cmd.exe` or PowerShell)\n3. Standard keyboard layouts (QWERTY, AZERTY, etc.) are used\n4. No conflicting keyboard hooks from other software (e.g., AutoHotkey)\n\n### Constraints\n\n1. Low-level hooks have limitations:\n   - Cannot intercept secure desktop (UAC prompts, lock screen)\n   - Some anti-cheat software blocks hooks\n   - Requires message loop (event loop integration)\n\n2. Development constraints:\n   - 3-week timeline for v0.2.0\n   - No budget for driver code signing ($300-500/year)\n\n---\n\n## Risks & Mitigations\n\n### Risk 1: Hook Latency Higher Than Expected\n\n**Likelihood**: Low\n**Impact**: High (defeats core value proposition)\n\n**Mitigation**:\n- Benchmark early (Week 1)\n- If >1ms, escalate immediately\n- Fallback: Document as \"Windows beta\" with known latency\n\n---\n\n### Risk 2: Anti-Cheat Software Blocks Hooks\n\n**Likelihood**: Medium\n**Impact**: Medium (limits gaming use case)\n\n**Mitigation**:\n- Document known incompatibilities\n- Provide toggle to disable hooks (future feature)\n- Target professional users first, gamers second\n\n---\n\n### Risk 3: Tray Icon Library Lacks Windows Support\n\n**Likelihood**: Low\n**Impact**: Low (can fallback to CLI-only)\n\n**Mitigation**:\n- Verify tray-icon crate on Windows during Week 1\n- Fallback: CLI-only control if tray fails\n\n---\n\n## Acceptance Criteria Summary\n\n**Definition of Done**:\n- [ ] All P0 user stories implemented and tested\n- [ ] Windows binary builds in CI/CD\n- [ ] Test coverage ≥95% for platform/windows.rs\n- [ ] Latency <1ms end-to-end verified via benchmarks\n- [ ] Documentation updated (README, Windows setup guide)\n- [ ] Tray icon functional with reload/exit menu\n- [ ] Same .krx files work on Windows and Linux\n\n---\n\n## References\n\n- [Windows Implementation Options RFC](../../../docs/rfcs/windows-implementation-options.md)\n- [Product Steering Doc](../../steering/product.md)\n- [Tech Steering Doc](../../steering/tech.md)\n- Windows API Documentation: https://learn.microsoft.com/en-us/windows/win32/\n- tray-icon crate: https://docs.rs/tray-icon/\n\n---\n\n**Document Status**: Ready for Review\n",
  "fileStats": {
    "size": 13906,
    "lines": 456,
    "lastModified": "2025-12-24T14:31:55.818Z"
  },
  "comments": []
}