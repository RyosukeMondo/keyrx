{
  "id": "snapshot_1764768195962_xrjigup54",
  "approvalId": "approval_1764767191192_4b9h16hho",
  "approvalTitle": "Validation Decomposition - Requirements",
  "version": 2,
  "timestamp": "2025-12-03T13:23:15.962Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThe validation module contains `conflicts.rs` at 1,321 LOC with 61 functions handling three distinct concerns: remap/block conflict detection, combo shadowing detection, and circular dependency detection. Additionally, 44% of the file is inline tests. This spec decomposes the monolithic file into focused submodules with clear separation of concerns.\n\n## Alignment with Product Vision\n\nThis feature supports KeyRx's product principles:\n- **Safety First**: Validation is critical for user trust; it must be maintainable\n- **Testable Configs**: Modular validators enable targeted testing\n- **Visual > Abstract**: Clear module boundaries make validation pipeline visible\n\nPer tech.md: \"Single Responsibility Principle: Each file should have a single, well-defined purpose\"\n\n## Requirements\n\n### Requirement 1: Conflict Detection Module\n\n**User Story:** As a developer, I want remap/block conflict detection in its own module, so that I can understand and modify conflict logic without wading through combo and cycle code.\n\n#### Acceptance Criteria\n\n1. WHEN two remaps target the same key THEN the detector SHALL report a conflict\n2. IF a remap conflicts with a block THEN both operations SHALL be listed in the error\n3. WHEN conflicts are detected THEN the report SHALL include source locations\n4. IF no conflicts exist THEN the detector SHALL return an empty result efficiently\n\n### Requirement 2: Combo Shadowing Module\n\n**User Story:** As a developer, I want combo shadowing detection separate from general conflict detection, so that I can optimize shadowing algorithms independently.\n\n#### Acceptance Criteria\n\n1. WHEN a combo's keys are individually remapped THEN shadowing SHALL be detected\n2. IF a combo shadows another combo THEN both combos SHALL be reported\n3. WHEN analyzing shadowing THEN the detector SHALL consider key ordering\n4. IF shadowing analysis is expensive THEN it SHALL be skippable via flag\n\n### Requirement 3: Circular Dependency Module\n\n**User Story:** As a developer, I want circular remap detection in its own module, so that graph algorithms are isolated and testable.\n\n#### Acceptance Criteria\n\n1. WHEN A remaps to B and B remaps to A THEN a cycle SHALL be detected\n2. IF cycles involve more than 2 keys THEN the full cycle path SHALL be reported\n3. WHEN detecting cycles THEN the algorithm SHALL use efficient graph traversal\n4. IF no cycles exist THEN the check SHALL complete in O(n) time\n\n### Requirement 4: Test Extraction\n\n**User Story:** As a test developer, I want validation tests in dedicated test files, so that source files are focused on implementation.\n\n#### Acceptance Criteria\n\n1. WHEN tests exist inline THEN they SHALL be moved to `validation/tests/`\n2. IF tests require internal access THEN the module SHALL expose `#[cfg(test)]` helpers\n3. WHEN running tests THEN all existing tests SHALL pass without modification\n4. IF new tests are added THEN they SHALL go in the appropriate test module\n\n### Requirement 5: Shared Utilities Extraction\n\n**User Story:** As a developer, I want shared validation utilities in a common module, so that conflict, shadowing, and cycle detectors can reuse code.\n\n#### Acceptance Criteria\n\n1. WHEN multiple detectors traverse operations THEN a shared `OperationVisitor` SHALL be used\n2. IF error types are shared THEN they SHALL live in `validation/error.rs`\n3. WHEN building reports THEN a common `ReportBuilder` SHALL be available\n4. IF location tracking is needed THEN `Span` type SHALL be shared\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Each file handles one detection concern\n- **Modular Design**: Detectors are pluggable into validation engine\n- **Dependency Management**: Detectors don't import each other directly\n- **Clear Interfaces**: `Detector` trait defines common interface\n\n### Performance\n- Conflict detection SHALL complete in O(n) for n operations\n- Cycle detection SHALL use DFS with O(V+E) complexity\n- Memory usage SHALL not exceed O(n) for intermediate state\n\n### Security\n- Validation SHALL not execute user scripts\n- Error messages SHALL not leak file system paths outside project\n\n### Reliability\n- All existing validation behavior SHALL be preserved\n- No new validation false positives or negatives\n\n### Usability\n- Each detector module SHALL be < 400 LOC\n- Adding a new detector SHALL require < 100 LOC boilerplate\n",
  "fileStats": {
    "size": 4431,
    "lines": 97,
    "lastModified": "2025-12-03T12:59:42.561Z"
  },
  "comments": []
}