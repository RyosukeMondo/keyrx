{
  "id": "snapshot_1764716258241_rb4dg7360",
  "approvalId": "approval_1764716188086_9l1iexo8y",
  "approvalTitle": "Wire Every Remaining Feature - Design Document",
  "version": 2,
  "timestamp": "2025-12-02T22:57:38.241Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design implements a two-tier Flutter UI that exposes all CLI functionality while maintaining a clean separation between User and Developer interfaces. The User interface provides essential features for daily usage, while Developer Tools contains advanced debugging, testing, and analysis capabilities.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **FFI Bridge**: Extends `ui/lib/ffi/bridge.dart` with new bindings\n- **Flutter Architecture**: Follows existing page/widget/service patterns\n- **Cross-Platform**: All features work on Linux and Windows\n- **State Management**: Uses existing AppState patterns\n\n### Project Structure (structure.md)\n\n```\nui/lib/\n├── main.dart                       # MODIFY: Add developer mode toggle\n├── ffi/\n│   ├── bindings.dart              # MODIFY: Add new FFI signatures\n│   └── bridge.dart                # MODIFY: Add new bridge methods\n├── pages/\n│   ├── devices_page.dart          # NEW: Device selection\n│   ├── run_controls_page.dart     # NEW: Engine control panel\n│   ├── developer/                 # NEW: Developer tools directory\n│   │   ├── test_runner_page.dart\n│   │   ├── simulator_page.dart\n│   │   ├── analyzer_page.dart\n│   │   ├── benchmark_page.dart\n│   │   ├── doctor_page.dart\n│   │   ├── replay_page.dart\n│   │   └── discovery_page.dart\n│   └── editor_page.dart           # MODIFY: Add validation\n├── services/\n│   ├── device_service.dart        # NEW: Device management\n│   ├── test_service.dart          # NEW: Test runner\n│   ├── simulation_service.dart    # NEW: Key simulation\n│   ├── session_service.dart       # NEW: Replay/analyze\n│   ├── benchmark_service.dart     # NEW: Benchmarking\n│   └── doctor_service.dart        # NEW: Diagnostics\n├── state/\n│   └── app_state.dart             # MODIFY: Add developer mode\n└── widgets/\n    ├── developer_drawer.dart      # NEW: Developer navigation\n    └── virtual_keyboard.dart      # NEW: For simulator\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`ui/lib/ffi/bridge.dart`**: FFI bridge pattern - extend with new methods\n- **`ui/lib/services/engine_service.dart`**: Service pattern - create similar services\n- **`ui/lib/state/app_state.dart`**: State management - add developer mode flag\n- **`ui/lib/pages/debugger_page.dart`**: Page layout pattern - follow for new pages\n- **`ui/lib/widgets/keyboard.dart`**: Virtual keyboard - extend for simulator\n\n### Integration Points\n\n- **Rust CLI Commands**: Each CLI command maps to an FFI function\n- **Existing Navigation**: Main NavigationRail extended with Devices, Run Controls\n- **Developer Drawer**: New drawer component for developer tools\n\n## Architecture\n\n### Navigation Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                              Main App Shell                                  │\n│  ┌─────────────────────────────────────────────────────────────────────────┐│\n│  │                         AppBar                                          ││\n│  │  [KeyRx Logo]                              [Developer Tools ⚙️]          ││\n│  └─────────────────────────────────────────────────────────────────────────┘│\n│  ┌────────────┐  ┌──────────────────────────────────────────────────────────┐│\n│  │            │  │                                                          ││\n│  │ Navigation │  │                    Content Area                          ││\n│  │   Rail     │  │                                                          ││\n│  │            │  │  ┌────────────────────────────────────────────────────┐ ││\n│  │ ┌────────┐ │  │  │                                                    │ ││\n│  │ │Training│ │  │  │            Active Page Content                     │ ││\n│  │ └────────┘ │  │  │                                                    │ ││\n│  │ ┌────────┐ │  │  │                                                    │ ││\n│  │ │ Editor │ │  │  └────────────────────────────────────────────────────┘ ││\n│  │ └────────┘ │  │                                                          ││\n│  │ ┌────────┐ │  └──────────────────────────────────────────────────────────┘│\n│  │ │Devices │ │                                                              │\n│  │ └────────┘ │  Developer Drawer (slides from right when toggled)          │\n│  │ ┌────────┐ │  ┌──────────────────────────────────────────────────────────┐│\n│  │ │  Run   │ │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     ││\n│  │ └────────┘ │  │ │ Debugger │ │ Console  │ │  Test    │ │ Simulate │     ││\n│  │            │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘     ││\n│  └────────────┘  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     ││\n│                  │ │ Analyze  │ │  Bench   │ │  Doctor  │ │  Replay  │     ││\n│                  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘     ││\n│                  │ ┌──────────┐                                             ││\n│                  │ │ Discover │                                             ││\n│                  │ └──────────┘                                             ││\n│                  └──────────────────────────────────────────────────────────┘│\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n### FFI Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                           Flutter UI Layer                                   │\n│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │\n│  │ DevicePage  │  │ TestRunner  │  │ Simulator   │  │ Analyzer    │        │\n│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │\n│         │                │                │                │                │\n│         ▼                ▼                ▼                ▼                │\n│  ┌─────────────────────────────────────────────────────────────────────────┐│\n│  │                         Service Layer                                   ││\n│  │  DeviceService  TestService  SimulationService  SessionService  ...    ││\n│  └─────────────────────────────────────────────────────────────────────────┘│\n│                                    │                                        │\n│                                    ▼                                        │\n│  ┌─────────────────────────────────────────────────────────────────────────┐│\n│  │                      FFI Bridge (bridge.dart)                           ││\n│  │  listDevices()  runTests()  simulate()  analyzeSession()  ...          ││\n│  └─────────────────────────────────────────────────────────────────────────┘│\n│                                    │                                        │\n│                                    ▼ FFI                                    │\n└────────────────────────────────────┼────────────────────────────────────────┘\n                                     │\n┌────────────────────────────────────┼────────────────────────────────────────┐\n│                           Rust Core (libkeyrx)                              │\n│                                    │                                        │\n│  ┌─────────────────────────────────────────────────────────────────────────┐│\n│  │                       FFI Exports (ffi/mod.rs)                          ││\n│  │  keyrx_list_devices()  keyrx_run_tests()  keyrx_simulate()  ...        ││\n│  └─────────────────────────────────────────────────────────────────────────┘│\n│                                    │                                        │\n│                                    ▼                                        │\n│  ┌─────────────────────────────────────────────────────────────────────────┐│\n│  │                        CLI Command Implementations                       ││\n│  │  devices.rs  test.rs  simulate.rs  analyze.rs  bench.rs  doctor.rs     ││\n│  └─────────────────────────────────────────────────────────────────────────┘│\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n### Modular Design Principles\n\n- **Single Responsibility**: Each page handles one feature\n- **Service Isolation**: Each CLI command gets a dedicated service\n- **Component Reuse**: Virtual keyboard shared between Editor and Simulator\n- **State Separation**: Developer mode state separate from engine state\n\n## Components and Interfaces\n\n### Component 1: FFI Bindings Extension\n\n**Purpose:** Expose CLI commands to Flutter via FFI\n\n**File:** `ui/lib/ffi/bindings.dart` (extend)\n\n**New Signatures:**\n```dart\n// Device management\ntypedef KeyrxListDevices = Pointer<Utf8> Function();\ntypedef KeyrxSelectDevice = Int32 Function(Pointer<Utf8> devicePath);\n\n// Script validation\ntypedef KeyrxCheckScript = Pointer<Utf8> Function(Pointer<Utf8> scriptPath);\n\n// Test runner\ntypedef KeyrxDiscoverTests = Pointer<Utf8> Function(Pointer<Utf8> scriptPath);\ntypedef KeyrxRunTests = Pointer<Utf8> Function(Pointer<Utf8> scriptPath, Pointer<Utf8> filter);\n\n// Simulation\ntypedef KeyrxSimulate = Pointer<Utf8> Function(Pointer<Utf8> keys, Int32 comboMode);\n\n// Session management\ntypedef KeyrxListSessions = Pointer<Utf8> Function();\ntypedef KeyrxAnalyzeSession = Pointer<Utf8> Function(Pointer<Utf8> sessionPath);\ntypedef KeyrxReplaySession = Pointer<Utf8> Function(Pointer<Utf8> sessionPath, Int32 verify);\n\n// Benchmarking\ntypedef KeyrxRunBenchmark = Pointer<Utf8> Function(Int32 iterations);\n\n// Diagnostics\ntypedef KeyrxRunDoctor = Pointer<Utf8> Function();\n\n// Discovery\ntypedef KeyrxStartDiscovery = Pointer<Utf8> Function(Pointer<Utf8> deviceId);\ntypedef KeyrxOnDiscoveryProgress = Void Function(Pointer<Utf8>);\n\n// Recording control\ntypedef KeyrxStartRecording = Int32 Function(Pointer<Utf8> outputPath);\ntypedef KeyrxStopRecording = Pointer<Utf8> Function();\n```\n\n**Dependencies:** Rust FFI exports\n**Reuses:** Existing FFI patterns from bindings.dart\n\n### Component 2: Developer Navigation Drawer\n\n**Purpose:** Provide access to developer tools without cluttering main navigation\n\n**File:** `ui/lib/widgets/developer_drawer.dart` (new)\n\n**Interface:**\n```dart\nclass DeveloperDrawer extends StatelessWidget {\n  final int selectedIndex;\n  final Function(int) onDestinationSelected;\n\n  // Destinations:\n  // 0: Debugger (existing)\n  // 1: Console (existing)\n  // 2: Test Runner\n  // 3: Simulator\n  // 4: Analyzer\n  // 5: Benchmark\n  // 6: Doctor\n  // 7: Replay\n  // 8: Discovery\n}\n```\n\n**Dependencies:** AppState for developer mode\n**Reuses:** NavigationRail styling patterns\n\n### Component 3: Device Service\n\n**Purpose:** Manage keyboard device listing and selection\n\n**File:** `ui/lib/services/device_service.dart` (new)\n\n**Interface:**\n```dart\nclass DeviceService {\n  Future<List<KeyboardDevice>> listDevices();\n  Future<void> selectDevice(String devicePath);\n  Future<bool> hasProfile(String deviceId);\n  Stream<DeviceEvent> get deviceEvents;\n}\n\nclass KeyboardDevice {\n  final String name;\n  final String vendorId;\n  final String productId;\n  final String path;\n  final bool hasProfile;\n}\n```\n\n**Dependencies:** KeyrxBridge\n**Reuses:** EngineService patterns\n\n### Component 4: Test Service\n\n**Purpose:** Discover and run script tests\n\n**File:** `ui/lib/services/test_service.dart` (new)\n\n**Interface:**\n```dart\nclass TestService {\n  Future<List<TestCase>> discoverTests(String scriptPath);\n  Future<TestResults> runTests(String scriptPath, {String? filter});\n  Stream<TestProgress> runTestsStreaming(String scriptPath);\n}\n\nclass TestCase {\n  final String name;\n  final String file;\n  final int lineNumber;\n}\n\nclass TestResult {\n  final String name;\n  final bool passed;\n  final String? error;\n  final Duration duration;\n}\n```\n\n**Dependencies:** KeyrxBridge\n**Reuses:** Service async patterns\n\n### Component 5: Simulation Service\n\n**Purpose:** Simulate key sequences through the engine\n\n**File:** `ui/lib/services/simulation_service.dart` (new)\n\n**Interface:**\n```dart\nclass SimulationService {\n  Future<SimulationResult> simulate(List<KeyInput> keys, {bool comboMode = false});\n}\n\nclass KeyInput {\n  final String keyCode;\n  final int? holdMs;\n}\n\nclass SimulationResult {\n  final List<KeyMapping> mappings;\n  final List<String> activeLayers;\n  final List<PendingDecision> pending;\n}\n\nclass KeyMapping {\n  final String input;\n  final String output;\n  final String decisionType;\n}\n```\n\n**Dependencies:** KeyrxBridge\n**Reuses:** Existing key registry\n\n### Component 6: Session Service\n\n**Purpose:** Manage session replay and analysis\n\n**File:** `ui/lib/services/session_service.dart` (new)\n\n**Interface:**\n```dart\nclass SessionService {\n  Future<List<SessionInfo>> listSessions();\n  Future<SessionAnalysis> analyze(String sessionPath);\n  Stream<ReplayEvent> replay(String sessionPath, {double speed = 0, bool verify = false});\n}\n\nclass SessionInfo {\n  final String path;\n  final String name;\n  final DateTime created;\n  final int eventCount;\n  final Duration duration;\n}\n\nclass SessionAnalysis {\n  final int eventCount;\n  final Duration duration;\n  final Duration avgLatency;\n  final Map<String, int> decisionBreakdown;\n  final List<TimingEvent> timeline;\n}\n```\n\n**Dependencies:** KeyrxBridge\n**Reuses:** Session format from core\n\n### Component 7: Devices Page\n\n**Purpose:** List and select keyboard devices\n\n**File:** `ui/lib/pages/devices_page.dart` (new)\n\n**Interface:**\n```dart\nclass DevicesPage extends StatefulWidget {\n  // Displays list of detected keyboards\n  // Allows selection of active device\n  // Shows profile status badges\n  // Refresh button for re-scan\n}\n```\n\n**Dependencies:** DeviceService\n**Reuses:** ListTile patterns from existing pages\n\n### Component 8: Run Controls Page\n\n**Purpose:** Central engine control panel\n\n**File:** `ui/lib/pages/run_controls_page.dart` (new)\n\n**Interface:**\n```dart\nclass RunControlsPage extends StatefulWidget {\n  // Large Start/Stop button\n  // Device selector dropdown\n  // Script selector\n  // Recording toggle\n  // Status indicators\n}\n```\n\n**Dependencies:** EngineService, DeviceService\n**Reuses:** Existing engine state patterns\n\n### Component 9: Test Runner Page\n\n**Purpose:** Discover and run script tests with results\n\n**File:** `ui/lib/pages/developer/test_runner_page.dart` (new)\n\n**Interface:**\n```dart\nclass TestRunnerPage extends StatefulWidget {\n  // Test list with status indicators\n  // Run All / Run Selected buttons\n  // Filter input\n  // Watch mode toggle\n  // Results panel with error details\n}\n```\n\n**Dependencies:** TestService\n**Reuses:** List patterns from debugger\n\n### Component 10: Simulator Page\n\n**Purpose:** Simulate key sequences visually\n\n**File:** `ui/lib/pages/developer/simulator_page.dart` (new)\n\n**Interface:**\n```dart\nclass SimulatorPage extends StatefulWidget {\n  // Virtual keyboard for key selection\n  // Key sequence display\n  // Hold duration editor\n  // Combo mode toggle\n  // Results showing input → output\n  // Layer/pending state display\n}\n```\n\n**Dependencies:** SimulationService, VirtualKeyboard widget\n**Reuses:** Keyboard widget from editor\n\n## Data Models\n\n### Device Model\n\n```dart\nclass KeyboardDevice {\n  final String name;\n  final String vendorId;\n  final String productId;\n  final String path;\n  final bool hasProfile;\n  final bool isSelected;\n}\n```\n\n### Test Models\n\n```dart\nclass TestCase {\n  final String name;\n  final String file;\n  final int lineNumber;\n  TestStatus status; // pending, running, passed, failed\n}\n\nclass TestResults {\n  final int total;\n  final int passed;\n  final int failed;\n  final Duration duration;\n  final List<TestResult> results;\n}\n```\n\n### Simulation Models\n\n```dart\nclass SimulationInput {\n  final List<KeyInput> keys;\n  final bool comboMode;\n}\n\nclass SimulationOutput {\n  final List<KeyMapping> mappings;\n  final EngineState finalState;\n}\n```\n\n### Session Models\n\n```dart\nclass SessionAnalysis {\n  final SessionMetadata metadata;\n  final LatencyStats latency;\n  final Map<DecisionType, int> decisions;\n  final List<TimelineEvent> timeline;\n}\n\nclass TimelineEvent {\n  final int sequence;\n  final String input;\n  final DecisionType decision;\n  final String output;\n  final Duration latency;\n  final DateTime timestamp;\n}\n```\n\n### Benchmark Models\n\n```dart\nclass BenchmarkConfig {\n  final int iterations;\n  final String? scriptPath;\n}\n\nclass BenchmarkResults {\n  final Duration min;\n  final Duration max;\n  final Duration mean;\n  final Duration p99;\n  final bool hasWarning;\n}\n```\n\n### Doctor Models\n\n```dart\nclass DiagnosticCheck {\n  final String name;\n  final CheckStatus status; // pass, fail, warn\n  final String details;\n  final String? remediation;\n}\n\nclass DiagnosticReport {\n  final List<DiagnosticCheck> checks;\n  final int passed;\n  final int failed;\n  final int warned;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Device not found**\n   - **Handling:** Show empty state with platform-specific troubleshooting\n   - **User Impact:** \"No keyboards detected. [Platform hints]\"\n\n2. **Script validation fails**\n   - **Handling:** Parse error JSON, highlight line in editor\n   - **User Impact:** Error banner with clickable line reference\n\n3. **Test execution error**\n   - **Handling:** Mark test as failed, show error details\n   - **User Impact:** Red status with expandable error message\n\n4. **Session file not found**\n   - **Handling:** Remove from list, show toast notification\n   - **User Impact:** \"Session file no longer exists\"\n\n5. **Benchmark interrupted**\n   - **Handling:** Show partial results with warning\n   - **User Impact:** \"Benchmark incomplete - partial results shown\"\n\n6. **Discovery cancelled**\n   - **Handling:** Discard state, return to devices page\n   - **User Impact:** \"Discovery cancelled - no changes saved\"\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Services**: Mock FFI bridge, test response parsing\n- **State**: Test developer mode toggle, persistence\n- **Models**: Test JSON serialization/deserialization\n\n### Widget Testing\n\n- **DevicesPage**: Test device list rendering, selection\n- **TestRunnerPage**: Test status updates, filter functionality\n- **SimulatorPage**: Test key input, results display\n- **DeveloperDrawer**: Test navigation, state persistence\n\n### Integration Testing\n\n- **FFI Round-trip**: Call FFI → Verify response parsing\n- **Navigation Flow**: User view → Developer tools → Back\n- **Full Workflow**: Select device → Load script → Run → Record → Analyze\n\n## Implementation Sequence\n\n1. **FFI Bindings** - Foundation for all features\n2. **Device Service + Page** - User-facing, enables device selection\n3. **Run Controls Page** - User-facing, central control\n4. **Script Validation** - Editor enhancement\n5. **Developer Drawer** - Navigation for developer tools\n6. **Test Service + Page** - Most commonly needed developer tool\n7. **Simulation Service + Page** - Interactive testing\n8. **Session Service** - Shared by Analyzer and Replay\n9. **Analyzer Page** - Session analysis\n10. **Replay Page** - Session playback\n11. **Benchmark Service + Page** - Performance testing\n12. **Doctor Service + Page** - Diagnostics\n13. **Discovery Page** - Device profile creation\n",
  "fileStats": {
    "size": 23867,
    "lines": 599,
    "lastModified": "2025-12-02T22:56:22.426Z"
  },
  "comments": []
}