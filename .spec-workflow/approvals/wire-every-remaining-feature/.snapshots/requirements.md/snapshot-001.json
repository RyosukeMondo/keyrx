{
  "id": "snapshot_1764715095519_980mcb9ho",
  "approvalId": "approval_1764715095511_n8jn1tdjt",
  "approvalTitle": "Wire Every Remaining Feature - Requirements Document",
  "version": 1,
  "timestamp": "2025-12-02T22:38:15.519Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThis spec bridges the gap between KeyRx's powerful CLI capabilities and the Flutter UI. Currently, only 3 of 12 CLI commands are fully wired to the UI (state, repl, partial run). This leaves 9 essential developer and user features inaccessible from the graphical interface.\n\n**Goal:** Expose all CLI functionality through the Flutter UI, enabling users to perform every operation without touching the command line.\n\n## Alignment with Product Vision\n\nFrom product.md:\n- **CLI First, GUI Later**: CLI is complete; now it's time for \"GUI Later\"\n- **Developer Experience**: Full feature parity between CLI and UI\n- **Visual Debugging**: UI should provide enhanced visualization over CLI\n\nFrom tech.md:\n- **FFI Bridge**: Extend existing `ui/lib/ffi/` bindings for new functionality\n- **Flutter Architecture**: Follow established page/widget patterns\n- **Cross-Platform**: UI must work on Linux and Windows\n\n## Current State Analysis\n\n### Fully Wired (3 commands)\n| CLI Command | UI Screen | FFI Binding |\n|-------------|-----------|-------------|\n| `state` | Debugger | `onState()` |\n| `repl` (eval) | Console | `eval()` |\n| `run` (partial) | Global | `loadScript()`, `init()` |\n\n### Missing (9 commands)\n| CLI Command | Purpose | Priority |\n|-------------|---------|----------|\n| `check` | Script syntax validation | P0 |\n| `devices` | List keyboard devices | P0 |\n| `doctor` | System diagnostics | P1 |\n| `bench` | Latency benchmarking | P1 |\n| `simulate` | Key sequence simulation | P0 |\n| `discover` | Device profile discovery | P1 |\n| `test` | Script test runner | P1 |\n| `replay` | Session replay | P2 |\n| `analyze` | Session analysis | P2 |\n\n## Requirements\n\n### Requirement 1: Script Validation (check)\n\n**User Story:** As a user, I want to validate my Rhai scripts in the UI before loading them, so that I can catch syntax errors immediately.\n\n#### Acceptance Criteria\n\n1. WHEN I open a script in the Editor, THEN the UI SHALL validate syntax automatically\n2. WHEN syntax errors exist, THEN the UI SHALL display error location (line, column) and message\n3. WHEN I click \"Validate\" button, THEN the UI SHALL run full script validation\n4. WHEN validation passes, THEN the UI SHALL show success indicator\n5. WHEN validation fails, THEN the UI SHALL highlight the problematic line in the editor\n\n### Requirement 2: Device Management (devices)\n\n**User Story:** As a user, I want to see all available keyboard devices and select which one to use, so that I can configure KeyRx for my specific hardware.\n\n#### Acceptance Criteria\n\n1. WHEN I open the Devices screen, THEN the UI SHALL list all detected keyboard devices\n2. WHEN devices are listed, THEN each SHALL show: name, vendor ID, product ID, device path\n3. WHEN I select a device, THEN it SHALL become the active input source\n4. WHEN no devices are found, THEN the UI SHALL show platform-specific troubleshooting hints\n5. WHEN I refresh the device list, THEN the UI SHALL re-scan for new devices\n6. WHEN a device has a saved profile, THEN the UI SHALL indicate this with a badge\n\n### Requirement 3: System Diagnostics (doctor)\n\n**User Story:** As a user, I want to run system diagnostics from the UI, so that I can verify my setup is correct without using the terminal.\n\n#### Acceptance Criteria\n\n1. WHEN I open the Diagnostics screen, THEN the UI SHALL run all system checks automatically\n2. WHEN checks complete, THEN each SHALL show: check name, status (pass/fail/warn), details\n3. WHEN a check fails, THEN the UI SHALL show remediation steps\n4. WHEN on Linux, THEN the UI SHALL check: /dev/uinput, input group membership\n5. WHEN on Windows, THEN the UI SHALL check: keyboard hook API, user32.dll\n6. WHEN I click \"Re-run Diagnostics\", THEN all checks SHALL execute again\n\n### Requirement 4: Latency Benchmarking (bench)\n\n**User Story:** As a user, I want to run latency benchmarks from the UI, so that I can verify performance meets requirements.\n\n#### Acceptance Criteria\n\n1. WHEN I open the Benchmark screen, THEN I SHALL see benchmark configuration options\n2. WHEN I set iterations count, THEN the UI SHALL use that value (default: 10,000)\n3. WHEN I click \"Run Benchmark\", THEN the UI SHALL execute latency measurements\n4. WHEN benchmark runs, THEN the UI SHALL show progress indicator\n5. WHEN benchmark completes, THEN the UI SHALL display: min, max, mean, p99 latencies\n6. WHEN mean latency exceeds 1ms, THEN the UI SHALL show warning\n7. WHEN benchmark history exists, THEN the UI SHALL show trend comparison chart\n\n### Requirement 5: Key Sequence Simulation (simulate)\n\n**User Story:** As a user, I want to simulate key sequences in the UI, so that I can test my mappings without physical key presses.\n\n#### Acceptance Criteria\n\n1. WHEN I open the Simulator screen, THEN I SHALL see a key input area\n2. WHEN I type keys or click virtual keyboard, THEN they SHALL be added to simulation queue\n3. WHEN I click \"Simulate\", THEN the engine SHALL process the key sequence\n4. WHEN simulation completes, THEN the UI SHALL show: input â†’ output mapping for each key\n5. WHEN I specify hold duration per key, THEN simulation SHALL respect timing\n6. WHEN I enable \"Combo Mode\", THEN keys SHALL be treated as simultaneous press\n7. WHEN simulation runs, THEN the UI SHALL show pending decisions and layer state\n\n### Requirement 6: Device Profile Discovery (discover)\n\n**User Story:** As a user, I want to run device discovery from the UI, so that I can create keyboard profiles without CLI.\n\n#### Acceptance Criteria\n\n1. WHEN I click \"Start Discovery\", THEN the UI SHALL begin interactive discovery flow\n2. WHEN discovery starts, THEN the UI SHALL prompt me to press specific keys\n3. WHEN I press keys during discovery, THEN progress SHALL update in real-time\n4. WHEN discovery completes, THEN the UI SHALL show detected layout\n5. WHEN I confirm the profile, THEN it SHALL be saved to device registry\n6. WHEN discovery is cancelled, THEN partial progress SHALL be discarded\n7. WHEN emergency exit pattern is detected, THEN discovery SHALL abort safely\n\n### Requirement 7: Script Test Runner (test)\n\n**User Story:** As a user, I want to run script tests from the UI, so that I can verify my mappings work correctly.\n\n#### Acceptance Criteria\n\n1. WHEN I open the Test Runner screen, THEN the UI SHALL discover all test_* functions\n2. WHEN tests are discovered, THEN each SHALL show: name, file, status (pending/running/pass/fail)\n3. WHEN I click \"Run All\", THEN all tests SHALL execute\n4. WHEN I click a specific test, THEN only that test SHALL run\n5. WHEN I enter a filter pattern, THEN only matching tests SHALL be shown\n6. WHEN a test fails, THEN the UI SHALL show: error message, line number, expected vs actual\n7. WHEN I enable \"Watch Mode\", THEN tests SHALL re-run automatically on script changes\n\n### Requirement 8: Session Replay (replay)\n\n**User Story:** As a user, I want to replay recorded sessions from the UI, so that I can debug and verify behavior.\n\n#### Acceptance Criteria\n\n1. WHEN I open the Replay screen, THEN I SHALL see a list of recorded sessions (.krx files)\n2. WHEN I select a session, THEN the UI SHALL show session metadata (duration, event count, timestamp)\n3. WHEN I click \"Play\", THEN the session SHALL replay through the engine\n4. WHEN replay runs, THEN the UI SHALL visualize each event in real-time\n5. WHEN I adjust speed slider, THEN replay speed SHALL change (0x=instant, 1x=realtime, 2x=fast)\n6. WHEN I enable \"Verify Mode\", THEN outputs SHALL be compared against recorded outputs\n7. WHEN verification fails, THEN the UI SHALL highlight mismatched events\n\n### Requirement 9: Session Analysis (analyze)\n\n**User Story:** As a user, I want to analyze recorded sessions from the UI, so that I can understand timing and decision patterns.\n\n#### Acceptance Criteria\n\n1. WHEN I select a session for analysis, THEN the UI SHALL parse and display statistics\n2. WHEN analysis runs, THEN the UI SHALL show: event count, duration, average latency\n3. WHEN analysis runs, THEN the UI SHALL show decision breakdown (remap, block, tap, hold, combo, layer)\n4. WHEN I click \"Timing Diagram\", THEN the UI SHALL render visual timeline of events\n5. WHEN viewing timeline, THEN each event SHALL show: input, decision type, output, latency\n6. WHEN I hover over an event, THEN detailed information SHALL appear in tooltip\n\n### Requirement 10: Enhanced Run Controls (run options)\n\n**User Story:** As a user, I want full control over engine execution from the UI, including recording and tracing.\n\n#### Acceptance Criteria\n\n1. WHEN I start the engine, THEN I SHALL have option to enable session recording\n2. WHEN recording is enabled, THEN sessions SHALL be saved to specified path\n3. WHEN I start the engine, THEN I SHALL have option to enable OpenTelemetry tracing\n4. WHEN tracing is enabled, THEN traces SHALL be exported to specified file\n5. WHEN I select a device, THEN that device SHALL be used for input\n6. WHEN engine is running, THEN the UI SHALL show: recording indicator, trace indicator, device name\n\n## Non-Functional Requirements\n\n### UI/UX Standards\n\n- **Consistency**: New screens follow existing navigation pattern (NavigationRail tabs)\n- **Feedback**: All async operations show loading indicators\n- **Errors**: All errors display user-friendly messages with remediation hints\n- **Responsiveness**: UI updates in real-time during long operations\n\n### Performance\n\n- **Benchmark UI**: Must not introduce >1% overhead to benchmark measurements\n- **Simulation**: Key sequence processing visible within 16ms (60fps)\n- **Device Scan**: Complete within 2 seconds\n\n### Architecture\n\n- **FFI Bindings**: All new functionality exposed via existing bridge pattern\n- **State Management**: Use existing AppState patterns\n- **Service Layer**: Follow existing EngineService/AudioService patterns\n",
  "fileStats": {
    "size": 9799,
    "lines": 199,
    "lastModified": "2025-12-02T22:38:10.352Z"
  },
  "comments": []
}