{
  "id": "snapshot_1764716062656_mepz4fxh5",
  "approvalId": "approval_1764715364155_arhnqjibr",
  "approvalTitle": "Wire Every Remaining Feature - Requirements Document (Revised)",
  "version": 3,
  "timestamp": "2025-12-02T22:54:22.656Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThis spec bridges the gap between KeyRx's powerful CLI capabilities and the Flutter UI. Currently, only 3 of 12 CLI commands are fully wired to the UI. This leaves 9 essential features inaccessible from the graphical interface.\n\n**Goal:** Expose all CLI functionality through the Flutter UI with **clear separation between User and Developer interfaces** - keeping the user experience simple while containing advanced complexity in a dedicated developer area.\n\n## Alignment with Product Vision\n\nFrom product.md:\n- **CLI First, GUI Later**: CLI is complete; now it's time for \"GUI Later\"\n- **Developer Experience**: Full feature parity between CLI and UI\n- **Visual Debugging**: UI should provide enhanced visualization over CLI\n\nFrom tech.md:\n- **FFI Bridge**: Extend existing `ui/lib/ffi/` bindings for new functionality\n- **Flutter Architecture**: Follow established page/widget patterns\n- **Cross-Platform**: UI must work on Linux and Windows\n\n## UI Organization Philosophy\n\n### Two-Tier Interface\n\n```\n┌─────────────────────────────────────────────────────────────────────┐\n│                         USER INTERFACE                               │\n│  Simple, essential features for daily keyboard usage                 │\n│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐               │\n│  │Training │  │ Editor  │  │ Devices │  │  Run    │               │\n│  │         │  │         │  │         │  │Controls │               │\n│  └─────────┘  └─────────┘  └─────────┘  └─────────┘               │\n├─────────────────────────────────────────────────────────────────────┤\n│                      DEVELOPER TOOLS                                 │\n│  Advanced features for script development, debugging, testing        │\n│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │\n│  │Debugger │  │ Console │  │  Test   │  │Simulate │  │ Analyze │  │\n│  │         │  │  (REPL) │  │ Runner  │  │         │  │         │  │\n│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │\n│  ┌─────────┐  ┌─────────┐  ┌─────────┐                            │\n│  │  Bench  │  │ Doctor  │  │ Replay  │                            │\n│  │         │  │         │  │         │                            │\n│  └─────────┘  └─────────┘  └─────────┘                            │\n└─────────────────────────────────────────────────────────────────────┘\n```\n\n### User Interface (Main Navigation)\nFeatures everyday users need:\n- **Training** (existing) - Audio-based key training\n- **Editor** (existing) - Visual keymap creation\n- **Devices** (new) - Select keyboard device\n- **Run Controls** (enhanced) - Start/stop with simple options\n\n### Developer Tools (Secondary Navigation / Drawer)\nFeatures for script developers and power users:\n- **Debugger** (existing) - Real-time state visualization\n- **Console** (existing) - REPL for Rhai evaluation\n- **Test Runner** (new) - Run script tests\n- **Simulator** (new) - Test key sequences\n- **Analyzer** (new) - Session analysis and timing\n- **Benchmark** (new) - Latency measurements\n- **Doctor** (new) - System diagnostics\n- **Replay** (new) - Session replay\n\n---\n\n## User Interface Requirements\n\n### Requirement 1: Device Selection (devices)\n\n**User Story:** As a user, I want to see and select my keyboard device, so that KeyRx works with the right hardware.\n\n#### Acceptance Criteria\n\n1. WHEN I open the Devices screen, THEN the UI SHALL list all detected keyboard devices\n2. WHEN devices are listed, THEN each SHALL show: device name and status indicator\n3. WHEN I tap a device, THEN it SHALL become the active input source\n4. WHEN no devices are found, THEN the UI SHALL show simple troubleshooting message\n5. WHEN I pull to refresh, THEN the UI SHALL re-scan for devices\n6. WHEN a device has a saved profile, THEN it SHALL show a checkmark badge\n\n### Requirement 2: Enhanced Run Controls (run options)\n\n**User Story:** As a user, I want simple controls to start/stop KeyRx with optional session recording.\n\n#### Acceptance Criteria\n\n1. WHEN I view the main screen, THEN I SHALL see a prominent Start/Stop button\n2. WHEN I tap Start, THEN the engine SHALL begin with selected device and script\n3. WHEN I toggle \"Record Session\", THEN the session SHALL be saved for later review\n4. WHEN engine is running, THEN status indicators SHALL show: active script, device, recording status\n5. WHEN I tap Stop, THEN the engine SHALL gracefully shut down\n6. WHEN recording is enabled, THEN the saved file path SHALL be shown\n\n### Requirement 3: Script Validation in Editor (check)\n\n**User Story:** As a user, I want immediate feedback when my script has errors, so I can fix them before loading.\n\n#### Acceptance Criteria\n\n1. WHEN I modify a script in the Editor, THEN syntax SHALL be validated automatically\n2. WHEN syntax errors exist, THEN an error banner SHALL appear with message\n3. WHEN I tap the error, THEN the problematic line SHALL be highlighted\n4. WHEN script is valid, THEN a success indicator SHALL appear\n5. WHEN I tap \"Load Script\", THEN validation SHALL run first and block if errors exist\n\n---\n\n## Developer Tools Requirements\n\n### Requirement 4: Developer Tools Navigation\n\n**User Story:** As a developer, I want access to advanced tools without cluttering the main user interface.\n\n#### Acceptance Criteria\n\n1. WHEN I tap \"Developer Tools\" button/menu, THEN the developer navigation SHALL appear\n2. WHEN in developer mode, THEN I SHALL see all developer-only screens\n3. WHEN I tap \"Back to User View\", THEN I SHALL return to simplified navigation\n4. WHEN developer tools are hidden, THEN they SHALL not appear in main navigation\n5. WHEN I'm in developer mode, THEN it SHALL persist across app restarts (preference)\n\n### Requirement 5: Test Runner (test)\n\n**User Story:** As a developer, I want to run script tests from the UI, so I can verify my mappings work.\n\n#### Acceptance Criteria\n\n1. WHEN I open Test Runner, THEN the UI SHALL discover all `test_*` functions\n2. WHEN tests are discovered, THEN each SHALL show: name, file, status (pending/pass/fail)\n3. WHEN I tap \"Run All\", THEN all tests SHALL execute with progress indicator\n4. WHEN I tap a specific test, THEN only that test SHALL run\n5. WHEN I enter a filter pattern, THEN only matching tests SHALL be shown\n6. WHEN a test fails, THEN the UI SHALL show: error message, line number\n7. WHEN I enable \"Watch Mode\", THEN tests SHALL re-run on script changes\n\n### Requirement 6: Key Sequence Simulator (simulate)\n\n**User Story:** As a developer, I want to simulate key sequences, so I can test mappings without physical key presses.\n\n#### Acceptance Criteria\n\n1. WHEN I open Simulator, THEN I SHALL see key input area and virtual keyboard\n2. WHEN I tap keys on virtual keyboard, THEN they SHALL be added to sequence\n3. WHEN I tap \"Simulate\", THEN the engine SHALL process the sequence\n4. WHEN simulation completes, THEN I SHALL see: input → output for each key\n5. WHEN I specify hold duration, THEN simulation SHALL respect timing\n6. WHEN I enable \"Combo Mode\", THEN keys SHALL be treated as simultaneous\n7. WHEN simulation runs, THEN pending decisions and active layers SHALL display\n\n### Requirement 7: Session Analyzer (analyze)\n\n**User Story:** As a developer, I want to analyze recorded sessions to understand timing and decisions.\n\n#### Acceptance Criteria\n\n1. WHEN I open Analyzer, THEN I SHALL see list of recorded sessions (.krx files)\n2. WHEN I select a session, THEN statistics SHALL display: event count, duration, avg latency\n3. WHEN analysis loads, THEN decision breakdown SHALL show (remap, block, tap, hold, combo, layer)\n4. WHEN I tap \"Timing Diagram\", THEN visual timeline of events SHALL render\n5. WHEN viewing timeline, THEN each event SHALL show: input, decision, output, latency\n6. WHEN I tap an event, THEN detailed information SHALL appear\n\n### Requirement 8: Latency Benchmark (bench)\n\n**User Story:** As a developer, I want to run latency benchmarks to verify performance requirements.\n\n#### Acceptance Criteria\n\n1. WHEN I open Benchmark, THEN I SHALL see configuration options\n2. WHEN I set iterations, THEN that value SHALL be used (default: 10,000)\n3. WHEN I tap \"Run Benchmark\", THEN measurements SHALL execute with progress\n4. WHEN benchmark completes, THEN results SHALL show: min, max, mean, p99 latencies\n5. WHEN mean latency exceeds 1ms, THEN a warning SHALL display\n6. WHEN previous results exist, THEN trend comparison SHALL be available\n\n### Requirement 9: System Diagnostics (doctor)\n\n**User Story:** As a developer, I want to run system diagnostics to verify setup is correct.\n\n#### Acceptance Criteria\n\n1. WHEN I open Doctor, THEN all system checks SHALL run automatically\n2. WHEN checks complete, THEN each SHALL show: name, status (pass/fail/warn), details\n3. WHEN a check fails, THEN remediation steps SHALL display\n4. WHEN on Linux, THEN checks SHALL include: /dev/uinput, input group membership\n5. WHEN on Windows, THEN checks SHALL include: keyboard hook API, user32.dll\n6. WHEN I tap \"Re-run\", THEN all checks SHALL execute again\n\n### Requirement 10: Session Replay (replay)\n\n**User Story:** As a developer, I want to replay sessions to debug and verify behavior.\n\n#### Acceptance Criteria\n\n1. WHEN I open Replay, THEN I SHALL see list of recorded sessions\n2. WHEN I select a session, THEN metadata SHALL show: duration, event count, timestamp\n3. WHEN I tap \"Play\", THEN session SHALL replay through engine\n4. WHEN replay runs, THEN events SHALL visualize in real-time\n5. WHEN I adjust speed slider, THEN replay speed SHALL change (0x, 1x, 2x)\n6. WHEN I enable \"Verify Mode\", THEN outputs SHALL compare against recorded\n7. WHEN verification fails, THEN mismatched events SHALL highlight\n\n### Requirement 11: Device Profile Discovery (discover)\n\n**User Story:** As a developer, I want to create device profiles through guided discovery.\n\n#### Acceptance Criteria\n\n1. WHEN I tap \"Start Discovery\" in Developer Tools, THEN discovery wizard SHALL begin\n2. WHEN discovery starts, THEN prompts SHALL guide me to press specific keys\n3. WHEN I press keys, THEN progress SHALL update in real-time\n4. WHEN discovery completes, THEN detected layout SHALL display for confirmation\n5. WHEN I confirm, THEN profile SHALL save to device registry\n6. WHEN I cancel, THEN partial progress SHALL discard\n7. WHEN emergency exit pattern detected, THEN discovery SHALL abort safely\n\n---\n\n## Non-Functional Requirements\n\n### UI/UX Standards\n\n- **Separation**: Clear visual distinction between User and Developer interfaces\n- **Simplicity**: User interface contains only essential features\n- **Discoverability**: Developer tools accessible but not prominent\n- **Consistency**: All screens follow existing navigation patterns\n- **Feedback**: Async operations show loading indicators\n- **Errors**: User-friendly messages with remediation hints\n\n### Performance\n\n- **Benchmark UI**: Must not introduce >1% overhead to measurements\n- **Simulation**: Key processing visible within 16ms (60fps)\n- **Device Scan**: Complete within 2 seconds\n\n### Architecture\n\n- **FFI Bindings**: All new functionality via existing bridge pattern\n- **State Management**: Use existing AppState patterns\n- **Service Layer**: Follow existing EngineService/AudioService patterns\n- **Navigation**: User screens in main NavigationRail; Developer screens in drawer/secondary nav\n",
  "fileStats": {
    "size": 12446,
    "lines": 243,
    "lastModified": "2025-12-02T22:42:35.153Z"
  },
  "comments": []
}