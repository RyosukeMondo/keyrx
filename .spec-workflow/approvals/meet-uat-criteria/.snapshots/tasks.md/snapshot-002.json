{
  "id": "snapshot_1764714737863_ng30llm19",
  "approvalId": "approval_1764714682563_dq34xjudq",
  "approvalTitle": "Meet UAT Criteria - Tasks Document",
  "version": 2,
  "timestamp": "2025-12-02T22:32:17.863Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document\n\n## UAT Core Infrastructure\n\n- [ ] 1. Create UAT module structure\n  - Files: core/src/uat/mod.rs (new)\n  - Create module with public exports for all UAT components\n  - _Leverage: existing module patterns in core/src/_\n  - _Requirements: All_\n  - _Prompt: Role: Rust systems engineer | Task: Create core/src/uat/mod.rs with module declarations and public exports for: runner, golden, gates, coverage, perf, fuzz, report. Add mod uat to core/src/lib.rs | Restrictions: ≤30 lines; follow existing module patterns; no implementation yet | Success: `cargo check` passes with empty submodules._\n\n- [ ] 2. Implement UAT test discovery\n  - Files: core/src/uat/runner.rs (new)\n  - Implement UatTest struct and discovery of uat_* functions\n  - _Leverage: core/src/test_harness/ discovery patterns_\n  - _Requirements: 1.1, 1.2_\n  - _Prompt: Role: Rust developer specializing in test frameworks | Task: Create runner.rs with UatTest struct (name, file, category, priority, requirements, latency_threshold) and discover() function that scans tests/uat/ for uat_* Rhai functions | Restrictions: ≤150 lines; reuse test_harness patterns; return Vec<UatTest> | Success: Discovers uat_* functions with parsed metadata._\n\n- [ ] 3. Implement UAT metadata parsing\n  - Files: core/src/uat/runner.rs (extend)\n  - Parse @category, @priority, @requirement, @latency from Rhai comments\n  - _Leverage: Rhai comment parsing_\n  - _Requirements: 1.5, 1.6_\n  - _Prompt: Role: Parser developer | Task: Extend runner.rs with parse_metadata() that extracts @category, @priority (P0/P1/P2), @requirement (comma-separated IDs), @latency (microseconds) from Rhai function comments | Restrictions: ≤100 lines; regex-based parsing; handle missing metadata gracefully | Success: All metadata types parsed correctly from test comments._\n\n- [ ] 4. Implement UAT test execution\n  - Files: core/src/uat/runner.rs (extend)\n  - Add UatRunner struct with run() and run_fail_fast() methods\n  - _Leverage: core/src/test_harness/ execution engine_\n  - _Requirements: 3.1, 3.7_\n  - _Prompt: Role: Test framework engineer | Task: Extend runner.rs with UatRunner struct and run(filter: UatFilter) method that executes discovered tests, collecting UatResults (total, passed, failed, skipped, duration, test results) | Restrictions: ≤200 lines; reuse test_harness execution; support fail-fast mode | Success: `keyrx uat` runs all uat_* tests and reports results._\n\n- [ ] 5. Implement UAT filter and categorization\n  - Files: core/src/uat/runner.rs (extend)\n  - Add UatFilter with category, priority, and pattern filtering\n  - _Leverage: existing filter patterns_\n  - _Requirements: 3.2, 3.3_\n  - _Prompt: Role: Rust developer | Task: Extend runner.rs with UatFilter struct supporting categories (Vec<String>), priorities (Vec<Priority>), pattern (Option<String>). Implement filter matching in run() | Restrictions: ≤80 lines; AND logic for multiple filters | Success: `keyrx uat --category core --priority P0` filters correctly._\n\n## Quality Gates\n\n- [ ] 6. Implement quality gate configuration\n  - Files: core/src/uat/gates.rs (new)\n  - Create QualityGate struct and TOML loading\n  - _Leverage: existing TOML config patterns_\n  - _Requirements: 4.1, 4.7_\n  - _Prompt: Role: Configuration engineer | Task: Create gates.rs with QualityGate struct (pass_rate, p0_open, p1_open, max_latency_us, coverage_min) and load() function parsing .keyrx/quality-gates.toml with named gates (default, alpha, beta, rc, ga) | Restrictions: ≤120 lines; use serde for TOML; provide sensible defaults | Success: Loads quality gate config with gate selection._\n\n- [ ] 7. Implement quality gate evaluation\n  - Files: core/src/uat/gates.rs (extend)\n  - Add QualityGateEnforcer with evaluate() method\n  - _Leverage: UatResults from runner_\n  - _Requirements: 4.2, 4.3, 4.4, 4.5, 4.6_\n  - _Prompt: Role: Quality assurance engineer | Task: Extend gates.rs with QualityGateEnforcer.evaluate(gate, results) returning GateResult with passed bool and Vec<GateViolation>. Check all criteria: pass_rate, p0_open, p1_open, max_latency_us, coverage_min | Restrictions: ≤150 lines; clear violation messages | Success: Gate evaluation catches all threshold violations._\n\n## Golden Sessions\n\n- [ ] 8. Implement golden session data structures\n  - Files: core/src/uat/golden.rs (new)\n  - Create GoldenSession struct and JSON serialization\n  - _Leverage: core/src/session/ format patterns_\n  - _Requirements: 2.6_\n  - _Prompt: Role: Data modeling engineer | Task: Create golden.rs with GoldenSession struct (name, version, created, metadata, events, expected_outputs) using serde for JSON. Ensure human-readable output | Restrictions: ≤100 lines; JSON format matches design spec | Success: Golden sessions serialize to readable JSON._\n\n- [ ] 9. Implement golden session recording\n  - Files: core/src/uat/golden.rs (extend)\n  - Add GoldenSessionManager.record() method\n  - _Leverage: core/src/session/ recording logic_\n  - _Requirements: 2.1_\n  - _Prompt: Role: Session recording engineer | Task: Extend golden.rs with GoldenSessionManager.record(name, script) that executes script, captures events and outputs, saves to tests/golden/<name>.krx as JSON | Restrictions: ≤120 lines; reuse session recording; validate name format | Success: `keyrx record-golden basic --script test.rhai` creates golden session._\n\n- [ ] 10. Implement golden session verification\n  - Files: core/src/uat/golden.rs (extend)\n  - Add verify() method with semantic comparison\n  - _Leverage: session replay logic_\n  - _Requirements: 2.2, 2.3, 2.4_\n  - _Prompt: Role: Comparison algorithm engineer | Task: Extend golden.rs with GoldenSessionManager.verify(name) that replays session and compares output semantically (ignoring non-deterministic timestamps). Return GoldenVerifyResult with differences | Restrictions: ≤150 lines; detailed diff output; event index tracking | Success: `keyrx verify-golden basic` reports exact differences._\n\n- [ ] 11. Implement golden session update\n  - Files: core/src/uat/golden.rs (extend)\n  - Add update() method with confirmation\n  - _Leverage: record() method_\n  - _Requirements: 2.5_\n  - _Prompt: Role: CLI developer | Task: Extend golden.rs with GoldenSessionManager.update(name, confirm) that re-records golden session. Require explicit confirmation flag | Restrictions: ≤50 lines; safety confirmation required | Success: `keyrx update-golden basic` requires --confirm flag._\n\n## Coverage Mapping\n\n- [ ] 12. Implement requirements coverage mapping\n  - Files: core/src/uat/coverage.rs (new)\n  - Create CoverageMapper with requirement linking\n  - _Leverage: @requirement metadata from tests_\n  - _Requirements: 5.1, 5.2_\n  - _Prompt: Role: Traceability engineer | Task: Create coverage.rs with CoverageMapper.build(tests, results) that creates CoverageMap linking requirement IDs to tests based on @requirement metadata | Restrictions: ≤120 lines; handle multiple requirements per test | Success: Coverage map shows all requirement-test links._\n\n- [ ] 13. Implement coverage report generation\n  - Files: core/src/uat/coverage.rs (extend)\n  - Add report() method with status calculation\n  - _Leverage: CoverageMap data_\n  - _Requirements: 5.3, 5.4, 5.5, 5.6_\n  - _Prompt: Role: Report engineer | Task: Extend coverage.rs with CoverageMapper.report() generating CoverageReport with RequirementCoverage entries (id, linked_tests, status: Verified/AtRisk/Uncovered, last_verified) | Restrictions: ≤100 lines; include all status fields | Success: `keyrx uat --coverage-report` shows requirement matrix._\n\n## Performance UAT\n\n- [ ] 14. Implement performance UAT runner\n  - Files: core/src/uat/perf.rs (new)\n  - Create PerformanceUat with latency measurement\n  - _Leverage: core/benches/latency.rs patterns_\n  - _Requirements: 7.1, 7.2, 7.3_\n  - _Prompt: Role: Performance engineer | Task: Create perf.rs with PerformanceUat.run() that executes tests with @latency threshold, measuring p50/p95/p99/max latencies and collecting violations | Restrictions: ≤150 lines; reuse benchmark timing; microsecond precision | Success: `keyrx uat --perf` reports latency percentiles._\n\n- [ ] 15. Implement baseline comparison\n  - Files: core/src/uat/perf.rs (extend)\n  - Add compare_baseline() for regression detection\n  - _Leverage: git branch comparison_\n  - _Requirements: 7.4, 7.5, 7.6_\n  - _Prompt: Role: Regression detection engineer | Task: Extend perf.rs with PerformanceUat.compare_baseline(branch) that compares current latencies against baseline. Fail on >100µs regression | Restrictions: ≤100 lines; git integration for baseline fetch | Success: CI detects latency regressions vs main branch._\n\n## Fuzz Testing\n\n- [ ] 16. Implement fuzz engine\n  - Files: core/src/uat/fuzz.rs (new)\n  - Create FuzzEngine with random key sequence generation\n  - _Leverage: existing proptest/fuzz infrastructure_\n  - _Requirements: 8.1, 8.2, 8.4_\n  - _Prompt: Role: Fuzz testing engineer | Task: Create fuzz.rs with FuzzEngine.run(duration, count) that generates random key sequences (min 10,000), executes against engine, reports sequences_tested, duration, unique_paths | Restrictions: ≤200 lines; leverage proptest generators | Success: `keyrx uat --fuzz` runs 10,000+ sequences._\n\n- [ ] 17. Implement crash sequence saving\n  - Files: core/src/uat/fuzz.rs (extend)\n  - Add crash detection and sequence saving\n  - _Leverage: session recording for crash sequences_\n  - _Requirements: 8.3, 8.5, 8.6_\n  - _Prompt: Role: Crash analysis engineer | Task: Extend fuzz.rs to detect crashes, save failing sequences to tests/crashes/<timestamp>.krx as reproducible recordings | Restrictions: ≤80 lines; timestamps in filename; JSON format | Success: Crashes are saved and reproducible via `keyrx replay`._\n\n## Report Generation\n\n- [ ] 18. Implement HTML report generator\n  - Files: core/src/uat/report.rs (new)\n  - Create ReportGenerator with HTML output\n  - _Leverage: template patterns_\n  - _Requirements: 9.1, 9.2, 9.3, 9.4_\n  - _Prompt: Role: Report generation engineer | Task: Create report.rs with ReportGenerator.generate_html(data) that creates comprehensive HTML report with summary, test results by category, coverage matrix, performance metrics, gate status, trend comparison | Restrictions: ≤250 lines; embedded CSS; no external dependencies | Success: `keyrx uat --report` generates readable HTML._\n\n- [ ] 19. Implement Markdown report generator\n  - Files: core/src/uat/report.rs (extend)\n  - Add Markdown output for PR comments\n  - _Leverage: HTML report data_\n  - _Requirements: 9.5, 9.6_\n  - _Prompt: Role: Markdown engineer | Task: Extend report.rs with generate_markdown(data) for GitHub PR comment format. Support --report-format md and --report-output path | Restrictions: ≤100 lines; GitHub-flavored markdown | Success: Report suitable for PR comment posting._\n\n- [ ] 20. Implement JSON report output\n  - Files: core/src/uat/report.rs (extend)\n  - Add JSON output for machine parsing\n  - _Leverage: serde serialization_\n  - _Requirements: 3.5_\n  - _Prompt: Role: API engineer | Task: Extend report.rs with generate_json(data) for machine-readable output. Include all metrics and results | Restrictions: ≤50 lines; serde_json | Success: `keyrx uat --json` outputs parseable JSON._\n\n## CLI Commands\n\n- [ ] 21. Implement keyrx uat command\n  - Files: core/src/cli/commands/uat.rs (new)\n  - Create UAT command with all flags\n  - _Leverage: existing CLI command patterns_\n  - _Requirements: 3.1-3.7_\n  - _Prompt: Role: CLI engineer | Task: Create uat.rs with keyrx uat command supporting: --category, --priority, --json, --fail-fast, --perf, --fuzz, --coverage-report, --report, --report-format, --report-output, --gate. Return appropriate exit codes (0/1/2/3) | Restrictions: ≤200 lines; clap derive macros; integrate all UAT components | Success: `keyrx uat --help` shows all options._\n\n- [ ] 22. Implement keyrx golden commands\n  - Files: core/src/cli/commands/golden.rs (new)\n  - Create record-golden, verify-golden, update-golden commands\n  - _Leverage: GoldenSessionManager_\n  - _Requirements: 2.1, 2.2, 2.5_\n  - _Prompt: Role: CLI developer | Task: Create golden.rs with subcommands: record-golden <name> --script <path>, verify-golden <name>, update-golden <name> --confirm. Wire to GoldenSessionManager | Restrictions: ≤150 lines; clear error messages | Success: All golden session commands functional._\n\n- [ ] 23. Implement keyrx regression command\n  - Files: core/src/cli/commands/regression.rs (new)\n  - Create regression command for all golden sessions\n  - _Leverage: GoldenSessionManager.verify()_\n  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_\n  - _Prompt: Role: Regression testing engineer | Task: Create regression.rs with keyrx regression that replays all golden sessions, reports regressions with session name/event index/expected/actual, supports --update-all for intentional changes | Restrictions: ≤120 lines; fail CI on regression | Success: `keyrx regression` verifies all golden sessions._\n\n- [ ] 24. Implement keyrx ci-check command\n  - Files: core/src/cli/commands/ci_check.rs (new)\n  - Create unified CI command\n  - _Leverage: all test runners_\n  - _Requirements: 10.1-10.6_\n  - _Prompt: Role: CI/CD engineer | Task: Create ci_check.rs with keyrx ci-check that runs: unit tests, integration tests, UAT tests, regression tests, performance tests. Support --gate <name>, --json. Collect all failures before reporting. Exit codes: 1=test fail, 2=gate fail, 3=crash | Restrictions: ≤200 lines; run all checks even on failure | Success: `keyrx ci-check --gate beta` runs full CI suite._\n\n## Integration & Testing\n\n- [ ] 25. Create sample UAT tests\n  - Files: tests/uat/core/basic.rhai (new), tests/uat/layers/switching.rhai (new)\n  - Create example UAT tests demonstrating all features\n  - _Leverage: existing test patterns_\n  - _Requirements: 1.1-1.6_\n  - _Prompt: Role: QA engineer | Task: Create sample UAT tests in tests/uat/ with uat_* functions, demonstrating @category, @priority, @requirement, @latency metadata. Cover basic typing, layer switching, combo execution | Restrictions: ≤200 lines total; realistic scenarios | Success: Sample tests discoverable and runnable._\n\n- [ ] 26. Create default quality gate config\n  - Files: .keyrx/quality-gates.toml (new)\n  - Create quality gate configuration with all presets\n  - _Leverage: design spec_\n  - _Requirements: 4.1-4.7_\n  - _Prompt: Role: DevOps engineer | Task: Create .keyrx/quality-gates.toml with gates: default (95% pass, 0 P0, 2 P1, 1000µs, 80% coverage), alpha (relaxed), beta, rc, ga (strict) | Restrictions: ≤40 lines; documented comments | Success: All gate presets defined and loadable._\n\n- [ ] 27. Create initial golden sessions\n  - Files: tests/golden/basic_typing.krx (new), tests/golden/layer_switch.krx (new)\n  - Record baseline golden sessions\n  - _Leverage: keyrx record-golden command_\n  - _Requirements: 2.1, 2.6_\n  - _Prompt: Role: QA engineer | Task: Record golden sessions for basic typing and layer switching using keyrx record-golden. Ensure JSON format, human-readable | Restrictions: Cover core functionality; ≤5 sessions initially | Success: Golden sessions exist and verify successfully._\n\n- [ ] 28. Add UAT module to Cargo.toml\n  - Files: core/Cargo.toml (modify)\n  - Add any new dependencies for UAT system\n  - _Leverage: existing dependencies_\n  - _Requirements: All_\n  - _Prompt: Role: Build engineer | Task: Add any required dependencies to core/Cargo.toml for UAT system (likely: none new, reuse existing serde, toml, chrono) | Restrictions: Minimize new dependencies; ≤5 lines added | Success: `cargo build` succeeds with UAT module._\n\n- [ ] 29. Write UAT runner unit tests\n  - Files: core/src/uat/runner.rs (extend with #[cfg(test)])\n  - Add unit tests for discovery, parsing, filtering\n  - _Leverage: existing test patterns_\n  - _Requirements: 1.1-1.6, 3.1-3.3_\n  - _Prompt: Role: Test engineer | Task: Add unit tests to runner.rs for: metadata parsing, filter matching, result aggregation. Use #[cfg(test)] module | Restrictions: ≤150 lines; test edge cases | Success: `cargo test uat::runner` passes._\n\n- [ ] 30. Write quality gate unit tests\n  - Files: core/src/uat/gates.rs (extend with #[cfg(test)])\n  - Add unit tests for gate loading and evaluation\n  - _Leverage: existing test patterns_\n  - _Requirements: 4.1-4.7_\n  - _Prompt: Role: Test engineer | Task: Add unit tests to gates.rs for: config loading, threshold evaluation, violation detection. Test all gate criteria | Restrictions: ≤120 lines; cover all thresholds | Success: `cargo test uat::gates` passes._\n\n- [ ] 31. Write integration tests for UAT system\n  - Files: core/tests/uat_integration.rs (new)\n  - End-to-end tests for UAT workflow\n  - _Leverage: existing integration test patterns_\n  - _Requirements: All_\n  - _Prompt: Role: Integration test engineer | Task: Create uat_integration.rs with tests for: full UAT run, golden session lifecycle, gate evaluation, report generation | Restrictions: ≤200 lines; use temp directories | Success: `cargo test --test uat_integration` passes._\n\n- [ ] 32. Update CI workflow for UAT\n  - Files: .github/workflows/ci.yml (modify)\n  - Add UAT step to CI pipeline\n  - _Leverage: existing CI structure_\n  - _Requirements: 10.1-10.6_\n  - _Prompt: Role: CI engineer | Task: Add UAT job to ci.yml that runs `keyrx ci-check --gate beta --json`. Fail PR on gate failure. Upload report as artifact | Restrictions: ≤30 lines added; after test job | Success: CI runs UAT checks on every PR._\n\n- [ ] 33. Documentation and README update\n  - Files: README.md (modify)\n  - Add UAT system documentation\n  - _Leverage: existing README structure_\n  - _Requirements: All_\n  - _Prompt: Role: Technical writer | Task: Add \"## UAT System\" section to README explaining: keyrx uat command, golden sessions, quality gates, CI integration | Restrictions: ≤50 lines; include command examples | Success: New developers understand UAT workflow._\n",
  "fileStats": {
    "size": 17925,
    "lines": 251,
    "lastModified": "2025-12-02T22:31:17.396Z"
  },
  "comments": []
}