{
  "id": "snapshot_1764747746045_5oyoo5529",
  "approvalId": "approval_1764747708794_ku65g3vj5",
  "approvalTitle": "Tasks: Flutter UI Fixes (18 tasks)",
  "version": 2,
  "timestamp": "2025-12-03T07:42:26.045Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: Flutter UI Fixes\n\n## Phase 1: Fix Failing Tests\n\n- [ ] 1. Create FakeDeviceService for tests\n  - File: `test/helpers/fake_services.dart`\n  - Create `_FakeDeviceService` implementing `DeviceService`\n  - Return empty list for `listDevices()`\n  - Return success for `selectDevice()`\n  - Purpose: Provide mock device service for all tests\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Test Developer | Task: Create test/helpers/fake_services.dart with FakeDeviceService class implementing DeviceService interface. Add FakeEngineService, FakeAudioService if not already centralized. | Restrictions: Keep implementations minimal, return success/empty values | Success: Helper file created and importable. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 2. Fix keyrx_training_screen_test.dart\n  - File: `test/keyrx_training_screen_test.dart`\n  - Add `deviceService` parameter to `ServiceRegistry.withOverrides()`\n  - Import fake services helper\n  - Purpose: Fix compilation error\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Test Developer | Task: Fix test/keyrx_training_screen_test.dart by adding deviceService parameter to ServiceRegistry.withOverrides() call around line 100. Import FakeDeviceService from helpers. | Restrictions: Only fix the parameter issue, don't change test logic | Success: Test compiles and passes. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 3. Fix trade_off_test.dart\n  - File: `test/trade_off_test.dart`\n  - Add `deviceService` parameter to `ServiceRegistry.withOverrides()`\n  - Purpose: Fix compilation error\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Test Developer | Task: Fix test/trade_off_test.dart by adding deviceService parameter to ServiceRegistry.withOverrides() call around line 98. | Restrictions: Only fix the parameter issue | Success: Test compiles and passes. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 4. Fix debugger_page_test.dart\n  - File: `test/debugger_page_test.dart`\n  - Add `deviceService` parameter to `ServiceRegistry.withOverrides()`\n  - Purpose: Fix compilation error\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Test Developer | Task: Fix test/debugger_page_test.dart by adding deviceService parameter to ServiceRegistry.withOverrides(). | Restrictions: Only fix the parameter issue | Success: Test compiles and passes. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 5. Fix training_screen_test.dart\n  - File: `test/pages/training_screen_test.dart`\n  - Add `deviceService` parameter to `ServiceRegistry.withOverrides()`\n  - Purpose: Fix compilation error\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Test Developer | Task: Fix test/pages/training_screen_test.dart by adding deviceService parameter to ServiceRegistry.withOverrides(). | Restrictions: Only fix the parameter issue | Success: Test compiles and passes. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 6. Fix any remaining test failures\n  - Files: Any tests still failing after above fixes\n  - Check for other missing required parameters\n  - Purpose: Ensure all tests pass\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Test Developer | Task: Run `flutter test` and fix any remaining compilation errors or test failures. Check all ServiceRegistry.withOverrides() calls have required parameters. | Restrictions: Only fix issues, don't change test assertions | Success: `flutter test` reports 0 failures. Mark [-] before, log after, mark [x] complete._\n\n## Phase 2: FFI Bridge Refactoring\n\n- [ ] 7. Create bridge_core.dart\n  - File: `lib/ffi/bridge_core.dart`\n  - Extract: `_init()`, `version` getter, `dispose()`, `_freeString()`, initialization logic\n  - Purpose: Isolate core FFI initialization\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter FFI Developer | Task: Create lib/ffi/bridge_core.dart by extracting initialization, version, dispose, and string management functions from bridge.dart. Create a mixin or extension that KeyrxBridge can use. | Restrictions: Keep function signatures identical | Success: Core functions work when imported. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 8. Create bridge_engine.dart\n  - File: `lib/ffi/bridge_engine.dart`\n  - Extract: `loadScript()`, `eval()`, `listKeys()`, `stateStream`, state-related methods\n  - Purpose: Isolate engine control FFI methods\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter FFI Developer | Task: Create lib/ffi/bridge_engine.dart by extracting engine control methods (loadScript, eval, listKeys, isBypassActive, setBypass) and stateStream from bridge.dart. | Restrictions: Maintain stream controller patterns | Success: Engine methods work correctly. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 9. Create bridge_audio.dart\n  - File: `lib/ffi/bridge_audio.dart`\n  - Extract: `startAudio()`, `stopAudio()`, `setBpm()`, classification stream\n  - Purpose: Isolate audio capture FFI methods\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter FFI Developer | Task: Create lib/ffi/bridge_audio.dart by extracting audio methods (startAudio, stopAudio, setBpm) and classificationStream from bridge.dart. | Restrictions: Maintain stream controller patterns | Success: Audio methods work correctly. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 10. Create bridge_session.dart\n  - File: `lib/ffi/bridge_session.dart`\n  - Extract: `startRecording()`, `stopRecording()`, `listSessions()`, `analyzeSession()`, `replaySession()`\n  - Purpose: Isolate session/recording FFI methods\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter FFI Developer | Task: Create lib/ffi/bridge_session.dart by extracting session/recording methods and related result types from bridge.dart. | Restrictions: Keep result types with their methods | Success: Session methods work correctly. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 11. Create bridge_discovery.dart\n  - File: `lib/ffi/bridge_discovery.dart`\n  - Extract: `startDiscovery()`, `processDiscoveryEvent()`, `cancelDiscovery()`, `getDiscoveryProgress()`\n  - Purpose: Isolate device discovery FFI methods\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter FFI Developer | Task: Create lib/ffi/bridge_discovery.dart by extracting discovery methods from bridge.dart. | Restrictions: Maintain callback patterns | Success: Discovery methods work correctly. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 12. Create bridge_testing.dart\n  - File: `lib/ffi/bridge_testing.dart`\n  - Extract: `simulate()`, `runTests()`, `discoverTests()`, `runBenchmark()`, `runDoctor()`\n  - Purpose: Isolate testing/diagnostic FFI methods\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter FFI Developer | Task: Create lib/ffi/bridge_testing.dart by extracting testing and diagnostic methods from bridge.dart. | Restrictions: Keep result types with their methods | Success: Testing methods work correctly. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 13. Update bridge.dart with re-exports\n  - File: `lib/ffi/bridge.dart`\n  - Import all bridge_*.dart modules\n  - Compose KeyrxBridge class using mixins/parts\n  - Maintain public API through re-exports\n  - Purpose: Complete bridge refactoring\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Developer | Task: Update lib/ffi/bridge.dart to import and compose all bridge_* modules. Use part/part of or mixins to maintain KeyrxBridge class. Verify file is under 500 lines. | Restrictions: All existing public APIs must remain accessible | Success: `flutter analyze` passes, bridge.dart under 500 lines. Mark [-] before, log after, mark [x] complete._\n\n## Phase 3: Page/Widget Refactoring\n\n- [ ] 14. Create run_controls_widgets.dart\n  - File: `lib/pages/run_controls_widgets.dart`\n  - Extract: `_StatusIndicator`, card builder methods\n  - Purpose: Reduce run_controls_page.dart below 500 lines\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Developer | Task: Create lib/pages/run_controls_widgets.dart by extracting _StatusIndicator widget and card builder widgets from run_controls_page.dart. Make _StatusIndicator public as StatusIndicator. | Restrictions: Keep widget APIs compatible | Success: Both files under 500 lines. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 15. Create visual_keyboard_keys.dart\n  - File: `lib/widgets/visual_keyboard_keys.dart`\n  - Extract: Key rendering helpers, key layout calculations\n  - Purpose: Reduce visual_keyboard.dart below 500 lines\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Developer | Task: Create lib/widgets/visual_keyboard_keys.dart by extracting key rendering helper methods and layout calculations from visual_keyboard.dart. | Restrictions: Keep widget APIs compatible | Success: Both files under 500 lines. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 16. Refactor editor_page.dart if needed\n  - File: `lib/pages/editor_page.dart`\n  - Move remaining helper methods to editor_widgets.dart\n  - Purpose: Reduce editor_page.dart below 500 lines\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Flutter Developer | Task: Check if lib/pages/editor_page.dart exceeds 500 lines after previous changes. If so, extract more helpers to editor_widgets.dart. | Restrictions: Keep widget APIs compatible | Success: File under 500 lines or already compliant. Mark [-] before, log after, mark [x] complete._\n\n## Phase 4: Verification\n\n- [ ] 17. Run full test suite\n  - Run: `flutter test` - verify 0 failures\n  - Run: `flutter analyze` - verify 0 errors\n  - Purpose: Ensure all tests pass after refactoring\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Run `flutter test` and `flutter analyze`. Fix any failures or errors introduced by refactoring. | Restrictions: Do not skip tests | Success: All tests pass, no analyzer errors. Mark [-] before, log after, mark [x] complete._\n\n- [ ] 18. Verify file sizes\n  - Run: `find lib -name \"*.dart\" -exec wc -l {} \\; | awk '$1 > 500'`\n  - Verify no files exceed 500 lines\n  - Purpose: Final verification of code quality metrics\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec flutter-ui-fixes, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Verify all Dart files in lib/ are under 500 lines. List any violations and create follow-up tasks if needed. | Restrictions: All lib files must comply | Success: No files over 500 lines. Mark [-] before, log after, mark [x] complete._\n",
  "fileStats": {
    "size": 12564,
    "lines": 141,
    "lastModified": "2025-12-03T07:41:39.692Z"
  },
  "comments": []
}