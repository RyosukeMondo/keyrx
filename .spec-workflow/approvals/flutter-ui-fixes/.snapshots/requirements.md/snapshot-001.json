{
  "id": "snapshot_1764747708698_kiqf7c7wf",
  "approvalId": "approval_1764747708682_wltcpd0ru",
  "approvalTitle": "Requirements: Flutter UI Fixes",
  "version": 1,
  "timestamp": "2025-12-03T07:41:48.698Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: Flutter UI Fixes\n\n## Introduction\n\nThis spec addresses code quality issues identified in the Flutter UI codebase during a comprehensive audit:\n- 8 failing tests due to outdated mock configurations\n- 4 files exceeding the 500-line limit\n- Test infrastructure needing updates to match current ServiceRegistry API\n\n## Alignment with Product Vision\n\nPer `structure.md` Code Size Guidelines:\n- **Max 500 lines/file** (excluding comments/blank lines)\n- **All tests must pass** before deployment\n\nPer `tech.md` Key Patterns:\n- **Testability**: All services mockable via DI\n- **Modular Design**: Split large files by domain\n\n## Requirements\n\n### REQ-1: Fix Failing Flutter Tests\n\n**User Story:** As a developer, I want all Flutter tests to pass, so that CI/CD pipelines succeed and code quality is maintained.\n\n#### Acceptance Criteria\n\n1. WHEN running `flutter test` THEN the system SHALL report 0 failures\n2. IF `ServiceRegistry.withOverrides()` is called THEN all required parameters SHALL be provided\n3. WHEN tests use mock services THEN they SHALL match current ServiceRegistry API\n\n### REQ-2: Refactor FFI Bridge Module\n\n**User Story:** As a maintainer, I want the FFI bridge organized by domain, so that the codebase is easier to navigate and maintain.\n\n#### Acceptance Criteria\n\n1. WHEN `bridge.dart` (1841 lines) is refactored THEN each resulting file SHALL be under 500 lines\n2. IF FFI methods are split THEN the public API SHALL remain unchanged\n3. WHEN modules are separated THEN they SHALL follow single-responsibility:\n   - Core initialization in dedicated module\n   - Engine control in dedicated module\n   - Audio capture in dedicated module\n   - Session/recording in dedicated module\n   - Discovery in dedicated module\n\n### REQ-3: Refactor Oversized Page/Widget Files\n\n**User Story:** As a maintainer, I want page files to comply with size limits for better code organization.\n\n#### Acceptance Criteria\n\n1. WHEN `run_controls_page.dart` (542 lines) is refactored THEN resulting files SHALL be under 500 lines\n2. WHEN `visual_keyboard.dart` (529 lines) is refactored THEN resulting files SHALL be under 500 lines\n3. WHEN `editor_page.dart` (509 lines) is refactored THEN resulting files SHALL be under 500 lines\n4. IF widgets are extracted THEN existing public APIs SHALL remain unchanged\n\n### REQ-4: Maintain Test Coverage\n\n**User Story:** As a developer, I want test coverage maintained after refactoring.\n\n#### Acceptance Criteria\n\n1. WHEN all refactoring is complete THEN `flutter test` SHALL pass with 0 failures\n2. IF new modules are created THEN they SHALL be testable via existing patterns\n3. WHEN tests are updated THEN they SHALL continue to validate the same functionality\n\n## Non-Functional Requirements\n\n### Code Architecture\n- **Single Responsibility**: Each file should have single purpose\n- **Modular Design**: Split files logically by domain\n- **Backward Compatibility**: Maintain existing public APIs through re-exports\n\n### Reliability\n- All existing tests SHALL pass after refactoring\n- No behavioral changes to existing functionality\n",
  "fileStats": {
    "size": 3087,
    "lines": 78,
    "lastModified": "2025-12-03T07:41:39.587Z"
  },
  "comments": []
}