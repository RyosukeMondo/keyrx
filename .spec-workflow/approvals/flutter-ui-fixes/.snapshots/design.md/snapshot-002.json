{
  "id": "snapshot_1764747745452_oi8ikqn7e",
  "approvalId": "approval_1764747708742_0duf4msga",
  "approvalTitle": "Design: Flutter UI Fixes",
  "version": 2,
  "timestamp": "2025-12-03T07:42:25.452Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: Flutter UI Fixes\n\n## Overview\n\nThis design addresses Flutter UI code quality issues:\n1. Fix 8 failing tests by updating ServiceRegistry mock configurations\n2. Split `bridge.dart` (1841 lines) into domain-specific modules\n3. Refactor 3 oversized page/widget files\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- **Modular Design**: Split files by single responsibility\n- **Testability**: All services mockable via dependency injection\n\n### Project Structure (structure.md)\n- **Max 500 lines/file**: Target for all refactored files\n- **Re-exports**: Maintain public API through barrel files\n\n## Code Reuse Analysis\n\n### Existing Patterns to Follow\n- Service interface pattern (`EngineService`, `AudioService`, etc.)\n- `ServiceRegistry.withOverrides()` for test mocking\n- Widget extraction pattern (see `debugger_widgets.dart`, `editor_widgets.dart`)\n\n## Architecture\n\n### Test Fix Strategy\n\nThe 8 failing tests all have the same root cause:\n```dart\n// Current (broken):\nfinal registry = ServiceRegistry.withOverrides(\n  engineService: _FakeEngineService(),\n);\n\n// Fixed (add required deviceService):\nfinal registry = ServiceRegistry.withOverrides(\n  engineService: _FakeEngineService(),\n  deviceService: _FakeDeviceService(),  // Add this\n);\n```\n\n### FFI Bridge Split Strategy\n\n```\nbridge.dart (1841 lines)\n├── bridge.dart (~200 lines) - Re-exports, KeyrxBridge class shell\n├── bridge_core.dart (~150 lines) - init, version, dispose\n├── bridge_engine.dart (~300 lines) - engine control, state stream\n├── bridge_audio.dart (~200 lines) - audio capture, classification\n├── bridge_session.dart (~350 lines) - recording, replay, analysis\n├── bridge_discovery.dart (~300 lines) - device discovery\n└── bridge_testing.dart (~250 lines) - simulate, tests, benchmark\n```\n\n### Page/Widget Split Strategy\n\n**run_controls_page.dart (542 lines)**\n```\nrun_controls_page.dart (~300 lines) - Main page\nrun_controls_widgets.dart (~250 lines) - _StatusIndicator, cards\n```\n\n**visual_keyboard.dart (529 lines)**\n```\nvisual_keyboard.dart (~300 lines) - Main widget\nvisual_keyboard_keys.dart (~230 lines) - Key rendering helpers\n```\n\n**editor_page.dart (509 lines)**\nAlready has `editor_widgets.dart` - just needs extraction of remaining helpers.\n\n## Components\n\n### Component 1: Test Fixes\n\n| Test File | Fix Required |\n|-----------|--------------|\n| `keyrx_training_screen_test.dart` | Add `deviceService: _FakeDeviceService()` |\n| `trade_off_test.dart` | Add `deviceService: _FakeDeviceService()` |\n| `debugger_page_test.dart` | Add `deviceService: _FakeDeviceService()` |\n| `training_screen_test.dart` | Add `deviceService: _FakeDeviceService()` |\n\n### Component 2: Bridge Module Split\n\n| Module | Contents | Est. Lines |\n|--------|----------|------------|\n| `bridge.dart` | KeyrxBridge class, re-exports | ~200 |\n| `bridge_core.dart` | `_init()`, `version`, `dispose()`, `_freeString()` | ~150 |\n| `bridge_engine.dart` | `loadScript()`, `eval()`, `stateStream`, `listKeys()` | ~300 |\n| `bridge_audio.dart` | `startAudio()`, `stopAudio()`, `setBpm()`, classification | ~200 |\n| `bridge_session.dart` | `startRecording()`, `stopRecording()`, `listSessions()`, `analyzeSession()`, `replaySession()` | ~350 |\n| `bridge_discovery.dart` | `startDiscovery()`, `processDiscoveryEvent()`, `cancelDiscovery()` | ~300 |\n| `bridge_testing.dart` | `simulate()`, `runTests()`, `discoverTests()`, `runBenchmark()`, `runDoctor()` | ~250 |\n\n### Component 3: Page Widgets Extraction\n\nExtract reusable widgets to separate files following existing pattern.\n\n## Error Handling\n\n- Test compilation errors will be fixed by providing required parameters\n- Import path changes handled through re-exports in main files\n\n## Testing Strategy\n\n### Verification Steps\n1. Run `flutter test` - expect 0 failures\n2. Run `flutter analyze` - expect 0 errors\n3. Verify no file exceeds 500 lines\n",
  "fileStats": {
    "size": 3923,
    "lines": 113,
    "lastModified": "2025-12-03T07:41:39.638Z"
  },
  "comments": []
}